<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iblviewer.mouse_brain &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DataJoint</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dj_docs/dj_introduction.html">Introduction to DataJoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dj_docs/dj_public.html">Publicly available IBL data via Datajoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dj_docs/dj_credentials.html">DataJoint credentials for internal IBL users</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks_external/data_release_repro_ephys.html">Data Release - Reproducible Ephys Paper</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/dj_intro/dj_intro.html">Datajoint Introductory Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/dj_basics/dj_basics.html">Exploring the IBL Data Pipeline</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Detailed Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>iblviewer.mouse_brain</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for iblviewer.mouse_brain</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="kn">import</span> <span class="nn">vedo</span>
<span class="kn">import</span> <span class="nn">nrrd</span>
<span class="kn">import</span> <span class="nn">ibllib.atlas</span>
<span class="kn">from</span> <span class="nn">ibllib.atlas.regions</span> <span class="kn">import</span> <span class="n">BrainRegions</span>
<span class="kn">from</span> <span class="nn">iblutil.numerical</span> <span class="kn">import</span> <span class="n">ismember</span>

<span class="kn">from</span> <span class="nn">iblviewer.application</span> <span class="kn">import</span> <span class="n">Viewer</span>
<span class="kn">from</span> <span class="nn">iblviewer.volume</span> <span class="kn">import</span> <span class="n">VolumeController</span><span class="p">,</span> <span class="n">VolumeModel</span><span class="p">,</span> <span class="n">LUTModel</span>
<span class="kn">import</span> <span class="nn">iblviewer.utils</span> <span class="k">as</span> <span class="nn">utils</span>

<span class="n">ALLEN_ATLAS_RESOLUTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">ALLEN_ATLASES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;base_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://download.alleninstitute.org/informatics-archive&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mouse_ccf_folder&#39;</span><span class="p">:</span> <span class="s1">&#39;/current-release/mouse_ccf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;atlas_folder&#39;</span><span class="p">:</span> <span class="s1">&#39;/annotation/ccf_2017&#39;</span><span class="p">,</span> <span class="s1">&#39;atlas_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;/annotation_&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dwi_folder&#39;</span><span class="p">:</span> <span class="s1">&#39;/average_template&#39;</span><span class="p">,</span> <span class="s1">&#39;dwi_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;/average_template_&#39;</span><span class="p">,</span>
                <span class="s1">&#39;volume_extension&#39;</span><span class="p">:</span> <span class="s1">&#39;.nrrd&#39;</span><span class="p">}</span>

<span class="c1"># Default origin is &quot;bregma&quot;, an origin defined at the center of the XY axes (not on Z)</span>
<span class="c1"># For reference, bregma is np.array([5739.0, 5400.0, 332.0])</span>
<span class="c1"># And for some reason, it&#39;s not exactly in the middle of X axis (should be 5400.0)...</span>
<span class="n">IBL_BREGMA_ORIGIN</span> <span class="o">=</span> <span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">ALLEN_CCF_LANDMARKS_MLAPDV_UM</span><span class="p">[</span><span class="s1">&#39;bregma&#39;</span><span class="p">]</span>
<span class="n">BASE_PATH</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">split_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">REMAPPED_VOLUME_SUFFIX</span> <span class="o">=</span> <span class="s1">&#39;_remapped&#39;</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ibllib&#39;</span><span class="p">)</span>
<span class="n">LUT_VERSION</span> <span class="o">=</span> <span class="s1">&#39;v01&#39;</span> <span class="c1"># version 01 is the lateralized version</span>


<div class="viewcode-block" id="AllenAtlasExt"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.AllenAtlasExt">[docs]</a><span class="k">class</span> <span class="nc">AllenAtlasExt</span><span class="p">(</span><span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">AllenAtlas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This overwrites the constructor of AllenAtlas that is not designed to be used for the</span>
<span class="sd">    public, that is people outside of IBL. Typically, you&#39;d want to display the Allen volume</span>
<span class="sd">    data in this viewer and perform additional tasks (such as loading your own extra data)</span>
<span class="sd">    with other libraries. Dev note: I&#39;m forced to copy and modify the whole constructor in this case.</span>

<span class="sd">    Instantiates an atlas.BrainAtlas corresponding to the Allen CCF at the given resolution</span>
<span class="sd">    using the IBL Bregma and coordinate system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_volume</span><span class="p">(</span><span class="n">file_volume</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_volume</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.nrrd&#39;</span><span class="p">:</span>
            <span class="n">volume</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_volume</span><span class="p">,</span> <span class="n">index_order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>  <span class="c1"># ml, dv, ap</span>
            <span class="c1"># we want the coronal slice to be the most contiguous</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># image[iap, iml, idv]</span>
        <span class="k">elif</span> <span class="n">file_volume</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.npz&#39;</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_volume</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">volume</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_um</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">brainmap</span><span class="o">=</span><span class="s1">&#39;Allen&#39;</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="n">image_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param res_um: 10, 25 or 50 um</span>
<span class="sd">        :param brainmap: defaults to &#39;Allen&#39;, see ibllib.atlas.BrainRegion for re-mappings</span>
<span class="sd">        :param scaling: scale factor along ml, ap, dv for squeeze and stretch ([1, 1, 1])</span>
<span class="sd">        :return: atlas.AllenAtlasGP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xyz2dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="c1"># this is the c-contiguous ordering</span>
        <span class="n">dims2xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="c1"># we use Bregma as the origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res_um</span> <span class="o">=</span> <span class="n">res_um</span>
        <span class="n">dxyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_um</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>

        <span class="k">if</span> <span class="n">label_file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No point in going further</span>
            <span class="k">return</span>

        <span class="n">regions</span> <span class="o">=</span> <span class="n">BrainRegions</span><span class="p">()</span>
        <span class="n">ibregma</span> <span class="o">=</span> <span class="p">(</span><span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">ALLEN_CCF_LANDMARKS_MLAPDV_UM</span><span class="p">[</span><span class="s1">&#39;bregma&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_um</span><span class="p">)</span>
        <span class="c1">#image_path = atlas_path.joinpath(f&#39;average_template_{res_um}.nrrd&#39;)</span>
        <span class="c1"># It is really unfortunate that users are forced to have in memory two volumes: the atlas and the DWI!</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">AllenAtlasExt</span><span class="o">.</span><span class="n">_read_volume</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">image_file_path</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remap_atlas</span><span class="p">(</span><span class="n">label_file_path</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">ibregma</span><span class="p">)</span>

        <span class="c1"># This calls BrainAtlas, the mother class of AllenAtlas because we want to overwrite it</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">AllenAtlas</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">dxyz</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span>
        <span class="n">ibregma</span><span class="p">,</span> <span class="n">dims2xyz</span><span class="o">=</span><span class="n">dims2xyz</span><span class="p">,</span> <span class="n">xyz2dims</span><span class="o">=</span><span class="n">xyz2dims</span><span class="p">)</span>

<div class="viewcode-block" id="AllenAtlasExt.remap_atlas"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.AllenAtlasExt.remap_atlas">[docs]</a>    <span class="k">def</span> <span class="nf">remap_atlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibregma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remap the atlas label into a usable volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>
        <span class="n">parent_folder</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">npz_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">_lut_</span><span class="si">{</span><span class="n">LUT_VERSION</span><span class="si">}</span><span class="s1">.npz&#39;</span>
        <span class="n">remapped_file_path</span> <span class="o">=</span> <span class="n">parent_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">npz_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">remapped_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_volume</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">regions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Encapsulating the lateralization, that should be a given</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lateralize</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">ibregma</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving </span><span class="si">{</span><span class="n">remapped_file_path</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remapped_file_path</span><span class="p">),</span> <span class="n">volume</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remapped_file_path</span><span class="p">))[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">volume</span></div>

<div class="viewcode-block" id="AllenAtlasExt.lateralize"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.AllenAtlasExt.lateralize">[docs]</a>    <span class="k">def</span> <span class="nf">lateralize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibregma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Breaks the symmetry in regions labels in the Allen Mouse Atlas where the id</span>
<span class="sd">        of a region in the left hemisphere is the same as the same region in the right</span>
<span class="sd">        hemisphere. But if we want to map recordings to the brain, we need separate ids.</span>
<span class="sd">        :param label: Segmented volume</span>
<span class="sd">        :return: Modified volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;computing brain atlas annotations lookup table&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="n">BrainRegions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ibregma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ibregma</span> <span class="o">=</span> <span class="p">(</span><span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">ALLEN_CCF_LANDMARKS_MLAPDV_UM</span><span class="p">[</span><span class="s1">&#39;bregma&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_um</span><span class="p">)</span>
        <span class="n">xyz2dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># this is the c-contiguous ordering</span>
        <span class="c1"># lateralize atlas: for this the regions of the left hemisphere have primary</span>
        <span class="c1"># keys opposite to to the normal ones</span>
        <span class="n">lateral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">xyz2dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">lateral</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ibregma</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lateral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">lateral</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">*</span> <span class="n">lateral</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">ismember</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">regions</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="n">label</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span></div></div>



<div class="viewcode-block" id="IBLAtlasModel"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">IBLAtlasModel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IBL Atlas is a wrapper for the Allen Atlas with added features.</span>
<span class="sd">    The volume is also modified such that it fits functional needs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">origin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">IBL_BREGMA_ORIGIN</span>
    <span class="n">atlas</span><span class="p">:</span> <span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">AllenAtlas</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">atlas_lut</span><span class="p">:</span> <span class="n">LUTModel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">atlas_mapping_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ibl_back_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">IBL_TRANSPOSE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">atlas_volume</span><span class="p">:</span> <span class="n">VolumeModel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dwi_volume</span><span class="p">:</span> <span class="n">VolumeModel</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="IBLAtlasModel.initialize"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibl_back_end</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Allen Atlas metadata (.csv file that is copied into ibllib.atlas) and volume files</span>
<span class="sd">        :param resolution: Volume resolution in microns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLEN_ATLAS_RESOLUTIONS</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">ALLEN_ATLAS_RESOLUTIONS</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="o">==</span> <span class="n">ALLEN_ATLAS_RESOLUTIONS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: the Allen Atlas at 10um resolution will require over 10GB of RAM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ibl_back_end</span> <span class="o">=</span> <span class="n">ibl_back_end</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="n">ibllib</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">AllenAtlas</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">atlas_volume_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allen_volume_url</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
            <span class="n">atlas_volume_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allen_volume_file_name</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
            <span class="n">atlas_file</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atlas_volume_url</span><span class="p">)</span>
            <span class="n">atlas_volume_path</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">atlas_volume_name</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">atlas_volume_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atlas_file</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="n">dwi_volume_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allen_volume_url</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">dwi_volume_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allen_volume_file_name</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">dwi_file</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dwi_volume_url</span><span class="p">)</span>
            <span class="n">dwi_volume_path</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">dwi_volume_name</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">dwi_volume_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dwi_file</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="n">AllenAtlasExt</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">image_file_path</span><span class="o">=</span><span class="n">dwi_volume_path</span><span class="p">,</span> <span class="n">label_file_path</span><span class="o">=</span><span class="n">atlas_volume_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_mapping_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">mappings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>
        <span class="c1"># Further than initialize(), you will need to either call get_atlas_model() or get_dwi_model()</span>

<div class="viewcode-block" id="IBLAtlasModel.get_atlas_model"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_atlas_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_atlas_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a VolumeModel instance that represents the atlas (segmented) volume</span>
<span class="sd">        :param atlas_mapping: IBL Mapping that we want to use on this atlas.</span>
<span class="sd">            See ibllib.atlas.AllenAtlas.regions.mappings.keys()</span>
<span class="sd">        :return: VolumeModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No atlas!&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span> <span class="o">=</span> <span class="n">VolumeModel</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">base_color_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">rgb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapped_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">atlas_mapping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">atlas_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">VolumeModel</span><span class="o">.</span><span class="n">SEGMENTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Allen Mouse CCF v3 Atlas volume&#39;</span>
        <span class="c1"># IBL convention</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">lateralized</span> <span class="o">=</span> <span class="n">atlas_mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;-lr&#39;</span> <span class="ow">in</span> <span class="n">atlas_mapping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_back_end</span><span class="p">:</span>
            <span class="c1"># The IBL back-end uses a different convention for memory representation</span>
            <span class="c1"># so we are forced to untranspose the volume...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">IBLAtlasModel</span><span class="o">.</span><span class="n">IBL_TRANSPOSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">build_lut</span><span class="p">(</span><span class="n">color_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">make_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">compute_size</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_dwi_model"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_dwi_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_dwi_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a VolumeModel instance of the DWI volume image</span>
<span class="sd">        :return: VolumeModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span> <span class="o">=</span> <span class="n">VolumeModel</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">VolumeModel</span><span class="o">.</span><span class="n">RAW</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Allen Mouse CCF v3 DWI volume&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_back_end</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">IBLAtlasModel</span><span class="o">.</span><span class="n">IBL_TRANSPOSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span><span class="o">.</span><span class="n">compute_size</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_volume</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_num_regions"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_num_regions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get how many regions are labelled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">size</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_value_from_scalar_map"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_value_from_scalar_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_from_scalar_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverse look-up in array to find a corresponding value</span>
<span class="sd">        :param scalar: Scalar value</span>
<span class="sd">        :return: Raw volume value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scalar_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">luts</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">scalar_map</span>
        <span class="k">if</span> <span class="n">scalar_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scalar_map</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">scalar_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1">#print(scalar - scalar_map[value])</span>
            <span class="k">if</span> <span class="n">scalar_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">==</span> <span class="n">scalar</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_mapped_data"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_mapped_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_mapped_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a value from the segmented volume, we retrieve useful info</span>
<span class="sd">        :param value: Value from the volume</span>
<span class="sd">        :return: Dictionary of corresponding data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">region_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="n">region_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region_id</span><span class="p">)</span>

        <span class="n">data_lut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_volume</span><span class="o">.</span><span class="n">luts</span><span class="o">.</span><span class="n">current</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="n">region_data</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">data_lut</span><span class="o">.</span><span class="n">color_map</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">data_lut</span><span class="o">.</span><span class="n">alpha_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">data_lut</span><span class="o">.</span><span class="n">alpha_map</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scalar_map</span> <span class="o">=</span> <span class="n">data_lut</span><span class="o">.</span><span class="n">scalar_map</span>
        <span class="k">if</span> <span class="n">scalar_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scalar_map</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="n">scalar_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="n">scalar_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;scalar&#39;</span><span class="p">:</span><span class="n">scalar</span><span class="p">,</span> <span class="s1">&#39;region_id&#39;</span><span class="p">:</span><span class="n">region_id</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span>
                <span class="s1">&#39;region_name&#39;</span><span class="p">:</span><span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;region_data&#39;</span><span class="p">:</span><span class="n">region_data</span><span class="p">}</span></div>

<div class="viewcode-block" id="IBLAtlasModel.remap"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.remap">[docs]</a>    <span class="k">def</span> <span class="nf">remap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;Allen&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Beryl&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remap ids/scalar values from source to destination</span>
<span class="sd">        Function by Olivier Winter</span>
<span class="sd">        :param ids: List of ids</span>
<span class="sd">        :param source: Source mapping</span>
<span class="sd">        :param dest: Destination mapping</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#from ibllib.atlas import BrainRegions as br</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">inds</span> <span class="o">=</span> <span class="n">ismember</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">source</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">dest</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_allen_volume_file_name"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_allen_volume_file_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_allen_volume_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">raw_image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Allen volume file name given its resolution</span>
<span class="sd">        :param resolution: Resolution of the volume</span>
<span class="sd">        :param raw_image: Whether we want the raw volume file name or the segmented one</span>
<span class="sd">        :return: String</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;dwi_prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">raw_image</span> <span class="k">else</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;atlas_prefix&#39;</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span> <span class="o">+</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;volume_extension&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">file_name</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_allen_volume_url"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_allen_volume_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_allen_volume_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">raw_image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a URL with which we can download data sets</span>
<span class="sd">        :param resolution: Volume resolution, either 10, 25, 50 or 100 (um)</span>
<span class="sd">        :param raw_image: Whether the volume is the segmented one (aka the atlas) or the DWI</span>
<span class="sd">        :return: String</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;mouse_ccf_folder&#39;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;dwi_folder&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">raw_image</span> <span class="k">else</span> <span class="n">ALLEN_ATLASES</span><span class="p">[</span><span class="s1">&#39;atlas_folder&#39;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allen_volume_file_name</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">raw_image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="IBLAtlasModel.load_volume"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.load_volume">[docs]</a>    <span class="k">def</span> <span class="nf">load_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">remap_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_current</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a volume data file. Supports NRRD and many other formats thanks to vedo/VTK</span>
<span class="sd">        :param file_path: Volume file path. Could support other file types easily.</span>
<span class="sd">        :param remap_scalars: Whether scalar values in the volume are replaced by</span>
<span class="sd">            their row id from a mapping that stores. This is necessary in the case of segmented</span>
<span class="sd">            volumes with regions that have a discontinuous id.</span>
<span class="sd">        :param mapping: Pandas Series or a Dictionary</span>
<span class="sd">        :param make_current: Set the volume data as the current one</span>
<span class="sd">        :return: 3D array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_volume</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">remap_scalars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">make_current</span><span class="p">)</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_name"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get full name for a model, separated by underscores</span>
<span class="sd">        :return: String</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_mapped_volume"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_mapped_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_mapped_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">atlas_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibl_back_end</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the volume data according to a mapping</span>
<span class="sd">        :param volume: Given volume to display</span>
<span class="sd">        :param atlas_mapping: Mapping, either a string for the name of the mapping or an integer.</span>
<span class="sd">        :param ibl_back_end: If you are not using ibllib and want to load your own volume, set this to False</span>
<span class="sd">            so that there will be no transposition of the volume (needed for the ones from IBL)</span>
<span class="sd">        :return: Volume nd array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">volume_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ibl_back_end</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atlas_mapping</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atlas_mapping</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas_mapping_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#logging.error(&#39;[AtlasModel.get_mapped_volume()] could not find atlas mapping with id &#39; + str(atlas_mapping) + &#39;. Returning raw volume...&#39;)</span>
                    <span class="k">return</span> <span class="n">volume</span>
                <span class="n">map_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_mapping_ids</span><span class="p">[</span><span class="n">atlas_mapping</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">atlas_mapping</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_mapping_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">map_id</span> <span class="o">=</span> <span class="n">atlas_mapping</span>

            <span class="c1"># This mapping actually changes the order of the axes in the volume...</span>
            <span class="n">volume_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">map_id</span><span class="p">][</span><span class="n">volume</span><span class="p">]</span>
            <span class="c1">#logging.info(&#39;Loaded atlas volume with &#39; + map_id + &#39; mapping&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">volume_data</span> <span class="o">=</span> <span class="n">volume</span>
        <span class="k">return</span> <span class="n">volume_data</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_region_and_row_id"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_region_and_row_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_and_row_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acronym</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get region and row id given an acronym</span>
<span class="sd">        :param acronym: Acronym of a brain region</span>
<span class="sd">        :return: Region id and row id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">acronym</span> <span class="o">==</span> <span class="n">acronym</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ind</span></div>

<div class="viewcode-block" id="IBLAtlasModel.get_regions_mask"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.IBLAtlasModel.get_regions_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_regions_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_ids</span><span class="p">,</span> <span class="n">alpha_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an alpha map that reveals only the given region ids</span>
<span class="sd">        :param region_ids: List or numpy array of region ids</span>
<span class="sd">        :param alpha_map: Optional alpha map that will be modified. If None provided, the method will attempt</span>
<span class="sd">            to use the current active alpha map</span>
<span class="sd">        :return: 2D numpy array with region ids and corresponding alpha values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alpha_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lut</span><span class="o">.</span><span class="n">alpha_map</span>
        <span class="k">if</span> <span class="n">alpha_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#logging.error(&#39;[Method build_regions_alpha_map()] requires that an alpha map is created by build_regions_alpha_map()&#39;)</span>
            <span class="k">return</span>
        <span class="n">new_alpha_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">alpha_map</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">new_alpha_map</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_map</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">new_alpha_map</span><span class="p">[</span><span class="n">region_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_map</span><span class="p">[</span><span class="n">region_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lut</span><span class="o">.</span><span class="n">sec_alpha_map</span> <span class="o">=</span> <span class="n">new_alpha_map</span>
        <span class="k">return</span> <span class="n">new_alpha_map</span></div></div>


<div class="viewcode-block" id="MouseBrainViewer"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer">[docs]</a><span class="k">class</span> <span class="nc">MouseBrainViewer</span><span class="p">(</span><span class="n">Viewer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is your entry point to International Brain Laboratory data visualization</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Shortcut for users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibl_transpose</span> <span class="o">=</span> <span class="n">IBLAtlasModel</span><span class="o">.</span><span class="n">IBL_TRANSPOSE</span>

<div class="viewcode-block" id="MouseBrainViewer.initialize"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="s1">&#39;Beryl&#39;</span><span class="p">,</span> <span class="n">add_atlas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_dwi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">dwi_color_map</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">dwi_alpha_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">local_allen_volumes_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">offscreen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jupyter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">embed_ui</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">embed_font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                    <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_window_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_windows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dark_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the controller, main entry point to the viewer</span>
<span class="sd">        :param resolution: Resolution of the atlas volume.</span>
<span class="sd">            Possible values are 10 (requires a lot of RAM), 25, 50, 100. Units are in microns</span>
<span class="sd">        :param mapping: Optional mapping value. In the context of IBL, there is &#39;Allen&#39; for the standard Allen map</span>
<span class="sd">            and &#39;Beryl&#39; (random name) which aggregates cortical layers as one.</span>
<span class="sd">        :param add_atlas: Whether the Atlas is included in the viewer</span>
<span class="sd">        :param add_dwi: Whether the diffusion weighted imaging is loaded in the viewer (same boundaries as atlas)</span>
<span class="sd">        :param context: Context of the visualization</span>
<span class="sd">        :param embed_ui: Whether the UI is embed within the VTK window</span>
<span class="sd">        :param embed_font_size: Embed font size. Defaults to 16 points. You might need larger values</span>
<span class="sd">            in case you have a small screen with high dpi (but VTK methods fail to detect that).</span>
<span class="sd">        :param jupyter: Whether we&#39;re running from a jupyter notebook or not</span>
<span class="sd">        :param plot: A vedo Plotter instance. You can either create it by yourself before hand, in case you want</span>
<span class="sd">            to have multiple windows with other stats or let the controller create a new one</span>
<span class="sd">        :param plot_window_id: Sub-window id where the 3D visualization will be displayed</span>
<span class="sd">        :param num_windows: Number of subwindows, in case you want to display your own stuff later</span>
<span class="sd">        :param dark_mode: Whether the viewer is in dark mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;IBL Viewer&#39;</span>

        <span class="c1"># ibllib works with two volumes at the same time: the segmented volume (called &#39;label&#39;)</span>
        <span class="c1"># and the DWI volume (called &#39;image&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span> <span class="o">=</span> <span class="n">IBLAtlasModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">local_allen_volumes_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">origin</span>

        <span class="c1"># Neuroscience specific</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">probe_initial_point1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">probe_initial_point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8000</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">offscreen</span><span class="p">,</span> <span class="n">jupyter</span><span class="p">,</span> <span class="n">embed_ui</span><span class="p">,</span> <span class="n">embed_font_size</span><span class="p">,</span>
                            <span class="n">plot</span><span class="p">,</span> <span class="n">plot_window_id</span><span class="p">,</span> <span class="n">num_windows</span><span class="p">,</span> <span class="n">dark_mode</span><span class="p">)</span>

        <span class="c1"># A VolumeController has a unique volume as target so if we want to visualize both volumes, we create two views</span>
        <span class="k">if</span> <span class="n">add_atlas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">get_atlas_model</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_atlas_segmentation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">add_dwi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">get_dwi_model</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dwi_alpha_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#dwi_alpha_map = np.ones(516)</span>
                <span class="c1">#dwi_alpha_map[:140] = 0</span>
                <span class="n">dwi_alpha_map</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_atlas_dwi</span><span class="p">(</span><span class="n">dwi_color_map</span><span class="p">,</span> <span class="n">dwi_alpha_map</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_bounding_mesh</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1">#light = vedo.Light(self.model.IBL_BREGMA_ORIGIN - [0, 0, 1000], c=&#39;w&#39;, intensity=0.2)</span>
        <span class="c1">#self.plot.add(light)</span>

        <span class="c1"># By default, the atlas volume is our target</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#self.add_origin()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_lut_update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_left_view</span><span class="p">()</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_atlas_segmentation"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_atlas_segmentation">[docs]</a>    <span class="k">def</span> <span class="nf">add_atlas_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the Allen Atlas segmented volume (aka label)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span><span class="p">,</span> <span class="n">VolumeController</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span> <span class="o">=</span> <span class="n">VolumeController</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">atlas_volume</span><span class="p">,</span>
                                                <span class="n">alpha_unit_upper_offset</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">center_on_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_controller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span><span class="o">.</span><span class="n">get_related_actors</span><span class="p">())</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_atlas_dwi"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_atlas_dwi">[docs]</a>    <span class="k">def</span> <span class="nf">add_atlas_dwi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color_map</span><span class="p">,</span> <span class="n">alpha_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the Allen Atlas diffusion weighted image</span>
<span class="sd">        :param color_map: Color map for the volume</span>
<span class="sd">        :param alpha_map: Alpha map for the volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span><span class="p">,</span> <span class="n">VolumeController</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span> <span class="o">=</span> <span class="n">VolumeController</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">dwi_volume</span><span class="p">,</span>
                                                <span class="n">center_on_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span><span class="o">.</span><span class="n">set_color_map</span><span class="p">(</span><span class="n">color_map</span><span class="p">,</span> <span class="n">alpha_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_controller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_controller</span><span class="o">.</span><span class="n">get_related_actors</span><span class="p">())</span></div>

<div class="viewcode-block" id="MouseBrainViewer.load_bounding_mesh"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.load_bounding_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">load_bounding_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha_on_scene</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the bounding mesh of the mouse brain that represents its approximate pial limit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_surface_mesh</span><span class="p">(</span><span class="s1">&#39;997&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_to_scene</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span><span class="o">.</span><span class="n">alpha</span><span class="p">(</span><span class="n">alpha_on_scene</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span><span class="p">)</span>

        <span class="c1"># An offset is applied to the volume in build_actor, so we have to apply it here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span><span class="o">.</span><span class="n">pos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span></div>
        <span class="c1">#self.bounding_mesh.mapper().SetClippingPlanes(self.clipping_planes)</span>

<div class="viewcode-block" id="MouseBrainViewer.find_region"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.find_region">[docs]</a>    <span class="k">def</span> <span class="nf">find_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find a region with a substring</span>
<span class="sd">        :param term: Search term</span>
<span class="sd">        :return: List of matching entries and the corresponding mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ibl_model.atlas.regions is a BrainRegion object that puts a pandas dataframe</span>
        <span class="c1"># into separate numpy arrays (like &#39;name&#39;) so we work on a numpy array here</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">term</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="MouseBrainViewer.get_region_names"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.get_region_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the region names</span>
<span class="sd">        :return: List</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">camera_position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the current object selected</span>
<span class="sd">        :param actor: a vtkActor</span>
<span class="sd">        :param controller: Controller of the given actor (optional)</span>
<span class="sd">        :param event: a vedo event from which we use picked3d and picked2d (we could directly use vtk)</span>
<span class="sd">        :param camera_position: position of the camera (optional) at selection time</span>
<span class="sd">        :param position: The final position computed on the volume or mesh or point or line.</span>
<span class="sd">            If not given, this will be automatically calculated</span>
<span class="sd">        .param value: The value corresponding to the point on the object. If not given, this will</span>
<span class="sd">            be automatically retrieved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">camera_position</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_model</span><span class="o">.</span><span class="n">get_mapped_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># This is where we retrieve neuroscience specific data about our selection</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection</span>
        <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span><span class="o">.</span><span class="n">actor</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_probe</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection_related_name</span> <span class="o">=</span> <span class="n">extra_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;region_name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection_related_value</span> <span class="o">=</span> <span class="n">extra_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scalar&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MouseBrainViewer.get_selection_info"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.get_selection_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_selection_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information about the current selection</span>
<span class="sd">        :param line_length: Region name line length after what it&#39;s word-wrapped</span>
<span class="sd">        :param precision: Scalar value floating precision displayed</span>
<span class="sd">        :return: Preformatted multiline text and a dictionary of extra data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_selection_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection_related_name</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">selection_related_value</span>
        <span class="k">if</span> <span class="n">region_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line_length</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">break_long_words</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">region_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Scalar value: </span><span class="si">{</span><span class="n">scalar</span><span class="si">:</span><span class="s1">.</span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_origin"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_origin">[docs]</a>    <span class="k">def</span> <span class="nf">add_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the origin on scene</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_origin</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Cross3DExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas_origin</span><span class="o">.</span><span class="n">lighting</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atlas_origin</span><span class="p">)</span></div>
        <span class="c1">#text_pos = self.atlas_origin.pos()+[0, 100, 0]</span>
        <span class="c1">#font_size = self.model.ui.font_size * 10</span>
        <span class="c1">#self.atlas_origin_label = vedo.Text3D(&#39;Bregma origin&#39;, pos=text_pos, s=font_size, c=&#39;k&#39;)</span>
        <span class="c1">#self.atlas_origin_label.followCamera()</span>
        <span class="c1">#self.plot.add([self.atlas_origin, self.atlas_origin_label])</span>

<div class="viewcode-block" id="MouseBrainViewer.add_many_points_test"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_many_points_test">[docs]</a>    <span class="k">def</span> <span class="nf">add_many_points_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">point_radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">auto_xy_rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test method that validates that VTK is fast enough for displaying 10 million points interactively (and it is :)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">points_path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_local_data_file_path</span><span class="p">(</span><span class="s1">&#39;mouse_brain_neurons&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">)</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">points_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># We sample a cube if you don&#39;t have the pickle file for neurons in the brain</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.0</span>
        <span class="n">point_cloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">point_radius</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">use_origin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">as_spheres</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_xy_rotate</span><span class="p">:</span>
            <span class="n">point_cloud</span><span class="o">.</span><span class="n">rotateX</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">point_cloud</span><span class="o">.</span><span class="n">rotateZ</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_object</span><span class="p">(</span><span class="n">point_cloud</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_to_scene</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point_cloud</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">point_cloud</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_spheres"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_spheres">[docs]</a>    <span class="k">def</span> <span class="nf">add_spheres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="s1">&#39;Accent&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Spheres&#39;</span><span class="p">,</span>
                    <span class="n">use_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noise_amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trim_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">bounding_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibl_flip_yz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add new spheres</span>
<span class="sd">        :param positions: 3D array of coordinates</span>
<span class="sd">        :param radius: List same length as positions of radii. The default size is 5um, or 5 pixels</span>
<span class="sd">            in case as_spheres is False.</span>
<span class="sd">        :param values: 1D array of values, one per neuron or a time series of such 1D arrays (numpy format)</span>
<span class="sd">        :param color_map: A color map, it can be a color map built by IBLViewer or</span>
<span class="sd">            a color map name (see vedo documentation), or a list of values, etc.</span>
<span class="sd">        :param name: All point neurons are grouped into one object, you can give it a custom name</span>
<span class="sd">        :param use_origin: Whether the origin is added as offset to the given positions</span>
<span class="sd">        :param add_to_scene: Whether the new lines are added to scene/plot and rendered</span>
<span class="sd">        :param noise_amount: Amount of 3D random noise applied to each point. Defaults to 0</span>
<span class="sd">        :param trim_outliers: If bounding_mesh param is given, then the spheres will be trimmed,</span>
<span class="sd">            only the ones inside the bounding mesh will be kept</span>
<span class="sd">        :param bounding_mesh: A closed manifold surface mesh used for trimming segments. If None,</span>
<span class="sd">            the current self.bounding_mesh is used (if it exists)</span>
<span class="sd">        :param ibl_flip_yz: If you have an IBL data set, its 3D coordinates will be multiplied by -1</span>
<span class="sd">            on Y and Z axes in order to match Allen Brain Atlas volume and how it&#39;s stored by IBL.</span>
<span class="sd">        :return: objects.Points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ibl_flip_yz</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">noise_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_amount</span>
        <span class="n">link</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">add_to_scene</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trim_outliers</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">spheres</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_spheres</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color_map</span><span class="p">,</span>
                                    <span class="n">name</span><span class="p">,</span> <span class="n">use_origin</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">spheres</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="k">if</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounding_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span>
        <span class="k">if</span> <span class="n">trim_outliers</span> <span class="ow">and</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spheres</span><span class="o">.</span><span class="n">cutWithMesh</span><span class="p">(</span><span class="n">bounding_mesh</span><span class="p">)</span>
            <span class="n">spheres</span><span class="o">.</span><span class="n">mapper</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalarVisibility</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_to_scene</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spheres</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spheres</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_points"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_points">[docs]</a>    <span class="k">def</span> <span class="nf">add_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="s1">&#39;Accent&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Points&#39;</span><span class="p">,</span> <span class="n">screen_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">use_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noise_amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trim_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bounding_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">ibl_flip_yz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add new points</span>
<span class="sd">        :param positions: 3D array of coordinates</span>
<span class="sd">        :param radius: List same length as positions of radii. The default size is 5um, or 5 pixels</span>
<span class="sd">            in case as_spheres is False.</span>
<span class="sd">        :param values: 1D array of values, one per neuron or a time series of such 1D arrays (numpy format)</span>
<span class="sd">        :param color_map: A color map, it can be a color map built by IBLViewer or</span>
<span class="sd">            a color map name (see vedo documentation), or a list of values, etc.</span>
<span class="sd">        :param name: All point neurons are grouped into one object, you can give it a custom name</span>
<span class="sd">        :param screen_space: Type of point, if True then the points are static screen-space points.</span>
<span class="sd">            If False, then the points are made to scale in 3D, ie you see them larger when you</span>
<span class="sd">            zoom closer to them, while this is not the case with screen-space points. Defaults to False.</span>
<span class="sd">        :param use_origin: Whether the origin is added as offset to the given positions</span>
<span class="sd">        :param add_to_scene: Whether the new lines are added to scene/plot and rendered</span>
<span class="sd">        :param noise_amount: Amount of 3D random noise applied to each point. Defaults to 0</span>
<span class="sd">        :param trim_outliers: If bounding_mesh param is given, then the spheres will be trimmed,</span>
<span class="sd">            only the ones inside the bounding mesh will be kept</span>
<span class="sd">        :param bounding_mesh: A closed manifold surface mesh used for trimming segments. If None,</span>
<span class="sd">            the current self.bounding_mesh is used (if it exists)</span>
<span class="sd">        :param ibl_flip_yz: If you have an IBL data set, its 3D coordinates will be multiplied by -1</span>
<span class="sd">            on Y and Z axes in order to match Allen Brain Atlas volume and how it&#39;s stored by IBL.</span>
<span class="sd">        :return: objects.Points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ibl_flip_yz</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">noise_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_amount</span>
        <span class="n">link</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">add_to_scene</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trim_outliers</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">points</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color_map</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                    <span class="n">screen_space</span><span class="p">,</span> <span class="n">use_origin</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">points</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="k">if</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounding_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span>
        <span class="k">if</span> <span class="n">trim_outliers</span> <span class="ow">and</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points</span><span class="o">.</span><span class="n">cutWithMesh</span><span class="p">(</span><span class="n">bounding_mesh</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">mapper</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalarVisibility</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_to_scene</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">points</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_segments"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_segments">[docs]</a>    <span class="k">def</span> <span class="nf">add_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">end_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="s1">&#39;Accent&#39;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Segments&#39;</span><span class="p">,</span> <span class="n">use_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">relative_end_points</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">spherical_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trim_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bounding_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">ibl_flip_yz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a set of segments</span>
<span class="sd">        :param points: 3D numpy array of points of length n</span>
<span class="sd">        :param end_points: 3D numpy array of points of length n</span>
<span class="sd">        :param line_width: Line width, defaults to 2px</span>
<span class="sd">        :param values: 1D list of length n, for one scalar value per line</span>
<span class="sd">        :param color_map: A color map, it can be a color map built by IBLViewer or</span>
<span class="sd">            a color map name (see vedo documentation), or a list of values, etc.</span>
<span class="sd">        :param name: Name to give to the object</span>
<span class="sd">        :param use_origin: Whether the current origin (not necessarily absolute 0) is used as offset</span>
<span class="sd">        :param add_to_scene: Whether the new lines are added to scene/plot and rendered</span>
<span class="sd">        :param relative_end_points: Whether the given end point is relative to the start point. False by default,</span>
<span class="sd">            except is spherical coordinates are given</span>
<span class="sd">        :param spherical_angles: 3D numpy array of spherical angle data of length n</span>
<span class="sd">            In case end_points is None, this replaces end_points by finding the relative</span>
<span class="sd">            coordinate to each start point with the given radius/depth, theta and phi</span>
<span class="sd">        :param radians: Whether the given spherical angle data is in radians or in degrees</span>
<span class="sd">        :param trim_outliers: Whether segments are cropped by the bounding mesh</span>
<span class="sd">        :param bounding_mesh: A closed manifold surface mesh used for trimming segments. If None,</span>
<span class="sd">            the current self.bounding_mesh is used (if it exists)</span>
<span class="sd">        :param ibl_flip_yz: If you have an IBL data set, its 3D coordinates will be multiplied by -1</span>
<span class="sd">            on Y and Z axes in order to match Allen Brain Atlas volume and how it&#39;s stored by IBL.</span>
<span class="sd">        :return: objects.Lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ibl_flip_yz</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">*</span> <span class="n">axes</span>
            <span class="k">if</span> <span class="n">end_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">axes</span>
        <span class="n">pre_add</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">add_to_scene</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trim_outliers</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1">#lines = super().add_segments(points, end_points, line_width, values, color_map, name, use_origin,</span>
                                    <span class="c1">#pre_add, relative_end_points, spherical_angles, radians)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Crazy python stuff here [WARNING]</span>
<span class="sd">        If the above line with super() is called, then the scope of self within super() is this one,</span>
<span class="sd">        which is wrong. When we are in super, self should be the parent class.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Copy-paste from application.Viewer.add_segments, due to above reason</span>
        <span class="k">if</span> <span class="n">end_points</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spherical_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">relative_end_points</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">spherical_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spherical_angles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">radians</span><span class="p">:</span>
                <span class="n">end_points</span> <span class="o">=</span> <span class="n">spherical_angles</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vedo</span><span class="o">.</span><span class="n">spher2cart</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_points</span> <span class="o">=</span> <span class="n">spherical_angles</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">spherical_degree_angles_to_xyz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relative_end_points</span><span class="p">:</span>
                <span class="n">end_points</span> <span class="o">+=</span> <span class="n">points</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">points</span><span class="p">,</span> <span class="n">end_points</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">end_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_points</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_points</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[add_segments() error] Mismatch between start and end points length. Only </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> segments shown.&#39;</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">end_points</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_lines</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">line_width</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color_map</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">use_origin</span><span class="p">,</span> <span class="n">pre_add</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="k">if</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounding_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span>
        <span class="k">if</span> <span class="n">trim_outliers</span> <span class="ow">and</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">cutWithMesh</span><span class="p">(</span><span class="n">bounding_mesh</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">mapper</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalarVisibility</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_to_scene</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_lines"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_lines">[docs]</a>    <span class="k">def</span> <span class="nf">add_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="s1">&#39;Accent&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Lines&#39;</span><span class="p">,</span>
                <span class="n">use_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trim_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bounding_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibl_flip_yz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a set of lines with given point sets</span>
<span class="sd">        :param points: List of lists of 3D coordinates</span>
<span class="sd">        :param line_width: Line width, defaults to 2px</span>
<span class="sd">        :param values: 1D list of length n, for one scalar value per line</span>
<span class="sd">        :param color_map: A color map, it can be a color map built by IBLViewer or</span>
<span class="sd">            a color map name (see vedo documentation), or a list of values, etc.</span>
<span class="sd">        :param name: Name to give to the object</span>
<span class="sd">        :param use_origin: Whether the current origin (not necessarily absolute 0) is used as offset</span>
<span class="sd">        :param add_to_scene: Whether the new lines are added to scene/plot and rendered</span>
<span class="sd">        :param trim_outliers: Whether segments that are out of the brain envelope are trimmed or not. True by default</span>
<span class="sd">        :param bounding_mesh: A closed manifold surface mesh used for trimming lines. If None,</span>
<span class="sd">            the current self.bounding_mesh is used (if it exists)</span>
<span class="sd">        :param ibl_flip_yz: If you have an IBL data set, its 3D coordinates will be multiplied by -1</span>
<span class="sd">            on Y and Z axes in order to match Allen Brain Atlas volume and how it&#39;s stored by IBL.</span>
<span class="sd">        :return: objects.Lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ibl_flip_yz</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#target =  list(points.keys()) if isinstance(points, dict) else range(len(points))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            This part below is to handle the numpy error that does not allow a numpy array</span>
<span class="sd">            to contain lists with unequal lengths.</span>
<span class="sd">            -&gt; VisibleDeprecationWarning: Creating an ndarray from ragged nested sequences </span>
<span class="sd">            (which is a list-or-tuple of lists-or-tuples-or ndarrays with different </span>
<span class="sd">            lengths or shapes) is deprecated</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">all_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">line_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Possible speed improvement: use map or np.apply_along_axis</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
                <span class="n">point_set</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">point_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_set</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">point_set</span> <span class="o">=</span> <span class="n">point_set</span> <span class="o">*</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">use_origin</span><span class="p">:</span>
                    <span class="n">point_set</span> <span class="o">=</span> <span class="n">point_set</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">origin</span>
                <span class="n">all_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_set</span><span class="p">)</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_id</span><span class="p">)</span>
                <span class="n">line_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">all_points</span>
            <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">indices</span>

        <span class="n">pre_add</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">add_to_scene</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trim_outliers</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_lines</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">line_width</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color_map</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pre_add</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounding_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_mesh</span>
        <span class="k">if</span> <span class="n">trim_outliers</span> <span class="ow">and</span> <span class="n">bounding_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">cutWithMesh</span><span class="p">(</span><span class="n">bounding_mesh</span><span class="p">)</span>
            <span class="c1"># This is the sort of thing that kills me. I was loosing all scalar colors</span>
            <span class="c1"># and it took me a while to see it&#39;s because of vedo&#39;s cutWithMesh that disables</span>
            <span class="c1"># scalar visibility!</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">mapper</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalarVisibility</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_to_scene</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="MouseBrainViewer.add_volume"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.add_volume">[docs]</a>    <span class="k">def</span> <span class="nf">add_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                    <span class="n">alpha_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a volume to the viewer with box clipping and slicing enabled by default</span>
<span class="sd">        :param data: Volume image data or a file_path</span>
<span class="sd">        :param resolution: Resoluton of the volume</span>
<span class="sd">        :param file_path: File path of the volume. If you don&#39;t provide an image volume data,</span>
<span class="sd">            then the file_path will be used to load the volume data</span>
<span class="sd">        :param color_map: Color map for the volume</span>
<span class="sd">        :param alpha_map: Alpha map for the volume. If None, it will assume that 0 values</span>
<span class="sd">            are transparent and maximum values are opaque</span>
<span class="sd">        :param select: Whether the volume is selected</span>
<span class="sd">        :param add_to_scene: Whether the volume is added to scene</span>
<span class="sd">        :param transpose: Transposition parameter. If None. nothing happens. If True,</span>
<span class="sd">            then the default IBL transposition is applied. You can provide your own, that is,</span>
<span class="sd">            a list of 3 elements to reorder the volume as desired.</span>
<span class="sd">        :return: VolumeController</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transpose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">transpose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibl_transpose</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_volume</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">color_map</span><span class="p">,</span>
                                <span class="n">alpha_map</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">add_to_scene</span><span class="p">,</span> <span class="n">transpose</span><span class="p">)</span></div>

<div class="viewcode-block" id="MouseBrainViewer.set_left_view"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.set_left_view">[docs]</a>    <span class="k">def</span> <span class="nf">set_left_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set left sagittal view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_camera</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Z_DOWN</span><span class="p">)</span></div>

<div class="viewcode-block" id="MouseBrainViewer.set_right_view"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.set_right_view">[docs]</a>    <span class="k">def</span> <span class="nf">set_right_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set right sagittal view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_camera</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Z_DOWN</span><span class="p">)</span></div>

<div class="viewcode-block" id="MouseBrainViewer.set_anterior_view"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.set_anterior_view">[docs]</a>    <span class="k">def</span> <span class="nf">set_anterior_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set anterior coronal view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_camera</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Z_DOWN</span><span class="p">)</span></div>

<div class="viewcode-block" id="MouseBrainViewer.set_posterior_view"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.set_posterior_view">[docs]</a>    <span class="k">def</span> <span class="nf">set_posterior_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set posterior coronal view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_camera</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Z_DOWN</span><span class="p">)</span></div>

<div class="viewcode-block" id="MouseBrainViewer.set_dorsal_view"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.set_dorsal_view">[docs]</a>    <span class="k">def</span> <span class="nf">set_dorsal_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set dorsal axial view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_camera</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">X_UP</span><span class="p">)</span></div>

<div class="viewcode-block" id="MouseBrainViewer.set_ventral_view"><a class="viewcode-back" href="../../_autosummary/iblviewer.mouse_brain.html#iblviewer.mouse_brain.MouseBrainViewer.set_ventral_view">[docs]</a>    <span class="k">def</span> <span class="nf">set_ventral_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set ventral axial view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_camera</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">X_UP</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>