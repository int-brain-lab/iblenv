

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iblutil.io.net.app &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/style.css?v=17142d56" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_repro_ephys.html">Data Release - Reproducible Ephys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_download.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/docs_wheel_screen_stimulus.html">Computing the stimulus position using the wheel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">iblutil.io.net.app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for iblutil.io.net.app</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Examples</span>
<span class="sd">--------</span>

<span class="sd"># Connect to remote server rig, send initialization message and wait for response</span>
<span class="sd">&gt;&gt;&gt; server = await EchoProtocol.server(&#39;udp://192.168.0.4&#39;, name=&#39;main&#39;)</span>
<span class="sd">&gt;&gt;&gt; await server.init(&#39;2022-01-01_1_subject&#39;)  # Send init message and await confirmation of receipt</span>
<span class="sd">&gt;&gt;&gt; response = await server.on_event(&#39;INIT&#39;)  # Await response</span>

<span class="sd"># Send initialization message and wait max 10 seconds for response</span>
<span class="sd">&gt;&gt;&gt; try:</span>
<span class="sd">...     response = await asyncio.wait_for(server.on_event(&#39;INIT&#39;), 10.)</span>
<span class="sd">... except asyncio.TimeoutError:</span>
<span class="sd">...     server.close()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">MappingProxyType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">colorlog</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">iblutil.io.net</span><span class="w"> </span><span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iblutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_setup_log</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A colour log with the log name in the format string&quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fmt_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(log_color)s%(asctime)s</span><span class="s1"> [</span><span class="si">%(name)s</span><span class="s1">] </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)-4d</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    <span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
        <span class="n">colorlog</span><span class="o">.</span><span class="n">ColoredFormatter</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">LOG_DATE_FORMAT</span><span class="p">,</span> <span class="n">log_colors</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">LOG_COLORS</span><span class="p">))</span>
    <span class="n">stream_handler</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_auto&#39;</span>
    <span class="n">stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stream_handler</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_address2tuple</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert URI to (host, port) tuple.</span>

<span class="sd">    Convert URI to form used by transport layer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    address : str</span>
<span class="sd">        A URI from which to extract the port and hostname.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The hostname.</span>
<span class="sd">    int</span>
<span class="sd">        The port.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">server_uri</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">validate_uri</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">LISTEN_PORT</span><span class="p">)</span>
    <span class="n">parsed_uri</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">server_uri</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_uri</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">parsed_uri</span><span class="o">.</span><span class="n">port</span>


<div class="viewcode-block" id="EchoProtocol">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EchoProtocol</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Communicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An echo server implementing TCP/IP and UDP.</span>

<span class="sd">    This should be instantiated using either EchoProtocol.server or EchoProtocol.client.</span>
<span class="sd">    In the client role, the remote address is specified; in the server role, the local address is</span>
<span class="sd">    specified.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    Server : asyncio.Server</span>
<span class="sd">        A network server instance if using TCP/IP.</span>
<span class="sd">    role : {&#39;client&#39;, &#39;server&#39;}</span>
<span class="sd">        The communicator role.  A server may communicate with multiple clients. The server URI</span>
<span class="sd">        specifies its local address.  A client only communicates with a single host, specified by</span>
<span class="sd">        the server URI.</span>
<span class="sd">    default_echo_timeout : float</span>
<span class="sd">        The default maximum time in seconds to await a message echo.</span>
<span class="sd">    _last_sent : dict[(str, int), (bytes, asyncio.Future)]</span>
<span class="sd">        A map of addresses holding the last sent bytes str and the future being waited on.  In</span>
<span class="sd">        client mode there should only be one entry - the server URI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_role</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">default_echo_timeout</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_uri</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="c1"># For validating echo&#39;d response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Transport specific futures</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_lost</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error_received</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_eof_received</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">role</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;{&#39;client&#39;, &#39;server&#39;}: The remote computer&#39;s role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span>

    <span class="nd">@role</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set remote computer role.</span>

<span class="sd">        Ensures the role is only set once.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : {&#39;client&#39;, &#39;server&#39;}</span>
<span class="sd">            The role to set.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            The role has already been set and cannot be changed.</span>
<span class="sd">        ValueError</span>
<span class="sd">            The role must be one of {&#39;client&#39;, &#39;server&#39;}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;can</span><span class="se">\&#39;</span><span class="s1">t set attribute&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;role must be either &quot;server&quot; or &quot;client&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bool: True if transport layer set and open.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">is_closing</span><span class="p">()</span>

<div class="viewcode-block" id="EchoProtocol.awaiting_response">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.awaiting_response">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">awaiting_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bool: True if awaiting confirmation of receipt from remote.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">addr</span><span class="p">:</span>
            <span class="n">last_sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">last_sent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_sent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="EchoProtocol.cleanup">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.cleanup">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup experiment.</span>

<span class="sd">        Send a cleanup message to the remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.start">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_ref</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start an experiment.</span>

<span class="sd">        Send a stop message to the remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exp_ref : str</span>
<span class="sd">            A experiment reference string in the form yyyy-mm-dd_n_subject.</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">exp_ref</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.stop">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.stop">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End an experiment.</span>

<span class="sd">        Send a stop message to the remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        immediately : bool</span>
<span class="sd">            If True, an EXPINTERRUPT signal is used.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">immediately</span><span class="o">=</span><span class="n">immediately</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.status">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.status">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Communicate experiment status.</span>

<span class="sd">        Send a status message to the remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : iblutil.net.base.ExpStatus</span>
<span class="sd">            An experiment status enumeration.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.info">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.info">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Communicate experiment information.</span>

<span class="sd">        Send experiment status and details to the remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : iblutil.net.base.ExpStatus</span>
<span class="sd">            An experiment status enumeration.</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.init">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.init">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an experiment.</span>

<span class="sd">        Send an initialization message to the remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.alyx">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.alyx">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">alyx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alyx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send/request Alyx token to/from remote host.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alyx : one.webclient.AlyxClient</span>
<span class="sd">            An instance of Alyx to extract and send token from.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">        The remote host address and port. Only required in server role.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (str, dict) or None</span>
<span class="sd">            (If alyx arg was None or not authenticated) the received Alyx token in the form (base_url, {user: token}).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">alyx</span><span class="p">(</span><span class="n">alyx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>  <span class="c1"># send instance to remote host</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># request instance from remote host</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
            <span class="n">fut</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assign_callback</span><span class="p">(</span><span class="s1">&#39;ALYX&#39;</span><span class="p">,</span> <span class="n">fut</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed_send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fut</span>
            <span class="k">return</span> <span class="n">token</span></div>


<div class="viewcode-block" id="EchoProtocol.encode">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.encode">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize data for transmission&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>


<div class="viewcode-block" id="EchoProtocol.send">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.send">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send data to clients.</span>

<span class="sd">        Serialize data and pass to transport layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s1">&#39;udp&#39;</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Send &quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&quot; to udp://</span><span class="si">{</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">addr</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">getpeername</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message not sent: unexpected address </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Send &quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&quot; to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">))</span></div>

            <span class="c1"># self._transport.write_eof()</span>

<div class="viewcode-block" id="EchoProtocol.confirmed_send">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.confirmed_send">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirmed_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message to the client and await echo.</span>

<span class="sd">        NB: Methods such as start, stop, init, cleanup and alyx should be used instead of calling</span>
<span class="sd">        this directly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            The data to serialize and send to remote host.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The remote host address and port. Only required in server role.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            The time in seconds to wait for an echo before raising an exception.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            The response from the client did not match the original message.</span>
<span class="sd">        ValueError</span>
<span class="sd">            Timeout must be non-zero number.</span>
<span class="sd">            Unexpected remote address: in client mode the address must match server_uri.</span>
<span class="sd">        TypeError</span>
<span class="sd">            In server mode a remote address must be provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;server&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;confirmed_send missing 1 required argument: </span><span class="se">\&#39;</span><span class="s1">addr</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">addr</span> <span class="ow">and</span> <span class="n">addr</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected remote address&#39;</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">:=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_echo_timeout</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Timeout must be non-zero number&#39;</span><span class="p">)</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="n">echo_future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
        <span class="c1"># echo_future.add_done_callback(lambda _: self._last_sent.pop(addr))  # delete below instead (no difference)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">echo_future</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="c1"># Sockets can no longer be blocking, so we&#39;ll wait ourselves.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">echo_future</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to receive client response in time (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_uri</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected response from server&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span></div>


<div class="viewcode-block" id="EchoProtocol.close">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the connection, de-register callbacks and cancel outstanding futures.</span>

<span class="sd">        The EchoProtocol.on_connection_lost future is resolved at this time, all others are</span>
<span class="sd">        cancelled.  NB: Closing the socket should be handled by transport base class later on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close transport</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Deregister callbacks, cancel event futures</span>
        <span class="n">echo_futures</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">done</span><span class="p">(),</span> <span class="n">echo_futures</span><span class="p">):</span>
            <span class="n">fut</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="s1">&#39;Close called on communicator&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_error_received</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_error_received</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_error_received</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="s1">&#39;Close called on communicator&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_eof_received</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_eof_received</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_eof_received</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="s1">&#39;Close called on communicator&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_lost</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_lost</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_lost</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="s1">&#39;Close called on communicator&#39;</span><span class="p">)</span></div>


    <span class="c1"># The following methods are inherited from asyncio.DatagramProtocol and called by the event loop</span>

<div class="viewcode-block" id="EchoProtocol.connection_made">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.connection_made">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called by event loop&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="n">transport</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s1">&#39;socket&#39;</span><span class="p">)</span>

        <span class="c1"># Validate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="s1">&#39;udp&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unsupported transport layer for UDP&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">,</span> <span class="s1">&#39;wss&#39;</span><span class="p">,</span> <span class="s1">&#39;tcp&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unsupported transport layer for TCP/IP&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported transport layer with socket type &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected with socket </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process data received from remote host.  This is called by different lower level methods</span>
<span class="sd">        depending on the transport layer.  This method handles the message echo logic, while the</span>
<span class="sd">        base class method handles message callbacks exclusively.</span>

<span class="sd">        If awaiting an echo, the timeout is cancelled and the message is checked against the one</span>
<span class="sd">        sent.  Otherwise, the message is immediately echo&#39;d and the super class method is called to</span>
<span class="sd">        notify any listeners.</span>

<span class="sd">        This method should not be called by the user.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : bytes</span>
<span class="sd">            The serialized data received by the transport layer.</span>
<span class="sd">        addr : (str, int)</span>
<span class="sd">            The source address as (hostname, port)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Callbacks apply only to new messages, not echo responses.  EchoProtocol.confirmed_send</span>
<span class="sd">        should be awaited, however it is possible to assign a callback for receipt of an echo with</span>
<span class="sd">        EchoProtocol._last_sent[addr][1].add_done_callback.</span>
<span class="sd">        - Currently this only checks the received message, not its origin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="c1"># If we&#39;re still awaiting echo from this address, process here. NB: sometimes the echo_future is already set</span>
        <span class="c1"># but not yet removed from last sent, so we also check future not successfully finished.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">last_sent</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">is_success</span><span class="p">(</span><span class="n">last_sent</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">expected</span><span class="p">,</span> <span class="n">echo_future</span> <span class="o">=</span> <span class="n">last_sent</span>
            <span class="c1"># If echo doesn&#39;t match, raise exception</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Expected </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">, got </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">echo_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">echo_future</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>  <span class="c1"># Notify callbacks of receipt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Confirmation received&#39;</span><span class="p">)</span>
                <span class="n">echo_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Received </span><span class="si">%r</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="c1"># Update from remote</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>  <span class="c1"># do not echo 0 code messages; these are low-level errors</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Echo </span><span class="si">%r</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>  <span class="c1"># Echo</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_receive</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>  <span class="c1"># Process callbacks</span>

<div class="viewcode-block" id="EchoProtocol.datagram_received">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.datagram_received">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">datagram_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called by UDP transport layer&quot;&quot;&quot;</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;client&#39;</span> <span class="ow">and</span> <span class="n">host</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Ignoring UDP packet from unexpected host (</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">) with message &quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_receive</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.data_received">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.data_received">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called by TCP/IP transport layer&quot;&quot;&quot;</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s1">&#39;peername&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receive</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.error_received">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.error_received">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">error_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error received: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error_received</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.eof_received">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.eof_received">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">eof_received</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;EOF received&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_eof_received</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="EchoProtocol.connection_lost">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.connection_lost">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connection_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Connection closed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;on_con_lost&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_lost</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span></div>


    <span class="c1"># Factory methods for instantiating a server or client</span>

<div class="viewcode-block" id="EchoProtocol.server">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.server">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">server</span><span class="p">(</span><span class="n">server_uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;EchoProtocol&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a remote server instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        server_uri : str, ipaddress.IPv4Address, ipaddress.IPv6Address</span>
<span class="sd">            The address of the remote computer, may be an IP or hostname with or without a port.</span>
<span class="sd">            To use TCP/IP instead of the default UDP, add a &#39;ws://&#39; scheme to the URI.</span>
<span class="sd">        name : str</span>
<span class="sd">            An optional, arbitrary label.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional parameters to pass to create_datagram_endpoint for UDP or create_server for</span>
<span class="sd">            TCP/IP.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EchoProtocol</span>
<span class="sd">            A Communicator instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate server URI</span>
        <span class="n">server_uri</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">validate_uri</span><span class="p">(</span><span class="n">server_uri</span><span class="p">)</span>

        <span class="c1"># Get a reference to the event loop</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>

        <span class="c1"># Logging</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">log</span> <span class="ow">or</span> <span class="n">_setup_log</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="n">server_uri</span><span class="p">)</span>

        <span class="c1"># One protocol instance will be created to serve all client requests.</span>
        <span class="k">if</span> <span class="n">server_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;udp&#39;</span><span class="p">):</span>
            <span class="n">Protocol</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EchoProtocol</span><span class="p">,</span> <span class="n">server_uri</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_datagram_endpoint</span><span class="p">(</span><span class="n">Protocol</span><span class="p">,</span> <span class="n">local_addr</span><span class="o">=</span><span class="n">_address2tuple</span><span class="p">(</span><span class="n">server_uri</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">EchoProtocol</span><span class="p">(</span><span class="n">server_uri</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
            <span class="n">protocol</span><span class="o">.</span><span class="n">Server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">protocol</span><span class="p">,</span> <span class="o">*</span><span class="n">_address2tuple</span><span class="p">(</span><span class="n">server_uri</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">protocol</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Listening on </span><span class="si">{</span><span class="n">protocol</span><span class="o">.</span><span class="n">server_uri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">protocol</span></div>


<div class="viewcode-block" id="EchoProtocol.client">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.EchoProtocol.client">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">server_uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;EchoProtocol&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a remote client instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        server_uri : str</span>
<span class="sd">            The address of the remote computer, may be an IP or hostname with or without a port.</span>
<span class="sd">            To use TCP/IP instead of the default UDP, add a &#39;ws://&#39; scheme to the URI.</span>
<span class="sd">        name : str</span>
<span class="sd">            An optional, arbitrary label.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional parameters to pass to create_datagram_endpoint for UDP or create_server for</span>
<span class="sd">            TCP/IP.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EchoProtocol</span>
<span class="sd">            A Communicator instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate server URI</span>
        <span class="n">server_uri</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">validate_uri</span><span class="p">(</span><span class="n">server_uri</span><span class="p">)</span>

        <span class="c1"># Get a reference to the event loop</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>

        <span class="c1"># Logging</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">log</span> <span class="ow">or</span> <span class="n">_setup_log</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="n">server_uri</span><span class="p">)</span>

        <span class="n">Protocol</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EchoProtocol</span><span class="p">,</span> <span class="n">server_uri</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">server_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;udp&#39;</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_datagram_endpoint</span><span class="p">(</span><span class="n">Protocol</span><span class="p">,</span> <span class="n">remote_addr</span><span class="o">=</span><span class="n">_address2tuple</span><span class="p">(</span><span class="n">server_uri</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">Protocol</span><span class="p">,</span> <span class="o">*</span><span class="n">_address2tuple</span><span class="p">(</span><span class="n">server_uri</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">protocol</span></div>
</div>



<div class="viewcode-block" id="Services">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Services</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Service</span><span class="p">,</span> <span class="n">UserDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for multiple remote rig services.&quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_rigs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">10.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handler for multiple remote rig services.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote_rigs : list(iblutil.io.net.base.Service)</span>
<span class="sd">            A list of remote rig service objects.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            How long to wait for response from client(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store rig communicators by name</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remote_rigs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Remote services must be of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">MappingProxyType</span><span class="p">({</span><span class="n">rig</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">rig</span> <span class="k">for</span> <span class="n">rig</span> <span class="ow">in</span> <span class="n">remote_rigs</span><span class="p">})</span>  <span class="c1"># Ensure immutable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bool: All services are connected.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rig</span><span class="p">:</span> <span class="n">rig</span><span class="o">.</span><span class="n">is_connected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

<div class="viewcode-block" id="Services.assign_callback">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.assign_callback">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">return_service</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a callback to all services for a given event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event : str, int, iblutil.io.net.base.ExpMessage</span>
<span class="sd">            An event to listen for.</span>
<span class="sd">        callback : function, async.io.Future</span>
<span class="sd">            A callable or future to notify when the event occurs.</span>
<span class="sd">        return_service : bool</span>
<span class="sd">            When True an instance of the Communicator is additionally passed to the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_callback</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">return_service</span><span class="p">:</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_callback</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>
                <span class="c1"># keep track of original callback id</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hash</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
                <span class="n">service</span><span class="o">.</span><span class="n">assign_callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">service</span><span class="o">.</span><span class="n">assign_callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="Services.clear_callbacks">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.clear_callbacks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear all callbacks for a given event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event : str, int, iblutil.io.net.base.ExpMessage</span>
<span class="sd">            The event to clear listeners from.</span>
<span class="sd">        callback : function, asyncio.Future</span>
<span class="sd">            A specific callback or future to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">removed</span><span class="p">[</span><span class="n">rig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rig</span><span class="o">.</span><span class="n">clear_callbacks</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">removed</span></div>


<div class="viewcode-block" id="Services.await_all">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.await_all">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">await_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for all services to report a given event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event : str, int, iblutil.io.net.base.ExpMessage</span>
<span class="sd">            The event to wait on.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A map of rig name and the data that was received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_return_data</span><span class="p">(</span><span class="n">rig</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return map of rig name and data so we know origin of data&quot;&quot;&quot;</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span>
            <span class="n">responses</span><span class="p">[</span><span class="n">rig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_return_data</span><span class="p">(</span><span class="n">rig</span><span class="p">,</span> <span class="n">rig</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">)))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>  <span class="c1"># py3.11 with asyncio.timeout context manager</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
                <span class="n">tasks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ALL_COMPLETED</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pending</span><span class="p">):</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The following services failed to respond in time: </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">responses</span></div>


<div class="viewcode-block" id="Services.close">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close all communication.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">rig</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Services.init">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.init">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an experiment.</span>

<span class="sd">        Send an initialization signal to the remote services and await the responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        concurrent : bool</span>
<span class="sd">            If false, wait for response from each service before communicating with the next.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">            Remote host failed to respond within response period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="p">[</span><span class="s1">&#39;EXPINIT&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="n">concurrent</span><span class="p">)</span></div>


<div class="viewcode-block" id="Services.cleanup">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.cleanup">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup an experiment.</span>

<span class="sd">        Send a cleanup signal to the remote services and await responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        concurrent : bool</span>
<span class="sd">            If false, wait for response from each service before communicating with the next.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">            Remote host failed to respond within response period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">EXPCLEANUP</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="n">concurrent</span><span class="p">)</span></div>


<div class="viewcode-block" id="Services.start">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_ref</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start an experiment.</span>

<span class="sd">        Send a start signal to the remote services and await responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exp_ref : str</span>
<span class="sd">            An experiment reference string in the form yyyy-mm-dd_n_subject.</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        concurrent : bool</span>
<span class="sd">            If false, wait for response from each service before communicating with the next.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">            Remote host failed to respond within response period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">EXPSTART</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">exp_ref</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="n">concurrent</span><span class="p">)</span></div>


<div class="viewcode-block" id="Services.stop">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.stop">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End an experiment.</span>

<span class="sd">        Send a stop signal to the remote services and await responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>
<span class="sd">        immediately : bool</span>
<span class="sd">            If true, send an EXPINTERRUPT signal.</span>
<span class="sd">        concurrent : bool</span>
<span class="sd">            If false, wait for response from each service before communicating with the next.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">            Remote host failed to respond within response period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">EXPEND</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">immediately</span><span class="o">=</span><span class="n">immediately</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Services.status">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.status">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Communicate experiment status.</span>

<span class="sd">        Send a status message to the remote services and await responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : iblutil.net.base.ExpStatus</span>
<span class="sd">            An experiment status enumeration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">            Remote host failed to respond within response period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">EXPSTATUS</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Services.info">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.info">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Report experiment information.</span>

<span class="sd">        Send a status message and other details to the remote services and await responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : iblutil.net.base.ExpStatus</span>
<span class="sd">            An experiment status enumeration.</span>
<span class="sd">        data : any</span>
<span class="sd">            Optional extra data to send to the remote host.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Remote host failed to echo the message within the timeout period.</span>
<span class="sd">            Remote host failed to respond within response period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">EXPINFO</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send an event signal to the remote services and await responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event : iblutil.io.net.base.ExpMessage</span>
<span class="sd">            The event to signal to services.</span>
<span class="sd">        method : str</span>
<span class="sd">            The name of the method to call for each service.</span>
<span class="sd">        args</span>
<span class="sd">            Positional arguments to pass to method.</span>
<span class="sd">        concurrent : bool</span>
<span class="sd">            If true, all services are signaled concurrently.</span>
<span class="sd">        reverse : bool</span>
<span class="sd">            If true, iterate over services in reverse order.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Keyword arguments to pass to method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of str</span>
<span class="sd">            A dictionary of service names and the response data received.</span>

<span class="sd">        TODO Could initialize response dict created in await_all and allow it to be returned</span>
<span class="sd">         this would allow one to peek at responses before all are in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">allow_bitwise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">concurrent</span><span class="p">:</span>
            <span class="c1"># Register event callbacks before sending messages otherwise we may receive a response before callback is</span>
            <span class="c1"># created.</span>
            <span class="n">all_responses</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">await_all</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;service responses&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">await</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">all_responses</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">await</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="n">responses</span><span class="p">[</span><span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">responses</span>

<div class="viewcode-block" id="Services.alyx">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.Services.alyx">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">alyx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alyx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send Alyx token to remote services.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alyx : one.webclient.AlyxClient</span>
<span class="sd">            An instance of Alyx to extract and send token from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">alyx</span><span class="p">(</span><span class="n">alyx</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../../_autosummary/iblutil.io.net.app.html#iblutil.io.net.app.main">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">server_uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An example of an entry point for creating an individual communicator.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;server&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting server&#39;</span><span class="p">)</span>
        <span class="n">com</span> <span class="o">=</span> <span class="k">await</span> <span class="n">EchoProtocol</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">server_uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">com</span><span class="o">.</span><span class="n">server_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;udp&#39;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># Serve for 1 hour.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">com</span><span class="o">.</span><span class="n">Server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;client&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting client&#39;</span><span class="p">)</span>
        <span class="n">com</span> <span class="o">=</span> <span class="k">await</span> <span class="n">EchoProtocol</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">server_uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Here you would send a message</span>
            <span class="k">await</span> <span class="n">com</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;2022-01-01_1_subject&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown role &quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    # Run server</span>
<span class="sd">    python udp.py server</span>

<span class="sd">    # Run server locally for debugging</span>
<span class="sd">    python udp.py server -H localhost</span>

<span class="sd">    # Run client for debugging</span>
<span class="sd">    python udp.py client</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse parameters</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;UDP Experiment Communicator.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;communicator role i.e. server or client&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--host&#39;</span><span class="p">,</span> <span class="s1">&#39;-H&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the host address&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">hostname2ip</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>  <span class="c1"># returns data from the options specified</span>

    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">))</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>