

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibllib.oneibl.data_handlers &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/style.css?v=17142d56" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/public_introduction.html">Publicly Available IBL Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/dataset_overview.html">What is available for download ?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Datasets - Collaboration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/2025_data_release_brainwidemap.html">2025 - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/2024_data_release_repro_ephys.html">2024 - Reproducible Ephys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/2021_data_release_behavior.html">2021 - Behavior</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Datasets - Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/2025_data_release_autism_noel.html">2025 - Autism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/2025_data_release_autism_davatolhagh.html">2025 - Autism Widefield</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/2022_data_release_spikesorting_benchmarks.html">2022 - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../02_installation.html">Installation of IBL Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_download.html">Setting up credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../09_contribution.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/information_contact.html">Getting Help: Information and Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/docs_wheel_screen_stimulus.html">Computing the stimulus position using the wheel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ibllib.oneibl.data_handlers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibllib.oneibl.data_handlers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Downloading of task dependent datasets and registration of task output datasets.</span>

<span class="sd">The DataHandler class is used by the pipes.tasks.Task class to ensure dependent datasets are</span>
<span class="sd">present and to register and upload the output datasets.  For examples on how to run a task using</span>
<span class="sd">specific data handlers, see :func:`ibllib.pipes.tasks`.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PurePosixPath</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">one.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ONE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.webclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">AlyxClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">filter_datasets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.alf.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_uuid_string</span><span class="p">,</span> <span class="n">get_alf_path</span><span class="p">,</span> <span class="n">ensure_alf_path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.alf.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">_make_datasets_df</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iblutil.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">ensure_list</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ibllib.oneibl.registration</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_dataset</span><span class="p">,</span> <span class="n">get_lab</span><span class="p">,</span> <span class="n">get_local_data_repository</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ibllib.oneibl.patcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">FTPPatcher</span><span class="p">,</span> <span class="n">SDSCPatcher</span><span class="p">,</span> <span class="n">SDSC_ROOT_PATH</span><span class="p">,</span> <span class="n">SDSC_PATCH_PATH</span><span class="p">,</span> <span class="n">S3Patcher</span>


<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ExpectedDataset">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ExpectedDataset">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExpectedDataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An expected input or output dataset.&quot;&quot;&quot;</span>
    <span class="n">inverted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An expected input or output dataset.</span>

<span class="sd">        NB: This should not be instantiated directly, but rather via the `input` or `output`</span>
<span class="sd">        static method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, None</span>
<span class="sd">            A dataset name or glob pattern.</span>
<span class="sd">        collection : str, None</span>
<span class="sd">            An ALF collection or pattern.</span>
<span class="sd">        register : bool</span>
<span class="sd">            Whether to register the file. Default is False for input files, True for output</span>
<span class="sd">            files.</span>
<span class="sd">        revision : str</span>
<span class="sd">            An optional revision.</span>
<span class="sd">        unique : bool</span>
<span class="sd">            Whether identifier pattern is expected to match a single dataset or several.  NB: This currently does not</span>
<span class="sd">            affect the output of `find_files`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">collection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span> <span class="o">=</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="n">register</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bool: whether to register the output file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span>

    <span class="nd">@register</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bool: whether to register the output file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;cannot set register attribute for operator datasets&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;tuple: the identifying parts of the dataset.</span>

<span class="sd">        If no operator is applied, the identifiers are (collection, revision, name).</span>
<span class="sd">        If an operator is applied, a tuple of 3-element tuples is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span>
        <span class="c1"># Flatten nested identifiers into tuple of 3-element tuples</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">:</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">extend</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">operator</span> <span class="k">else</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span>
            <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">glob_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str, tuple of str: one or more glob patterns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="o">*</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">glob_pattern</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represent the dataset object as a string.</span>

<span class="sd">        If the `name` property is not None, it is returned, otherwise the identifies are used to</span>
<span class="sd">        format the name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">)&gt;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">:</span>
            <span class="n">sym</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;or&#39;</span><span class="p">:</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;xor&#39;</span><span class="p">:</span> <span class="s1">&#39;^&#39;</span><span class="p">}</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">]</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sym</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">]</span><span class="si">:</span><span class="s1">^3</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverted</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;~(</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;~&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverted</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_pattern</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1">)&gt;&#39;</span>

<div class="viewcode-block" id="ExpectedDataset.find_files">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ExpectedDataset.find_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find files on disk.</span>

<span class="sd">        Uses glob patterns to find dataset(s) on disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        session_path : pathlib.Path, str</span>
<span class="sd">            A session path within which to glob for the dataset(s).</span>
<span class="sd">        register : bool</span>
<span class="sd">            Only return files intended to be registered.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the dataset is found on disk or is optional.</span>
<span class="sd">        list of pathlib.Path</span>
<span class="sd">            A list of matching dataset files.</span>
<span class="sd">        missing, None, str, set of str</span>
<span class="sd">            One or more glob patterns that either didn&#39;t yield files (or did in the case of inverted datasets).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Currently if `unique` is true and multiple files are found, all files are returned without an exception raised</span>
<span class="sd">          although this may change in the future.</span>
<span class="sd">        - If `register` is false, all files are returned regardless of whether they are intended to be registered.</span>
<span class="sd">        - If `register` is true, an input with register=True may not be returned if part of an OR operation.</span>
<span class="sd">        - If `inverted` is true, and files are found, the glob pattern is returned as missing.</span>
<span class="sd">        - If XOR, returns all patterns if all are present when only one should be, otherwise returns all missing</span>
<span class="sd">          patterns.</span>
<span class="sd">        - Missing (or unexpectedly found) patterns are returned despite the dataset being optional.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">actual_files</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">register</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">actual_files</span><span class="p">,</span> <span class="n">missing</span>
            <span class="n">actual_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">session_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glob_pattern</span><span class="p">))</span>
            <span class="c1"># If no revision pattern provided and no files found, search for any revision</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">actual_files</span><span class="p">):</span>
                <span class="n">glob_pattern</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;#*#&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">actual_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">session_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">glob_pattern</span><span class="p">))</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">actual_files</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_pattern</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">_ok</span><span class="p">,</span> <span class="n">_actual_files</span><span class="p">,</span> <span class="n">_missing</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="n">register</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">))</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">_ok</span><span class="p">)</span>
            <span class="n">actual_files</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">_actual_files</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">flatten</span><span class="p">(</span><span class="n">_missing</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">:</span>
                <span class="n">ok</span><span class="p">,</span> <span class="n">actual_files</span><span class="p">,</span> <span class="n">_missing</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="n">register</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_missing</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_missing</span><span class="p">,</span> <span class="nb">set</span><span class="p">)</span> <span class="k">else</span> <span class="n">missing</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_missing</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;xor&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">_ok</span><span class="p">,</span> <span class="n">_actual_files</span><span class="p">,</span> <span class="n">_missing</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="n">register</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">))</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_ok</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># and sum(map(bool, map(len, _actual_files))) == 1</span>
            <span class="c1"># Return only those datasets that are complete if OK</span>
            <span class="n">actual_files</span> <span class="o">=</span> <span class="n">_actual_files</span><span class="p">[</span><span class="n">_ok</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">flatten</span><span class="p">(</span><span class="n">_actual_files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">_ok</span><span class="p">):</span>  <span class="c1"># return all patterns if all present when only one should be, otherwise return all missing</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glob_pattern</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">_ok</span><span class="p">):</span>  <span class="c1"># return all missing glob patterns if none present</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">flatten</span><span class="p">(</span><span class="n">_missing</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized operator type &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;logical </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> not implemented&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span><span class="p">,</span> <span class="n">actual_files</span><span class="p">,</span> <span class="n">missing</span></div>


<div class="viewcode-block" id="ExpectedDataset.filter">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ExpectedDataset.filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter dataset frame by expected datasets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        session_datasets : pandas.DataFrame</span>
<span class="sd">            A data frame of session datasets.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Extra arguments for `one.util.filter_datasets`, namely revision_last_before, qc, and</span>
<span class="sd">            ignore_qc_not_set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the required dataset(s) are present in the data frame.</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A filtered data frame of containing the expected dataset(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ok, datasets = False, session_datasets.iloc[0:0]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">collection</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;revisions not yet supported&#39;</span><span class="p">)</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">session_datasets</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">wildcards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">empty</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverted</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">:</span>
                <span class="n">ok</span><span class="p">,</span> <span class="n">datasets</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">session_datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;xor&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">_ok</span><span class="p">,</span> <span class="n">_datasets</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">session_datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">))</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_ok</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="c1"># Return only those datasets that are complete.</span>
                <span class="n">datasets</span> <span class="o">=</span> <span class="n">_datasets</span><span class="p">[</span><span class="n">_ok</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datasets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">_datasets</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">_ok</span><span class="p">,</span> <span class="n">_datasets</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">session_datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">))</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">_ok</span><span class="p">)</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">_datasets</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized operator type &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;logical </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> not implemented&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span><span class="p">,</span> <span class="n">datasets</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply an operation between two datasets.&quot;&quot;&quot;</span>
        <span class="c1"># Assert both instances of Input or both instances of Output</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;logical operations not supported between objects of type &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Assert operation supported</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="s1">&#39;xor&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="c1"># Convert tuple to ExpectDataset instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Input</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="o">*</span><span class="n">other</span><span class="p">)</span>
        <span class="c1"># Returned instance should only be optional if both datasets are optional</span>
        <span class="n">is_input</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Input</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OptionalDataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)):</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">OptionalInput</span> <span class="k">if</span> <span class="n">is_input</span> <span class="k">else</span> <span class="n">OptionalOutput</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">Input</span> <span class="k">if</span> <span class="n">is_input</span> <span class="k">else</span> <span class="n">Output</span>
        <span class="c1"># Instantiate &#39;empty&#39; object</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">_identifiers</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">op</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert dataset doesn&#39;t exist on disk.&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">inverted</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverted</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert either dataset exists or another does, or both exist.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_op</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert either dataset exists or another does, not both.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_op</span><span class="p">(</span><span class="s1">&#39;xor&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert that a second dataset exists together with the first.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_op</span><span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<div class="viewcode-block" id="ExpectedDataset.input">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ExpectedDataset.input">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">input</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an expected input dataset.</span>

<span class="sd">        By default, expected input datasets are not automatically registered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            A dataset name or glob pattern.</span>
<span class="sd">        collection : str, None</span>
<span class="sd">            An ALF collection or pattern.</span>
<span class="sd">        required : bool</span>
<span class="sd">            Whether file must always be present, or is an optional dataset. Default is True.</span>
<span class="sd">        register : bool</span>
<span class="sd">            Whether to register the input file. Default is False for input files, True for output</span>
<span class="sd">            files.</span>
<span class="sd">        revision : str</span>
<span class="sd">            An optional revision.</span>
<span class="sd">        unique : bool</span>
<span class="sd">            Whether identifier pattern is expected to match a single dataset or several.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Input, OptionalInput</span>
<span class="sd">            An instance of an Input dataset if required is true, otherwise an OptionalInput.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Class</span> <span class="o">=</span> <span class="n">Input</span> <span class="k">if</span> <span class="n">required</span> <span class="k">else</span> <span class="n">OptionalInput</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="n">register</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="ExpectedDataset.output">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ExpectedDataset.output">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an expected output dataset.</span>

<span class="sd">        By default, expected output datasets are automatically registered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            A dataset name or glob pattern.</span>
<span class="sd">        collection : str, None</span>
<span class="sd">            An ALF collection or pattern.</span>
<span class="sd">        required : bool</span>
<span class="sd">            Whether file must always be present, or is an optional dataset. Default is True.</span>
<span class="sd">        register : bool</span>
<span class="sd">            Whether to register the output file. Default is False for input files, True for output</span>
<span class="sd">            files.</span>
<span class="sd">        revision : str</span>
<span class="sd">            An optional revision.</span>
<span class="sd">        unique : bool</span>
<span class="sd">            Whether identifier pattern is expected to match a single dataset or several.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Output, OptionalOutput</span>
<span class="sd">            An instance of an Output dataset if required is true, otherwise an OptionalOutput.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Class</span> <span class="o">=</span> <span class="n">Output</span> <span class="k">if</span> <span class="n">required</span> <span class="k">else</span> <span class="n">OptionalOutput</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="n">register</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>
</div>



<div class="viewcode-block" id="OptionalDataset">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.OptionalDataset">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OptionalDataset</span><span class="p">(</span><span class="n">ExpectedDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An expected dataset that is not strictly required.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OptionalDataset.find_files">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.OptionalDataset.find_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find files on disk.</span>

<span class="sd">        Uses glob patterns to find dataset(s) on disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        session_path : pathlib.Path, str</span>
<span class="sd">            A session path within which to glob for the dataset(s).</span>
<span class="sd">        register : bool</span>
<span class="sd">            Only return files intended to be registered.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True</span>
<span class="sd">            Always True as dataset is optional.</span>
<span class="sd">        list of pathlib.Path</span>
<span class="sd">            A list of matching dataset files.</span>
<span class="sd">        missing, None, str, set of str</span>
<span class="sd">            One or more glob patterns that either didn&#39;t yield files (or did in the case of inverted datasets).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Currently if `unique` is true and multiple files are found, all files are returned without an exception raised</span>
<span class="sd">          although this may change in the future.</span>
<span class="sd">        - If `register` is false, all files are returned regardless of whether they are intended to be registered.</span>
<span class="sd">        - If `inverted` is true, and files are found, the glob pattern is returned as missing.</span>
<span class="sd">        - If XOR, returns all patterns if all are present when only one should be, otherwise returns all missing</span>
<span class="sd">          patterns.</span>
<span class="sd">        - Missing (or unexpectedly found) patterns are returned despite the dataset being optional.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">actual_files</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="n">register</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">actual_files</span><span class="p">,</span> <span class="n">missing</span></div>


<div class="viewcode-block" id="OptionalDataset.filter">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.OptionalDataset.filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter dataset frame by expected datasets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        session_datasets : pandas.DataFrame</span>
<span class="sd">            An data frame of session datasets.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Extra arguments for `one.util.filter_datasets`, namely revision_last_before, qc,</span>
<span class="sd">            ignore_qc_not_set, and assert_unique.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True</span>
<span class="sd">            Always True as dataset is optional.</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A filtered data frame of containing the expected dataset(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">datasets</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">session_datasets</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">datasets</span></div>
</div>



<div class="viewcode-block" id="Input">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.Input">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="n">ExpectedDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An expected input dataset.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="OptionalInput">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.OptionalInput">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OptionalInput</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">OptionalDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An optional expected input dataset.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="Output">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.Output">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="n">ExpectedDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An expected output dataset.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="OptionalOutput">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.OptionalOutput">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OptionalOutput</span><span class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="n">OptionalDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An optional expected output dataset.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_parse_signature</span><span class="p">(</span><span class="n">signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure all a signature&#39;s expected datasets are instances of ExpectedDataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signature : Dict[str, list]</span>
<span class="sd">        A dict with keys {&#39;input_files&#39;, &#39;output_files&#39;} containing lists of tuples and/or</span>
<span class="sd">        ExpectedDataset instances.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, list of ExpectedDataset]</span>
<span class="sd">        A dict containing all tuples converted to ExpectedDataset instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">O</span> <span class="o">=</span> <span class="n">ExpectedDataset</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">ExpectedDataset</span><span class="o">.</span><span class="n">output</span>  <span class="c1"># noqa</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ExpectedDataset</span><span class="p">)</span> <span class="k">else</span> <span class="n">I</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">signature</span><span class="p">[</span><span class="s1">&#39;input_files&#39;</span><span class="p">]]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">ExpectedDataset</span><span class="p">)</span> <span class="k">else</span> <span class="n">O</span><span class="p">(</span><span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">signature</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;input_files&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span> <span class="s1">&#39;output_files&#39;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<div class="viewcode-block" id="dataset_from_name">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.dataset_from_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dataset_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">datasets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a list of ExpectedDataset instances, return those that match a given name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str, function</span>
<span class="sd">        The name of the dataset or a function to match the dataset name.</span>
<span class="sd">    datasets : list of ExpectedDataset</span>
<span class="sd">        A list of ExpectedDataset instances.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of ExpectedDataset</span>
<span class="sd">        The ExpectedDataset instances that match the given name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dataset_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">matches</span></div>



<div class="viewcode-block" id="update_collections">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.update_collections">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_collections</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">new_collection</span><span class="p">,</span> <span class="n">substring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exact_match</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the collection of a dataset.</span>

<span class="sd">    This updates all nested ExpectedDataset instances with the new collection and returns copies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset : ExpectedDataset</span>
<span class="sd">        The dataset to update.</span>
<span class="sd">    new_collection : str, list of str</span>
<span class="sd">        The new collection or collections.</span>
<span class="sd">    substring : str, optional</span>
<span class="sd">        An optional substring in the collection to replace with new collection(s). If None, the</span>
<span class="sd">        entire collection will be replaced.</span>
<span class="sd">    unique : bool, optional</span>
<span class="sd">        When provided, this will be used to set the `unique` attribute of the new dataset(s). If</span>
<span class="sd">        None, the `unique` attribute will be set to True if the collection does not contain</span>
<span class="sd">        wildcards.</span>
<span class="sd">    exact_match : bool</span>
<span class="sd">        If True, the collection will be replaced only if it contains `substring`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ExpectedDataset</span>
<span class="sd">        A copy of the dataset with the updated collection(s).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">after</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">new_collection</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">ExpectedDataset</span><span class="o">.</span><span class="n">input</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">Input</span><span class="p">)</span> <span class="k">else</span> <span class="n">ExpectedDataset</span><span class="o">.</span><span class="n">output</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">identifiers</span>
        <span class="k">if</span> <span class="n">revision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">if</span> <span class="n">substring</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exact_match</span> <span class="ow">and</span> <span class="n">substring</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
                <span class="n">after</span> <span class="o">=</span> <span class="p">[</span><span class="n">collection</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">after</span> <span class="o">=</span> <span class="p">[(</span><span class="n">collection</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">after</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unique</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="s1">&#39;*[?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">after</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
        <span class="n">register</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">register</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">after</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">OptionalDataset</span><span class="p">),</span> <span class="n">register</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">after</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">unq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">after</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">unique</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">updated</span> <span class="o">&amp;=</span> <span class="n">D</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">OptionalDataset</span><span class="p">),</span> <span class="n">register</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">updated</span><span class="o">.</span><span class="n">_identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_collections</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">new_collection</span><span class="p">,</span> <span class="n">substring</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">exact_match</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">updated</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">updated</span></div>



<div class="viewcode-block" id="DataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.DataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataHandler</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base data handler class</span>
<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signature: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="o">=</span> <span class="n">ensure_alf_path</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">_parse_signature</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="o">=</span> <span class="n">one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map of filepaths and their processed records (e.g. upload receipts or Alyx records)</span>

<div class="viewcode-block" id="DataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.DataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to optionally overload to download required data to run task.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DataHandler.getData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.DataHandler.getData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds the datasets required for task based on input signatures.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        one : one.api.One, optional</span>
<span class="sd">            An instance of ONE to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame, None</span>
<span class="sd">            A data frame of required datasets. An empty frame is returned if no registered datasets are required,</span>
<span class="sd">            while None is returned if no instance of ONE is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">one</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">one</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span>
        <span class="n">session_datasets</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">path2eid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">),</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">session_datasets</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">[</span><span class="s1">&#39;input_files&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataHandler.getOutputFiles">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.DataHandler.getOutputFiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getOutputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a data frame of output datasets found on disk.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A dataset data frame of datasets on disk that were specified in signature[&#39;output_files&#39;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="k">if</span> <span class="n">session_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">session_path</span>
        <span class="k">assert</span> <span class="n">session_path</span>
        <span class="c1"># Next convert datasets to frame</span>
        <span class="c1"># Create dataframe of all ALF datasets</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">_make_datasets_df</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">hash_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="c1"># Filter outputs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">present</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">df</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">present</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;eid&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.DataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to optionally overload to upload and register data</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="n">version</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="n">version</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">versions</span></div>


<div class="viewcode-block" id="DataHandler.cleanUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.DataHandler.cleanUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to optionally overload to clean up files after running task.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="LocalDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.LocalDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LocalDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data handler for running tasks locally, with no architecture or db connection</span>
<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signature: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span></div>



<div class="viewcode-block" id="ServerDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ServerDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data handler for running tasks on lab local servers when all data is available locally</span>

<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signature: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>

<div class="viewcode-block" id="ServerDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload and/or register output data.</span>

<span class="sd">        This is typically called by :meth:`ibllib.pipes.tasks.Task.register_datasets`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outputs : list of pathlib.Path</span>
<span class="sd">            A set of ALF paths to register to Alyx.</span>
<span class="sd">        version : str, list of str</span>
<span class="sd">            The version of ibllib used to generate these output files.</span>
<span class="sd">        clobber : bool</span>
<span class="sd">            If True, re-upload outputs that have already been passed to this method.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional keyword arguments for one.registration.RegistrationClient.register_files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of dicts, dict</span>
<span class="sd">            A list of newly created Alyx dataset records or the registration data if dry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">data_repo</span> <span class="o">=</span> <span class="n">get_local_data_repository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">)</span>
        <span class="c1"># If clobber = False, do not re-upload the outputs that have already been processed</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">to_upload</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">clobber</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span> <span class="n">outputs</span><span class="p">))</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">register_dataset</span><span class="p">(</span><span class="n">to_upload</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="n">repository</span><span class="o">=</span><span class="n">data_repo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dry&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">records</span>
        <span class="c1"># Store processed outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">to_upload</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="p">]</span></div>


<div class="viewcode-block" id="ServerDataHandler.cleanUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerDataHandler.cleanUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Empties and returns the processed dataset mep.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cleanUp</span><span class="p">()</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">processed</span></div>
</div>



<div class="viewcode-block" id="ServerGlobusDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerGlobusDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ServerGlobusDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data handler for running tasks on lab local servers. Will download missing data from SDSC using Globus</span>

<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signatures: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">one.remote.globus</span><span class="w"> </span><span class="kn">import</span> <span class="n">Globus</span><span class="p">,</span> <span class="n">get_lab_from_endpoint_id</span>  <span class="c1"># noqa</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globus</span> <span class="o">=</span> <span class="n">Globus</span><span class="p">(</span><span class="n">client_name</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># on local servers set up the local root path manually as some have different globus config paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">endpoints</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">][</span><span class="s1">&#39;root_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/mnt/s0/Data/Subjects&#39;</span>

        <span class="c1"># Find the lab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lab</span> <span class="o">=</span> <span class="n">get_lab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">)</span>

        <span class="c1"># For cortex lab we need to get the endpoint from the ibl alyx</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab</span> <span class="o">==</span> <span class="s1">&#39;cortexlab&#39;</span><span class="p">:</span>
            <span class="n">alyx</span> <span class="o">=</span> <span class="n">AlyxClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;https://alyx.internationalbrainlab.org&#39;</span><span class="p">,</span> <span class="n">cache_rest</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">add_endpoint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flatiron_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alyx</span><span class="o">=</span><span class="n">alyx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">add_endpoint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flatiron_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alyx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">local_paths</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ServerGlobusDataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerGlobusDataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to download necessary data to run tasks using globus-sdk.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab</span> <span class="o">==</span> <span class="s1">&#39;cortexlab&#39;</span> <span class="ow">and</span> <span class="s1">&#39;cortexlab&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="n">ONE</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;https://alyx.internationalbrainlab.org&#39;</span><span class="p">,</span> <span class="n">cache_rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">cache_mode</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If no datasets found in the cache only work off local file system do not attempt to</span>
            <span class="c1"># download any missing data using Globus</span>
            <span class="k">return</span>

        <span class="c1"># Check for space on local server. If less that 500 GB don&#39;t download new data</span>
        <span class="n">space_free</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">endpoints</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">][</span><span class="s1">&#39;root_path&#39;</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">space_free</span> <span class="o">&lt;</span> <span class="mf">500e9</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Space left on server is &lt; 500GB, won</span><span class="se">\&#39;</span><span class="s1">t re-download new data&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">rel_sess_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">session_path_short</span><span class="p">()</span>
        <span class="n">target_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">sess_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_sess_path</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">])</span>
            <span class="n">full_local_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">endpoints</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">][</span><span class="s1">&#39;root_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">sess_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">uuid</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_local_path</span><span class="p">)</span>
                <span class="n">target_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sess_path</span><span class="p">)</span>
                <span class="n">source_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_uuid_string</span><span class="p">(</span><span class="n">sess_path</span><span class="p">,</span> <span class="n">uuid</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_paths</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">source_paths</span><span class="p">,</span> <span class="n">target_paths</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downloading </span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flatiron_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">source_paths</span><span class="p">,</span> <span class="n">target_paths</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Complete. Time elapsed </span><span class="si">{</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ServerGlobusDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerGlobusDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to upload and register data of completed task</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return: output info of registered datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">data_repo</span> <span class="o">=</span> <span class="n">get_local_data_repository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">register_dataset</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="n">repository</span><span class="o">=</span><span class="n">data_repo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ServerGlobusDataHandler.cleanUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.ServerGlobusDataHandler.cleanUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up, remove the files that were downloaded from Globus once task has completed.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_paths</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RemoteEC2DataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteEC2DataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RemoteEC2DataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data handler for running tasks on remote compute node. Will download missing data via http using ONE</span>

<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signature: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>

<div class="viewcode-block" id="RemoteEC2DataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteEC2DataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to download necessary data to run tasks using ONE</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_check_filesystem</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">check_hash</span><span class="o">=</span><span class="n">check_hash</span><span class="p">)</span></div>


<div class="viewcode-block" id="RemoteEC2DataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteEC2DataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to upload and register data of completed task via S3 patcher</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return: output info of registered datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">s3_patcher</span> <span class="o">=</span> <span class="n">S3Patcher</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s3_patcher</span><span class="o">.</span><span class="n">patch_dataset</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                        <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RemoteHttpDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteHttpDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RemoteHttpDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data handler for running tasks on remote compute node. Will download missing data via http using ONE</span>

<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signature: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>

<div class="viewcode-block" id="RemoteHttpDataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteHttpDataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to download necessary data to run tasks using ONE</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_check_filesystem</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="RemoteHttpDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteHttpDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to upload and register data of completed task via FTP patcher</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return: output info of registered datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">ftp_patcher</span> <span class="o">=</span> <span class="n">FTPPatcher</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ftp_patcher</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                          <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RemoteAwsDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteAwsDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RemoteAwsDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data handler for running tasks on remote compute node.</span>

<span class="sd">        This will download missing data from the private IBL S3 AWS data bucket.  New datasets are</span>
<span class="sd">        uploaded via Globus.</span>

<span class="sd">        :param session_path: path to session</span>
<span class="sd">        :param signature: input and output file signatures</span>
<span class="sd">        :param one: ONE instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_paths</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RemoteAwsDataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteAwsDataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to download necessary data to run tasks using AWS boto3.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_aws</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()))</span></div>


<div class="viewcode-block" id="RemoteAwsDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteAwsDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to upload and register data of completed task via FTP patcher</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return: output info of registered datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set up Globus</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">one.remote.globus</span><span class="w"> </span><span class="kn">import</span> <span class="n">Globus</span> <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globus</span> <span class="o">=</span> <span class="n">Globus</span><span class="p">(</span><span class="n">client_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;client_name&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">),</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">lab</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab</span> <span class="o">==</span> <span class="s1">&#39;cortexlab&#39;</span> <span class="ow">and</span> <span class="s1">&#39;cortexlab&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://alyx.internationalbrainlab.org&#39;</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Changing Alyx client to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">base_url</span><span class="p">)</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">AlyxClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cache_rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">cache_mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">add_endpoint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flatiron_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alyx</span><span class="o">=</span><span class="n">ac</span><span class="p">)</span>

        <span class="c1"># register datasets</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">register_dataset</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="n">server_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># upload directly via globus</span>
        <span class="n">source_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">dset</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="c1"># set flag to false</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fr</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;flatiron&#39;</span> <span class="ow">in</span> <span class="n">fr</span><span class="p">[</span><span class="s1">&#39;data_repository&#39;</span><span class="p">])</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="s1">&#39;relative_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">collections</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dset</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fr_id&#39;</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">]}})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">collections</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dset</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fr_id&#39;</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">]}}</span>

            <span class="c1"># Set all exists status to false for server file records</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">fr</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

            <span class="n">source_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">target_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_uuid_string</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="s1">&#39;relative_path&#39;</span><span class="p">],</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_paths</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">source_paths</span><span class="p">,</span> <span class="n">target_paths</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Uploading </span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;flatiron_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">source_paths</span><span class="p">,</span> <span class="n">target_paths</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Complete. Time elapsed </span><span class="si">{</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">collection</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">globus_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globus</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flatiron_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">remove_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">gl</span> <span class="ow">in</span> <span class="n">globus_files</span><span class="p">]</span>
            <span class="n">file_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">gl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">gl</span> <span class="ow">in</span> <span class="n">globus_files</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">file_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">file_sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]:</span>
                        <span class="c1"># update the file record if sizes match</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;fr_id&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> found on SDSC but sizes do not match&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> not found on SDSC&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>


        <span class="c1"># ftp_patcher = FTPPatcher(one=self.one)</span>
        <span class="c1"># return ftp_patcher.create_dataset(path=outputs, created_by=self.one.alyx.user,</span>
        <span class="c1">#                                   versions=versions, **kwargs)</span>

<div class="viewcode-block" id="RemoteAwsDataHandler.cleanUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteAwsDataHandler.cleanUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up, remove the files that were downloaded from globus once task has completed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_paths</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RemoteGlobusDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteGlobusDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RemoteGlobusDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data handler for running tasks on remote compute node. Will download missing data using Globus.</span>

<span class="sd">    :param session_path: path to session</span>
<span class="sd">    :param signature: input and output file signatures</span>
<span class="sd">    :param one: ONE instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>

<div class="viewcode-block" id="RemoteGlobusDataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteGlobusDataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to download necessary data to run tasks using globus.&quot;&quot;&quot;</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="RemoteGlobusDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.RemoteGlobusDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to upload and register data of completed task via FTP patcher</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return: output info of registered datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">ftp_patcher</span> <span class="o">=</span> <span class="n">FTPPatcher</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ftp_patcher</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                          <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SDSCDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.SDSCDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SDSCDataHandler</span><span class="p">(</span><span class="n">DataHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data handler for running tasks on SDSC compute node</span>

<span class="sd">    :param session_path: path to session</span>
<span class="sd">    :param signature: input and output file signatures</span>
<span class="sd">    :param one: ONE instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SDSC_PATCH_PATH&#39;</span><span class="p">,</span> <span class="n">SDSC_PATCH_PATH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">SDSC_ROOT_PATH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linked_files</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of symlinks created to run tasks</span>

<div class="viewcode-block" id="SDSCDataHandler.setUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.SDSCDataHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to create symlinks to necessary data to run tasks.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>

        <span class="n">SDSC_TMP</span> <span class="o">=</span> <span class="n">ensure_alf_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">get_alf_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">session_path</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span>
            <span class="n">file_uuid</span> <span class="o">=</span> <span class="n">add_uuid_string</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
            <span class="n">file_link</span> <span class="o">=</span> <span class="n">SDSC_TMP</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">file_link</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># TODO append link to task attribute</span>
                <span class="n">file_link</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span>
                    <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_uuid</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">linked_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_link</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">task</span><span class="o">.</span><span class="n">session_path</span> <span class="o">=</span> <span class="n">SDSC_TMP</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>
        <span class="c1"># If one of the symlinked input files is also an expected output, raise here to avoid overwriting</span>
        <span class="c1"># In the future we may instead copy the data under this condition</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputFiles</span><span class="p">(</span><span class="n">session_path</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;On SDSC patcher, output files should be distinct from input files to avoid overwriting&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDSCDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.SDSCDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to upload and register data of completed task via SDSC patcher</span>
<span class="sd">        :param outputs: output files from task to register</span>
<span class="sd">        :param version: ibllib version</span>
<span class="sd">        :return: output info of registered datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">uploadData</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">sdsc_patcher</span> <span class="o">=</span> <span class="n">SDSCPatcher</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sdsc_patcher</span><span class="o">.</span><span class="n">patch_datasets</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDSCDataHandler.cleanUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.SDSCDataHandler.cleanUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to clean up symlinks created to run task.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_path</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PopeyeDataHandler">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.PopeyeDataHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PopeyeDataHandler</span><span class="p">(</span><span class="n">SDSCDataHandler</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">signatures</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SDSC_PATCH_PATH&#39;</span><span class="p">,</span> <span class="s2">&quot;/mnt/sdceph/users/ibl/data/quarantine/tasks/&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/mnt/sdceph/users/ibl/data&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PopeyeDataHandler.uploadData">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.PopeyeDataHandler.uploadData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uploadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot register data from Popeye. Login as Datauser and use the RegisterSpikeSortingSDSC task.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PopeyeDataHandler.cleanUp">
<a class="viewcode-back" href="../../../_autosummary/ibllib.oneibl.data_handlers.html#ibllib.oneibl.data_handlers.PopeyeDataHandler.cleanUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Symlinks are preserved until registration.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>