<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibllib.qc.task_metrics &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DataJoint</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dj_docs/dj_introduction.html">Introduction to DataJoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dj_docs/dj_public.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dj_docs/dj_credentials.html">DataJoint credentials for internal IBL users</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../06_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/dj_intro/dj_intro.html">Datajoint Introductory Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/dj_basics/dj_basics.html">Exploring the IBL Data Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Detailed Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>ibllib.qc.task_metrics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibllib.qc.task_metrics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Behaviour QC</span>
<span class="sd">This module runs a list of quality control metrics on the behaviour data.</span>

<span class="sd">Examples:</span>
<span class="sd">    # Running on a rig computer and updating QC fields in Alyx:</span>
<span class="sd">    from ibllib.qc.task_metrics import TaskQC</span>
<span class="sd">    TaskQC(&#39;path/to/session&#39;).run(update=True)</span>

<span class="sd">    # Downloading the required data and inspecting the QC on a different computer:</span>
<span class="sd">    from ibllib.qc.task_metrics import TaskQC</span>
<span class="sd">    qc = TaskQC(eid)</span>
<span class="sd">    outcome, results = qc.run()</span>

<span class="sd">    # Inspecting individual test outcomes</span>
<span class="sd">    from ibllib.qc.task_metrics import TaskQC</span>
<span class="sd">    qc = TaskQC(eid)</span>
<span class="sd">    outcome, results, outcomes = qc.compute().compute_session_status()</span>

<span class="sd">    # Running bpod QC on ephys session</span>
<span class="sd">    from ibllib.qc.task_metrics import TaskQC</span>
<span class="sd">    qc = TaskQC(eid)</span>
<span class="sd">    qc.load_data(bpod_only=True)  # Extract without FPGA</span>
<span class="sd">    bpod_qc = qc.run()</span>

<span class="sd">    # Running bpod QC only, from training rig PC</span>
<span class="sd">    from ibllib.qc.task_metrics import TaskQC</span>
<span class="sd">    from ibllib.qc.qcplots import plot_results</span>
<span class="sd">    session_path = r&#39;/home/nico/Downloads/FlatIron/mrsicflogellab/Subjects/SWC_023/2020-02-14/001&#39;</span>
<span class="sd">    qc = TaskQC(session_path)</span>
<span class="sd">    qc.load_data(bpod_only=True, download_data=False)  # Extract without FPGA</span>
<span class="sd">    qc.run()</span>
<span class="sd">    plot_results(qc, save_path=session_path)</span>

<span class="sd">    # Running ephys QC, from local server PC (after ephys + bpod data have been copied to a same</span>
<span class="sd">    folder)</span>
<span class="sd">    from ibllib.qc.task_metrics import TaskQC</span>
<span class="sd">    from ibllib.qc.qcplots import plot_results</span>
<span class="sd">    session_path = r&#39;/home/nico/Downloads/FlatIron/mrsicflogellab/Subjects/SWC_023/2020-02-14/001&#39;</span>
<span class="sd">    qc = TaskQC(session_path)</span>
<span class="sd">    qc.run()</span>
<span class="sd">    plot_results(qc, save_path=session_path)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span><span class="p">,</span> <span class="n">isfunction</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sized</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chisquare</span>

<span class="kn">from</span> <span class="nn">brainbox.behavior.wheel</span> <span class="kn">import</span> <span class="n">cm_to_rad</span><span class="p">,</span> <span class="n">traces_by_trial</span>
<span class="kn">from</span> <span class="nn">ibllib.qc.task_extractors</span> <span class="kn">import</span> <span class="n">TaskQCExtractor</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors</span> <span class="kn">import</span> <span class="n">ephys_fpga</span>
<span class="kn">from</span> <span class="nn">one.alf.spec</span> <span class="kn">import</span> <span class="n">is_session_path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ibllib&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="TaskQC"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.TaskQC">[docs]</a><span class="k">class</span> <span class="nc">TaskQC</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">QC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for computing task QC metrics&quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PASS&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">fcns_value2status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">TaskQC</span><span class="o">.</span><span class="n">_thresholding</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                         <span class="s1">&#39;_task_stimFreeze_delays&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;_task_response_stimFreeze_delays&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;_task_passed_trial_checks&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;_task_iti_delays&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_thresholding</span><span class="p">(</span><span class="n">qc_value</span><span class="p">,</span> <span class="n">thresholds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the outcome of a single key by applying thresholding.</span>
<span class="sd">        :param qc_value: proportion of passing qcs, between 0 and 1</span>
<span class="sd">        :param thresholds: dictionary with keys &#39;PASS&#39;, &#39;WARNING&#39;, &#39;FAIL&#39;</span>
<span class="sd">         (cf. TaskQC.criteria attribute)</span>
<span class="sd">        :return: int where -1: NOT_SET, 0: FAIL, 1: WARNING, 2: PASS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">MAX_BOUND</span><span class="p">,</span> <span class="n">MIN_BOUND</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thresholds</span><span class="p">:</span>
            <span class="n">thresholds</span> <span class="o">=</span> <span class="n">TaskQC</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">qc_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">qc_value</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">qc_value</span> <span class="o">&gt;</span> <span class="n">MAX_BOUND</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qc_value</span> <span class="o">&lt;</span> <span class="n">MIN_BOUND</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Values out of bound&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="n">qc_value</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">thresholds</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">passed</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path_or_eid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param session_path_or_eid: A session eid or path</span>
<span class="sd">        :param log: A logging.Logger instance, if None the &#39;ibllib&#39; logger is used</span>
<span class="sd">        :param one: An ONE instance for fetching and setting the QC on Alyx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># When an eid is provided, we will download the required data by default (if necessary)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_session_path</span><span class="p">(</span><span class="n">session_path_or_eid</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path_or_eid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractor</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Metrics and passed trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TaskQC.load_data"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.TaskQC.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bpod_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download_data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the data from raw data files</span>
<span class="sd">        Extracts all the required task data from the raw data files.</span>

<span class="sd">        :param bpod_only: if True no data is extracted from the FPGA for ephys sessions</span>
<span class="sd">        :param download_data: if True, any missing raw data is downloaded via ONE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractor</span> <span class="o">=</span> <span class="n">TaskQCExtractor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="n">download_data</span><span class="o">=</span><span class="n">download_data</span><span class="p">,</span> <span class="n">bpod_only</span><span class="o">=</span><span class="n">bpod_only</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskQC.compute"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.TaskQC.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute and store the QC metrics</span>
<span class="sd">        Runs the QC on the session and stores a map of the metrics for each datapoint for each</span>
<span class="sd">        test, and a map of which datapoints passed for each test</span>
<span class="sd">        :param bpod_only: if True no data is extracted from the FPGA for ephys sessions</span>
<span class="sd">        :param download_data: if True, any missing raw data is downloaded via ONE.  By default</span>
<span class="sd">        data are not downloaded if a session path was provided to the constructor.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;download_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;download_data&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="si">}</span><span class="s2">: Running QC on behavior data...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_bpodqc_metrics_frame</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">wheel_gain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;STIM_GAIN&quot;</span><span class="p">],</span>  <span class="c1"># The wheel gain</span>
            <span class="n">photodiode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">frame_ttls</span><span class="p">,</span>
            <span class="n">audio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">audio_ttls</span><span class="p">,</span>
            <span class="n">re_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">wheel_encoding</span> <span class="ow">or</span> <span class="s1">&#39;X1&#39;</span><span class="p">,</span>
            <span class="n">min_qt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QUIESCENT_PERIOD&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.2</span>
        <span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TaskQC.run"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.TaskQC.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param update: if True, updates the session QC fields on Alyx</span>
<span class="sd">        :param bpod_only: if True no data is extracted from the FPGA for ephys sessions</span>
<span class="sd">        :param download_data: if True, any missing raw data is downloaded via ONE.  By default</span>
<span class="sd">        data are not downloaded if a session path was provided to the constructor.</span>
<span class="sd">        :return: QC outcome (str), a dict for extended QC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">outcome</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_session_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_extended_qc</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">results</span></div>

<div class="viewcode-block" id="TaskQC.compute_session_status_from_dict"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.TaskQC.compute_session_status_from_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compute_session_status_from_dict</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a dictionary of results, computes the overall session QC for each key and aggregates</span>
<span class="sd">        in a single value</span>
<span class="sd">        :param results: a dictionary of qc keys containing (usually scalar) values</span>
<span class="sd">        :return: Overall session QC outcome as a string</span>
<span class="sd">        :return: A dict of QC tests and their outcomes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v2status_fcns</span> <span class="o">=</span> <span class="n">TaskQC</span><span class="o">.</span><span class="n">fcns_value2status</span>  <span class="c1"># the need to have this as a parameter may arise</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">v2status_fcns</span><span class="p">:</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v2status_fcns</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v2status_fcns</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">](</span><span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">key_map</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">TaskQC</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">x</span><span class="p">]</span>
        <span class="c1"># Criteria map is in order of severity so the max index is our overall QC outcome</span>
        <span class="n">session_outcome</span> <span class="o">=</span> <span class="n">key_map</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        <span class="n">outcomes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">map</span><span class="p">(</span><span class="n">key_map</span><span class="p">,</span> <span class="n">indices</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">session_outcome</span><span class="p">,</span> <span class="n">outcomes</span></div>

<div class="viewcode-block" id="TaskQC.compute_session_status"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.TaskQC.compute_session_status">[docs]</a>    <span class="k">def</span> <span class="nf">compute_session_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the overall session QC for each key and aggregates in a single value</span>
<span class="sd">        :return: Overall session QC outcome as a string</span>
<span class="sd">        :return: A dict of QC tests and the proportion of data points that passed them</span>
<span class="sd">        :return: A dict of QC tests and their outcomes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;passed is None; compute QC first&#39;</span><span class="p">)</span>
        <span class="c1"># Get mean passed of each check, or None if passed is None or all NaN</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">session_outcome</span><span class="p">,</span> <span class="n">outcomes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_session_status_from_dict</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session_outcome</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">outcomes</span></div></div>


<div class="viewcode-block" id="HabituationQC"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.HabituationQC">[docs]</a><span class="k">class</span> <span class="nc">HabituationQC</span><span class="p">(</span><span class="n">TaskQC</span><span class="p">):</span>

<div class="viewcode-block" id="HabituationQC.compute"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.HabituationQC.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute and store the QC metrics</span>
<span class="sd">        Runs the QC on the session and stores a map of the metrics for each datapoint for each</span>
<span class="sd">        test, and a map of which datapoints passed for each test</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If download_data is None, decide based on whether eid or session path was provided</span>
            <span class="n">ensure_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span> <span class="k">if</span> <span class="n">download_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">download_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">download_data</span><span class="o">=</span><span class="n">ensure_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="si">}</span><span class="s2">: Running QC on habituation data...&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize checks</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;_task_&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractor</span><span class="o">.</span><span class="n">data</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Check all reward volumes == 3.0ul</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;reward_volumes&#39;</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rewardVolume&#39;</span><span class="p">]</span>
        <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.0</span>

        <span class="c1"># Check session durations are increasing in steps &gt;= 12 minutes</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;habituation_time&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;unable to determine session trials without ONE&#39;</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subject</span><span class="p">,</span> <span class="n">session_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># compute from the date specified</span>
            <span class="n">date_minus_week</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">session_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                                          <span class="n">date_range</span><span class="o">=</span><span class="p">[</span><span class="n">date_minus_week</span><span class="p">,</span> <span class="n">session_date</span><span class="p">],</span>
                                          <span class="n">task_protocol</span><span class="o">=</span><span class="s1">&#39;habituation&#39;</span><span class="p">)</span>
            <span class="c1"># Remove the current session if already registered</span>
            <span class="k">if</span> <span class="n">sessions</span> <span class="ow">and</span> <span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">session_date</span><span class="p">):</span>
                <span class="n">sessions</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span> <span class="o">-</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">]])</span>

            <span class="c1"># The duration from raw trial data</span>
            <span class="c1"># duration = map(float, self.extractor.raw_data[-1][&#39;elapsed_time&#39;].split(&#39;:&#39;))</span>
            <span class="c1"># duration = timedelta(**dict(zip((&#39;hours&#39;, &#39;minutes&#39;, &#39;seconds&#39;),</span>
            <span class="c1">#                                 duration))).total_seconds() / 60</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">12</span>

        <span class="c1"># Check event orders: trial_start &lt; stim on &lt; stim center &lt; feedback &lt; stim off</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;trial_event_sequence&#39;</span>
        <span class="n">nans</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>  <span class="o">|</span>  <span class="c1"># noqa</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOn_times&quot;</span><span class="p">])</span>     <span class="o">|</span>  <span class="c1"># noqa</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimCenter_times&quot;</span><span class="p">])</span> <span class="o">|</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;valveOpen_times&quot;</span><span class="p">])</span>  <span class="o">|</span>  <span class="c1"># noqa</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOn_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOn_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimCenter_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimCenter_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;valveOpen_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;valveOpen_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>

        <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nans</span>
        <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Check that the time difference between the visual stimulus center-command being</span>
        <span class="c1"># triggered and the stimulus effectively appearing in the center is smaller than 150 ms.</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;stimCenter_delays&#39;</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimCenter_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimCenterTrigger_times&quot;</span><span class="p">],</span>
                               <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>

        <span class="c1"># Phase check</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;phase&#39;</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span>
        <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>

        <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;phase_distribution&#39;</span>
        <span class="n">metric</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">])</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">chisquare</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>

        <span class="c1"># Checks common to training QC</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span><span class="n">check_goCue_delays</span><span class="p">,</span> <span class="n">check_stimOn_goCue_delays</span><span class="p">,</span>
                  <span class="n">check_stimOn_delays</span><span class="p">,</span> <span class="n">check_stimOff_delays</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fcn</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">fcn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">check</span><span class="p">],</span> <span class="n">passed</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">passed</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_bpodqc_metrics_frame"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.get_bpodqc_metrics_frame">[docs]</a><span class="k">def</span> <span class="nf">get_bpodqc_metrics_frame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates all the QC metric functions in this module (those starting with &#39;check&#39;) and</span>
<span class="sd">    returns the results.  The optional kwargs listed below are passed to each QC metric function.</span>
<span class="sd">    :param data: dict of extracted task data</span>
<span class="sd">    :param re_encoding: the encoding of the wheel data, X1, X2 or X4</span>
<span class="sd">    :param enc_res: the rotary encoder resolution</span>
<span class="sd">    :param wheel_gain: the STIM_GAIN task parameter</span>
<span class="sd">    :param photodiode: the fronts from Bpod&#39;s BNC1 input or FPGA frame2ttl channel</span>
<span class="sd">    :param audio: the fronts from Bpod&#39;s BNC2 input FPGA audio sync channel</span>
<span class="sd">    :param min_qt: the QUIESCENT_PERIOD task parameter</span>
<span class="sd">    :return metrics: dict of checks and their QC metrics</span>
<span class="sd">    :return passed: dict of checks and a float array of which samples passed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">is_metric</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;check_&#39;</span><span class="p">)</span>
    <span class="c1"># Find all methods that begin with &#39;check_&#39;</span>
    <span class="n">checks</span> <span class="o">=</span> <span class="n">getmembers</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">is_metric</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;_task_&#39;</span>  <span class="c1"># Extended QC fields will start with this</span>
    <span class="c1"># Method &#39;check_foobar&#39; stored with key &#39;_task_foobar&#39; in metrics map</span>
    <span class="n">qc_metrics_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">6</span><span class="p">:]:</span> <span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">}</span>

    <span class="c1"># Split metrics and passed frames</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">qc_metrics_map</span><span class="p">:</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">passed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">qc_metrics_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="c1"># Add a check for trial level pass: did a given trial pass all checks?</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Trial-level checks return an array the length that equals the number of trials</span>
    <span class="n">trial_level_passed</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                          <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Sized</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_trials</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;passed_trial_checks&#39;</span>
    <span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="n">trial_level_passed</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">trial_level_passed</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="c1"># SINGLE METRICS</span>
<span class="c1"># ---------------------------------------------------------------------------- #</span>

<span class="c1"># === Delays between events checks ===</span>

<div class="viewcode-block" id="check_stimOn_goCue_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_stimOn_goCue_delays">[docs]</a><span class="k">def</span> <span class="nf">check_stimOn_goCue_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks that the time difference between the onset of the visual stimulus</span>
<span class="sd">    and the onset of the go cue tone is positive and less than 10ms.</span>

<span class="sd">    Metric: M = stimOn_times - goCue_times</span>
<span class="sd">    Criteria: 0 &lt; M &lt; 0.010 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;goCue_times&#39;, &#39;stimOn_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the difference between stimOn and goCue times.</span>
    <span class="c1"># If either are NaN, the result will be Inf to ensure that it crosses the failure threshold.</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOn_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_response_feedback_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_response_feedback_delays">[docs]</a><span class="k">def</span> <span class="nf">check_response_feedback_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks that the time difference between the response and the feedback onset</span>
<span class="sd">    (error sound or valve) is positive and less than 10ms.</span>

<span class="sd">    Metric: M = Feedback_time - response_time</span>
<span class="sd">    Criterion: 0 &lt; M &lt; 0.010 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;feedback_times&#39;, &#39;response_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;response_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_response_stimFreeze_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_response_stimFreeze_delays">[docs]</a><span class="k">def</span> <span class="nf">check_response_stimFreeze_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks that the time difference between the visual stimulus freezing and the</span>
<span class="sd">    response is positive and less than 100ms.</span>

<span class="sd">    Metric: M = (stimFreeze_times - response_times)</span>
<span class="sd">    Criterion: 0 &lt; M &lt; 0.100 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimFreeze_times&#39;, &#39;response_times&#39;, &#39;intervals&#39;,</span>
<span class="sd">    &#39;choice&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the difference between stimOn and goCue times.</span>
    <span class="c1"># If either are NaN, the result will be Inf to ensure that it crosses the failure threshold.</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimFreeze_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;response_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="c1"># Test for valid values</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">((</span><span class="n">metric</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Finally remove no_go trials (stimFreeze triggered differently in no_go trials)</span>
    <span class="c1"># These values are ignored in calculation of proportion passed</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_stimOff_itiIn_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_stimOff_itiIn_delays">[docs]</a><span class="k">def</span> <span class="nf">check_stimOff_itiIn_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the start of the trial interval is within 10ms of the visual stimulus turning off.</span>

<span class="sd">    Metric: M = itiIn_times - stimOff_times</span>
<span class="sd">    Criterion: 0 &lt; M &lt; 0.010 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimOff_times&#39;, &#39;itiIn_times&#39;, &#39;intervals&#39;,</span>
<span class="sd">    &#39;choice&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If either are NaN, the result will be Inf to ensure that it crosses the failure threshold.</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">((</span><span class="n">metric</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Remove no_go trials (stimOff triggered differently in no_go trials)</span>
    <span class="c1"># NaN values are ignored in calculation of proportion passed</span>
    <span class="n">metric</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_iti_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_iti_delays">[docs]</a><span class="k">def</span> <span class="nf">check_iti_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the period of gray screen between stim off and the start of the next trial is</span>
<span class="sd">    0.5s +/- 200%.</span>

<span class="sd">    Metric: M = stimOff (n) - trialStart (n+1) - 0.5</span>
<span class="sd">    Criterion: |M| &lt; 1</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimOff_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize array the length of completed trials</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Get the difference between stim off and the start of the next trial</span>
    <span class="c1"># Missing data are set to Inf, except for the last trial which is a NaN</span>
    <span class="n">metric</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">.5</span>  <span class="c1"># Last trial is not counted</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_positive_feedback_stimOff_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_positive_feedback_stimOff_delays">[docs]</a><span class="k">def</span> <span class="nf">check_positive_feedback_stimOff_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the valve onset and the visual stimulus turning off</span>
<span class="sd">    is 1 ± 0.150 seconds.</span>

<span class="sd">    Metric: M = stimOff_times - feedback_times - 1s</span>
<span class="sd">    Criterion: |M| &lt; 0.150 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimOff_times&#39;, &#39;feedback_times&#39;, &#39;intervals&#39;,</span>
<span class="sd">    &#39;correct&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If either are NaN, the result will be Inf to ensure that it crosses the failure threshold.</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># NaN values are ignored in calculation of proportion passed; ignore incorrect trials here</span>
    <span class="n">metric</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">passed</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_negative_feedback_stimOff_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_negative_feedback_stimOff_delays">[docs]</a><span class="k">def</span> <span class="nf">check_negative_feedback_stimOff_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the error sound and the visual stimulus</span>
<span class="sd">    turning off is 2 ± 0.150 seconds.</span>

<span class="sd">    Metric: M = stimOff_times - errorCue_times - 2s</span>
<span class="sd">    Criterion: |M| &lt; 0.150 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimOff_times&#39;, &#39;errorCue_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;errorCue_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="c1"># Apply criteria</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Remove none negative feedback trials</span>
    <span class="n">metric</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="c1"># === Wheel movement during trial checks ===</span>

<div class="viewcode-block" id="check_wheel_move_before_feedback"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_wheel_move_before_feedback">[docs]</a><span class="k">def</span> <span class="nf">check_wheel_move_before_feedback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the wheel does move within 100ms of the feedback onset (error sound or valve).</span>

<span class="sd">    Metric: M = (w_t - 0.05) - (w_t + 0.05), where t = feedback_times</span>
<span class="sd">    Criterion: M != 0</span>
<span class="sd">    Units: radians</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;wheel_timestamps&#39;, &#39;wheel_position&#39;, &#39;choice&#39;,</span>
<span class="sd">    &#39;intervals&#39;, &#39;feedback_times&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get tuple of wheel times and positions within 100ms of feedback</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">traces_by_trial</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_timestamps&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_position&quot;</span><span class="p">],</span>
        <span class="n">start</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">])</span>
    <span class="c1"># For each trial find the displacement</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># except no-go trials</span>
    <span class="n">metric</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># NaN = trial ignored for this check</span>
    <span class="n">nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">passed</span><span class="p">[</span><span class="o">~</span><span class="n">nans</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="o">~</span><span class="n">nans</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="k">def</span> <span class="nf">_wheel_move_during_closed_loop</span><span class="p">(</span><span class="n">re_ts</span><span class="p">,</span> <span class="n">re_pos</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">wheel_gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the wheel moves by approximately 35 degrees during the closed-loop period</span>
<span class="sd">    on trials where a feedback (error sound or valve) is delivered.</span>

<span class="sd">    Metric: M = abs(w_resp - w_t0) - threshold_displacement, where w_resp = position at response</span>
<span class="sd">        time, w_t0 = position at go cue time, threshold_displacement = displacement required to</span>
<span class="sd">        move 35 visual degrees</span>
<span class="sd">    Criterion: displacement &lt; tol visual degree</span>
<span class="sd">    Units: degrees angle of wheel turn</span>

<span class="sd">    :param re_ts: extracted wheel timestamps in seconds</span>
<span class="sd">    :param re_pos: extracted wheel positions in radians</span>
<span class="sd">    :param data: a dict with the keys (goCueTrigger_times, response_times, feedback_times,</span>
<span class="sd">    position, choice, intervals)</span>
<span class="sd">    :param wheel_gain: the &#39;STIM_GAIN&#39; task setting</span>
<span class="sd">    :param tol: the criterion in visual degrees</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wheel_gain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No wheel_gain input in function call, returning None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Get tuple of wheel times and positions over each trial&#39;s closed-loop period</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">traces_by_trial</span><span class="p">(</span><span class="n">re_ts</span><span class="p">,</span> <span class="n">re_pos</span><span class="p">,</span>
                             <span class="n">start</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCueTrigger_times&quot;</span><span class="p">],</span>
                             <span class="n">end</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;response_times&quot;</span><span class="p">])</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">])</span>
    <span class="c1"># For each trial find the absolute displacement</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">trial</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Find the position of the preceding sample and subtract it</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">re_ts</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">re_pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">origin</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Load wheel_gain and thresholds for each trial</span>
    <span class="n">wheel_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wheel_gain</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]))</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
    <span class="c1"># abs displacement, s, in mm required to move 35 visual degrees</span>
    <span class="n">s_mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresh</span> <span class="o">/</span> <span class="n">wheel_gain</span><span class="p">)</span>  <span class="c1"># don&#39;t care about direction</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">cm_to_rad</span><span class="p">(</span><span class="n">s_mm</span> <span class="o">*</span> <span class="mf">1e-1</span><span class="p">)</span>  <span class="c1"># convert abs displacement to radians (wheel pos is in rad)</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span> <span class="o">-</span> <span class="n">criterion</span>  <span class="c1"># difference should be close to 0</span>
    <span class="n">rad_per_deg</span> <span class="o">=</span> <span class="n">cm_to_rad</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">wheel_gain</span> <span class="o">*</span> <span class="mf">1e-1</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rad_per_deg</span> <span class="o">*</span> <span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># less than 1 visual degree off</span>
    <span class="n">metric</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># except no-go trials</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span>


<div class="viewcode-block" id="check_wheel_move_during_closed_loop"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_wheel_move_during_closed_loop">[docs]</a><span class="k">def</span> <span class="nf">check_wheel_move_during_closed_loop</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">wheel_gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the wheel moves by approximately 35 degrees during the closed-loop period</span>
<span class="sd">    on trials where a feedback (error sound or valve) is delivered.</span>

<span class="sd">    Metric: M = abs(w_resp - w_t0) - threshold_displacement, where w_resp = position at response</span>
<span class="sd">        time, w_t0 = position at go cue time, threshold_displacement = displacement required to</span>
<span class="sd">        move 35 visual degrees</span>
<span class="sd">    Criterion: displacement &lt; 3 visual degrees</span>
<span class="sd">    Units: degrees angle of wheel turn</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;wheel_timestamps&#39;, &#39;wheel_position&#39;, &#39;choice&#39;,</span>
<span class="sd">    &#39;intervals&#39;, &#39;goCueTrigger_times&#39;, &#39;response_times&#39;, &#39;feedback_times&#39;, &#39;position&#39;)</span>
<span class="sd">    :param wheel_gain: the &#39;STIM_GAIN&#39; task setting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the Bpod extracted wheel data</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">]</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel_position&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">_wheel_move_during_closed_loop</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">wheel_gain</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_wheel_move_during_closed_loop_bpod"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_wheel_move_during_closed_loop_bpod">[docs]</a><span class="k">def</span> <span class="nf">check_wheel_move_during_closed_loop_bpod</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">wheel_gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the wheel moves by approximately 35 degrees during the closed-loop period</span>
<span class="sd">    on trials where a feedback (error sound or valve) is delivered.  This check uses the Bpod</span>
<span class="sd">    wheel data (measured at a lower resolution) with a stricter tolerance (1 visual degree).</span>

<span class="sd">    Metric: M = abs(w_resp - w_t0) - threshold_displacement, where w_resp = position at response</span>
<span class="sd">        time, w_t0 = position at go cue time, threshold_displacement = displacement required to</span>
<span class="sd">        move 35 visual degrees</span>
<span class="sd">    Criterion: displacement &lt; 1 visual degree</span>
<span class="sd">    Units: degrees angle of wheel turn</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;wheel_timestamps(_bpod)&#39;, &#39;wheel_position(_bpod)&#39;,</span>
<span class="sd">    &#39;choice&#39;, &#39;intervals&#39;, &#39;goCueTrigger_times&#39;, &#39;response_times&#39;, &#39;feedback_times&#39;, &#39;position&#39;)</span>
<span class="sd">    :param wheel_gain: the &#39;STIM_GAIN&#39; task setting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the Bpod extracted wheel data</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wheel_timestamps_bpod&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">])</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wheel_position_bpod&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel_position&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">_wheel_move_during_closed_loop</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">wheel_gain</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_wheel_freeze_during_quiescence"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_wheel_freeze_during_quiescence">[docs]</a><span class="k">def</span> <span class="nf">check_wheel_freeze_during_quiescence</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the wheel does not move more than 2 degrees in each direction during the</span>
<span class="sd">    quiescence interval before the stimulus appears.</span>

<span class="sd">    Metric: M = |max(W) - min(W)| where W is wheel pos over quiescence interval</span>
<span class="sd">    interval = [stimOnTrigger_times - quiescent_duration, stimOnTrigger_times]</span>
<span class="sd">    Criterion: M &lt; 2 degrees</span>
<span class="sd">    Units: degrees angle of wheel turn</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;wheel_timestamps&#39;, &#39;wheel_position&#39;, &#39;quiescence&#39;,</span>
<span class="sd">    &#39;intervals&#39;, &#39;stimOnTrigger_times&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_timestamps&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;quiescence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOnTrigger_times&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="c1"># Get tuple of wheel times and positions over each trial&#39;s quiescence period</span>
    <span class="n">qevt_start_times</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOnTrigger_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;quiescence&quot;</span><span class="p">]</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">traces_by_trial</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_timestamps&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_position&quot;</span><span class="p">],</span>
        <span class="n">start</span><span class="o">=</span><span class="n">qevt_start_times</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOnTrigger_times&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quiescence&quot;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_trials, n_directions)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">trial</span>
        <span class="c1"># Get the last position before the period began</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Find the position of the preceding sample and subtract it</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_timestamps&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wheel_position&quot;</span><span class="p">][</span><span class="n">idx</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Find the absolute min and max relative to the last sample</span>
            <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">origin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">origin</span><span class="p">)])</span>
    <span class="c1"># Reduce to the largest displacement found in any direction</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">metric</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># convert to degrees from radians</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Position shouldn&#39;t change more than 2 in either direction</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span> <span class="o">&lt;</span> <span class="n">criterion</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_detected_wheel_moves"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_detected_wheel_moves">[docs]</a><span class="k">def</span> <span class="nf">check_detected_wheel_moves</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_qt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the detected first movement times are reasonable.</span>

<span class="sd">    Metric: M = firstMovement times</span>
<span class="sd">    Criterion: (goCue trigger time - min quiescent period) &lt; M &lt; response time</span>
<span class="sd">    Units: Seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;firstMovement_times&#39;, &#39;goCueTrigger_times&#39;,</span>
<span class="sd">    &#39;response_times&#39;, &#39;choice&#39;, &#39;intervals&#39;)</span>
<span class="sd">    :param min_qt: the minimum possible quiescent period (the QUIESCENT_PERIOD task parameter)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Depending on task version this may be a single value or an array of quiescent periods</span>
    <span class="n">min_qt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">min_qt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_qt</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">min_qt</span> <span class="o">=</span> <span class="n">min_qt</span><span class="p">[:</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstMovement_times&#39;</span><span class="p">]</span>
    <span class="n">qevt_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;goCueTrigger_times&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">min_qt</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;response_times&#39;</span><span class="p">]</span>
    <span class="c1"># First movement time for each trial should be after the quiescent period and before feedback</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">qevt_start</span><span class="p">,</span> <span class="n">response</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">nogo</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">nogo</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># No go trial may have no movement times and that&#39;s fine</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="c1"># === Sequence of events checks ===</span>

<div class="viewcode-block" id="check_error_trial_event_sequence"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_error_trial_event_sequence">[docs]</a><span class="k">def</span> <span class="nf">check_error_trial_event_sequence</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that on incorrect / miss trials, there are exactly:</span>
<span class="sd">    2 audio events (go cue sound and error sound) and 2 Bpod events (trial start, ITI), occurring</span>
<span class="sd">    in the correct order</span>

<span class="sd">    Metric: M = Bpod (trial start) &gt; audio (go cue) &gt; audio (error) &gt; Bpod (ITI) &gt; Bpod (trial end)</span>
<span class="sd">    Criterion: M == True</span>
<span class="sd">    Units: -none-</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;errorCue_times&#39;, &#39;goCue_times&#39;, &#39;intervals&#39;,</span>
<span class="sd">    &#39;itiIn_times&#39;, &#39;correct&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># An array the length of N trials where True means at least one event time was NaN (bad)</span>
    <span class="n">nans</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">])</span>     <span class="o">|</span>  <span class="c1"># noqa</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;errorCue_times&quot;</span><span class="p">])</span>  <span class="o">|</span>  <span class="c1"># noqa</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">])</span>     <span class="o">|</span>  <span class="c1"># noqa</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># For each trial check that the events happened in the correct order (ignore NaN values)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># Start time &lt; go cue</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;errorCue_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># Go cue &lt; error cue</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;errorCue_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># Error cue &lt; ITI start</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># ITI start &lt; end time</span>

    <span class="c1"># For each trial check all events were in order AND all event times were not NaN</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nans</span>

    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Look only at incorrect trials</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_correct_trial_event_sequence"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_correct_trial_event_sequence">[docs]</a><span class="k">def</span> <span class="nf">check_correct_trial_event_sequence</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that on correct trials, there are exactly:</span>
<span class="sd">    1 audio events and 3 Bpod events (valve open, trial start, ITI), occurring in the correct order</span>

<span class="sd">    Metric: M = Bpod (trial start) &gt; audio (go cue) &gt; Bpod (valve) &gt; Bpod (ITI) &gt; Bpod (trial end)</span>
<span class="sd">    Criterion: M == True</span>
<span class="sd">    Units: -none-</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;valveOpen_times&#39;, &#39;goCue_times&#39;, &#39;intervals&#39;,</span>
<span class="sd">    &#39;itiIn_times&#39;, &#39;correct&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># An array the length of N trials where True means at least one event time was NaN (bad)</span>
    <span class="n">nans</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">])</span>     <span class="o">|</span>  <span class="c1"># noqa</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;valveOpen_times&quot;</span><span class="p">])</span> <span class="o">|</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">])</span>     <span class="o">|</span>  <span class="c1"># noqa</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># For each trial check that the events happened in the correct order (ignore NaN values)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># Start time &lt; go cue</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;valveOpen_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># Go cue &lt; feedback</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;valveOpen_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># Feedback &lt; ITI start</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;itiIn_times&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">where</span><span class="o">=~</span><span class="n">nans</span><span class="p">)</span>  <span class="c1"># ITI start &lt; end time</span>

    <span class="c1"># For each trial True means all events were in order AND all event times were not NaN</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">nans</span>

    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">passed</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Look only at correct trials</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_n_trial_events"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_n_trial_events">[docs]</a><span class="k">def</span> <span class="nf">check_n_trial_events</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the number events per trial is correct</span>
<span class="sd">    Within every trial interval there should be one of each trial event, except for</span>
<span class="sd">    goCueTrigger_times which should only be defined for incorrect trials</span>

<span class="sd">    Metric: M = all(start &lt; event &lt; end) for all event times except errorCueTrigger_times where</span>
<span class="sd">                start &lt; error_trigger &lt; end if not correct trial, else error_trigger == NaN</span>
<span class="sd">    Criterion: M == True</span>
<span class="sd">    Units: -none-, boolean</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;intervals&#39;, &#39;stimOnTrigger_times&#39;,</span>
<span class="sd">                 &#39;stimOffTrigger_times&#39;, &#39;stimOn_times&#39;, &#39;stimOff_times&#39;,</span>
<span class="sd">                 &#39;stimFreezeTrigger_times&#39;, &#39;errorCueTrigger_times&#39;, &#39;itiIn_times&#39;,</span>
<span class="sd">                 &#39;goCueTrigger_times&#39;, &#39;goCue_times&#39;, &#39;response_times&#39;, &#39;feedback_times&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">intervals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">]</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span>
    <span class="n">err_trig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;errorCueTrigger_times&#39;</span><span class="p">]</span>

    <span class="c1"># Exclude these fields; valve and errorCue times are the same as feedback_times and we must</span>
    <span class="c1"># test errorCueTrigger_times separately</span>
    <span class="c1"># stimFreeze_times fails often due to TTL flicker</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;camera_timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;errorCueTrigger_times&#39;</span><span class="p">,</span> <span class="s1">&#39;errorCue_times&#39;</span><span class="p">,</span>
               <span class="s1">&#39;firstMovement_times&#39;</span><span class="p">,</span> <span class="s1">&#39;peakVelocity_times&#39;</span><span class="p">,</span> <span class="s1">&#39;valveOpen_times&#39;</span><span class="p">,</span>
               <span class="s1">&#39;wheel_moves_peak_amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;wheel_moves_intervals&#39;</span><span class="p">,</span> <span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">,</span>
               <span class="s1">&#39;wheel_intervals&#39;</span><span class="p">,</span> <span class="s1">&#39;stimFreeze_times&#39;</span><span class="p">]</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_times&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># For each trial interval check that one of each trial event occurred.  For incorrect trials,</span>
    <span class="c1"># check the error cue trigger occurred within the interval, otherwise check it is nan.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intervals</span><span class="p">):</span>
        <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">events</span><span class="p">])</span> <span class="ow">and</span>
                     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">err_trig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">err_trig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">))</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">intervals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_trial_length"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_trial_length">[docs]</a><span class="k">def</span> <span class="nf">check_trial_length</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the onset of the go cue sound</span>
<span class="sd">    and the feedback (error sound or valve) is positive and smaller than 60.1 s.</span>

<span class="sd">    Metric: M = feedback_times - goCue_times</span>
<span class="sd">    Criteria: 0 &lt; M &lt; 60.1 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;feedback_times&#39;, &#39;goCue_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NaN values are usually ignored so replace them with Inf so they fail the threshold</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feedback_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;</span> <span class="mf">60.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="c1"># === Trigger-response delay checks ===</span>

<div class="viewcode-block" id="check_goCue_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_goCue_delays">[docs]</a><span class="k">def</span> <span class="nf">check_goCue_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the go cue sound being triggered and</span>
<span class="sd">    effectively played is smaller than 1ms.</span>

<span class="sd">    Metric: M = goCue_times - goCueTrigger_times</span>
<span class="sd">    Criterion: 0 &lt; M &lt;= 0.001 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;goCue_times&#39;, &#39;goCueTrigger_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCueTrigger_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mf">0.0015</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_errorCue_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_errorCue_delays">[docs]</a><span class="k">def</span> <span class="nf">check_errorCue_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the error sound being triggered and</span>
<span class="sd">    effectively played is smaller than 1ms.</span>
<span class="sd">    Metric: M = errorCue_times - errorCueTrigger_times</span>
<span class="sd">    Criterion: 0 &lt; M &lt;= 0.001 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;errorCue_times&#39;, &#39;errorCueTrigger_times&#39;,</span>
<span class="sd">    &#39;intervals&#39;, &#39;correct&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;errorCue_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;errorCueTrigger_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">((</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mf">0.0015</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_stimOn_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_stimOn_delays">[docs]</a><span class="k">def</span> <span class="nf">check_stimOn_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the visual stimulus onset-command being triggered</span>
<span class="sd">    and the stimulus effectively appearing on the screen is smaller than 150 ms.</span>

<span class="sd">    Metric: M = stimOn_times - stimOnTrigger_times</span>
<span class="sd">    Criterion: 0 &lt; M &lt; 0.150 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimOn_times&#39;, &#39;stimOnTrigger_times&#39;,</span>
<span class="sd">    &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOn_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOnTrigger_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_stimOff_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_stimOff_delays">[docs]</a><span class="k">def</span> <span class="nf">check_stimOff_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the visual stimulus offset-command</span>
<span class="sd">    being triggered and the visual stimulus effectively turning off on the screen</span>
<span class="sd">    is smaller than 150 ms.</span>

<span class="sd">    Metric: M = stimOff_times - stimOffTrigger_times</span>
<span class="sd">    Criterion: 0 &lt; M &lt; 0.150 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimOff_times&#39;, &#39;stimOffTrigger_times&#39;,</span>
<span class="sd">    &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOff_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimOffTrigger_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_stimFreeze_delays"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_stimFreeze_delays">[docs]</a><span class="k">def</span> <span class="nf">check_stimFreeze_delays</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the time difference between the visual stimulus freeze-command</span>
<span class="sd">    being triggered and the visual stimulus effectively freezing on the screen</span>
<span class="sd">    is smaller than 150 ms.</span>

<span class="sd">    Metric: M = stimFreeze_times - stimFreezeTrigger_times</span>
<span class="sd">    Criterion: 0 &lt; M &lt; 0.150 s</span>
<span class="sd">    Units: seconds [s]</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;stimFreeze_times&#39;, &#39;stimFreezeTrigger_times&#39;,</span>
<span class="sd">    &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimFreeze_times&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;stimFreezeTrigger_times&quot;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&lt;=</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="c1"># === Data integrity checks ===</span>

<div class="viewcode-block" id="check_reward_volumes"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_reward_volumes">[docs]</a><span class="k">def</span> <span class="nf">check_reward_volumes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the reward volume is between 1.5 and 3 uL for correct trials, 0 for incorrect.</span>

<span class="sd">    Metric: M = reward volume</span>
<span class="sd">    Criterion: 1.5 &lt;= M &lt;= 3 if correct else M == 0</span>
<span class="sd">    Units: uL</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;rewardVolume&#39;, &#39;correct&#39;, &#39;intervals&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rewardVolume&#39;</span><span class="p">]</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="c1"># Check correct trials within correct range</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">correct</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">&lt;=</span> <span class="n">metric</span><span class="p">[</span><span class="n">correct</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="n">correct</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">3.</span><span class="p">)</span>
    <span class="c1"># Check incorrect trials are 0</span>
    <span class="n">passed</span><span class="p">[</span><span class="o">~</span><span class="n">correct</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="o">~</span><span class="n">correct</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_reward_volume_set"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_reward_volume_set">[docs]</a><span class="k">def</span> <span class="nf">check_reward_volume_set</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that there is only two reward volumes within a session, one of which is 0.</span>

<span class="sd">    Metric: M = set(rewardVolume)</span>
<span class="sd">    Criterion: (0 &lt; len(M) &lt;= 2) and 0 in M</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;rewardVolume&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rewardVolume&quot;</span><span class="p">]</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mf">0.</span> <span class="ow">in</span> <span class="n">metric</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_wheel_integrity"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_wheel_integrity">[docs]</a><span class="k">def</span> <span class="nf">check_wheel_integrity</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">re_encoding</span><span class="o">=</span><span class="s1">&#39;X1&#39;</span><span class="p">,</span> <span class="n">enc_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that the difference between wheel position samples is close to the encoder resolution</span>
<span class="sd">    and that the wheel timestamps strictly increase.</span>

<span class="sd">    Note: At high velocities some samples are missed due to the scanning frequency of the DAQ.</span>
<span class="sd">    This checks for more than 1 missing sample in a row (i.e. the difference between samples &gt;= 2)</span>

<span class="sd">    Metric: M = (absolute difference of the positions &lt; 1.5 * encoder resolution)</span>
<span class="sd">                 + 1 if (difference of timestamps &lt;= 0) else 0</span>
<span class="sd">    Criterion: M  ~= 0</span>
<span class="sd">    Units: arbitrary (radians, sometimes + 1)</span>

<span class="sd">    :param data: dict of wheel data with keys (&#39;wheel_timestamps&#39;, &#39;wheel_position&#39;)</span>
<span class="sd">    :param re_encoding: the encoding of the wheel data, X1, X2 or X4</span>
<span class="sd">    :param enc_res: the rotary encoder resolution (default 1024 ticks per revolution)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">re_encoding</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">re_encoding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re_encoding</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># The expected difference between samples in the extracted units</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">enc_res</span> <span class="ow">or</span> <span class="n">ephys_fpga</span><span class="o">.</span><span class="n">WHEEL_TICKS</span>
                      <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ephys_fpga</span><span class="o">.</span><span class="n">WHEEL_RADIUS_CM</span> <span class="o">/</span> <span class="n">re_encoding</span>
    <span class="c1"># We expect the difference of neighbouring positions to be close to the resolution</span>
    <span class="n">pos_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel_position&#39;</span><span class="p">]))</span>
    <span class="c1"># Timestamps should be strictly increasing</span>
    <span class="n">ts_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">0.</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">pos_check</span> <span class="o">+</span> <span class="n">ts_check</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># all values should be close to zero</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span> <span class="o">&lt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">resolution</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<span class="c1"># === Pre-stimulus checks ===</span>
<div class="viewcode-block" id="check_stimulus_move_before_goCue"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_stimulus_move_before_goCue">[docs]</a><span class="k">def</span> <span class="nf">check_stimulus_move_before_goCue</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">photodiode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that there are no visual stimulus change(s) between the start of the trial and the</span>
<span class="sd">    go cue sound onset - 20 ms.</span>

<span class="sd">    Metric: M = number of visual stimulus change events between trial start and goCue_times - 20ms</span>
<span class="sd">    Criterion: M == 0</span>
<span class="sd">    Units: -none-, integer</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;goCue_times&#39;, &#39;intervals&#39;, &#39;choice&#39;)</span>
<span class="sd">    :param photodiode: the fronts from Bpod&#39;s BNC1 input or FPGA frame2ttl channel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">photodiode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No photodiode TTL input in function call, returning None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">photodiode_clean</span> <span class="o">=</span> <span class="n">ephys_fpga</span><span class="o">.</span><span class="n">_clean_frame2ttl</span><span class="p">(</span><span class="n">photodiode</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">photodiode_clean</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>  <span class="c1"># Remove NaNs</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">]):</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="mf">0.02</span><span class="p">)))</span>

    <span class="n">passed</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Remove no go trials</span>
    <span class="n">passed</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>


<div class="viewcode-block" id="check_audio_pre_trial"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.task_metrics.html#ibllib.qc.task_metrics.check_audio_pre_trial">[docs]</a><span class="k">def</span> <span class="nf">check_audio_pre_trial</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">audio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that there are no audio outputs between the start of the trial and the</span>
<span class="sd">    go cue sound onset - 20 ms.</span>

<span class="sd">    Metric: M = sum(start_times &lt; audio TTL &lt; (goCue_times - 20ms))</span>
<span class="sd">    Criterion: M == 0</span>
<span class="sd">    Units: -none-, integer</span>

<span class="sd">    :param data: dict of trial data with keys (&#39;goCue_times&#39;, &#39;intervals&#39;)</span>
<span class="sd">    :param audio: the fronts from Bpod&#39;s BNC2 input FPGA audio sync channel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">audio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No BNC2 input in function call, retuning None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">audio</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">])]</span>  <span class="c1"># Audio TTLs with NaNs removed</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;goCue_times&quot;</span><span class="p">]):</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="mf">0.02</span><span class="p">)))</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="n">metric</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">,</span> <span class="n">passed</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>