<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibllib.qc.camera &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DataJoint</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dj_docs/dj_introduction.html">Introduction to DataJoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dj_docs/dj_public.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dj_docs/dj_credentials.html">DataJoint credentials for internal IBL users</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../06_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/dj_intro/dj_intro.html">Datajoint Introductory Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/dj_basics/dj_basics.html">Exploring the IBL Data Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Detailed Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>ibllib.qc.camera</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibllib.qc.camera</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Camera QC</span>
<span class="sd">This module runs a list of quality control metrics on the camera and extracted video data.</span>

<span class="sd">Example - Run right camera QC, downloading all but video file</span>
<span class="sd">    qc = CameraQC(eid, &#39;right&#39;, download_data=True, stream=True)</span>
<span class="sd">    qc.run()</span>

<span class="sd">Example - Run left camera QC with session path, update QC field in Alyx</span>
<span class="sd">    qc = CameraQC(session_path, &#39;left&#39;)</span>
<span class="sd">    outcome, extended = qc.run(update=True)  # Returns outcome of videoQC only</span>
<span class="sd">    print(f&#39;video QC = {outcome}; overall session QC = {qc.outcome}&#39;)  # NB difference outcomes</span>

<span class="sd">Example - Run only video QC (no timestamp/alignment checks) on 20 frames for the body camera</span>
<span class="sd">    qc = CameraQC(eid, &#39;body&#39;, n_samples=20)</span>
<span class="sd">    qc.load_video_data()  # Quicker than loading all data</span>
<span class="sd">    qc.run()</span>

<span class="sd">Example - Run specific video QC check and display the plots</span>
<span class="sd">    qc = CameraQC(eid, &#39;left;)</span>
<span class="sd">    qc.load_data(download_data=True)</span>
<span class="sd">    qc.check_position(display=True)  # NB: Not all checks make plots</span>

<span class="sd">Example - Run the QC for all cameras</span>
<span class="sd">    qcs = run_all_qc(eid)</span>
<span class="sd">    qcs[&#39;left&#39;].metrics  # Dict of checks and outcomes for left camera</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span><span class="p">,</span> <span class="n">isfunction</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>

<span class="kn">import</span> <span class="nn">one.alf.io</span> <span class="k">as</span> <span class="nn">alfio</span>
<span class="kn">from</span> <span class="nn">one.util</span> <span class="kn">import</span> <span class="n">filter_datasets</span>
<span class="kn">from</span> <span class="nn">one.alf.spec</span> <span class="kn">import</span> <span class="n">is_session_path</span>
<span class="kn">from</span> <span class="nn">one.alf.exceptions</span> <span class="kn">import</span> <span class="n">ALFObjectNotFound</span>
<span class="kn">from</span> <span class="nn">iblutil.util</span> <span class="kn">import</span> <span class="n">Bunch</span>
<span class="kn">from</span> <span class="nn">iblutil.numerical</span> <span class="kn">import</span> <span class="n">within_ranges</span>

<span class="kn">from</span> <span class="nn">ibllib.io.extractors.camera</span> <span class="kn">import</span> <span class="n">extract_camera_sync</span><span class="p">,</span> <span class="n">extract_all</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors</span> <span class="kn">import</span> <span class="n">ephys_fpga</span><span class="p">,</span> <span class="n">training_wheel</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.video_motion</span> <span class="kn">import</span> <span class="n">MotionAlignment</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.base</span> <span class="kn">import</span> <span class="n">get_session_extractor_type</span>
<span class="kn">from</span> <span class="nn">ibllib.io</span> <span class="kn">import</span> <span class="n">raw_data_loaders</span> <span class="k">as</span> <span class="n">raw</span>
<span class="kn">import</span> <span class="nn">brainbox.behavior.wheel</span> <span class="k">as</span> <span class="nn">wh</span>
<span class="kn">from</span> <span class="nn">ibllib.io.video</span> <span class="kn">import</span> <span class="n">get_video_meta</span><span class="p">,</span> <span class="n">get_video_frames_preload</span><span class="p">,</span> <span class="n">assert_valid_label</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ibllib&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="CameraQC"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC">[docs]</a><span class="k">class</span> <span class="nc">CameraQC</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">QC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for computing camera QC metrics&quot;&quot;&quot;</span>
    <span class="n">dstypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;_iblrig_Camera.frame_counter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_iblrig_Camera.GPIO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_iblrig_Camera.timestamps&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_iblrig_taskData.raw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_iblrig_taskSettings.raw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_iblrig_Camera.raw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;camera.times&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wheel.position&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wheel.timestamps&#39;</span>
    <span class="p">]</span>
    <span class="n">dstypes_fpga</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;_spikeglx_sync.channels&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_spikeglx_sync.polarities&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_spikeglx_sync.times&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ephysData.raw.meta&#39;</span>
    <span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Recall that for the training rig there is only one side camera at 30 Hz and 1280 x 1024 px.</span>
<span class="sd">    For the recording rig there are two label cameras (left: 60 Hz, 1280 x 1024 px;</span>
<span class="sd">    right: 150 Hz, 640 x 512 px) and one body camera (30 Hz, 640 x 512 px). &quot;&quot;&quot;</span>
    <span class="n">video_meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;training&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;fps&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;ephys&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;fps&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">},</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;fps&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">},</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;fps&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path_or_eid</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param session_path_or_eid: A session id or path</span>
<span class="sd">        :param camera: The camera to run QC on, if None QC is run for all three cameras</span>
<span class="sd">        :param n_samples: The number of frames to sample for the position and brightness QC</span>
<span class="sd">        :param stream: If true and local video files not available, the data are streamed from</span>
<span class="sd">        the remote source.</span>
<span class="sd">        :param log: A logging.Logger instance, if None the &#39;ibllib&#39; logger is used</span>
<span class="sd">        :param one: An ONE instance for fetching and setting the QC on Alyx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># When an eid is provided, we will download the required data by default (if necessary)</span>
        <span class="n">download_data</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_session_path</span><span class="p">(</span><span class="n">session_path_or_eid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;download_data&#39;</span><span class="p">,</span> <span class="n">download_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_samples&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path_or_eid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">assert_valid_label</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_iblrig_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">Camera.raw*.mp4&#39;</span>
        <span class="n">raw_video_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;raw_video_data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">raw_video_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If local video doesn&#39;t exist, change video path to URL</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">path2url</span><span class="p">(</span><span class="n">raw_video_path</span> <span class="o">/</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">StopIteration</span><span class="p">,</span> <span class="n">ALFObjectNotFound</span><span class="p">):</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No remote or local video file found&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">get_session_extractor_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;pin_state&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">,</span> <span class="s1">&#39;fpga_times&#39;</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span>
                <span class="s1">&#39;frame_samples&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;camera_times&#39;</span><span class="p">,</span> <span class="s1">&#39;bonsai_times&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">Bunch</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_samples_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># QC outcomes map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;NOT_SET&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the camera type based on the protocol.</span>
<span class="sd">        :return: Returns either None, &#39;ephys&#39; or &#39;training&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ephys&#39;</span> <span class="k">if</span> <span class="s1">&#39;ephys&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="k">else</span> <span class="s1">&#39;training&#39;</span>

<div class="viewcode-block" id="CameraQC.load_data"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">extract_times</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extract the data from raw data files</span>
<span class="sd">        Extracts all the required task data from the raw data files.</span>

<span class="sd">        Data keys:</span>
<span class="sd">            - count (int array): the sequential frame number (n, n+1, n+2...)</span>
<span class="sd">            - pin_state (): the camera GPIO pin; records the audio TTLs; should be one per frame</span>
<span class="sd">            - audio (float array): timestamps of audio TTL fronts</span>
<span class="sd">            - fpga_times (float array): timestamps of camera TTLs recorded by FPGA</span>
<span class="sd">            - timestamps (float array): extracted video timestamps (the camera.times ALF)</span>
<span class="sd">            - bonsai_times (datetime array): system timestamps of video PC; should be one per frame</span>
<span class="sd">            - camera_times (float array): camera frame timestamps extracted from frame headers</span>
<span class="sd">            - wheel (Bunch): rotary encoder timestamps, position and period used for wheel motion</span>
<span class="sd">            - video (Bunch): video meta data, including dimensions and FPS</span>
<span class="sd">            - frame_samples (h x w x n array): array of evenly sampled frames (1 colour channel)</span>

<span class="sd">        :param download_data: if True, any missing raw data is downloaded via ONE.</span>
<span class="sd">        Missing data will raise an AssertionError</span>
<span class="sd">        :param extract_times: if True, the camera.times are re-extracted from the raw data</span>
<span class="sd">        :param load_video: if True, calls the load_video_data method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="s1">&#39;no session path set&#39;</span>
        <span class="k">if</span> <span class="n">download_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span> <span class="o">=</span> <span class="n">download_data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">offline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_required_data</span><span class="p">()</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Gathering data for QC&#39;</span><span class="p">)</span>

        <span class="c1"># Get frame count and pin state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pin_state&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">raw</span><span class="o">.</span><span class="n">load_embedded_frame_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Load the audio and raw FPGA times</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;ephys&#39;</span><span class="p">:</span>
            <span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span> <span class="o">=</span> <span class="n">ephys_fpga</span><span class="o">.</span><span class="n">get_main_probe_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span>
            <span class="n">audio_ttls</span> <span class="o">=</span> <span class="n">ephys_fpga</span><span class="o">.</span><span class="n">get_sync_fronts</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_ttls</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span>  <span class="c1"># Get rises</span>
            <span class="c1"># Load raw FPGA times</span>
            <span class="n">cam_ts</span> <span class="o">=</span> <span class="n">extract_camera_sync</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fpga_times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam_ts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bpod_data</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">audio_ttls</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">load_bpod_fronts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="n">bpod_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_ttls</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span>

        <span class="c1"># Load extracted frame times</span>
        <span class="n">alf_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="o">/</span> <span class="s1">&#39;alf&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">extract_times</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alfio</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span>
                <span class="n">alf_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">Camera&#39;</span><span class="p">,</span> <span class="n">short_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>  <span class="c1"># Re-extract</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_path</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;ephys&#39;</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;sync&#39;</span><span class="p">:</span> <span class="n">sync</span><span class="p">,</span> <span class="s1">&#39;chmap&#39;</span><span class="p">:</span> <span class="n">chmap</span><span class="p">}</span>  <span class="c1"># noqa</span>
            <span class="n">outputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">_camera_timestamps&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">ALFObjectNotFound</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no camera.times ALF found for session&#39;</span><span class="p">)</span>

        <span class="c1"># Get audio and wheel data</span>
        <span class="n">wheel_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alfio</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">alf_path</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="n">short_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ALFObjectNotFound</span><span class="p">:</span>
            <span class="c1"># Extract from raw data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;ephys&#39;</span><span class="p">:</span>
                <span class="n">wheel_data</span> <span class="o">=</span> <span class="n">ephys_fpga</span><span class="o">.</span><span class="n">extract_wheel_sync</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wheel_data</span> <span class="o">=</span> <span class="n">training_wheel</span><span class="o">.</span><span class="n">get_wheel_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">wheel_keys</span><span class="p">,</span> <span class="n">wheel_data</span><span class="p">))</span>

        <span class="c1"># Find short period of wheel motion for motion correlation.</span>
        <span class="k">if</span> <span class="n">data_for_keys</span><span class="p">(</span><span class="n">wheel_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_wheel_period</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">])</span>

        <span class="c1"># Load Bonsai frame timestamps</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssv_times</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">load_camera_ssv_times</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bonsai_times&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;camera_times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssv_times</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No Bonsai video timestamps file found&#39;</span><span class="p">)</span>

        <span class="c1"># Gather information from video file</span>
        <span class="k">if</span> <span class="n">load_video</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inspecting video file...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_video_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="CameraQC.load_video_data"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.load_video_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_video_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get basic properties of video</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_video_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_path</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
            <span class="c1"># Sample some frames from the video file</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_samples_idx</span> <span class="o">=</span> <span class="n">indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_video_frames_preload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_path</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span>
                                                                  <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to read video file; setting outcome to CRITICAL&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outcome</span> <span class="o">=</span> <span class="s1">&#39;CRITICAL&#39;</span></div>

<div class="viewcode-block" id="CameraQC.get_active_wheel_period"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.get_active_wheel_period">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_active_wheel_period</span><span class="p">(</span><span class="n">wheel</span><span class="p">,</span> <span class="n">duration_range</span><span class="o">=</span><span class="p">(</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to find a period of movement where the wheel accelerates and decelerates for</span>
<span class="sd">        the wheel motion alignment QC.</span>
<span class="sd">        :param wheel: A Bunch of wheel timestamps and position data</span>
<span class="sd">        :param duration_range: The candidates must be within min/max duration range</span>
<span class="sd">        :param display: If true, plot the selected wheel movement</span>
<span class="sd">        :return: 2-element array comprising the start and end times of the active period</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">interpolate_position</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">v</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">velocity_smoothed</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">on</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">movements</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">pos_thresh</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">on</span><span class="p">,</span> <span class="n">off</span><span class="p">]</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">duration_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">duration_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No period of wheel movement found for motion alignment.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Pick movement somewhere in the middle</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ts</span> <span class="o">&gt;</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">acc</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="CameraQC.ensure_required_data"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.ensure_required_data">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_required_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures the datasets required for QC are local.  If the download_data attribute is True,</span>
<span class="sd">        any missing data are downloaded.  If all the data are not present locally at the end of</span>
<span class="sd">        it an exception is raised.  If the stream attribute is True, the video file is not</span>
<span class="sd">        required to be local, however it must be remotely accessible.</span>
<span class="sd">        NB: Requires a valid instance of ONE and a valid session eid.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ONE required to download data&#39;</span>
        <span class="c1"># dataset collections outside this list are ignored (e.g. probe00, raw_passive_data)</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_ephys_data&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_video_data&#39;</span><span class="p">)</span>
        <span class="c1"># Get extractor type</span>
        <span class="n">is_ephys</span> <span class="o">=</span> <span class="s1">&#39;ephys&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">)[</span><span class="s1">&#39;task_protocol&#39;</span><span class="p">])</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dstypes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dstypes_fpga</span> <span class="k">if</span> <span class="n">is_ephys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dstypes</span>
        <span class="n">assert_unique</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Check we have raw ephys data for session</span>
        <span class="k">if</span> <span class="n">is_ephys</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;raw_ephys_data&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Assert 3A probe model; if so download all probe data</span>
            <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">probe_model</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">det</span><span class="p">[</span><span class="s1">&#39;probe_insertion&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">probe_model</span> <span class="o">==</span> <span class="s1">&#39;3A&#39;</span><span class="p">,</span> <span class="s1">&#39;raw ephys data missing&#39;</span>
            <span class="n">collections</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;raw_ephys_data/probe00&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_ephys_data/probe01&#39;</span><span class="p">)</span>
            <span class="n">assert_unique</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">dstype</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">:</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">type2datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">dstype</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;camera&#39;</span> <span class="ow">in</span> <span class="n">dstype</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>  <span class="c1"># Download individual camera file</span>
                <span class="n">datasets</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.*</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">.*&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Ignore probe datasets, etc.</span>
                <span class="n">datasets</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="n">collections</span><span class="p">,</span>
                                           <span class="n">assert_unique</span><span class="o">=</span><span class="n">assert_unique</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">rel_path</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
                <span class="k">assert</span> <span class="sa">f</span><span class="s1">&#39;_iblrig_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">Camera.raw.mp4&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">,</span> <span class="s1">&#39;No remote video file found&#39;</span>
                <span class="k">continue</span>
            <span class="n">optional</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;camera.times&#39;</span><span class="p">,</span> <span class="s1">&#39;_iblrig_Camera.raw&#39;</span><span class="p">,</span> <span class="s1">&#39;wheel.position&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;wheel.timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;_iblrig_Camera.frame_counter&#39;</span><span class="p">,</span> <span class="s1">&#39;_iblrig_Camera.GPIO&#39;</span><span class="p">)</span>
            <span class="n">present</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span>
                <span class="k">else</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="n">required</span> <span class="o">=</span> <span class="p">(</span><span class="n">dstype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optional</span><span class="p">)</span>
            <span class="n">all_present</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">datasets</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">present</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">all_present</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">required</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Dataset </span><span class="si">{</span><span class="n">dstype</span><span class="si">}</span><span class="s1"> not found&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">get_session_extractor_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="CameraQC.run"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run video QC checks and return outcome</span>
<span class="sd">        :param update: if True, updates the session QC fields on Alyx</span>
<span class="sd">        :param download_data: if True, downloads any missing data if required</span>
<span class="sd">        :param extract_times: if True, re-extracts the camera timestamps from the raw data</span>
<span class="sd">        :returns: overall outcome as a str, a dict of checks and their outcomes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computing QC outcome for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> camera, session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;video</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No timestamps for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> camera; setting outcome to CRITICAL&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">is_metric</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;check_&#39;</span><span class="p">)</span>

        <span class="n">checks</span> <span class="o">=</span> <span class="n">getmembers</span><span class="p">(</span><span class="n">CameraQC</span><span class="p">,</span> <span class="n">is_metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s1">_&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">6</span><span class="p">:]:</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">}</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">CRITERIA</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">CRITERIA</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">extended</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;NOT_SET&#39;</span>
                <span class="k">else</span> <span class="n">base</span><span class="o">.</span><span class="n">CRITERIA</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">CRITERIA</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># Convert first value to bool if array</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_extended_qc</span><span class="p">(</span><span class="n">extended</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outcome</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span></div>

<div class="viewcode-block" id="CameraQC.check_brightness"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_brightness">[docs]</a>    <span class="k">def</span> <span class="nf">check_brightness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">max_std</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the video brightness is within a given range</span>
<span class="sd">        The mean brightness of each frame must be with the bounds provided, and the standard</span>
<span class="sd">        deviation across samples frames should be less then the given value.  Assumes that the</span>
<span class="sd">        frame samples are 2D (no colour channels).</span>

<span class="sd">        :param bounds: For each frame, check that: bounds[0] &lt; M &lt; bounds[1],</span>
<span class="sd">        where M = mean(frame). If less than 75% of sample frames outside of these bounds, the</span>
<span class="sd">        outcome is WARNING. If &lt;75% of frames within twice the bounds, the outcome is FAIL.</span>
<span class="sd">        :param max_std: The standard deviation of the frame luminance means must be less than this</span>
<span class="sd">        :param roi: If True, check brightness on ROI of frame</span>
<span class="sd">        :param display: When True the mean frame luminance is plotted against sample frames.</span>
<span class="sd">        The sample frames with the lowest and highest mean luminance are shown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span>  <span class="c1"># Latter half</span>
                <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>  <span class="c1"># Top left quadrant (~2/3, 1/2 height)</span>
                <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="mf">.66</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Top right quadrant (~2/3 width, 1/2 height)</span>
                <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="mf">.66</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">brightness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># dims = self.data[&#39;frame_samples&#39;].shape</span>
        <span class="c1"># brightness /= np.array((*dims[1:], 255)).prod()  # Normalize</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_samples_idx</span>
            <span class="c1"># Plot mean frame luminance</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;brightness&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;frame #&#39;</span><span class="p">,</span>
                <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;brightness (mean pixel)&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Brightness&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;warning bounds&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;failure bounds&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="c1"># Plot min-max frames</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">brightness</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">brightness</span><span class="p">))):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">brightness</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span>  <span class="c1"># this is the point to label</span>
                            <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; mean luminance = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">brightness</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="n">PCT_PASS</span> <span class="o">=</span> <span class="mf">.75</span>  <span class="c1"># Proportion of sample frames that must pass</span>
        <span class="c1"># Warning if brightness not within range (3/4 of frames must be between bounds)</span>
        <span class="n">warn_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">brightness</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">warn_range</span> <span class="o">=</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">warn_range</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">&gt;</span> <span class="n">PCT_PASS</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span>
        <span class="c1"># Fail if brightness not within twice the range or std less than threshold</span>
        <span class="n">fail_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">brightness</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">within_range</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fail_range</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">&gt;</span> <span class="n">PCT_PASS</span>
        <span class="n">fail_range</span> <span class="o">=</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">within_range</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">brightness</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_std</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_outcome</span><span class="p">([</span><span class="n">warn_range</span><span class="p">,</span> <span class="n">fail_range</span><span class="p">])</span></div>

<div class="viewcode-block" id="CameraQC.check_file_headers"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_file_headers">[docs]</a>    <span class="k">def</span> <span class="nf">check_file_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check reported frame rate matches FPGA frame rate&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_meta</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">][</span><span class="s1">&#39;fps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;fps&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span></div>

<div class="viewcode-block" id="CameraQC.check_framerate"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_framerate">[docs]</a>    <span class="k">def</span> <span class="nf">check_framerate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check camera times match specified frame rate for camera</span>

<span class="sd">        :param threshold: The maximum absolute difference between timestamp sample rate and video</span>
<span class="sd">        frame rate.  NB: Does not take into account dropped frames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_meta</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;fps&#39;</span><span class="p">]</span>
        <span class="n">Fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]))</span>  <span class="c1"># Approx. frequency of camera</span>
        <span class="k">return</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fs</span> <span class="o">-</span> <span class="n">fps</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">Fs</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span></div>

<div class="viewcode-block" id="CameraQC.check_pin_state"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_pin_state">[docs]</a>    <span class="k">def</span> <span class="nf">check_pin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the pin state reflects Bpod TTLs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_for_keys</span><span class="p">((</span><span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;pin_state&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">size_diff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pin_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
        <span class="c1"># NB: The pin state to be high for 2 consecutive frames</span>
        <span class="n">low2high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pin_state&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># NB: Time between two consecutive TTLs can be sub-frame, so this will fail</span>
        <span class="n">ndiff_low2high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">low2high</span><span class="p">))</span>
        <span class="n">state_ttl_matches</span> <span class="o">=</span> <span class="n">ndiff_low2high</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="c1"># Check within ms of audio times</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">low2high</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">low2high</span><span class="p">)),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GPIO Low -&gt; High&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Audio TTL High&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;FPGA frame times / s&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticklabels</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_outcome</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">size_diff</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">size_diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">,</span>
             <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">state_ttl_matches</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">ndiff_low2high</span><span class="p">,</span> <span class="n">size_diff</span></div>

<div class="viewcode-block" id="CameraQC.check_dropped_frames"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_dropped_frames">[docs]</a>    <span class="k">def</span> <span class="nf">check_dropped_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check how many frames were reported missing</span>

<span class="sd">        :param threshold: The maximum allowable percentage of dropped frames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_for_keys</span><span class="p">((</span><span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">size_diff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
        <span class="n">strict_increase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_increase</span><span class="p">:</span>
            <span class="n">n_effected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">strict_increase</span><span class="p">))</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frame count not strictly increasing: &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_effected</span><span class="si">}</span><span class="s1"> frames effected (</span><span class="si">{</span><span class="n">n_effected</span> <span class="o">/</span> <span class="n">strict_increase</span><span class="o">.</span><span class="n">size</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;CRITICAL&#39;</span>
        <span class="n">dropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">pct_dropped</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dropped</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Calculate overall outcome for this check</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_outcome</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">size_diff</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">size_diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">,</span>
             <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">pct_dropped</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">outcome</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dropped</span><span class="p">)),</span> <span class="n">size_diff</span></div>

<div class="viewcode-block" id="CameraQC.check_timestamps"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_timestamps">[docs]</a>    <span class="k">def</span> <span class="nf">check_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the camera.times array is reasonable&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_for_keys</span><span class="p">((</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="c1"># Check frame rate matches what we expect</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;fps&#39;</span><span class="p">]</span>
        <span class="c1"># TODO Remove dropped frames from test</span>
        <span class="n">frame_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
        <span class="n">fps_matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frame_delta</span><span class="p">),</span> <span class="n">expected</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="c1"># Check number of timestamps matches video</span>
        <span class="n">length_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
        <span class="c1"># Check times are strictly increasing</span>
        <span class="n">increasing</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Check times do not contain nans</span>
        <span class="n">nanless</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">increasing</span> <span class="ow">and</span> <span class="n">fps_matches</span> <span class="ow">and</span> <span class="n">length_matches</span> <span class="ow">and</span> <span class="n">nanless</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span></div>

<div class="viewcode-block" id="CameraQC.check_camera_times"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_camera_times">[docs]</a>    <span class="k">def</span> <span class="nf">check_camera_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the number of raw camera timestamps matches the number of video frames&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_for_keys</span><span class="p">((</span><span class="s1">&#39;bonsai_times&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">length_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;camera_times&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">length_match</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span>
        <span class="c1"># 1 / np.median(np.diff(self.data.camera_times))</span>
        <span class="k">return</span> <span class="n">outcome</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;camera_times&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span></div>

<div class="viewcode-block" id="CameraQC.check_resolution"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">check_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the timestamps and video file resolution match what we expect&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">actual</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">actual</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span></div>

<div class="viewcode-block" id="CameraQC.check_wheel_alignment"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_wheel_alignment">[docs]</a>    <span class="k">def</span> <span class="nf">check_wheel_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check wheel motion in video correlates with the rotary encoder signal</span>

<span class="sd">        Check is skipped for body camera videos as the wheel is often obstructed</span>

<span class="sd">        :param tolerance: maximum absolute offset in frames.  If two values, the maximum value</span>
<span class="sd">        is taken as the warning threshold</span>
<span class="sd">        :param display: if true, the wheel motion energy is plotted against the rotary encoder</span>
<span class="sd">        :returns: outcome string, frame offset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wheel_present</span> <span class="o">=</span> <span class="n">data_for_keys</span><span class="p">((</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wheel_present</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>

        <span class="c1"># Check the selected wheel movement period occurred within camera timestamp time</span>
        <span class="n">camera_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>
        <span class="n">in_range</span> <span class="o">=</span> <span class="n">within_ranges</span><span class="p">(</span><span class="n">camera_times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_range</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Check if any camera timestamps overlap with the wheel times</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">camera_times</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">camera_times</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to check wheel alignment: &#39;</span>
                             <span class="s1">&#39;chosen movement is not during video&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No overlap, return fail</span>
                <span class="k">return</span> <span class="s1">&#39;FAIL&#39;</span>
        <span class="n">aln</span> <span class="o">=</span> <span class="n">MotionAlignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">session_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span>
        <span class="n">aln</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aln</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;camera_times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="n">camera_times</span><span class="p">}</span>
        <span class="n">aln</span><span class="o">.</span><span class="n">video_paths</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span><span class="p">}</span>
        <span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">aln</span><span class="o">.</span><span class="n">align_motion</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wheel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">period</span><span class="p">,</span>
                                      <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">aln</span><span class="o">.</span><span class="n">plot_alignment</span><span class="p">()</span>

        <span class="c1"># Determine the outcome.  If there are two values for the tolerance, one is taken to be</span>
        <span class="c1"># a warning threshold, the other a failure threshold.</span>
        <span class="n">out_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;PASS&#39;</span><span class="p">}</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tolerance</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out_map</span><span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">passed</span><span class="p">)],</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span></div>

<div class="viewcode-block" id="CameraQC.check_position"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_position">[docs]</a>    <span class="k">def</span> <span class="nf">check_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="n">pos_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                       <span class="n">metric</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCOEFF_NORMED</span><span class="p">,</span>
                       <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pct_thresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check camera is positioned correctly</span>
<span class="sd">        For the template matching zero-normalized cross-correlation (default) should be more</span>
<span class="sd">        robust to exposure (which we&#39;re not checking here).  The L2 norm (TM_SQDIFF) should</span>
<span class="sd">        also work.</span>

<span class="sd">        If display is True, the template ROI (pick hashed) is plotted over a video frame,</span>
<span class="sd">        along with the threshold regions (green solid).  The histogram correlations are plotted</span>
<span class="sd">        and the full histogram is plotted for one of the sample frames and the reference frame.</span>

<span class="sd">        :param hist_thresh: The minimum histogram cross-correlation threshold to pass (0-1).</span>
<span class="sd">        :param pos_thresh: The maximum number of pixels off that the template matcher may be off</span>
<span class="sd">         by. If two values are provided, the lower threshold is treated as a warning boundary.</span>
<span class="sd">        :param metric: The metric to use for template matching.</span>
<span class="sd">        :param display: If true, the results are plotted</span>
<span class="sd">        :param test: If true a reference frame instead of the frames in frame_samples.</span>
<span class="sd">        :param roi: A tuple of indices for the face template in the for ((y1, y2), (x1, x2))</span>
<span class="sd">        :param pct_thresh: If true, the thresholds are treated as percentages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="c1"># ensure iterable</span>
        <span class="n">pos_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_thresh</span><span class="p">))</span>
        <span class="n">hist_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hist_thresh</span><span class="p">))</span>

        <span class="c1"># Method 1: compareHist</span>
        <span class="c1">#### Mean hist comparison</span>
        <span class="c1"># ref_h = [cv2.calcHist([x], [0], None, [256], [0, 256]) for x in refs]</span>
        <span class="c1"># ref_h = np.array(ref_h).mean(axis=0)</span>
        <span class="c1"># frames = refs if test else self.data[&#39;frame_samples&#39;]</span>
        <span class="c1"># hists = [cv2.calcHist([x], [0], None, [256], [0, 256]) for x in frames]</span>
        <span class="c1"># test_h = np.array(hists).mean(axis=0)</span>
        <span class="c1"># corr = cv2.compareHist(test_h, ref_h, cv2.HISTCMP_CORREL)</span>
        <span class="c1"># if pct_thresh:</span>
        <span class="c1">#     corr *= 100</span>
        <span class="c1"># hist_passed = corr &gt; hist_thresh</span>
        <span class="c1">####</span>
        <span class="n">ref_h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcHist</span><span class="p">([</span><span class="n">refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">refs</span> <span class="k">if</span> <span class="n">test</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span>
        <span class="n">hists</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">calcHist</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cv2</span><span class="o">.</span><span class="n">compareHist</span><span class="p">(</span><span class="n">test_h</span><span class="p">,</span> <span class="n">ref_h</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HISTCMP_CORREL</span><span class="p">)</span> <span class="k">for</span> <span class="n">test_h</span> <span class="ow">in</span> <span class="n">hists</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pct_thresh</span><span class="p">:</span>
            <span class="n">corr</span> <span class="o">*=</span> <span class="mi">100</span>
        <span class="n">hist_passed</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">corr</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hist_thresh</span><span class="p">]</span>

        <span class="c1"># Method 2:</span>
        <span class="n">top_left</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_face</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">refs</span><span class="o">=</span><span class="n">refs</span><span class="p">)</span>
        <span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="n">roi</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top_left</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">pct_thresh</span><span class="p">:</span>  <span class="c1"># Threshold as percent</span>
            <span class="c1"># t_x, t_y = pct_thresh</span>
            <span class="n">err_pct</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))]</span>
            <span class="n">face_passed</span> <span class="o">=</span> <span class="p">[</span><span class="nb">all</span><span class="p">(</span><span class="n">err_pct</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pos_thresh</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">face_passed</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pos_thresh</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="c1"># Plot frame with template overlay</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pct_thresh</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">),</span> <span class="n">pos_thresh</span><span class="p">):</span>
                    <span class="n">t_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">thresh</span>
                    <span class="n">t_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">thresh</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">t_x</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">t_y</span><span class="p">)</span>
                    <span class="n">ax0</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
                                            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">),</span> <span class="n">pos_thresh</span><span class="p">):</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">thresh</span><span class="p">)</span>
                    <span class="n">ax0</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="p">(</span><span class="n">thresh</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="p">(</span><span class="n">thresh</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
                                            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">,</span>
                                    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="c1"># Plot the image histograms</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ref_h</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;reference frame&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hists</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mean frame&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="c1"># Plot the correlations for each sample frame</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;hist correlation&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">hist_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fail threshold&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">hist_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pass threshold&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Sample Frame #&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Hist correlation&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check position&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">pass_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s1">&#39;FAIL&#39;</span><span class="p">,</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="s1">&#39;PASS&#39;</span><span class="p">))}</span>
        <span class="n">face_aligned</span> <span class="o">=</span> <span class="n">pass_map</span><span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">face_passed</span><span class="p">)]</span>
        <span class="n">hist_correlates</span> <span class="o">=</span> <span class="n">pass_map</span><span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">hist_passed</span><span class="p">)]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_outcome</span><span class="p">([</span><span class="n">face_aligned</span><span class="p">,</span> <span class="n">hist_correlates</span><span class="p">],</span> <span class="n">agg</span><span class="o">=</span><span class="nb">min</span><span class="p">)</span></div>

<div class="viewcode-block" id="CameraQC.check_focus"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.check_focus">[docs]</a>    <span class="k">def</span> <span class="nf">check_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                    <span class="n">roi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">equalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check video is in focus</span>
<span class="sd">        Two methods are used here: Looking at the high frequencies with a DFT and</span>
<span class="sd">        applying a Laplacian HPF and looking at the variance.</span>

<span class="sd">        Note:</span>
<span class="sd">            - Both methods are sensitive to noise (Laplacian is 2nd order filter).</span>
<span class="sd">            - The thresholds for the fft may need to be different for the left/right vs body as</span>
<span class="sd">              the distribution of frequencies in the image is different (e.g. the holder</span>
<span class="sd">              comprises mostly very high frequencies).</span>
<span class="sd">            - The image may be overall in focus but the places we care about can still be out of</span>
<span class="sd">              focus (namely the face).  For this we&#39;ll take an ROI around the face.</span>
<span class="sd">            - Focus check thrown off by brightness.  This may be fixed by equalizing the histogram</span>
<span class="sd">              (set equalize=True)</span>

<span class="sd">        :param n: number of frames from frame_samples data to use in check.</span>
<span class="sd">        :param threshold: the lower boundary for Laplacian variance and mean FFT filtered</span>
<span class="sd">         brightness, respectively</span>
<span class="sd">        :param roi: if False, the roi is determined via template matching for the face or body.</span>
<span class="sd">        If None, some set ROIs for face and paws are used.  A list of slices may also be passed.</span>
<span class="sd">        :param display: if true, the results are displayed</span>
<span class="sd">        :param test: if true, a set of artificially blurred reference frames are used as the</span>
<span class="sd">        input.  This can be used to selecting reasonable thresholds.</span>
<span class="sd">        :param equalize: if true, the histograms of the frames are equalized, resulting in an</span>
<span class="sd">        increased the global contrast and linear CDF.  This makes check robust to low light</span>
<span class="sd">        conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">no_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span> <span class="ow">and</span> <span class="n">no_frames</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NOT_SET&#39;</span>

        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">top_left</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_face</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>  <span class="c1"># (y1, y2), (x1, x2)</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">roi</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top_left</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">],)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ROI</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span><span class="mi">400</span><span class="p">,</span> <span class="p">:</span><span class="mi">561</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="mi">500</span><span class="p">:,</span> <span class="mi">100</span><span class="p">:</span><span class="mi">800</span><span class="p">]),</span>  <span class="c1"># (face, wheel)</span>
                <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span><span class="mi">196</span><span class="p">,</span> <span class="mi">397</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="mi">221</span><span class="p">:,</span> <span class="mi">255</span><span class="p">:]),</span>
                <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="mi">143</span><span class="p">:</span><span class="mi">274</span><span class="p">,</span> <span class="mi">84</span><span class="p">:</span><span class="mi">433</span><span class="p">],)</span>  <span class="c1"># body holder</span>
            <span class="p">}</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span> <span class="ow">or</span> <span class="n">ROI</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;In test mode load a reference frame and run it through a normalized box filter with</span>
<span class="sd">            increasing kernel size.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">kernal_sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">kernal_sz</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># Size excluding repeated kernels</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kernal_sz</span><span class="p">):</span>
                <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cv2</span><span class="o">.</span><span class="n">blur</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">equalize</span><span class="p">:</span>
                <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                <span class="c1"># Plot blurred images</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kernal_sz</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ig</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">kernal_sz</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Kernal (</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span> <span class="ow">or</span> <span class="s1">&#39;None&#39;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Reference frame with box filter&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sub-sample the frame samples</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">equalize</span><span class="p">:</span>
                <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img</span><span class="p">]</span>

        <span class="c1"># A measure of the sharpness effectively taking the second derivative of the image</span>
        <span class="n">lpc_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">lpc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Laplacian</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_16S</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lpc_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lpc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">roi</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="c1"># Plot the first sample image</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Frame #</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_samples_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Plot the ROIs with and without filter</span>
            <span class="n">lpc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Laplacian</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_16S</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">abs_lpc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convertScaleAbs</span><span class="p">(</span><span class="n">lpc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">roi</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROI #</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">abs_lpc</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROI #</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1"> - Lapacian filter&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Laplacian blur detection&#39;</span><span class="p">)</span>
            <span class="c1"># Plot variance over frames</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">),</span> <span class="p">:])</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lpc_var</span><span class="p">)</span>
            <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ROI #</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ln</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;lower threshold&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Frame sample&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Variance of the Laplacian&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># Second test is to highpass with dft</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">cX</span><span class="p">,</span> <span class="n">cY</span> <span class="o">=</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># Seems to be the magic number for high pass</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">cY</span> <span class="o">-</span> <span class="n">sz</span><span class="p">:</span><span class="n">cY</span> <span class="o">+</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cX</span> <span class="o">-</span> <span class="n">sz</span><span class="p">:</span><span class="n">cX</span> <span class="o">+</span> <span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">filt_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">dft</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">DFT_COMPLEX_OUTPUT</span><span class="p">)</span>
            <span class="n">f_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">dft</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>  <span class="c1"># Shift &amp; remove low frequencies</span>
            <span class="n">f_ishift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">f_shift</span><span class="p">)</span>  <span class="c1"># Shift back</span>
            <span class="n">filt_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">idft</span><span class="p">(</span><span class="n">f_ishift</span><span class="p">)</span>  <span class="c1"># Reconstruct</span>
            <span class="n">filt_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">filt_frame</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">filt_frame</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Re-normalize to 8-bits to make threshold simpler</span>
            <span class="n">img_back</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">filt_frame</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                                     <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">)</span>
            <span class="n">filt_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_back</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">display</span><span class="p">:</span>
                <span class="c1"># Plot Fourier transforms</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Original frame&#39;</span><span class="p">)</span>
                <span class="n">dft_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">dft</span><span class="p">)</span>
                <span class="n">magnitude</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">dft_shift</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dft_shift</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Magnitude spectrum&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_back</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Filtered frame&#39;</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filt_mean</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;lower threshold&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Frame sample&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Mean of filtered frame&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Discrete Fourier Transform&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">passes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lpc_var</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">filt_mean</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">passes</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span></div>

<div class="viewcode-block" id="CameraQC.find_face"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.find_face">[docs]</a>    <span class="k">def</span> <span class="nf">find_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCOEFF_NORMED</span><span class="p">,</span> <span class="n">refs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use template matching to find face location in frame</span>
<span class="sd">        For the template matching zero-normalized cross-correlation (default) should be more</span>
<span class="sd">        robust to exposure (which we&#39;re not checking here).  The L2 norm (TM_SQDIFF) should</span>
<span class="sd">        also work.  That said, normalizing the histograms works best.</span>

<span class="sd">        :param roi: A tuple of indices for the face template in the for ((y1, y2), (x1, x2))</span>
<span class="sd">        :param test: If True the template is matched against frames that come from the same session</span>
<span class="sd">        :param metric: The metric to use for template matching</span>
<span class="sd">        :param refs: An array of frames to match the template to</span>

<span class="sd">        :returns: (y1, y2), (x1, x2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ROI</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mi">45</span><span class="p">,</span> <span class="mi">346</span><span class="p">),</span> <span class="p">(</span><span class="mi">138</span><span class="p">,</span> <span class="mi">501</span><span class="p">)),</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">174</span><span class="p">),</span> <span class="p">(</span><span class="mi">430</span><span class="p">,</span> <span class="mi">618</span><span class="p">)),</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mi">141</span><span class="p">,</span> <span class="mi">272</span><span class="p">),</span> <span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">339</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span> <span class="ow">or</span> <span class="n">ROI</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_reference_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">refs</span>

        <span class="n">frames</span> <span class="o">=</span> <span class="n">refs</span> <span class="k">if</span> <span class="n">test</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;frame_samples&#39;</span><span class="p">]</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roi</span><span class="p">)]</span>
        <span class="n">top_left</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [(x1, y1), ...]</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">min_loc</span><span class="p">,</span> <span class="n">max_loc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minMaxLoc</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="c1"># If the method is TM_SQDIFF or TM_SQDIFF_NORMED, take minimum</span>
            <span class="n">top_left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_loc</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">max_loc</span><span class="p">)</span>
            <span class="c1"># bottom_right = (top_left[0] + w, top_left[1] + h)</span>
        <span class="k">return</span> <span class="n">top_left</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">template</span></div>

<div class="viewcode-block" id="CameraQC.load_reference_frames"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.load_reference_frames">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_reference_frames</span><span class="p">(</span><span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load some reference frames for a given video</span>

<span class="sd">        The reference frames are from sessions where the camera was well positioned. The</span>
<span class="sd">        frames are in qc/reference, one file per camera, only one channel per frame.  The</span>
<span class="sd">        session eids can be found in qc/reference/frame_src.json</span>

<span class="sd">        :param side: Video label, e.g. &#39;left&#39;</span>
<span class="sd">        :return: numpy array of frames with the shape (n, h, w)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frames_</span><span class="si">{</span><span class="n">side</span><span class="si">}</span><span class="s1">.npy&#39;</span><span class="p">))</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">refs</span></div>

<div class="viewcode-block" id="CameraQC.imshow"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.CameraQC.imshow">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;plt.imshow with some convenient defaults for greyscale frames&quot;&quot;&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">or</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">),</span>
            <span class="s1">&#39;vmin&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;vmax&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">h</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span></div></div>


<div class="viewcode-block" id="data_for_keys"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.data_for_keys">[docs]</a><span class="k">def</span> <span class="nf">data_for_keys</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check keys exist in &#39;data&#39; dict and contain values other than None&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_all_qc"><a class="viewcode-back" href="../../../_autosummary/ibllib.qc.camera.html#ibllib.qc.camera.run_all_qc">[docs]</a><span class="k">def</span> <span class="nf">run_all_qc</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cameras</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run QC for all cameras</span>
<span class="sd">    Run the camera QC for left, right and body cameras.</span>
<span class="sd">    :param session: A session path or eid.</span>
<span class="sd">    :param update: If True, QC fields are updated on Alyx.</span>
<span class="sd">    :param cameras: A list of camera names to perform QC on.</span>
<span class="sd">    :param stream: If true and local video files not available, the data are streamed from</span>
<span class="sd">    the remote source.</span>
<span class="sd">    :return: dict of CameraCQ objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">run_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;download_data&#39;</span><span class="p">,</span> <span class="s1">&#39;extract_times&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>
        <span class="n">qc</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">CameraQC</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">qc</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qc</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>