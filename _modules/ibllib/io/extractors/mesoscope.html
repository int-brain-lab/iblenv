<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibllib.io.extractors.mesoscope &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_repro_ephys.html">Data Release - Reproducible Ephys Paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_download.html">Download the public datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ibllib.io.extractors.mesoscope</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibllib.io.extractors.mesoscope</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Mesoscope (timeline) data extraction.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">one.alf.io</span> <span class="k">as</span> <span class="nn">alfio</span>
<span class="kn">from</span> <span class="nn">one.util</span> <span class="kn">import</span> <span class="n">ensure_list</span>
<span class="kn">from</span> <span class="nn">one.alf.files</span> <span class="kn">import</span> <span class="n">session_path_parts</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">neurodsp.utils</span> <span class="kn">import</span> <span class="n">falls</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">parse_version</span>

<span class="kn">from</span> <span class="nn">ibllib.plots.misc</span> <span class="kn">import</span> <span class="n">squares</span><span class="p">,</span> <span class="n">vertical_lines</span>
<span class="kn">from</span> <span class="nn">ibllib.io.raw_daq_loaders</span> <span class="kn">import</span> <span class="p">(</span><span class="n">extract_sync_timeline</span><span class="p">,</span> <span class="n">timeline_get_channel</span><span class="p">,</span>
                                       <span class="n">correct_counter_discontinuities</span><span class="p">,</span> <span class="n">load_timeline_sync_and_chmap</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">ibllib.io.extractors.base</span> <span class="k">as</span> <span class="nn">extractors_base</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.ephys_fpga</span> <span class="kn">import</span> <span class="n">FpgaTrials</span><span class="p">,</span> <span class="n">WHEEL_TICKS</span><span class="p">,</span> <span class="n">WHEEL_RADIUS_CM</span><span class="p">,</span> <span class="n">get_sync_fronts</span><span class="p">,</span> <span class="n">get_protocol_period</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.training_wheel</span> <span class="kn">import</span> <span class="n">extract_wheel_moves</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.camera</span> <span class="kn">import</span> <span class="n">attribute_times</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.ephys_fpga</span> <span class="kn">import</span> <span class="n">_assign_events_bpod</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="patch_imaging_meta">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.patch_imaging_meta">[docs]</a>
<span class="k">def</span> <span class="nf">patch_imaging_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Patch imaging metadata for compatibility across versions.</span>

<span class="sd">    A copy of the dict is NOT returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    meta : dict</span>
<span class="sd">        A folder path that contains a rawImagingData.meta file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The loaded metadata file, updated to the most recent version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 2023-05-17 (unversioned) adds nFrames, channelSaved keys, MM and Deg keys</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;=</span> <span class="n">parse_version</span><span class="p">(</span><span class="s1">&#39;0.0.0&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;channelSaved&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;channelSaved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;channelIdx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;FOV&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;channelIdx&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span> <span class="p">[])</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;topLeft&#39;</span><span class="p">,</span> <span class="s1">&#39;topRight&#39;</span><span class="p">,</span> <span class="s1">&#39;bottomLeft&#39;</span><span class="p">,</span> <span class="s1">&#39;bottomRight&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fov</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FOV&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Deg&#39;</span><span class="p">,</span> <span class="s1">&#39;MM&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fov</span><span class="p">:</span>  <span class="c1"># topLeftDeg, etc. -&gt; Deg[topLeft]</span>
                    <span class="n">fov</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">fov</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">unit</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="n">parse_version</span><span class="p">(</span><span class="s1">&#39;0.1.0&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fov</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FOV&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="s1">&#39;roiUuid&#39;</span> <span class="ow">in</span> <span class="n">fov</span><span class="p">:</span>
                <span class="n">fov</span><span class="p">[</span><span class="s1">&#39;roiUUID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fov</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;roiUuid&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">meta</span></div>



<div class="viewcode-block" id="plot_timeline">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.plot_timeline">[docs]</a>
<span class="k">def</span> <span class="nf">plot_timeline</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the timeline data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timeline : one.alf.io.AlfBunch</span>
<span class="sd">        The timeline data object.</span>
<span class="sd">    channels : list of str</span>
<span class="sd">        An iterable of channel names to plot.</span>
<span class="sd">    raw : bool</span>
<span class="sd">        If true, plot the raw DAQ samples; if false, apply TTL thresholds and plot changes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.pyplot.Figure</span>
<span class="sd">        The figure containing timeline subplots.</span>
<span class="sd">    list of matplotlib.pyplot.Axes</span>
<span class="sd">        The axes for each timeline channel plotted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]}</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span> <span class="ow">or</span> <span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">chmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="s1">&#39;arrayColumn&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">}</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="n">extract_sync_timeline</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">chmap</span><span class="o">=</span><span class="n">chmap</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">channels</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="c1"># axesScale controls vertical scaling of each trace (multiplicative)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][:,</span> <span class="n">meta</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="s1">&#39;arrayColumn&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">meta</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="s1">&#39;axesScale&#39;</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idx</span> <span class="o">:=</span> <span class="n">sync</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">chmap</span><span class="p">[</span><span class="n">ch</span><span class="p">]):</span>
            <span class="n">squares</span><span class="p">(</span><span class="n">sync</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">sync</span><span class="p">[</span><span class="s1">&#39;polarities&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="c1"># Add back x-axis ticks to the last plot</span>
    <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>  <span class="c1"># full screen</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>



<div class="viewcode-block" id="TimelineTrials">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.TimelineTrials">[docs]</a>
<span class="k">class</span> <span class="nc">TimelineTrials</span><span class="p">(</span><span class="n">FpgaTrials</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Similar extraction to the FPGA, however counter and position channels are treated differently.&quot;&quot;&quot;</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;one.alf.io.AlfBunch: The timeline data object&quot;&quot;&quot;</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sync_collection</span><span class="o">=</span><span class="s1">&#39;raw_sync_data&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An extractor for all ephys trial data, in Timeline time&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span> <span class="o">=</span> <span class="n">alfio</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="o">/</span> <span class="n">sync_collection</span><span class="p">,</span> <span class="s1">&#39;DAQdata&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;timeline&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sync_collection</span><span class="o">=</span><span class="s1">&#39;raw_sync_data&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sync</span> <span class="ow">or</span> <span class="n">chmap</span><span class="p">):</span>
            <span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span> <span class="o">=</span> <span class="n">load_timeline_sync_and_chmap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="o">/</span> <span class="n">sync_collection</span><span class="p">,</span> <span class="n">timeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span> <span class="n">chmap</span><span class="o">=</span><span class="n">chmap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">plot_timeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">chmap</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">,</span> <span class="n">sync_collection</span><span class="p">,</span> <span class="n">extractor_type</span><span class="o">=</span><span class="s1">&#39;ephys&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># If no protocol number is defined, trim timestamps based on Bpod trials intervals</span>
        <span class="n">trials_table</span> <span class="o">=</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span>
        <span class="n">bpod</span> <span class="o">=</span> <span class="n">get_sync_fronts</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">[</span><span class="s1">&#39;bpod&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocol_number&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="n">trials_table</span><span class="o">.</span><span class="n">intervals_0</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">tmax</span> <span class="o">=</span> <span class="n">trials_table</span><span class="o">.</span><span class="n">intervals_1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Ensure wheel is cut off based on trials</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tmin</span> <span class="o">&lt;=</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">],</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)</span>
            <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheel_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheel_position&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheelMoves_intervals&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheelMoves_intervals&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)</span>
            <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheelMoves_intervals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;wheelMoves_intervals&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">get_protocol_period</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;protocol_number&#39;</span><span class="p">],</span> <span class="n">bpod</span><span class="p">)</span>
        <span class="n">bpod</span> <span class="o">=</span> <span class="n">get_sync_fronts</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">[</span><span class="s1">&#39;bpod&#39;</span><span class="p">],</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame2ttl</span> <span class="o">=</span> <span class="n">get_sync_fronts</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">[</span><span class="s1">&#39;frame2ttl&#39;</span><span class="p">],</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">)</span>  <span class="c1"># save for later access by QC</span>

        <span class="c1"># Replace valve open times with those extracted from the DAQ</span>
        <span class="c1"># TODO Let&#39;s look at the expected open length based on calibration and reward volume</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bpod</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;No Bpod TTLs detected on DAQ&#39;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">driver_out</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">=</span> <span class="n">_assign_events_bpod</span><span class="p">(</span><span class="n">bpod</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span> <span class="n">bpod</span><span class="p">[</span><span class="s1">&#39;polarities&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Use the driver TTLs to find the valve open times that correspond to the valve opening</span>
        <span class="n">valve_open_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valve_open_times</span><span class="p">(</span><span class="n">driver_ttls</span><span class="o">=</span><span class="n">driver_out</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valve_open_times</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trials_table</span><span class="o">.</span><span class="n">feedbackType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># TODO Relax assertion</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="n">trials_table</span><span class="o">.</span><span class="n">feedbackType</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;valveOpen_times&#39;</span><span class="p">][</span><span class="n">correct</span><span class="p">]</span> <span class="o">=</span> <span class="n">valve_open_times</span>
        <span class="n">trials_table</span><span class="o">.</span><span class="n">feedback_times</span><span class="p">[</span><span class="n">correct</span><span class="p">]</span> <span class="o">=</span> <span class="n">valve_open_times</span>

        <span class="c1"># Replace audio events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio</span> <span class="o">=</span> <span class="n">get_sync_fronts</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">chmap</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">],</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">)</span>
        <span class="c1"># Attempt to assign the go cue and error tone onsets based on TTL length</span>
        <span class="n">go_cue</span><span class="p">,</span> <span class="n">error_cue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_events_audio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;polarities&#39;</span><span class="p">])</span>

        <span class="k">assert</span> <span class="n">error_cue</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">correct</span><span class="p">),</span> <span class="s1">&#39;N detected error tones does not match number of incorrect trials&#39;</span>
        <span class="k">assert</span> <span class="n">go_cue</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials_table</span><span class="p">),</span> <span class="s1">&#39;More go cue tones detected than trials!&#39;</span>

        <span class="k">if</span> <span class="n">go_cue</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials_table</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> go cue tones missed&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials_table</span><span class="p">)</span> <span class="o">-</span> <span class="n">go_cue</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the error cues are all assigned and some go cues are missed it may be that some</span>
<span class="sd">            responses were so fast that the go cue and error tone merged.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">err_trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod2fpga</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span><span class="p">[</span><span class="s1">&#39;errorCueTrigger_times&#39;</span><span class="p">])</span>
            <span class="n">go_trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod2fpga</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span><span class="p">[</span><span class="s1">&#39;goCueTrigger_times&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">go_trig</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">err_trig</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">go_trig</span><span class="o">.</span><span class="n">size</span>

            <span class="k">def</span> <span class="nf">first_true</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Return the index of the first True value in an array.&quot;&quot;&quot;</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Find which trials are missing a go cue</span>
            <span class="n">_go_cue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials_table</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trials_table</span><span class="p">[[</span><span class="s1">&#39;intervals_0&#39;</span><span class="p">,</span> <span class="s1">&#39;intervals_1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">first_true</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">go_cue</span> <span class="o">&gt;</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">go_cue</span> <span class="o">&lt;</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_go_cue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">go_cue</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># Get all the DAQ timestamps where audio channel was HIGH</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">timeline_get_channel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw</span> <span class="o">-</span> <span class="n">raw</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">raw</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>  <span class="c1"># min-max normalize</span>
            <span class="n">ups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">raw</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="p">]</span>  <span class="c1"># timestamps where input HIGH</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_go_cue</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># Get the timestamp of the first HIGH after the trigger times</span>
                <span class="n">_go_cue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ups</span><span class="p">[</span><span class="n">first_true</span><span class="p">(</span><span class="n">ups</span> <span class="o">&gt;</span> <span class="n">go_trig</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">first_true</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">error_cue</span> <span class="o">&gt;</span> <span class="n">trials_table</span><span class="p">[</span><span class="s1">&#39;intervals_0&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">error_cue</span> <span class="o">&lt;</span> <span class="n">trials_table</span><span class="p">[</span><span class="s1">&#39;intervals_1&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">err_trig</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">error_cue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">error_cue</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>  <span class="c1"># Remove mis-assigned error tone time</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_cue</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ups</span><span class="p">[</span><span class="n">first_true</span><span class="p">(</span><span class="n">ups</span> <span class="o">&gt;</span> <span class="n">err_trig</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
            <span class="n">go_cue</span> <span class="o">=</span> <span class="n">_go_cue</span>

        <span class="n">trials_table</span><span class="o">.</span><span class="n">feedback_times</span><span class="p">[</span><span class="o">~</span><span class="n">correct</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_cue</span>
        <span class="n">trials_table</span><span class="o">.</span><span class="n">goCue_times</span> <span class="o">=</span> <span class="n">go_cue</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span><span class="p">}</span>

<div class="viewcode-block" id="TimelineTrials.extract_wheel_sync">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.TimelineTrials.extract_wheel_sync">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_wheel_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">WHEEL_TICKS</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">WHEEL_RADIUS_CM</span><span class="p">,</span> <span class="n">coding</span><span class="o">=</span><span class="s1">&#39;x4&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the wheel position from Timeline counter channel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ticks : int</span>
<span class="sd">            Number of ticks corresponding to a full revolution (1024 for IBL rotary encoder).</span>
<span class="sd">        radius : float</span>
<span class="sd">            Radius of the wheel. Defaults to 1 for an output in radians.</span>
<span class="sd">        coding : str {&#39;x1&#39;, &#39;x2&#39;, &#39;x4&#39;}</span>
<span class="sd">            Rotary encoder encoding (IBL default is x4).</span>
<span class="sd">        tmin : float</span>
<span class="sd">            The minimum time from which to extract the sync pulses.</span>
<span class="sd">        tmax : float</span>
<span class="sd">            The maximum time up to which we extract the sync pulses.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array</span>
<span class="sd">            Wheel timestamps in seconds.</span>
<span class="sd">        np.array</span>
<span class="sd">            Wheel positions in radians.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        ibllib.io.extractors.ephys_fpga.extract_wheel_sync</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="s1">&#39;x4&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported coding; must be one of x1, x2 or x4&#39;</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">correct_counter_discontinuities</span><span class="p">(</span><span class="n">timeline_get_channel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span> <span class="s1">&#39;rotary_encoder&#39;</span><span class="p">))</span>

        <span class="c1"># Timeline evenly samples counter so we extract only change points</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">-=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Start from zero</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">ticks</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">coding</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Convert to radians</span>

        <span class="c1"># Get timestamps of changes and trim based on protocol spacers</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">if</span> <span class="n">tmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tmin</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tmax</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ts</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ts</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>


<div class="viewcode-block" id="TimelineTrials.get_wheel_positions">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.TimelineTrials.get_wheel_positions">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wheel_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">WHEEL_TICKS</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">WHEEL_RADIUS_CM</span><span class="p">,</span> <span class="n">coding</span><span class="o">=</span><span class="s1">&#39;x4&#39;</span><span class="p">,</span>
                            <span class="n">tmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the wheel position and detected movements from Timeline counter channel.</span>

<span class="sd">        Called by the super class extractor (FPGATrials._extract).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ticks : int</span>
<span class="sd">            Number of ticks corresponding to a full revolution (1024 for IBL rotary encoder).</span>
<span class="sd">        radius : float</span>
<span class="sd">            Radius of the wheel. Defaults to 1 for an output in radians.</span>
<span class="sd">        coding : str {&#39;x1&#39;, &#39;x2&#39;, &#39;x4&#39;}</span>
<span class="sd">            Rotary encoder encoding (IBL default is x4).</span>
<span class="sd">        tmin : float</span>
<span class="sd">            The minimum time from which to extract the sync pulses.</span>
<span class="sd">        tmax : float</span>
<span class="sd">            The maximum time up to which we extract the sync pulses.</span>
<span class="sd">        display : bool</span>
<span class="sd">            If true, plot the wheel positions from bpod and the DAQ.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            wheel object with keys (&#39;timestamps&#39;, &#39;position&#39;).</span>
<span class="sd">        dict</span>
<span class="sd">            wheelMoves object with keys (&#39;intervals&#39; &#39;peakAmplitude&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wheel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_wheel_sync</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">coding</span><span class="o">=</span><span class="n">coding</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
        <span class="n">wheel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">),</span> <span class="n">wheel</span><span class="p">))</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="n">extract_wheel_moves</span><span class="p">(</span><span class="n">wheel</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span> <span class="n">wheel</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span><span class="p">,</span> <span class="s1">&#39;no bpod trials to compare&#39;</span>
            <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bpod_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span><span class="p">[</span><span class="s1">&#39;wheel_timestamps&#39;</span><span class="p">]</span>
            <span class="n">bpod_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span><span class="p">[</span><span class="s1">&#39;wheel_position&#39;</span><span class="p">]</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod2fpga</span><span class="p">(</span><span class="n">bpod_ts</span><span class="p">),</span> <span class="n">bpod_pos</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bpod wheel position / rad&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wheel</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span> <span class="n">wheel</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DAQ wheel position / rad&#39;</span><span class="p">),</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time / s&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wheel</span><span class="p">,</span> <span class="n">moves</span></div>


<div class="viewcode-block" id="TimelineTrials.get_valve_open_times">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.TimelineTrials.get_valve_open_times">[docs]</a>
    <span class="k">def</span> <span class="nf">get_valve_open_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=-</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">floor_percentile</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">driver_ttls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the valve open times from the raw timeline voltage trace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        display : bool</span>
<span class="sd">            Plot detected times on the raw voltage trace.</span>
<span class="sd">        threshold : float</span>
<span class="sd">            The threshold for applying to analogue channels.</span>
<span class="sd">        floor_percentile : float</span>
<span class="sd">            10% removes the percentile value of the analog trace before thresholding. This is to</span>
<span class="sd">            avoid DC offset drift.</span>
<span class="sd">        driver_ttls : numpy.array</span>
<span class="sd">            An optional array of driver TTLs to use for assigning with the valve times.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            The detected valve open times.</span>

<span class="sd">        TODO extract close times too</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tl</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reward_valve&#39;</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">tl</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][:,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;arrayColumn&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Timeline indices start from 1</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">floor_percentile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">falls</span><span class="p">(</span><span class="n">values</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>  <span class="c1"># Voltage falls when valve opens</span>
        <span class="n">open_times</span> <span class="o">=</span> <span class="n">tl</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># The closing of the valve is noisy. Keep only the falls that occur immediately after a Bpod TTL</span>
        <span class="k">if</span> <span class="n">driver_ttls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Returns an array of open_times indices, one for each driver TTL</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">attribute_times</span><span class="p">(</span><span class="n">open_times</span><span class="p">,</span> <span class="n">driver_ttls</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">take</span><span class="o">=</span><span class="s1">&#39;after&#39;</span><span class="p">)</span>
            <span class="n">open_times</span> <span class="o">=</span> <span class="n">open_times</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># TODO Log any &gt; 40ms? Difficult to report missing valve times because of calibration</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span> <span class="n">timeline_get_channel</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="s1">&#39;bpod&#39;</span><span class="p">),</span> <span class="s1">&#39;k-o&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">driver_ttls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vertical_lines</span><span class="p">(</span><span class="n">driver_ttls</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span> <span class="n">values</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="s1">&#39;k-o&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage / V&#39;</span><span class="p">),</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time / s&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="s1">&#39;r*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">driver_ttls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">open_times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">open_times</span><span class="p">),</span> <span class="s1">&#39;g*&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">open_times</span></div>


    <span class="k">def</span> <span class="nf">_assign_events_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_times</span><span class="p">,</span> <span class="n">audio_polarities</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is identical to ephys_fpga._assign_events_audio, except for the ready tone threshold.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        audio_times : numpy.array</span>
<span class="sd">            An array of audio TTL front times.</span>
<span class="sd">        audio_polarities : numpy.array</span>
<span class="sd">            An array of audio TTL front polarities (1 for rises, -1 for falls).</span>
<span class="sd">        display : bool</span>
<span class="sd">            If true, display audio pulses and the assigned onsets.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            The times of the go cue onsets.</span>
<span class="sd">        numpy.array</span>
<span class="sd">            The times of the error tone onsets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure that there are no 2 consecutive fall or consecutive rise events</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">audio_polarities</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># take only even time differences: ie. from rising to falling fronts</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">audio_times</span><span class="p">)</span>
        <span class="n">onsets</span> <span class="o">=</span> <span class="n">audio_polarities</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># error tones are events lasting from 400ms to 1200ms</span>
        <span class="n">i_error_tone_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="mf">0.4</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">onsets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_error_tone_in</span> <span class="o">=</span> <span class="n">audio_times</span><span class="p">[</span><span class="n">i_error_tone_in</span><span class="p">]</span>

        <span class="c1"># detect ready tone by length below 300 ms</span>
        <span class="n">i_ready_tone_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">onsets</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_ready_tone_in</span> <span class="o">=</span> <span class="n">audio_times</span><span class="p">[</span><span class="n">i_ready_tone_in</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">timeline_get_channel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">),</span> <span class="s1">&#39;k-o&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage / V&#39;</span><span class="p">)</span>
            <span class="n">squares</span><span class="p">(</span><span class="n">audio_times</span><span class="p">,</span> <span class="n">audio_polarities</span><span class="p">,</span> <span class="n">yrange</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">vertical_lines</span><span class="p">(</span><span class="n">t_ready_tone_in</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">.8</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;go cue&#39;</span><span class="p">)</span>
            <span class="n">vertical_lines</span><span class="p">(</span><span class="n">t_error_tone_in</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">.8</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;error tone&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time / s&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">t_ready_tone_in</span><span class="p">,</span> <span class="n">t_error_tone_in</span></div>



<div class="viewcode-block" id="MesoscopeSyncTimeline">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.MesoscopeSyncTimeline">[docs]</a>
<span class="k">class</span> <span class="nc">MesoscopeSyncTimeline</span><span class="p">(</span><span class="n">extractors_base</span><span class="o">.</span><span class="n">BaseExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extraction of mesoscope imaging times.&quot;&quot;&quot;</span>

    <span class="n">var_names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mpci_times&#39;</span><span class="p">,</span> <span class="s1">&#39;mpciStack_timeshift&#39;</span><span class="p">)</span>
    <span class="n">save_names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mpci.times.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;mpciStack.timeshift.npy&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;one.alf.io.AlfBunch: The raw imaging meta data and frame times&quot;&quot;&quot;</span>
    <span class="n">rawImagingData</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="n">n_FOVs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the mesoscope frame times from DAQ data acquired through Timeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        session_path : str, pathlib.Path</span>
<span class="sd">            The session path to extract times from.</span>
<span class="sd">        n_FOVs : int</span>
<span class="sd">            The number of fields of view acquired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_FOVs</span> <span class="o">=</span> <span class="n">n_FOVs</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;FOV_</span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">02</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_FOVs</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">fov</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_names</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">fov</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device_collection</span><span class="o">=</span><span class="s1">&#39;raw_imaging_data&#39;</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the frame timestamps for each individual field of view (FOV) and the time offsets</span>
<span class="sd">        for each line scan.</span>

<span class="sd">        The detected frame times from the &#39;neural_frames&#39; channel of the DAQ are split into bouts</span>
<span class="sd">        corresponding to the number of raw_imaging_data folders. These timestamps should match the</span>
<span class="sd">        number of frame timestamps extracted from the image file headers (found in the</span>
<span class="sd">        rawImagingData.times file).  The field of view (FOV) shifts are then applied to these</span>
<span class="sd">        timestamps for each field of view and provided together with the line shifts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sync : one.alf.io.AlfBunch</span>
<span class="sd">            A dictionary with keys (&#39;times&#39;, &#39;polarities&#39;, &#39;channels&#39;), containing the sync pulses</span>
<span class="sd">            and the corresponding channel numbers.</span>
<span class="sd">        chmap : dict</span>
<span class="sd">            A map of channel names and their corresponding indices. Only the &#39;neural_frames&#39;</span>
<span class="sd">            channel is required.</span>
<span class="sd">        device_collection : str, iterable of str</span>
<span class="sd">            The location of the raw imaging data.</span>
<span class="sd">        events : pandas.DataFrame</span>
<span class="sd">            A table of software events, with columns {&#39;time_timeline&#39; &#39;name_timeline&#39;,</span>
<span class="sd">            &#39;event_timeline&#39;}.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of numpy.array</span>
<span class="sd">            A list of timestamps for each FOV and the time offsets for each line scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame_times</span> <span class="o">=</span> <span class="n">sync</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="n">sync</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">chmap</span><span class="p">[</span><span class="s1">&#39;neural_frames&#39;</span><span class="p">]]</span>

        <span class="c1"># imaging_start_time = datetime.datetime(*map(round, self.rawImagingData.meta[&#39;acquisitionStartTime&#39;]))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device_collection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">device_collection</span> <span class="o">=</span> <span class="p">[</span><span class="n">device_collection</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mpepUDP&#39;</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bout_edges</span><span class="p">(</span><span class="n">frame_times</span><span class="p">,</span> <span class="n">device_collection</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
        <span class="n">fov_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line_shifts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">),</span> <span class="n">collection</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">device_collection</span><span class="p">)):</span>
            <span class="n">imaging_data</span> <span class="o">=</span> <span class="n">alfio</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="o">/</span> <span class="n">collection</span><span class="p">,</span> <span class="s1">&#39;rawImagingData&#39;</span><span class="p">)</span>
            <span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_imaging_meta</span><span class="p">(</span><span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">])</span>
            <span class="c1"># Calculate line shifts</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">fov_time_shifts</span><span class="p">,</span> <span class="n">line_time_shifts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeshifts</span><span class="p">(</span><span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fov_time_shifts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_FOVs</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;unexpected number of FOVs for </span><span class="si">{</span><span class="n">collection</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">frame_times</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">frame_times</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="n">ts</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;times_scanImage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;fewer DAQ timestamps for </span><span class="si">{</span><span class="n">collection</span><span class="si">}</span><span class="s1"> than expected&#39;</span>
            <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;times_scanImage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;More DAQ frame times detected for </span><span class="si">%s</span><span class="s1"> than were found in the raw image data.</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;N DAQ frame times:</span><span class="se">\t</span><span class="si">%i</span><span class="se">\n</span><span class="s1">N raw image data times:</span><span class="se">\t</span><span class="si">%i</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;This may occur if the bout detection fails (e.g. UDPs recorded late), &#39;</span>
                    <span class="s1">&#39;when image data is corrupt, or when frames are not written to file.&#39;</span><span class="p">,</span>
                    <span class="n">collection</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;times_scanImage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dropping last </span><span class="si">%i</span><span class="s1"> frame times for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;times_scanImage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[:</span><span class="n">imaging_data</span><span class="p">[</span><span class="s1">&#39;times_scanImage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
            <span class="n">fov_times</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ts</span> <span class="o">+</span> <span class="n">offset</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">fov_time_shifts</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_shifts</span><span class="p">:</span>
                <span class="n">line_shifts</span> <span class="o">=</span> <span class="n">line_time_shifts</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># The line shifts should be the same across all imaging bouts</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">line_time_shifts</span><span class="p">,</span> <span class="n">line_shifts</span><span class="p">)]</span>

        <span class="c1"># Concatenate imaging timestamps across all bouts for each field of view</span>
        <span class="n">fov_times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">fov_times</span><span class="p">)))</span>
        <span class="n">n_fov_times</span><span class="p">,</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fov_times</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_fov_times</span> <span class="o">!=</span> <span class="n">frame_times</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># This may happen if an experimenter deletes a raw_imaging_data folder</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;FOV timestamps length does not match neural frame count; imaging bout(s) likely missing&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fov_times</span> <span class="o">+</span> <span class="n">line_shifts</span>

<div class="viewcode-block" id="MesoscopeSyncTimeline.get_bout_edges">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.MesoscopeSyncTimeline.get_bout_edges">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bout_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_times</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_gap</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of edge times for each imaging bout corresponding to a raw_imaging_data</span>
<span class="sd">        collection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frame_times : numpy.array</span>
<span class="sd">            An array of all neural frame count times.</span>
<span class="sd">        collections : iterable of str</span>
<span class="sd">            A set of raw_imaging_data collections, used to extract selected imaging periods.</span>
<span class="sd">        events : pandas.DataFrame</span>
<span class="sd">            A table of UDP event times, corresponding to times when recordings start and end.</span>
<span class="sd">        min_gap : float</span>
<span class="sd">            If start or end events not present, split bouts by finding gaps larger than this value.</span>
<span class="sd">        display : bool</span>
<span class="sd">            If true, plot the detected bout edges and raw frame times.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            An array of imaging bout intervals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">events</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># No UDP events to mark blocks so separate based on gaps in frame rate</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_gap</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">frame_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frame_times</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">frame_times</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">frame_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Split using Exp/BlockStart and Exp/BlockEnd times</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">session_path_parts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;(Exp|Block)%s\s</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">\s</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">\s\d+&#39;</span>

            <span class="c1"># Get start times</span>
            <span class="n">UDP_start</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span> <span class="o">%</span> <span class="s1">&#39;Start&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">UDP_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">UDP_start</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Exp&#39;</span><span class="p">):</span>
                <span class="c1"># Use ExpStart instead of first bout start</span>
                <span class="n">UDP_start</span> <span class="o">=</span> <span class="n">UDP_start</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Use ExpStart/End instead of first/last BlockStart/End</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="n">frame_times</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">UDP_start</span><span class="o">.</span><span class="n">time</span><span class="p">]]</span>

            <span class="c1"># Get end times</span>
            <span class="n">UDP_end</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span> <span class="o">%</span> <span class="s1">&#39;End&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">UDP_end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">UDP_end</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Exp&#39;</span><span class="p">):</span>
                <span class="c1"># Use last BlockEnd instead of ExpEnd</span>
                <span class="n">UDP_end</span> <span class="o">=</span> <span class="n">UDP_end</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">UDP_end</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">UDP_end</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">ends</span> <span class="o">=</span> <span class="n">frame_times</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">UDP_end</span><span class="o">.</span><span class="n">time</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get index of last frame to occur within a second of the previous frame</span>
                <span class="n">consec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frame_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_gap</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">,</span> <span class="n">consec</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">starts</span><span class="p">]</span>
                <span class="n">ends</span> <span class="o">=</span> <span class="n">frame_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Remove any missing imaging bout collections</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">collections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">collections</span><span class="p">):</span>
                <span class="c1"># Remove any bouts that correspond to a skipped collection</span>
                <span class="c1"># e.g. if {raw_imaging_data_00, raw_imaging_data_02}, remove middle bout</span>
                <span class="n">include</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">)</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">include</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">collections</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;More raw imaging folders than detected bouts&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">frame_times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">frame_times</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;frame times&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">vertical_lines</span><span class="p">(</span><span class="n">edges</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">frame_times</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bout start&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">vertical_lines</span><span class="p">(</span><span class="n">edges</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">frame_times</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bout end&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">):</span>
                <span class="n">vertical_lines</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">edges</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">frame_times</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;missing bout start&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                <span class="n">vertical_lines</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">edges</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">frame_times</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;missing bout end&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time / s&#39;</span><span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frame #&#39;</span><span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">edges</span></div>


<div class="viewcode-block" id="MesoscopeSyncTimeline.get_timeshifts">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.mesoscope.html#ibllib.io.extractors.mesoscope.MesoscopeSyncTimeline.get_timeshifts">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_timeshifts</span><span class="p">(</span><span class="n">raw_imaging_meta</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the time shifts for each field of view (FOV) and the relative offsets for each</span>
<span class="sd">        scan line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raw_imaging_meta : dict</span>
<span class="sd">            Extracted ScanImage meta data (_ibl_rawImagingData.meta.json).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of numpy.array</span>
<span class="sd">            A list of arrays, one per FOV, containing indices of each image scan line.</span>
<span class="sd">        numpy.array</span>
<span class="sd">            An array of FOV time offsets (one value per FOV) relative to each frame acquisition</span>
<span class="sd">            time.</span>
<span class="sd">        list of numpy.array</span>
<span class="sd">            A list of arrays, one per FOV, containing the time offsets for each scan line, relative</span>
<span class="sd">            to each FOV offset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FOVs</span> <span class="o">=</span> <span class="n">raw_imaging_meta</span><span class="p">[</span><span class="s1">&#39;FOV&#39;</span><span class="p">]</span>

        <span class="c1"># Double-check meta extracted properly</span>
        <span class="n">raw_meta</span> <span class="o">=</span> <span class="n">raw_imaging_meta</span><span class="p">[</span><span class="s1">&#39;rawScanImageMeta&#39;</span><span class="p">]</span>
        <span class="n">artist</span> <span class="o">=</span> <span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;Artist&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;enable&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">artist</span><span class="p">[</span><span class="s1">&#39;RoiGroups&#39;</span><span class="p">][</span><span class="s1">&#39;imagingRoiGroup&#39;</span><span class="p">][</span><span class="s1">&#39;rois&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">FOVs</span><span class="p">)</span>

        <span class="c1"># Number of scan lines per FOV, i.e. number of Y pixels / image height</span>
        <span class="n">n_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;nXnYnZ&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">FOVs</span><span class="p">])</span>
        <span class="n">n_valid_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n_lines</span><span class="p">)</span>  <span class="c1"># Number of lines imaged excluding flybacks</span>
        <span class="c1"># Number of lines during flyback</span>
        <span class="n">n_lines_per_gap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;Height&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_valid_lines</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FOVs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># The start and end indices of each FOV in the raw images</span>
        <span class="n">fov_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">n_lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_lines_per_gap</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fov_end_idx</span> <span class="o">=</span> <span class="n">fov_start_idx</span> <span class="o">+</span> <span class="n">n_lines</span>
        <span class="n">line_period</span> <span class="o">=</span> <span class="n">raw_imaging_meta</span><span class="p">[</span><span class="s1">&#39;scanImageParams&#39;</span><span class="p">][</span><span class="s1">&#39;hRoiManager&#39;</span><span class="p">][</span><span class="s1">&#39;linePeriod&#39;</span><span class="p">]</span>

        <span class="n">line_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fov_time_shifts</span> <span class="o">=</span> <span class="n">fov_start_idx</span> <span class="o">*</span> <span class="n">line_period</span>
        <span class="n">line_time_shifts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_lines</span><span class="p">,</span> <span class="n">fov_start_idx</span><span class="p">,</span> <span class="n">fov_end_idx</span><span class="p">):</span>
            <span class="n">line_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">line_time_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_period</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">line_indices</span><span class="p">,</span> <span class="n">fov_time_shifts</span><span class="p">,</span> <span class="n">line_time_shifts</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>