<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibllib.io.extractors.base &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/style.css?v=17142d56" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_repro_ephys.html">Data Release - Reproducible Ephys Paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_download.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks_external/docs_wheel_screen_stimulus.html">Computing the stimulus position using the wheel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ibllib.io.extractors.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibllib.io.extractors.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Base Extractor classes.</span>

<span class="sd">A module for the base Extractor classes.  The Extractor, given a session path, will extract the</span>
<span class="sd">processed data from raw hardware files and optionally save them.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">ibllib.io</span> <span class="kn">import</span> <span class="n">raw_data_loaders</span> <span class="k">as</span> <span class="n">raw</span>
<span class="kn">from</span> <span class="nn">ibllib.io.raw_data_loaders</span> <span class="kn">import</span> <span class="n">load_settings</span><span class="p">,</span> <span class="n">_logger</span>


<div class="viewcode-block" id="BaseExtractor">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.BaseExtractor">[docs]</a>
<span class="k">class</span> <span class="nc">BaseExtractor</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base extractor class.</span>

<span class="sd">    Writing an extractor checklist:</span>

<span class="sd">    - on the child class, overload the _extract method</span>
<span class="sd">    - this method should output one or several numpy.arrays or dataframe with a consistent shape</span>
<span class="sd">    - save_names is a list or a string of filenames, there should be one per dataset</span>
<span class="sd">    - set save_names to None for a dataset that doesn&#39;t need saving (could be set dynamically in</span>
<span class="sd">      the _extract method)</span>

<span class="sd">    :param session_path: Absolute path of session folder</span>
<span class="sd">    :type session_path: str/Path</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">session_path</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pathlib.Path: Absolute path of session folder.&quot;&quot;&quot;</span>

    <span class="n">save_names</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;tuple of str: The filenames of each extracted dataset, or None if array should not be saved.&quot;&quot;&quot;</span>

    <span class="n">var_names</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;tuple of str: A list of names for the extracted variables. These become the returned output keys.&quot;&quot;&quot;</span>

    <span class="n">default_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>  <span class="c1"># relative to session</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pathlib.Path: The default output folder relative to `session_path`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If session_path is None Path(session_path) will fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>

<div class="viewcode-block" id="BaseExtractor.extract">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.BaseExtractor.extract">[docs]</a>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: dict of numpy.array, list of filenames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">path_out</span><span class="o">=</span><span class="n">path_out</span><span class="p">)</span> <span class="k">if</span> <span class="n">save</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">files</span></div>


    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path_out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check if self.save_names is of the same length of out</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_out</span><span class="p">:</span>
            <span class="n">path_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_path</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_write_to_disk</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Implements different save calls depending on file extension.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            file_path : pathlib.Path</span>
<span class="sd">                The location to save the data.</span>
<span class="sd">            data : pandas.DataFrame, numpy.ndarray</span>
<span class="sd">                The data to save</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">csv_separators</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;.csv&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
                <span class="s2">&quot;.ssv&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
                <span class="s2">&quot;.tsv&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="p">}</span>
            <span class="c1"># Ensure empty files are not created; we expect all datasets to have a non-zero size</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> appears to be empty&#39;</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">file_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.npy&quot;</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;.pqt&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Data is not a panda&#39;s DataFrame object&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Data is not a panda&#39;s DataFrame object&quot;</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">csv_separators</span><span class="p">:</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">csv_separators</span><span class="p">[</span><span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="p">]</span>
                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
                <span class="c1"># np.savetxt(file_path, data, delimiter=sep)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to save </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> files yet&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="n">path_out</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_names</span><span class="p">)</span>
            <span class="n">_write_to_disk</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)]:</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">path_out</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                    <span class="n">_write_to_disk</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">file_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Should be list or tuple...</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_names</span><span class="p">)</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">path_out</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                    <span class="n">_write_to_disk</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">file_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_paths</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="BaseBpodTrialsExtractor">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.BaseBpodTrialsExtractor">[docs]</a>
<span class="k">class</span> <span class="nc">BaseBpodTrialsExtractor</span><span class="p">(</span><span class="n">BaseExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base (abstract) extractor class for bpod jsonable data set.</span>

<span class="sd">    Wraps the _extract private method.</span>

<span class="sd">    :param session_path: Absolute path of session folder.</span>
<span class="sd">    :type session_path: str</span>
<span class="sd">    :param bpod_trials</span>
<span class="sd">    :param settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bpod_trials</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">task_collection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">frame2ttl</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">audio</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaseBpodTrialsExtractor.extract">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.BaseBpodTrialsExtractor.extract">[docs]</a>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bpod_trials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param: bpod_trials (optional) bpod trials from jsonable in a dictionary</span>
<span class="sd">        :param: settings (optional) bpod iblrig settings json file in a dictionary</span>
<span class="sd">        :param: save (bool) write output ALF files, defaults to False</span>
<span class="sd">        :param: path_out (pathlib.Path) output path (defaults to `{session_path}/alf`)</span>
<span class="sd">        :return: numpy.ndarray or list of ndarrays, list of filenames</span>
<span class="sd">        :rtype: dtype(&#39;float64&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span> <span class="o">=</span> <span class="n">bpod_trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_collection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;task_collection&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">load_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;IBLRIG_VERSION&quot;</span><span class="p">:</span> <span class="s2">&quot;100.0.0&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IBLRIG_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;IBLRIG_VERSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;100.0.0&quot;</span>
        <span class="c1"># Get all detected TTLs. These are stored for QC purposes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame2ttl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">load_bpod_fronts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod_trials</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseBpodTrialsExtractor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alf_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;pathlib.Path: The full task collection filepath.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_collection</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_extractor_classes">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.run_extractor_classes">[docs]</a>
<span class="k">def</span> <span class="nf">run_extractor_classes</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">session_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a set of extractors with the same inputs.</span>

<span class="sd">    :param classes: list of Extractor class</span>
<span class="sd">    :param save: True/False</span>
<span class="sd">    :param path_out: (defaults to alf path)</span>
<span class="sd">    :param kwargs: extractor arguments (session_path...)</span>
<span class="sd">    :return: dictionary of arrays, list of files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({})</span>
    <span class="k">assert</span> <span class="n">session_path</span>
    <span class="c1"># if a single class is passed, convert as a list</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">iter</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">classe</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">classe</span><span class="p">(</span><span class="n">session_path</span><span class="o">=</span><span class="n">session_path</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">fil</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">outputs</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">var_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">files</span></div>



<span class="k">def</span> <span class="nf">_get_task_types_json_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the extractor types map.</span>

<span class="sd">    This function is only used for legacy sessions, i.e. those without an experiment description</span>
<span class="sd">    file and will be removed in favor of :func:`_get_task_extractor_map`, which directly returns</span>
<span class="sd">    the Bpod extractor class name. The experiment description file cuts out the need for pipeline</span>
<span class="sd">    name identifiers.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, str]</span>
<span class="sd">        A map of task protocol to task extractor identifier, e.g. &#39;ephys&#39;, &#39;habituation&#39;, etc.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    _get_task_extractor_map - returns a map of task protocol to Bpod trials extractor class name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;extractor_types.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">task_types</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># look if there are custom extractor types in the personal projects repo</span>
        <span class="kn">import</span> <span class="nn">projects.base</span>
        <span class="n">custom_extractors</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">projects</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;extractor_types.json&#39;</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading extractor types from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">custom_extractors</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">custom_extractors</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">custom_task_types</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">task_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">custom_task_types</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">task_types</span>


<div class="viewcode-block" id="get_task_protocol">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.get_task_protocol">[docs]</a>
<span class="k">def</span> <span class="nf">get_task_protocol</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the task protocol name from task settings.</span>

<span class="sd">    If the session path and/or task collection do not exist, the settings file is missing or</span>
<span class="sd">    otherwise can not be parsed, or if the &#39;PYBPOD_PROTOCOL&#39; key is absent, None is returned.</span>
<span class="sd">    A warning is logged if the session path or settings file doesn&#39;t exist. An error is logged if</span>
<span class="sd">    the settings file can not be parsed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session_path : str, pathlib.Path</span>
<span class="sd">        The absolute session path.</span>
<span class="sd">    task_collection : str</span>
<span class="sd">        The session path directory containing the task settings file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        The Pybpod task protocol name or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">load_settings</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="n">task_collection</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Can</span><span class="se">\&#39;</span><span class="s1">t read settings for </span><span class="si">{</span><span class="n">session_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PYBPOD_PROTOCOL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="get_task_extractor_type">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.get_task_extractor_type">[docs]</a>
<span class="k">def</span> <span class="nf">get_task_extractor_type</span><span class="p">(</span><span class="n">task_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the task type string from the full pybpod task name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task_name : str</span>
<span class="sd">        The complete task protocol name from the PYBPOD_PROTOCOL field of the task settings.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The extractor type identifier. Examples include &#39;biased&#39;, &#39;habituation&#39;, &#39;training&#39;,</span>
<span class="sd">        &#39;ephys&#39;, &#39;mock_ephys&#39; and &#39;sync_ephys&#39;.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; get_task_extractor_type(&#39;_iblrig_tasks_biasedChoiceWorld3.7.0&#39;)</span>
<span class="sd">    &#39;biased&#39;</span>

<span class="sd">    &gt;&gt;&gt; get_task_extractor_type(&#39;_iblrig_tasks_trainingChoiceWorld3.6.0&#39;)</span>
<span class="sd">    &#39;training&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">task_name</span> <span class="o">=</span> <span class="n">get_task_protocol</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="n">task_types</span> <span class="o">=</span> <span class="n">_get_task_types_json_config</span><span class="p">()</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="n">task_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Try lazy matching of name</span>
        <span class="n">task_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">task_types</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">task_types</span> <span class="k">if</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">task_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No extractor type found for </span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_type</span></div>



<div class="viewcode-block" id="get_session_extractor_type">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.get_session_extractor_type">[docs]</a>
<span class="k">def</span> <span class="nf">get_session_extractor_type</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Infer trials extractor type from task settings.</span>

<span class="sd">    From a session path, loads the settings file, finds the task and checks if extractors exist.</span>
<span class="sd">    Examples include &#39;biased&#39;, &#39;habituation&#39;, &#39;training&#39;, &#39;ephys&#39;, &#39;mock_ephys&#39;, and &#39;sync_ephys&#39;.</span>
<span class="sd">    Note this should only be used for legacy sessions, i.e. those without an experiment description</span>
<span class="sd">    file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session_path : str, pathlib.Path</span>
<span class="sd">        The session path for which to determine the pipeline.</span>
<span class="sd">    task_collection : str</span>
<span class="sd">        The session path directory containing the raw task data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or False</span>
<span class="sd">        The task extractor type, e.g. &#39;biased&#39;, &#39;habituation&#39;, &#39;ephys&#39;, or False if unknown.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_protocol</span> <span class="o">=</span> <span class="n">get_task_protocol</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="n">task_collection</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ABORT: No task protocol found in &quot;</span><span class="si">{</span><span class="n">task_collection</span><span class="si">}</span><span class="s1">&quot; folder </span><span class="si">{</span><span class="n">session_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">extractor_type</span> <span class="o">=</span> <span class="n">get_task_extractor_type</span><span class="p">(</span><span class="n">task_protocol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extractor_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">extractor_type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_pipeline">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.get_pipeline">[docs]</a>
<span class="k">def</span> <span class="nf">get_pipeline</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the pre-processing pipeline name from a session path.</span>

<span class="sd">    Note this is only suitable for legacy sessions, i.e. those without an experiment description</span>
<span class="sd">    file. This function will be removed in the future.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session_path : str, pathlib.Path</span>
<span class="sd">        The session path for which to determine the pipeline.</span>
<span class="sd">    task_collection : str</span>
<span class="sd">        The session path directory containing the raw task data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The pipeline name inferred from the extractor type, e.g. &#39;ephys&#39;, &#39;training&#39;, &#39;widefield&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stype</span> <span class="o">=</span> <span class="n">get_session_extractor_type</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="n">task_collection</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_get_pipeline_from_task_type</span><span class="p">(</span><span class="n">stype</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_get_pipeline_from_task_type</span><span class="p">(</span><span class="n">stype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the pipeline from the task type.</span>

<span class="sd">    Some task types directly define the pipeline. Note this is only suitable for legacy sessions,</span>
<span class="sd">    i.e. those without an experiment description file. This function will be removed in the future.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stype : str</span>
<span class="sd">        The session type or task extractor type, e.g. &#39;habituation&#39;, &#39;ephys&#39;, etc.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A task pipeline identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ephys_biased_opto&#39;</span><span class="p">,</span> <span class="s1">&#39;ephys&#39;</span><span class="p">,</span> <span class="s1">&#39;ephys_training&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_ephys&#39;</span><span class="p">,</span> <span class="s1">&#39;sync_ephys&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;ephys&#39;</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;habituation&#39;</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;biased&#39;</span><span class="p">,</span> <span class="s1">&#39;biased_opto&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;training&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stype</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;widefield&#39;</span> <span class="ow">in</span> <span class="n">stype</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;widefield&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stype</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>


<span class="k">def</span> <span class="nf">_get_task_extractor_map</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the task protocol extractor map.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, str]</span>
<span class="sd">        A map of task protocol to Bpod trials extractor class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">&#39;task_extractor_map.json&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">))</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">task_extractors</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># look if there are custom extractor types in the personal projects repo</span>
        <span class="kn">import</span> <span class="nn">projects.base</span>
        <span class="n">custom_extractors</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">projects</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">custom_extractors</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">custom_task_types</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">task_extractors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">custom_task_types</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">task_extractors</span>


<div class="viewcode-block" id="get_bpod_extractor_class">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.get_bpod_extractor_class">[docs]</a>
<span class="k">def</span> <span class="nf">get_bpod_extractor_class</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the Bpod trials extractor class associated with a given Bpod session.</span>

<span class="sd">    Note that unlike :func:`get_session_extractor_type`, this function maps directly to the Bpod</span>
<span class="sd">    trials extractor class name. This is hardware invariant and is purly to determine the Bpod only</span>
<span class="sd">    trials extractor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session_path : str, pathlib.Path</span>
<span class="sd">        The session path containing Bpod behaviour data.</span>
<span class="sd">    task_collection : str</span>
<span class="sd">        The session_path sub-folder containing the Bpod settings file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The extractor class name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Attempt to get protocol name from settings file</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">get_task_protocol</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="n">task_collection</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No task protocol found in </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">task_collection</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">protocol2extractor</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span></div>



<div class="viewcode-block" id="protocol2extractor">
<a class="viewcode-back" href="../../../../_autosummary/ibllib.io.extractors.base.html#ibllib.io.extractors.base.protocol2extractor">[docs]</a>
<span class="k">def</span> <span class="nf">protocol2extractor</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the Bpod trials extractor class associated with a given Bpod task protocol.</span>

<span class="sd">    The Bpod task protocol can be found in the &#39;PYBPOD_PROTOCOL&#39; field of the</span>
<span class="sd">    _iblrig_taskSettings.raw.json file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    protocol : str</span>
<span class="sd">        A Bpod task protocol name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The extractor class name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Attempt to get extractor class from protocol</span>
    <span class="n">extractor_map</span> <span class="o">=</span> <span class="n">_get_task_extractor_map</span><span class="p">()</span>
    <span class="n">extractor</span> <span class="o">=</span> <span class="n">extractor_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extractor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Try lazy matching of name</span>
        <span class="n">extractor</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">extractor_map</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">extractor_map</span> <span class="k">if</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">protocol</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extractor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No extractor associated with &quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extractor</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>