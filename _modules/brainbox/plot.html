<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>brainbox.plot &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DataJoint</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dj_docs/dj_introduction.html">Introduction to DataJoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dj_docs/dj_public.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dj_docs/dj_credentials.html">DataJoint credentials for internal IBL users</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../06_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/dj_intro/dj_intro.html">Datajoint Introductory Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/dj_basics/dj_basics.html">Exploring the IBL Data Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Detailed Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>brainbox.plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for brainbox.plot</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plots metrics that assess quality of single units. Some functions here generate plots for the</span>
<span class="sd">output of functions in the brainbox `single_units.py` module.</span>

<span class="sd">Run the following to set-up the workspace to run the docstring examples:</span>
<span class="sd">&gt;&gt;&gt; from brainbox import processing</span>
<span class="sd">&gt;&gt;&gt; import alf.io as aio</span>
<span class="sd">&gt;&gt;&gt; import numpy as np</span>
<span class="sd">&gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">&gt;&gt;&gt; import ibllib.ephys.spikes as e_spks</span>
<span class="sd"># (*Note, if there is no &#39;alf&#39; directory, make &#39;alf&#39; directory from &#39;ks2&#39; output directory):</span>
<span class="sd">&gt;&gt;&gt; e_spks.ks2_to_alf(path_to_ks_out, path_to_alf_out)</span>
<span class="sd"># Load the alf spikes bunch and clusters bunch, and get a units bunch.</span>
<span class="sd">&gt;&gt;&gt; spks_b = aio.load_object(path_to_alf_out, &#39;spikes&#39;)</span>
<span class="sd">&gt;&gt;&gt; clstrs_b = aio.load_object(path_to_alf_out, &#39;clusters&#39;)</span>
<span class="sd">&gt;&gt;&gt; units_b = processing.get_units_bunch(spks_b)  # may take a few mins to compute</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># from matplotlib.ticker import StrMethodFormatter</span>
<span class="kn">from</span> <span class="nn">brainbox</span> <span class="kn">import</span> <span class="n">singlecell</span>
<span class="kn">from</span> <span class="nn">brainbox.metrics</span> <span class="kn">import</span> <span class="n">single_units</span>
<span class="kn">from</span> <span class="nn">brainbox.processing</span> <span class="kn">import</span> <span class="n">bincount2D</span>
<span class="kn">from</span> <span class="nn">brainbox.io.spikeglx</span> <span class="kn">import</span> <span class="n">extract_waveforms</span>
<span class="kn">from</span> <span class="nn">ibllib.io</span> <span class="kn">import</span> <span class="n">spikeglx</span>


<div class="viewcode-block" id="feat_vars"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.feat_vars">[docs]</a><span class="k">def</span> <span class="nf">feat_vars</span><span class="p">(</span><span class="n">units_b</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feat_name</span><span class="o">=</span><span class="s1">&#39;amps&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span> <span class="n">cmap_name</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
              <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots the coefficients of variation of a particular spike feature for all units as a bar plot,</span>
<span class="sd">    where each bar is color-coded corresponding to the depth of the max amplitude channel of the</span>
<span class="sd">    respective unit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    units_b : bunch</span>
<span class="sd">        A units bunch containing fields with spike information (e.g. cluster IDs, times, features,</span>
<span class="sd">        etc.) for all units.</span>
<span class="sd">    units : array-like (optional)</span>
<span class="sd">        A subset of all units for which to create the bar plot. (If `None`, all units are used)</span>
<span class="sd">    feat_name : string (optional)</span>
<span class="sd">        The spike feature to plot.</span>
<span class="sd">    dist : string (optional)</span>
<span class="sd">        The type of hypothetical null distribution from which the empirical spike feature</span>
<span class="sd">        distributions are presumed to belong to.</span>
<span class="sd">    test : string (optional)</span>
<span class="sd">        The statistical test used to calculate the probability that the empirical spike feature</span>
<span class="sd">        distributions come from `dist`.</span>
<span class="sd">    cmap_name : string (optional)</span>
<span class="sd">        The name of the colormap associated with the plot.</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cv_vals : ndarray</span>
<span class="sd">        The coefficients of variation of `feat_name` for each unit.</span>
<span class="sd">    p_vals : ndarray</span>
<span class="sd">        The probabilites that the distribution for `feat_name` for each unit comes from a</span>
<span class="sd">        `dist` distribution based on the `test` statistical test.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    metrics.unit_stability</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Create a bar plot of the coefficients of variation of the spike amplitudes for all units.</span>
<span class="sd">        &gt;&gt;&gt; fig, var_vals, p_vals = bb.plot.feat_vars(units_b)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Get units.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># we&#39;re using a subset of all units</span>
        <span class="n">unit_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units_b</span><span class="p">[</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># For each unit in `unit_list`, remove unit from `units_b` if not in `units`.</span>
        <span class="p">[</span><span class="n">units_b</span><span class="p">[</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="ow">in</span> <span class="n">units</span><span class="p">)]</span>
    <span class="n">unit_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units_b</span><span class="p">[</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># get new `unit_list` after removing unit</span>

    <span class="c1"># Calculate coefficients of variation for all units</span>
    <span class="n">p_vals_b</span><span class="p">,</span> <span class="n">cv_b</span> <span class="o">=</span> <span class="n">single_units</span><span class="o">.</span><span class="n">unit_stability</span><span class="p">(</span>
        <span class="n">units_b</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="p">[</span><span class="n">feat_name</span><span class="p">],</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
    <span class="n">cv_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cv_b</span><span class="p">[</span><span class="n">feat_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">cv_vals</span> <span class="o">=</span> <span class="n">cv_vals</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="k">if</span> <span class="n">feat_name</span> <span class="o">==</span> <span class="s1">&#39;amps&#39;</span> <span class="k">else</span> <span class="n">cv_vals</span>  <span class="c1"># convert to uV if amps</span>
    <span class="n">p_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p_vals_b</span><span class="p">[</span><span class="n">feat_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1"># Remove any empty units. This must be done AFTER the above calculations for ALL units so that</span>
    <span class="c1"># we can keep direct indexing.</span>
    <span class="n">empty_unit_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">units_b</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="n">unit</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_list</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">good_units</span> <span class="o">=</span> <span class="p">[</span><span class="n">unit</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_list</span> <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">empty_unit_idxs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]</span>

    <span class="c1"># Get mean depths of spikes for good units</span>
    <span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">units_b</span><span class="p">[</span><span class="s1">&#39;depths&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">unit</span><span class="p">)])</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">good_units</span><span class="p">])</span>

    <span class="c1"># Create unit normalized colormap based on `depths`, sorted by depth.</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap_name</span><span class="p">)</span>
    <span class="n">depths_norm</span> <span class="o">=</span> <span class="n">depths</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>
    <span class="n">rgba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">cmap</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">depths_norm</span><span class="p">))])</span>

    <span class="c1"># Plot depth-color-coded h bar plot of CVs for `feature` for each unit, where units are</span>
    <span class="c1"># sorted descendingly by depth along y-axis.</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">good_units</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">cv_vals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">depths</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">rgba</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">max_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>
    <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">max_d</span> <span class="o">*</span> <span class="n">tick</span><span class="p">)</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">cbar</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">())</span>  <span class="c1"># must call `set_ticks` to call `set_ticklabels`</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CV of </span><span class="si">{feat}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feat</span><span class="o">=</span><span class="n">feat_name</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Unit Number (sorted by depth)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;CV&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cv_vals</span><span class="p">,</span> <span class="n">p_vals</span></div>


<div class="viewcode-block" id="missed_spikes_est"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.missed_spikes_est">[docs]</a><span class="k">def</span> <span class="nf">missed_spikes_est</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span> <span class="n">spks_per_bin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_num_bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots the pdf of an estimated symmetric spike feature distribution, with a vertical cutoff line</span>
<span class="sd">    that indicates the approximate fraction of spikes missing from the distribution, assuming the</span>
<span class="sd">    true distribution is symmetric.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    feat : ndarray</span>
<span class="sd">        The spikes&#39; feature values.</span>
<span class="sd">    feat_name : string</span>
<span class="sd">        The spike feature to plot.</span>
<span class="sd">    spks_per_bin : int (optional)</span>
<span class="sd">        The number of spikes per bin from which to compute the spike feature histogram.</span>
<span class="sd">    sigma : int (optional)</span>
<span class="sd">        The standard deviation for the gaussian kernel used to compute the pdf from the spike</span>
<span class="sd">        feature histogram.</span>
<span class="sd">    min_num_bins : int (optional)</span>
<span class="sd">        The minimum number of bins used to compute the spike feature histogram.</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fraction_missing : float</span>
<span class="sd">        The fraction of missing spikes (0-0.5). *Note: If more than 50% of spikes are missing, an</span>
<span class="sd">        accurate estimate isn&#39;t possible.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    single_units.feature_cutoff</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Plot cutoff line indicating the fraction of spikes missing from a unit based on the recorded</span>
<span class="sd">    unit&#39;s spike amplitudes, assuming the distribution of the unit&#39;s spike amplitudes is symmetric.</span>
<span class="sd">        &gt;&gt;&gt; feat = units_b[&#39;amps&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; fraction_missing = bb.plot.missed_spikes_est(feat, feat_name=&#39;amps&#39;, unit=1)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Calculate the feature distribution histogram and fraction of spikes missing.</span>
    <span class="n">fraction_missing</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">cutoff_idx</span> <span class="o">=</span> \
        <span class="n">single_units</span><span class="o">.</span><span class="n">missed_spikes_est</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">spks_per_bin</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">min_num_bins</span><span class="p">)</span>

    <span class="c1"># Plot.</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># create two axes</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># plot histogram and pdf on two separate axes</span>
        <span class="n">num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">spks_per_bin</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feat_name</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feat_name</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">cutoff_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pdf</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bin Number&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PDF Symmetry Cutoff</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;(estimated </span><span class="si">{:.2f}</span><span class="s1">% missing spikes)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fraction_missing</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># just plot pdf</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">cutoff_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pdf</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bin Number&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PDF Symmetry Cutoff</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;(estimated </span><span class="si">{:.2f}</span><span class="s1">% missing spikes)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fraction_missing</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fraction_missing</span></div>


<div class="viewcode-block" id="wf_comp"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.wf_comp">[docs]</a><span class="k">def</span> <span class="nf">wf_comp</span><span class="p">(</span><span class="n">ephys_file</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> <span class="n">n_ch_probe</span><span class="o">=</span><span class="mi">385</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="n">car</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots two different sets of waveforms across specified channels after (optionally)</span>
<span class="sd">    common-average-referencing. In this way, waveforms can be compared to see if there is,</span>
<span class="sd">    e.g. drift during the recording, or if two units should be merged, or one unit should be split.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ephys_file : string</span>
<span class="sd">        The file path to the binary ephys data.</span>
<span class="sd">    ts1 : array_like</span>
<span class="sd">        A set of timestamps for which to compare waveforms with `ts2`.</span>
<span class="sd">    ts2: array_like</span>
<span class="sd">        A set of timestamps for which to compare waveforms with `ts1`.</span>
<span class="sd">    ch : array-like</span>
<span class="sd">        The channels to use for extracting and plotting the waveforms.</span>
<span class="sd">    sr : int (optional)</span>
<span class="sd">        The sampling rate (in hz) that the ephys data was acquired at.</span>
<span class="sd">    n_ch_probe : int (optional)</span>
<span class="sd">        The number of channels of the recording.</span>
<span class="sd">    dtype: str (optional)</span>
<span class="sd">        The datatype represented by the bytes in `ephys_file`.</span>
<span class="sd">    car: bool (optional)</span>
<span class="sd">        A flag for whether or not to perform common-average-referencing before extracting waveforms</span>
<span class="sd">    col: list of strings or float arrays (optional)</span>
<span class="sd">        Two elements in the list, where each specifies the color the `ts1` and `ts2` waveforms</span>
<span class="sd">        will be plotted in, respectively.</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wf1 : ndarray</span>
<span class="sd">        The waveforms for the spikes in `ts1`: an array of shape (#spikes, #samples, #channels).</span>
<span class="sd">    wf2 : ndarray</span>
<span class="sd">        The waveforms for the spikes in `ts2`: an array of shape (#spikes, #samples, #channels).</span>
<span class="sd">    s : float</span>
<span class="sd">        The similarity score between the two sets of waveforms, calculated by</span>
<span class="sd">        `single_units.wf_similarity`</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    io.extract_waveforms</span>
<span class="sd">    single_units.wf_similarity</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Compare first and last 100 spike waveforms for unit1, across 20 channels around the channel</span>
<span class="sd">    of max amplitude, and compare the waveforms in the first minute to the waveforms in the fourth</span>
<span class="sd">    minutes for unit2, across 10 channels around the mean.</span>
<span class="sd">        # Get first and last 100 spikes, and 20 channels around channel of max amp for unit 1:</span>
<span class="sd">        &gt;&gt;&gt; ts1 = units_b[&#39;times&#39;][&#39;1&#39;][:100]</span>
<span class="sd">        &gt;&gt;&gt; ts2 = units_b[&#39;times&#39;][&#39;1&#39;][-100:]</span>
<span class="sd">        &gt;&gt;&gt; max_ch = clstrs_b[&#39;channels&#39;][1]</span>
<span class="sd">        &gt;&gt;&gt; if max_ch &lt; n_c_ch:  # take only channels greater than `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch, max_ch + 20)</span>
<span class="sd">        &gt;&gt;&gt; elif (max_ch + n_c_ch) &gt; n_ch_probe:  # take only channels less than `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch - 20, max_ch)</span>
<span class="sd">        &gt;&gt;&gt; else:  # take `n_c_ch` around `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch - 10, max_ch + 10)</span>
<span class="sd">        &gt;&gt;&gt; wf1, wf2, s = bb.plot.wf_comp(path_to_ephys_file, ts1, ts2, ch)</span>
<span class="sd">        # Plot waveforms for unit2 from the first and fourth minutes across 10 channels.</span>
<span class="sd">        &gt;&gt;&gt; ts = units_b[&#39;times&#39;][&#39;2&#39;]</span>
<span class="sd">        &gt;&gt;&gt; ts1_2 = ts[np.where(ts&lt;60)[0]]</span>
<span class="sd">        &gt;&gt;&gt; ts2_2 = ts[np.where(ts&gt;180)[0][:len(ts1)]]</span>
<span class="sd">        &gt;&gt;&gt; max_ch = clstrs_b[&#39;channels&#39;][2]</span>
<span class="sd">        &gt;&gt;&gt; if max_ch &lt; n_c_ch:  # take only channels greater than `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch, max_ch + 10)</span>
<span class="sd">        &gt;&gt;&gt; elif (max_ch + n_c_ch) &gt; n_ch_probe:  # take only channels less than `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch - 10, max_ch)</span>
<span class="sd">        &gt;&gt;&gt; else:  # take `n_c_ch` around `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch - 5, max_ch + 5)</span>
<span class="sd">        &gt;&gt;&gt; wf1_2, wf2_2, s_2 = bb.plot.wf_comp(path_to_ephys_file, ts1_2, ts2_2, ch)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Ensure `ch` is ndarray</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ch</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ch</span>

    <span class="c1"># Extract the waveforms for these timestamps and compute similarity score.</span>
    <span class="n">wf1</span> <span class="o">=</span> <span class="n">extract_waveforms</span><span class="p">(</span><span class="n">ephys_file</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span> <span class="n">n_ch_probe</span><span class="o">=</span><span class="n">n_ch_probe</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                            <span class="n">car</span><span class="o">=</span><span class="n">car</span><span class="p">)</span>
    <span class="n">wf2</span> <span class="o">=</span> <span class="n">extract_waveforms</span><span class="p">(</span><span class="n">ephys_file</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span> <span class="n">n_ch_probe</span><span class="o">=</span><span class="n">n_ch_probe</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                            <span class="n">car</span><span class="o">=</span><span class="n">car</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">single_units</span><span class="o">.</span><span class="n">wf_similarity</span><span class="p">(</span><span class="n">wf1</span><span class="p">,</span> <span class="n">wf2</span><span class="p">)</span>

    <span class="c1"># Plot these waveforms against each other.</span>
    <span class="n">n_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">n_ch</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># left col is all waveforms, right col is mean</span>
    <span class="k">for</span> <span class="n">cur_ax</span><span class="p">,</span> <span class="n">cur_ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">cur_ax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wf1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">cur_ax</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">cur_ax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wf2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">cur_ax</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">cur_ax</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wf1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">cur_ax</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">cur_ax</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wf2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">cur_ax</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">cur_ax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ch </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_ch</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All Waveforms. S = </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean Waveforms&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;1st spike set&#39;</span><span class="p">,</span> <span class="s1">&#39;2nd spike set&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">wf1</span><span class="p">,</span> <span class="n">wf2</span><span class="p">,</span> <span class="n">s</span></div>


<div class="viewcode-block" id="amp_heatmap"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.amp_heatmap">[docs]</a><span class="k">def</span> <span class="nf">amp_heatmap</span><span class="p">(</span><span class="n">ephys_file</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> <span class="n">n_ch_probe</span><span class="o">=</span><span class="mi">385</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="n">cmap_name</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">,</span>
                <span class="n">car</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots a heatmap of the normalized voltage values over time and space for given timestamps and</span>
<span class="sd">    channels, after (optionally) common-average-referencing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ephys_file : string</span>
<span class="sd">        The file path to the binary ephys data.</span>
<span class="sd">    ts: array_like</span>
<span class="sd">        A set of timestamps for which to get the voltage values.</span>
<span class="sd">    ch : array-like</span>
<span class="sd">        The channels to use for extracting the voltage values.</span>
<span class="sd">    sr : int (optional)</span>
<span class="sd">        The sampling rate (in hz) that the ephys data was acquired at.</span>
<span class="sd">    n_ch_probe : int (optional)</span>
<span class="sd">        The number of channels of the recording.</span>
<span class="sd">    dtype: str (optional)</span>
<span class="sd">        The datatype represented by the bytes in `ephys_file`.</span>
<span class="sd">    cmap_name : string (optional)</span>
<span class="sd">        The name of the colormap associated with the plot.</span>
<span class="sd">    car: bool (optional)</span>
<span class="sd">        A flag for whether or not to perform common-average-referencing before extracting waveforms</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    v_vals : ndarray</span>
<span class="sd">        The voltage values.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Plot a heatmap of the spike amplitudes across 20 channels around the channel of max</span>
<span class="sd">    amplitude for all spikes in unit 1.</span>
<span class="sd">        &gt;&gt;&gt; ts = units_b[&#39;times&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; max_ch = clstrs_b[&#39;channels&#39;][1]</span>
<span class="sd">        &gt;&gt;&gt; if max_ch &lt; n_c_ch:  # take only channels greater than `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch, max_ch + 20)</span>
<span class="sd">        &gt;&gt;&gt; elif (max_ch + n_c_ch) &gt; n_ch_probe:  # take only channels less than `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch - 20, max_ch)</span>
<span class="sd">        &gt;&gt;&gt; else:  # take `n_c_ch` around `max_ch`.</span>
<span class="sd">        &gt;&gt;&gt;     ch = np.arange(max_ch - 10, max_ch + 10)</span>
<span class="sd">        &gt;&gt;&gt; bb.plot.amp_heatmap(path_to_ephys_file, ts, ch)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Ensure `ch` is ndarray</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ch</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ch</span>

    <span class="c1"># Get memmapped array of `ephys_file`</span>
    <span class="n">s_reader</span> <span class="o">=</span> <span class="n">spikeglx</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">ephys_file</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">file_m</span> <span class="o">=</span> <span class="n">s_reader</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Get voltage values for each peak amplitude sample for `ch`.</span>
    <span class="n">max_amp_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span> <span class="o">*</span> <span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># Currently this is an annoying way to calculate `v_vals` b/c indexing with multiple values</span>
    <span class="c1"># is currently unsupported.</span>
    <span class="n">v_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_amp_samples</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_amp_samples</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">v_vals</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_m</span><span class="p">[</span><span class="n">max_amp_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]:</span><span class="n">max_amp_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">car</span><span class="p">:</span>  <span class="c1"># compute spatial noise in chunks, and subtract from `v_vals`.</span>
        <span class="c1"># Get subset of time (from first to last max amp sample)</span>
        <span class="n">n_chunk_samples</span> <span class="o">=</span> <span class="mf">5e6</span>  <span class="c1"># number of samples per chunk</span>
        <span class="n">n_chunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">max_amp_samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_amp_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span>
                           <span class="n">n_chunk_samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="c1"># Get samples that make up each chunk. e.g. `chunk_sample[1] - chunk_sample[0]` are the</span>
        <span class="c1"># samples that make up the first chunk.</span>
        <span class="n">chunk_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_amp_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_amp_samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_chunk_samples</span><span class="p">,</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">chunk_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_sample</span><span class="p">,</span> <span class="n">max_amp_samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">noise_s_chunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_chunks</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>  <span class="c1"># spatial noise array</span>
        <span class="c1"># Give time estimate for computing `noise_s_chunks`.</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">file_m</span><span class="p">[</span><span class="n">chunk_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">chunk_sample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ch</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Performing spatial CAR before waveform extraction. Estimated time is </span><span class="si">{:.2f}</span><span class="s1"> mins.&#39;</span>
              <span class="s1">&#39; (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">n_chunks</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="c1"># Compute noise for each chunk, then take the median noise of all chunks.</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chunks</span><span class="p">):</span>
            <span class="n">noise_s_chunks</span><span class="p">[</span><span class="n">chunk</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span>
                <span class="n">file_m</span><span class="p">[</span><span class="n">chunk_sample</span><span class="p">[</span><span class="n">chunk</span><span class="p">]:</span><span class="n">chunk_sample</span><span class="p">[</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ch</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">noise_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">noise_s_chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">v_vals</span> <span class="o">-=</span> <span class="n">noise_s</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done. (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
    <span class="n">s_reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Plot heatmap.</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">v_vals_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_vals</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v_vals</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">cbar_map</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v_vals_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_name</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                         <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Channel Numbers&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Voltage Heatmap&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cbar_map</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v_vals</span></div>


<div class="viewcode-block" id="firing_rate"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.firing_rate">[docs]</a><span class="k">def</span> <span class="nf">firing_rate</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hist_win</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">fr_win</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">show_fr_cv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots the instantaneous firing rate of for given spike timestamps over time, and optionally</span>
<span class="sd">    overlays the value of the coefficient of variation of the firing rate for a specified number</span>
<span class="sd">    of bins.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts : ndarray</span>
<span class="sd">        The spike timestamps from which to compute the firing rate.</span>
<span class="sd">    hist_win : float (optional)</span>
<span class="sd">        The time window (in s) to use for computing spike counts.</span>
<span class="sd">    fr_win : float (optional)</span>
<span class="sd">        The time window (in s) to use as a moving slider to compute the instantaneous firing rate.</span>
<span class="sd">    n_bins : int (optional)</span>
<span class="sd">        The number of bins in which to compute coefficients of variation of the firing rate.</span>
<span class="sd">    show_fr_cv : bool (optional)</span>
<span class="sd">        A flag for whether or not to compute and show the coefficients of variation of the firing</span>
<span class="sd">        rate for `n_bins`.</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fr: ndarray</span>
<span class="sd">        The instantaneous firing rate over time (in hz).</span>
<span class="sd">    cv: float</span>
<span class="sd">        The mean coefficient of variation of the firing rate of the `n_bins` number of coefficients</span>
<span class="sd">        computed. Can only be returned if `show_fr_cv` is True.</span>
<span class="sd">    cvs: ndarray</span>
<span class="sd">        The coefficients of variation of the firing for each bin of `n_bins`. Can only be returned</span>
<span class="sd">        if `show_fr_cv` is True.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    single_units.firing_rate_cv</span>
<span class="sd">    singecell.firing_rate</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Plot the firing rate for unit 1 from the time of its first to last spike, showing the cv</span>
<span class="sd">    of the firing rate for 10 evenly spaced bins.</span>
<span class="sd">        &gt;&gt;&gt; ts = units_b[&#39;times&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; fr, cv, cvs = bb.plot.firing_rate(ts)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">show_fr_cv</span><span class="p">):</span>  <span class="c1"># compute just the firing rate</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">singlecell</span><span class="o">.</span><span class="n">firing_rate</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hist_win</span><span class="o">=</span><span class="n">hist_win</span><span class="p">,</span> <span class="n">fr_win</span><span class="o">=</span><span class="n">fr_win</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># compute firing rate and coefficients of variation</span>
        <span class="n">cv</span><span class="p">,</span> <span class="n">cvs</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">single_units</span><span class="o">.</span><span class="n">firing_rate_coeff_var</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hist_win</span><span class="o">=</span><span class="n">hist_win</span><span class="p">,</span> <span class="n">fr_win</span><span class="o">=</span><span class="n">fr_win</span><span class="p">,</span>
                                                         <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fr</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">hist_win</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Firing Rate&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rate (s$^-1$)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">show_fr_cv</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fr</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># show coefficients of variation</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span>
        <span class="n">x_l</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">n_bins</span><span class="p">)]</span>
        <span class="c1"># Plot vertical lines separating plots into `n_bins`.</span>
        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">((</span><span class="n">x_l</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">)]</span>
        <span class="c1"># Plot text with cv of firing rate for each bin.</span>
        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_l</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y_max</span><span class="p">,</span> <span class="s1">&#39;cv=</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cvs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">fr</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">cvs</span></div>


<div class="viewcode-block" id="peri_event_time_histogram"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.peri_event_time_histogram">[docs]</a><span class="k">def</span> <span class="nf">peri_event_time_histogram</span><span class="p">(</span>
        <span class="n">spike_times</span><span class="p">,</span> <span class="n">spike_clusters</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">cluster_id</span><span class="p">,</span>  <span class="c1"># Everything you need for a basic plot</span>
        <span class="n">t_before</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">t_after</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">as_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_raster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_rasters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_bars</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pethline_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="n">errbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="n">eventline_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="n">raster_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot peri-event time histograms, with the meaning firing rate of units centered on a given</span>
<span class="sd">    series of events. Can optionally add a raster underneath the PETH plot of individual spike</span>
<span class="sd">    trains about the events.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spike_times : array_like</span>
<span class="sd">        Spike times (in seconds)</span>
<span class="sd">    spike_clusters : array-like</span>
<span class="sd">        Cluster identities for each element of spikes</span>
<span class="sd">    events : array-like</span>
<span class="sd">        Times to align the histogram(s) to</span>
<span class="sd">    cluster_id : int</span>
<span class="sd">        Identity of the cluster for which to plot a PETH</span>

<span class="sd">    t_before : float, optional</span>
<span class="sd">        Time before event to plot (default: 0.2s)</span>
<span class="sd">    t_after : float, optional</span>
<span class="sd">        Time after event to plot (default: 0.5s)</span>
<span class="sd">    bin_size :float, optional</span>
<span class="sd">        Width of bin for histograms (default: 0.025s)</span>
<span class="sd">    smoothing : float, optional</span>
<span class="sd">        Sigma of gaussian smoothing to use in histograms. (default: 0.025s)</span>
<span class="sd">    as_rate : bool, optional</span>
<span class="sd">        Whether to use spike counts or rates in the plot (default: `True`, uses rates)</span>
<span class="sd">    include_raster : bool, optional</span>
<span class="sd">        Whether to put a raster below the PETH of individual spike trains (default: `False`)</span>
<span class="sd">    n_rasters : int, optional</span>
<span class="sd">        If include_raster is True, the number of rasters to include. If `None`</span>
<span class="sd">        will default to plotting rasters around all provided events. (default: `None`)</span>
<span class="sd">    error_bars : {&#39;std&#39;, &#39;sem&#39;, &#39;none&#39;}, optional</span>
<span class="sd">        Defines which type of error bars to plot. Options are:</span>
<span class="sd">        -- `&#39;std&#39;` for 1 standard deviation</span>
<span class="sd">        -- `&#39;sem&#39;` for standard error of the mean</span>
<span class="sd">        -- `&#39;none&#39;` for only plotting the mean value</span>
<span class="sd">        (default: `&#39;std&#39;`)</span>
<span class="sd">    ax : matplotlib axes, optional</span>
<span class="sd">        If passed, the function will plot on the passed axes. Note: current</span>
<span class="sd">        behavior causes whatever was on the axes to be cleared before plotting!</span>
<span class="sd">        (default: `None`)</span>
<span class="sd">    pethline_kwargs : dict, optional</span>
<span class="sd">        Dict containing line properties to define PETH plot line. Default</span>
<span class="sd">        is a blue line with weight of 2. Needs to have color. See matplotlib plot documentation</span>
<span class="sd">        for more options.</span>
<span class="sd">        (default: `{&#39;color&#39;: &#39;blue&#39;, &#39;lw&#39;: 2}`)</span>
<span class="sd">    errbar_kwargs : dict, optional</span>
<span class="sd">        Dict containing fill-between properties to define PETH error bars.</span>
<span class="sd">        Default is a blue fill with 50 percent opacity.. Needs to have color. See matplotlib</span>
<span class="sd">        fill_between documentation for more options.</span>
<span class="sd">        (default: `{&#39;color&#39;: &#39;blue&#39;, &#39;alpha&#39;: 0.5}`)</span>
<span class="sd">    eventline_kwargs : dict, optional</span>
<span class="sd">        Dict containing fill-between properties to define line at event.</span>
<span class="sd">        Default is a black line with 50 percent opacity.. Needs to have color. See matplotlib</span>
<span class="sd">        vlines documentation for more options.</span>
<span class="sd">        (default: `{&#39;color&#39;: &#39;black&#39;, &#39;alpha&#39;: 0.5}`)</span>
<span class="sd">    raster_kwargs : dict, optional</span>
<span class="sd">        Dict containing properties defining lines in the raster plot.</span>
<span class="sd">        Default is black lines with line width of 0.5. See matplotlib vlines for more options.</span>
<span class="sd">        (default: `{&#39;color&#39;: &#39;black&#39;, &#39;lw&#39;: 0.5}`)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        ax : matplotlib axes</span>
<span class="sd">            Axes with all of the plots requested.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check to make sure if we fail, we fail in an informative way</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_clusters</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Spike times and clusters are not of the same shape&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot make a PETH with only one event.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error_bars</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;sem&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid error bar type was passed.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">events</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are NaN or inf values in the list of events passed. &#39;</span>
                         <span class="s1">&#39; Please remove non-finite data points and try again.&#39;</span><span class="p">)</span>

    <span class="c1"># Compute peths</span>
    <span class="n">peths</span><span class="p">,</span> <span class="n">binned_spikes</span> <span class="o">=</span> <span class="n">singlecell</span><span class="o">.</span><span class="n">calculate_peths</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">spike_clusters</span><span class="p">,</span> <span class="p">[</span><span class="n">cluster_id</span><span class="p">],</span>
                                                      <span class="n">events</span><span class="p">,</span> <span class="n">t_before</span><span class="p">,</span> <span class="n">t_after</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">,</span>
                                                      <span class="n">smoothing</span><span class="p">,</span> <span class="n">as_rate</span><span class="p">)</span>
    <span class="c1"># Construct an axis object if none passed</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># Plot the curve and add error bars</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">peths</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peths</span><span class="o">.</span><span class="n">tscale</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="o">**</span><span class="n">pethline_kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="n">peths</span><span class="o">.</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s1">&#39;sem&#39;</span><span class="p">:</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="n">peths</span><span class="o">.</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error_bars</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">peths</span><span class="o">.</span><span class="n">tscale</span><span class="p">,</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">bars</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">bars</span><span class="p">,</span> <span class="o">**</span><span class="n">errbar_kwargs</span><span class="p">)</span>

    <span class="c1"># Plot the event marker line. Extends to 5% higher than max value of means plus any error bar.</span>
    <span class="n">plot_edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">bars</span><span class="p">[</span><span class="n">mean</span><span class="o">.</span><span class="n">argmax</span><span class="p">()])</span> <span class="o">*</span> <span class="mf">1.05</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">plot_edge</span><span class="p">,</span> <span class="o">**</span><span class="n">eventline_kwargs</span><span class="p">)</span>
    <span class="c1"># Set the limits on the axes to t_before and t_after. Either set the ylim to the 0 and max</span>
    <span class="c1"># values of the PETH, or if we want to plot a spike raster below, create an equal amount of</span>
    <span class="c1"># blank space below the zero where the raster will go.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="n">t_before</span><span class="p">,</span> <span class="n">t_after</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">plot_edge</span> <span class="k">if</span> <span class="n">include_raster</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">plot_edge</span><span class="p">])</span>
    <span class="c1"># Put y ticks only at min, max, and zero</span>
    <span class="k">if</span> <span class="n">mean</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">mean</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mean</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mean</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
    <span class="c1"># Move the x axis line from the bottom of the plotting space to zero if including a raster,</span>
    <span class="c1"># Then plot the raster</span>
    <span class="k">if</span> <span class="n">include_raster</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_rasters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_rasters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_rasters</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Number of raster traces is greater than 60. This might look bad on the plot.&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">tickheight</span> <span class="o">=</span> <span class="n">plot_edge</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">[:</span><span class="n">n_rasters</span><span class="p">])</span>  <span class="c1"># How much space per trace</span>
        <span class="n">tickedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">plot_edge</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="o">-</span><span class="n">tickheight</span><span class="p">)</span>
        <span class="n">clu_spks</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">spike_clusters</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">[:</span><span class="n">n_rasters</span><span class="p">]):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">clu_spks</span> <span class="o">&gt;=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t_before</span><span class="p">,</span> <span class="n">clu_spks</span> <span class="o">&lt;=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">t_after</span><span class="p">)</span>
            <span class="n">event_spks</span> <span class="o">=</span> <span class="n">clu_spks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">event_spks</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="n">tickedges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tickedges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">raster_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Firing Rate&#39;</span> <span class="k">if</span> <span class="n">as_rate</span> <span class="k">else</span> <span class="s1">&#39;Number of spikes&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Firing Rate&#39;</span> <span class="k">if</span> <span class="n">as_rate</span> <span class="k">else</span> <span class="s1">&#39;Number of spikes&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s) after event&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="driftmap"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.driftmap">[docs]</a><span class="k">def</span> <span class="nf">driftmap</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_style</span><span class="o">=</span><span class="s1">&#39;bincount&#39;</span><span class="p">,</span>
             <span class="n">t_bin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">d_bin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the values of a spike feature array (y-axis) over time (x-axis).</span>
<span class="sd">    Two arguments can be given for the plot_style of the drift map:</span>
<span class="sd">    - &#39;scatter&#39; : whereby each value is plotted as a marker (up to 100&#39;000 data point)</span>
<span class="sd">    - &#39;bincount&#39; : whereby the values are binned (optimised to represent spike raster)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    feat : ndarray</span>
<span class="sd">        The spikes&#39; feature values.</span>
<span class="sd">    ts : ndarray</span>
<span class="sd">        The spike timestamps from which to compute the firing rate.</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>
<span class="sd">    t_bin: time bin used when plot_style=&#39;bincount&#39;</span>
<span class="sd">    d_bin: depth bin used when plot_style=&#39;bincount&#39;</span>
<span class="sd">    plot_style: &#39;scatter&#39;, &#39;bincount&#39;</span>
<span class="sd">    **kwargs: matplotlib.imshow arguments</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cd: float</span>
<span class="sd">        The cumulative drift of `feat`.</span>
<span class="sd">    md: float</span>
<span class="sd">        The maximum drift of `feat`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    metrics.cum_drift</span>
<span class="sd">    metrics.max_drift</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Plot the amplitude driftmap for unit 1.</span>
<span class="sd">        &gt;&gt;&gt; ts = units_b[&#39;times&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; amps = units_b[&#39;amps&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; ax = bb.plot.driftmap(ts, amps)</span>
<span class="sd">    2) Plot the depth driftmap for unit 1.</span>
<span class="sd">        &gt;&gt;&gt; ts = units_b[&#39;times&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; depths = units_b[&#39;depths&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; ax = bb.plot.driftmap(ts, depths)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iok</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot_style</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;here todo&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># compute raster map as a function of site depth</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">depths</span> <span class="o">=</span> <span class="n">bincount2D</span><span class="p">(</span>
            <span class="n">ts</span><span class="p">[</span><span class="n">iok</span><span class="p">],</span> <span class="n">feat</span><span class="p">[</span><span class="n">iok</span><span class="p">],</span> <span class="n">t_bin</span><span class="p">,</span> <span class="n">d_bin</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="c1"># plot raster map</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
                  <span class="n">extent</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">times</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">depths</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (secs)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;depth (um)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="pres_ratio"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.pres_ratio">[docs]</a><span class="k">def</span> <span class="nf">pres_ratio</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hist_win</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots the presence ratio of spike counts: the number of bins where there is at least one</span>
<span class="sd">    spike, over the total number of bins, given a specified bin width.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts : ndarray</span>
<span class="sd">        The spike timestamps from which to compute the presence ratio.</span>
<span class="sd">    hist_win : float</span>
<span class="sd">        The time window (in s) to use for computing the presence ratio.</span>
<span class="sd">    ax : axessubplot (optional)</span>
<span class="sd">        The axis handle to plot the histogram on. (if `None`, a new figure and axis is created)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pr : float</span>
<span class="sd">        The presence ratio.</span>
<span class="sd">    spks_bins : ndarray</span>
<span class="sd">        The number of spks in each bin.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    metrics.pres_ratio</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    1) Plot the presence ratio for unit 1, given a window of 10 s.</span>
<span class="sd">        &gt;&gt;&gt; ts = units_b[&#39;times&#39;][&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pr, pr_bins = bb.plot.pres_ratio(ts)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">pr</span><span class="p">,</span> <span class="n">spks_bins</span> <span class="o">=</span> <span class="n">single_units</span><span class="o">.</span><span class="n">pres_ratio</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hist_win</span><span class="p">)</span>
    <span class="n">pr_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spks_bins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pr_bins</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bin Number (width=</span><span class="si">{:.1f}</span><span class="s1">s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hist_win</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Presence&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Presence Ratio&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pr</span><span class="p">,</span> <span class="n">spks_bins</span></div>


<div class="viewcode-block" id="driftmap_color"><a class="viewcode-back" href="../../_autosummary/brainbox.plot.html#brainbox.plot.driftmap_color">[docs]</a><span class="k">def</span> <span class="nf">driftmap_color</span><span class="p">(</span>
        <span class="n">clusters_depths</span><span class="p">,</span> <span class="n">spikes_times</span><span class="p">,</span>
        <span class="n">spikes_amps</span><span class="p">,</span> <span class="n">spikes_depths</span><span class="p">,</span> <span class="n">spikes_clusters</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axesoff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_lims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots the driftmap of a session or a trial</span>

<span class="sd">    The plot shows the spike times vs spike depths.</span>
<span class="sd">    Each dot is a spike, whose color indicates the cluster</span>
<span class="sd">    and opacity indicates the spike amplitude.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    clusters_depths: ndarray</span>
<span class="sd">        depths of all clusters</span>
<span class="sd">    spikes_times: ndarray</span>
<span class="sd">        spike times of all clusters</span>
<span class="sd">    spikes_amps: ndarray</span>
<span class="sd">        amplitude of each spike</span>
<span class="sd">    spikes_depths: ndarray</span>
<span class="sd">        depth of each spike</span>
<span class="sd">    spikes_clusters: ndarray</span>
<span class="sd">        cluster idx of each spike</span>
<span class="sd">    ax: matplotlib.axes.Axes object (optional)</span>
<span class="sd">        The axis object to plot the driftmap on</span>
<span class="sd">        (if `None`, a new figure and axis is created)</span>

<span class="sd">    Return</span>
<span class="sd">    ---</span>
<span class="sd">    ax: matplotlib.axes.Axes object</span>
<span class="sd">        The axis object with driftmap plotted</span>
<span class="sd">    x_lim: list of two elements</span>
<span class="sd">        range of x axis</span>
<span class="sd">    y_lim: list of two elements</span>
<span class="sd">        range of y axis</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">color_bins</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">new_color_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">color_bins</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># get the sorted idx of each depth, and create colors based on the idx</span>

    <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">clusters_depths</span><span class="p">))</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">new_color_bins</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="p">:][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">n_spikes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">n_spikes</span><span class="p">)</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">sorted_idx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spikes_clusters</span><span class="p">,</span>
                                      <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">])])</span>

    <span class="n">max_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">spikes_amps</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">min_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">spikes_amps</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">opacity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">spikes_amps</span> <span class="o">-</span> <span class="n">min_amp</span><span class="p">,</span> <span class="n">max_amp</span> <span class="o">-</span> <span class="n">min_amp</span><span class="p">)</span>
    <span class="n">opacity</span><span class="p">[</span><span class="n">opacity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">opacity</span><span class="p">[</span><span class="n">opacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">colorvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">opacity</span><span class="p">),</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float16&#39;</span><span class="p">)</span>
    <span class="n">colorvec</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">opacity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float16&#39;</span><span class="p">)</span>
    <span class="n">colorvec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float16&#39;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">spikes_times</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">spikes_depths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colorvec</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (sec)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Distance from the probe tip (um)&#39;</span><span class="p">)</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="n">x_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="n">x_lim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_edge</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_edge</span><span class="p">]</span>
    <span class="n">y_lim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">axesoff</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;driftmap.png&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_lims</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">x_lim</span><span class="p">,</span> <span class="n">y_lim</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ax</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>