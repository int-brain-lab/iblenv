

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>brainbox.behavior.training &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/style.css?v=17142d56" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_release_repro_ephys.html">Data Release - Reproducible Ephys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_download.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks_external/docs_wheel_screen_stimulus.html">Computing the stimulus position using the wheel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">brainbox.behavior.training</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for brainbox.behavior.training</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Computing and testing IBL training status criteria.</span>

<span class="sd">For an in-depth description of each training status, see `Appendix 2`_ of the IBL Protocol For Mice</span>
<span class="sd">Training.</span>

<span class="sd">.. _Appendix 2: https://figshare.com/articles/preprint/A_standardized_and_reproducible_method_to_\</span>
<span class="sd">measure_decision-making_in_mice_Appendix_2_IBL_protocol_for_mice_training/11634729</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">Plot the psychometric curve for a given session.</span>

<span class="sd">&gt;&gt;&gt; trials = ONE().load_object(eid, &#39;trials&#39;)</span>
<span class="sd">&gt;&gt;&gt; fix, ax = plot_psychometric(trials)</span>

<span class="sd">Compute &#39;response times&#39;, defined as the duration of open-loop for each contrast.</span>

<span class="sd">&gt;&gt;&gt; reaction_time, contrasts, n_contrasts = compute_reaction_time(trials)</span>

<span class="sd">Compute &#39;reaction times&#39;, defined as the time between go cue and first detected movement.</span>
<span class="sd">NB: These may be negative!</span>

<span class="sd">&gt;&gt;&gt; reaction_time, contrasts, n_contrasts = compute_reaction_time(</span>
<span class="sd">...     trials, stim_on_type=&#39;goCue_times&#39;, stim_off_type=&#39;firstMovement_times&#39;)</span>

<span class="sd">Compute &#39;response times&#39;, defined as the time between first detected movement and response.</span>

<span class="sd">&gt;&gt;&gt; reaction_time, contrasts, n_contrasts = compute_reaction_time(</span>
<span class="sd">...     trials, stim_on_type=&#39;firstMovement_times&#39;, stim_off_type=&#39;response_times&#39;)</span>

<span class="sd">Compute &#39;movement times&#39;, defined as the time between last detected movement and response threshold.</span>

<span class="sd">&gt;&gt;&gt; import brainbox.behavior.wheel as wh</span>
<span class="sd">&gt;&gt;&gt; wheel_moves = ONE().load_object(eid, &#39;wheeMoves&#39;)</span>
<span class="sd">&gt;&gt;&gt; trials[&#39;lastMovement_times&#39;] = wh.get_movement_onset(wheel_moves.intervals, trial_data.response_times)</span>
<span class="sd">&gt;&gt;&gt; reaction_time, contrasts, n_contrasts = compute_reaction_time(</span>
<span class="sd">...     trials, stim_on_type=&#39;lastMovement_times&#39;, stim_off_type=&#39;response_times&#39;)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntFlag</span><span class="p">,</span> <span class="n">auto</span><span class="p">,</span> <span class="n">unique</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootstrap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iblutil.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bunch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ONE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.alf.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">AlfBunch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.alf.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALFObjectNotFound</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psychofit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">psy</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ibllib&#39;</span><span class="p">)</span>

<span class="n">TRIALS_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;contrastLeft&#39;</span><span class="p">,</span>
               <span class="s1">&#39;contrastRight&#39;</span><span class="p">,</span>
               <span class="s1">&#39;feedbackType&#39;</span><span class="p">,</span>
               <span class="s1">&#39;probabilityLeft&#39;</span><span class="p">,</span>
               <span class="s1">&#39;choice&#39;</span><span class="p">,</span>
               <span class="s1">&#39;response_times&#39;</span><span class="p">,</span>
               <span class="s1">&#39;stimOn_times&#39;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;list of str: The required keys in the trials object for computing training status.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="TrainingStatus">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.TrainingStatus">[docs]</a>
<span class="nd">@unique</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainingStatus</span><span class="p">(</span><span class="n">IntFlag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard IBL training criteria.</span>

<span class="sd">    Enumeration allows for comparisons between training status.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; status = &#39;ready4delay&#39;</span>
<span class="sd">    ... assert TrainingStatus[status.upper()] is TrainingStatus.READY4DELAY</span>
<span class="sd">    ... assert TrainingStatus[status.upper()] not in TrainingStatus.FAILED, &#39;Subject failed training&#39;</span>
<span class="sd">    ... assert TrainingStatus[status.upper()] &gt;= TrainingStatus.TRAINED, &#39;Subject untrained&#39;</span>
<span class="sd">    ... assert TrainingStatus[status.upper()] &gt; TrainingStatus.IN_TRAINING, &#39;Subject untrained&#39;</span>
<span class="sd">    ... assert TrainingStatus[status.upper()] in ~TrainingStatus.FAILED, &#39;Subject untrained&#39;</span>
<span class="sd">    ... assert TrainingStatus[status.upper()] in TrainingStatus.TRAINED ^ TrainingStatus.READY</span>

<span class="sd">    Get the next training status</span>

<span class="sd">    &gt;&gt;&gt; next(member for member in sorted(TrainingStatus) if member &gt; TrainingStatus[status.upper()])</span>
<span class="sd">    &lt;TrainingStatus.READY4RECORDING: 128&gt;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - ~TrainingStatus.TRAINED means any status but trained 1a or trained 1b.</span>
<span class="sd">    - A subject may acheive both TRAINED_1A and TRAINED_1B within a single session, therefore it</span>
<span class="sd">      is possible to have skipped the TRAINED_1A session status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">UNTRAINABLE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">UNBIASABLE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">IN_TRAINING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">TRAINED_1A</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">TRAINED_1B</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">READY4EPHYSRIG</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">READY4DELAY</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">READY4RECORDING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="c1"># Compound training statuses for convenience</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="n">UNTRAINABLE</span> <span class="o">|</span> <span class="n">UNBIASABLE</span>
    <span class="n">READY</span> <span class="o">=</span> <span class="n">READY4EPHYSRIG</span> <span class="o">|</span> <span class="n">READY4DELAY</span> <span class="o">|</span> <span class="n">READY4RECORDING</span>
    <span class="n">TRAINED</span> <span class="o">=</span> <span class="n">TRAINED_1A</span> <span class="o">|</span> <span class="n">TRAINED_1B</span></div>



<div class="viewcode-block" id="get_lab_training_status">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.get_lab_training_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_lab_training_status</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the training status of all alive and water restricted subjects in a specified lab.</span>

<span class="sd">    The response are printed to std out.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lab : str</span>
<span class="sd">        Lab name (must match the name registered on Alyx).</span>
<span class="sd">    date : str</span>
<span class="sd">        The ISO date from which to compute training status. If not specified will compute from the</span>
<span class="sd">        latest date with available data.  Format should be &#39;YYYY-MM-DD&#39;.</span>
<span class="sd">    details : bool</span>
<span class="sd">        Whether to display all information about training status computation e.g. performance,</span>
<span class="sd">        number of trials, psychometric fit parameters.</span>
<span class="sd">    one : one.api.OneAlyx</span>
<span class="sd">        An instance of ONE.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">ONE</span><span class="p">()</span>
    <span class="n">subj_lab</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">water_restricted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">subj</span><span class="p">[</span><span class="s1">&#39;nickname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subj_lab</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">get_subject_training_status</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_subject_training_status">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.get_subject_training_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_subject_training_status</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the training status of specified subject and prints results to std out.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subj : str</span>
<span class="sd">        Subject nickname (must match the name registered on Alyx).</span>
<span class="sd">    date : str</span>
<span class="sd">        The ISO date from which to compute training status. If not specified will compute from the</span>
<span class="sd">        latest date with available data.  Format should be &#39;YYYY-MM-DD&#39;.</span>
<span class="sd">    details : bool</span>
<span class="sd">        Whether to display all information about training status computation e.g. performance,</span>
<span class="sd">        number of trials, psychometric fit parameters.</span>
<span class="sd">    one : one.api.OneAlyx</span>
<span class="sd">        An instance of ONE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">ONE</span><span class="p">()</span>

    <span class="n">trials</span><span class="p">,</span> <span class="n">task_protocol</span><span class="p">,</span> <span class="n">ephys_sess</span><span class="p">,</span> <span class="n">n_delay</span> <span class="o">=</span> <span class="n">get_sessions</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">trials</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">sess_dates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_training_status</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">task_protocol</span><span class="p">,</span> <span class="n">ephys_sess</span><span class="p">,</span> <span class="n">n_delay</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psych&#39;</span><span class="p">)):</span>
            <span class="n">display_status</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess_dates</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">perf_easy</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span>
                           <span class="n">n_trials</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">psych</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">psych</span><span class="p">,</span> <span class="n">rt</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psych_20&#39;</span><span class="p">)):</span>
            <span class="n">display_status</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess_dates</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">perf_easy</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span>
                           <span class="n">n_trials</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">psych_20</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">psych_20</span><span class="p">,</span> <span class="n">psych_80</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">psych_80</span><span class="p">,</span>
                           <span class="n">rt</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">display_status</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess_dates</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_sessions">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.get_sessions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_sessions</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download and load in training data for a specified subject. If a date is given it will load</span>
<span class="sd">    data from the three (or as many as are available) previous sessions up to the specified date.</span>
<span class="sd">    If not it will load data from the last three training sessions that have data available.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subj : str</span>
<span class="sd">        Subject nickname (must match the name registered on Alyx).</span>
<span class="sd">    date : str</span>
<span class="sd">        The ISO date from which to compute training status. If not specified will compute from the</span>
<span class="sd">        latest date with available data.  Format should be &#39;YYYY-MM-DD&#39;.</span>
<span class="sd">    one : one.api.OneAlyx</span>
<span class="sd">        An instance of ONE.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iblutil.util.Bunch</span>
<span class="sd">        Dictionary of trials objects where each key is the ISO session date string.</span>
<span class="sd">    list of str</span>
<span class="sd">        List of the task protocol used for each of the sessions.</span>
<span class="sd">    list of str</span>
<span class="sd">        List of ISO date strings where training was conducted on ephys rig. Empty list if all</span>
<span class="sd">        sessions on training rig.</span>
<span class="sd">    n_delay : int</span>
<span class="sd">        Number of sessions on ephys rig that had delay prior to starting session &gt; 15min.</span>
<span class="sd">        Returns 0 if no sessions detected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">ONE</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># compute from yesterday</span>
        <span class="n">specified_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">latest_sess</span> <span class="o">=</span> <span class="n">specified_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">latest_minus_week</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span>
                             <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># compute from the date specified</span>
        <span class="n">specified_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">latest_minus_week</span> <span class="o">=</span> <span class="p">(</span><span class="n">specified_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">latest_sess</span> <span class="o">=</span> <span class="n">date</span>

    <span class="n">sessions</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subj</span><span class="p">,</span> <span class="n">date_range</span><span class="o">=</span><span class="p">[</span><span class="n">latest_minus_week</span><span class="p">,</span>
                             <span class="n">latest_sess</span><span class="p">],</span> <span class="n">dataset_types</span><span class="o">=</span><span class="s1">&#39;trials.goCueTrigger_times&#39;</span><span class="p">)</span>

    <span class="c1"># If not enough sessions in the last week, then just fetch them all</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">specified_date_plus</span> <span class="o">=</span> <span class="p">(</span><span class="n">specified_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">django_query</span> <span class="o">=</span> <span class="s1">&#39;start_time__lte,&#39;</span> <span class="o">+</span> <span class="n">specified_date_plus</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subj</span><span class="p">,</span>
                                 <span class="n">dataset_types</span><span class="o">=</span><span class="s1">&#39;trials.goCueTrigger_times&#39;</span><span class="p">,</span> <span class="n">django</span><span class="o">=</span><span class="n">django_query</span><span class="p">)</span>

        <span class="c1"># If still 0 sessions then return with warning</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No training sessions detected for </span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="n">trials</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">task_protocol</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sess_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sessions</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">trials_</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;trials&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ALFObjectNotFound</span><span class="p">:</span>
                <span class="n">trials_</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">trials_</span><span class="p">:</span>
                <span class="n">task_protocol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;tasks_(.*)Choice&#39;</span><span class="p">,</span>
                                     <span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;task_protocol&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">sess_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">])</span>
                <span class="n">trials</span><span class="p">[</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]]</span> <span class="o">=</span> <span class="n">trials_</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">trials_</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;trials&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ALFObjectNotFound</span><span class="p">:</span>
                <span class="n">trials_</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">trials_</span><span class="p">:</span>
                <span class="n">task_protocol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;tasks_(.*)Choice&#39;</span><span class="p">,</span>
                                     <span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;task_protocol&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">sess_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">])</span>
                <span class="n">trials</span><span class="p">[</span><span class="n">sessions</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]]</span> <span class="o">=</span> <span class="n">trials_</span>

            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">task_protocol</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">):</span>
        <span class="n">ephys_sess</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subj</span><span class="p">,</span>
                                   <span class="n">date_range</span><span class="o">=</span><span class="p">[</span><span class="n">sess_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sess_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                   <span class="n">django</span><span class="o">=</span><span class="s1">&#39;location__name__icontains,ephys&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ephys_sess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ephys_sess_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">sess</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">ephys_sess</span><span class="p">]</span>

            <span class="n">n_delay</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subj</span><span class="p">,</span>
                                        <span class="n">date_range</span><span class="o">=</span><span class="p">[</span><span class="n">sess_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sess_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                        <span class="n">django</span><span class="o">=</span><span class="s1">&#39;json__SESSION_DELAY_START__gte,900&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ephys_sess_dates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_delay</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ephys_sess_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_delay</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">trials</span><span class="p">,</span> <span class="n">task_protocol</span><span class="p">,</span> <span class="n">ephys_sess_dates</span><span class="p">,</span> <span class="n">n_delay</span></div>



<div class="viewcode-block" id="get_training_status">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.get_training_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_training_status</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">task_protocol</span><span class="p">,</span> <span class="n">ephys_sess_dates</span><span class="p">,</span> <span class="n">n_delay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute training status of a subject from consecutive training datasets.</span>

<span class="sd">    For IBL, training status is calculated using trials from the last three consecutive sessions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : dict of str</span>
<span class="sd">        Dictionary of trials objects where each key is the ISO session date string.</span>
<span class="sd">    task_protocol : list of str</span>
<span class="sd">        Task protocol used for each training session in `trials`, can be &#39;training&#39;, &#39;biased&#39; or</span>
<span class="sd">        &#39;ephys&#39;.</span>
<span class="sd">    ephys_sess_dates : list of str</span>
<span class="sd">        List of ISO date strings where training was conducted on ephys rig. Empty list if all</span>
<span class="sd">        sessions on training rig.</span>
<span class="sd">    n_delay : int</span>
<span class="sd">        Number of sessions on ephys rig that had delay prior to starting session &gt; 15min.</span>
<span class="sd">        Returns 0 if no sessions detected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Training status of the subject.</span>
<span class="sd">    iblutil.util.Bunch</span>
<span class="sd">        Bunch containing performance metrics that decide training status i.e. performance on easy</span>
<span class="sd">        trials, number of trials, psychometric fit parameters, reaction time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">trials_all</span> <span class="o">=</span> <span class="n">concatenate_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">session_dates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">info</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">task_protocol</span><span class="p">]</span>

    <span class="c1"># Case when all sessions are trainingChoiceWorld</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">task_protocol</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">):</span>
        <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials_all</span><span class="p">))</span>
        <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span>
         <span class="n">info</span><span class="o">.</span><span class="n">psych</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_training_info</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">trials_all</span><span class="p">)</span>

        <span class="n">pass_criteria</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterion_1b</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">psych</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">,</span>
                                               <span class="n">signed_contrast</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pass_criteria</span><span class="p">:</span>
            <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
            <span class="n">failed_criteria</span><span class="p">[</span><span class="s1">&#39;NBiased&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">protocols</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="n">failed_criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;ready4ephysrig&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;trained 1b&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
            <span class="n">pass_criteria</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterion_1a</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">psych</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pass_criteria</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;trained 1a&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;in training&#39;</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">failed_criteria</span>

    <span class="c1"># Case when there are &lt; 3 biasedChoiceWorld sessions after reaching trained_1b criterion</span>
    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">task_protocol</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">task_protocol</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;trained 1b&#39;</span>
        <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span>
         <span class="n">info</span><span class="o">.</span><span class="n">psych</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_training_info</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">trials_all</span><span class="p">)</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;NBiased&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">protocols</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;ready4ephysrig&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">criteria</span>

    <span class="c1"># Case when there is biasedChoiceWorld or ephysChoiceWorld in last three sessions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">task_protocol</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">):</span>

        <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span>
         <span class="n">info</span><span class="o">.</span><span class="n">psych_20</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">psych_80</span><span class="p">,</span>
         <span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_bias_info</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">trials_all</span><span class="p">)</span>

        <span class="n">n_ephys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ephys_sess_dates</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">n_ephys</span> <span class="o">=</span> <span class="n">n_ephys</span>
        <span class="n">info</span><span class="o">.</span><span class="n">n_delay</span> <span class="o">=</span> <span class="n">n_delay</span>

        <span class="c1"># Criterion recording</span>
        <span class="n">pass_criteria</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria_recording</span><span class="p">(</span><span class="n">n_ephys</span><span class="p">,</span> <span class="n">n_delay</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">psych_20</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">psych_80</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span>
                                                     <span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pass_criteria</span><span class="p">:</span>
            <span class="c1"># Here the criteria doesn&#39;t actually fail but we have no other criteria to meet so we return this</span>
            <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready4recording&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">date</span> <span class="ow">in</span> <span class="n">trials</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">ephys_sess_dates</span><span class="p">)</span>
            <span class="n">perf_ephys_easy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_performance_easy</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                        <span class="n">ephys_sess_dates</span><span class="p">])</span>
            <span class="n">n_ephys_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_n_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ephys_sess_dates</span><span class="p">])</span>

            <span class="n">pass_criteria</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterion_delay</span><span class="p">(</span><span class="n">n_ephys</span><span class="p">,</span> <span class="n">n_ephys_trials</span><span class="p">,</span> <span class="n">perf_ephys_easy</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pass_criteria</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready4delay&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                <span class="n">pass_criteria</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterion_ephys</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">psych_20</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">psych_80</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n_trials</span><span class="p">,</span>
                                                          <span class="n">info</span><span class="o">.</span><span class="n">perf_easy</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">rt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pass_criteria</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready4ephysrig&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">failed_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;trained 1b&#39;</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">failed_criteria</span></div>



<div class="viewcode-block" id="display_status">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.display_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_status</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess_dates</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">perf_easy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psych</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">psych_20</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psych_80</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display training status of subject to terminal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subj : str</span>
<span class="sd">        Subject nickname (must match the name registered on Alyx).</span>
<span class="sd">    sess_dates : list of str</span>
<span class="sd">        ISO date strings of training sessions used to determine training status.</span>
<span class="sd">    status : str</span>
<span class="sd">        Training status of subject.</span>
<span class="sd">    perf_easy : numpy.array</span>
<span class="sd">        Proportion of correct high contrast trials for each training session.</span>
<span class="sd">    n_trials : numpy.array</span>
<span class="sd">        Total number of trials for each training session.</span>
<span class="sd">    psych : numpy.array</span>
<span class="sd">        Psychometric parameters fit to data from all training sessions - bias, threshold, lapse</span>
<span class="sd">        high, lapse low.</span>
<span class="sd">    psych_20 : numpy.array</span>
<span class="sd">        The fit psychometric parameters for the blocks where probability of a left stimulus is 0.2.</span>
<span class="sd">    psych_80 : numpy.array</span>
<span class="sd">        The fit psychometric parameters for the blocks where probability of a left stimulus is 0.8.</span>
<span class="sd">    rt : float</span>
<span class="sd">        The median response time for zero contrast trials across all training sessions. NaN</span>
<span class="sd">        indicates no zero contrast stimuli in training sessions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">perf_easy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Session dates=[</span><span class="si">{</span><span class="n">sess_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sess_dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sess_dates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">psych_20</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Session dates=</span><span class="si">{</span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sess_dates</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Perf easy=</span><span class="si">{</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pe</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">perf_easy</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;N trials=</span><span class="si">{</span><span class="p">[</span><span class="n">nt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">nt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">n_trials</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Psych fit over last 3 sessions: &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;bias=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, thres=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;lapse_low=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, lapse_high=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Median reaction time at 0 contrast over last 3 sessions = &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Session dates=</span><span class="si">{</span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sess_dates</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Perf easy=</span><span class="si">{</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pe</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">perf_easy</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;N trials=</span><span class="si">{</span><span class="p">[</span><span class="n">nt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">nt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">n_trials</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Psych fit over last 3 sessions (20): &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;bias=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, thres=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_20</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;lapse_low=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_20</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, lapse_high=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_20</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Psych fit over last 3 sessions (80): bias=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_80</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;thres=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_80</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, lapse_low=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_80</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;lapse_high=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">psych_80</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Median reaction time at 0 contrast over last 3 sessions = &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="concatenate_trials">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.concatenate_trials">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">concatenate_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate trials from different training sessions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : dict of str</span>
<span class="sd">        Dictionary of trials objects where each key is the ISO session date string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    one.alf.io.AlfBunch</span>
<span class="sd">        Trials object with data concatenated over three training sessions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trials_all</span> <span class="o">=</span> <span class="n">AlfBunch</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TRIALS_KEYS</span><span class="p">:</span>
        <span class="n">trials_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">trials_all</span></div>



<div class="viewcode-block" id="compute_training_info">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_training_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_training_info</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">trials_all</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute all relevant performance metrics for when subject is on trainingChoiceWorld.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : dict of str</span>
<span class="sd">        Dictionary of trials objects where each key is the ISO session date string.</span>
<span class="sd">    trials_all : one.alf.io.AlfBunch</span>
<span class="sd">        Trials object with data concatenated over three training sessions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Proportion of correct high contrast trials for each session.</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Total number of trials for each training session.</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Array of psychometric parameters fit to `all_trials` - bias, threshold, lapse high,</span>
<span class="sd">        lapse low.</span>
<span class="sd">    float</span>
<span class="sd">        The median response time for all zero-contrast trials across all sessions. Returns NaN if</span>
<span class="sd">        no trials zero-contrast trials).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials_all</span><span class="p">)</span>
    <span class="n">perf_easy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_performance_easy</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_n_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">psych</span> <span class="o">=</span> <span class="n">compute_psychometric</span><span class="p">(</span><span class="n">trials_all</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">)</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">compute_median_reaction_time</span><span class="p">(</span><span class="n">trials_all</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">psych</span><span class="p">,</span> <span class="n">rt</span></div>



<div class="viewcode-block" id="compute_bias_info">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_bias_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_bias_info</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">trials_all</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute all relevant performance metrics for when subject is on biasedChoiceWorld</span>

<span class="sd">    :param trials: dict containing trials objects from three consecutive training sessions,</span>
<span class="sd">    keys are session dates</span>
<span class="sd">    :type trials: Bunch</span>
<span class="sd">    :param trials_all: trials object with data concatenated over three training sessions</span>
<span class="sd">    :type trials_all: Bunch</span>
<span class="sd">    :returns:</span>
<span class="sd">        - perf_easy - performance of easy trials for each session</span>
<span class="sd">        - n_trials - number of trials in each session</span>
<span class="sd">        - psych_20 - parameters for psychometric curve fit to trials in 20 block over all sessions</span>
<span class="sd">        - psych_80 - parameters for psychometric curve fit to trials in 80 block over all sessions</span>
<span class="sd">        - rt - median reaction time for zero contrast stimuli over all sessions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials_all</span><span class="p">)</span>
    <span class="n">perf_easy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_performance_easy</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_n_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">psych_20</span> <span class="o">=</span> <span class="n">compute_psychometric</span><span class="p">(</span><span class="n">trials_all</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">psych_80</span> <span class="o">=</span> <span class="n">compute_psychometric</span><span class="p">(</span><span class="n">trials_all</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">compute_median_reaction_time</span><span class="p">(</span><span class="n">trials_all</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">psych_20</span><span class="p">,</span> <span class="n">psych_80</span><span class="p">,</span> <span class="n">rt</span></div>



<div class="viewcode-block" id="get_signed_contrast">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.get_signed_contrast">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute signed contrast from trials object</span>

<span class="sd">    :param trials: trials object that must contain contrastLeft and contrastRight keys</span>
<span class="sd">    :type trials: dict</span>
<span class="sd">    returns: array of signed contrasts in percent, where -ve values are on the left</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Replace NaNs with zeros, stack and take the difference</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">trials</span><span class="p">[</span><span class="s1">&#39;contrastLeft&#39;</span><span class="p">],</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;contrastRight&#39;</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span></div>



<div class="viewcode-block" id="compute_performance_easy">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_performance_easy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_performance_easy</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute performance on easy trials (stimulus &gt;= 50 %) from trials object</span>

<span class="sd">    :param trials: trials object that must contain contrastLeft, contrastRight and feedbackType</span>
<span class="sd">    keys</span>
<span class="sd">    :type trials: dict</span>
<span class="sd">    returns: float containing performance on easy contrast trials</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
    <span class="n">easy_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signed_contrast</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="s1">&#39;feedbackType&#39;</span><span class="p">][</span><span class="n">easy_trials</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">easy_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="compute_performance">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_performance">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_performance</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prob_right</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute performance on all trials at each contrast level from trials object</span>

<span class="sd">    :param trials: trials object that must contain contrastLeft, contrastRight and feedbackType</span>
<span class="sd">    keys</span>
<span class="sd">    :type trials: dict</span>
<span class="sd">    returns: float containing performance on easy contrast trials</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">signed_contrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span> <span class="o">==</span> <span class="n">block</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">block_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">signed_contrast</span><span class="p">[</span><span class="n">block_idx</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">prob_right</span><span class="p">:</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">feedbackType</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correct</span><span class="p">[(</span><span class="n">x</span> <span class="o">==</span> <span class="n">signed_contrast</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">block_idx</span><span class="p">]))(</span><span class="n">contrasts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rightward</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">choice</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Calculate the proportion rightward for each contrast type</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rightward</span><span class="p">[(</span><span class="n">x</span> <span class="o">==</span> <span class="n">signed_contrast</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">block_idx</span><span class="p">]))(</span><span class="n">contrasts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">performance</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span></div>



<div class="viewcode-block" id="compute_n_trials">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_n_trials">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_n_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute number of trials in trials object</span>

<span class="sd">    :param trials: trials object</span>
<span class="sd">    :type trials: dict</span>
<span class="sd">    returns: int containing number of trials in session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">trials</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="compute_psychometric">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_psychometric">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_psychometric</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compute_ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.032</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute psychometric fit parameters for trials object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : one.alf.io.AlfBunch</span>
<span class="sd">        An ALF trials object containing the keys {&#39;probabilityLeft&#39;, &#39;contrastLeft&#39;,</span>
<span class="sd">        &#39;contrastRight&#39;, &#39;feedbackType&#39;, &#39;choice&#39;, &#39;response_times&#39;, &#39;stimOn_times&#39;}.</span>
<span class="sd">    signed_contrast : numpy.array</span>
<span class="sd">        An array of signed contrasts in percent the length of trials, where left contrasts are -ve.</span>
<span class="sd">        If None, these are computed from the trials object.</span>
<span class="sd">    block : float</span>
<span class="sd">        The block type to compute. If None, all trials are included, otherwise only trials where</span>
<span class="sd">        probabilityLeft matches this value are included.  For biasedChoiceWorld, the</span>
<span class="sd">        probabilityLeft set is {0.5, 0.2, 0.8}.</span>
<span class="sd">    plotting : bool</span>
<span class="sd">        Which set of psychofit model parameters to use (see notes).</span>
<span class="sd">    compute_ci : bool</span>
<span class="sd">        If true, computes and returns the confidence intervals for response at each contrast.</span>
<span class="sd">    alpha : float, default=0.032</span>
<span class="sd">        Significance level for confidence interval. Must be in (0, 1). If `compute_ci` is false,</span>
<span class="sd">        this value is ignored.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Array of psychometric fit parameters - bias, threshold, lapse high, lapse low.</span>
<span class="sd">    (tuple of numpy.array)</span>
<span class="sd">        If `compute_ci` is true, a tuple of</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    statsmodels.stats.proportion.proportion_confint - The function used to compute confidence</span>
<span class="sd">      interval.</span>
<span class="sd">    psychofit.mle_fit_psycho - The function used to fit the psychometric parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The psychofit starting parameters and model constraints used for the fit when computing the</span>
<span class="sd">    training status (e.g. trained_1a, etc.) are sub-optimal and can produce a poor fit. To keep</span>
<span class="sd">    the precise criteria the same for all subjects, these parameters have not changed. To produce a</span>
<span class="sd">    better fit for plotting purposes, or to calculate the training status in a manner inconsistent</span>
<span class="sd">    with the IBL training pipeline, use plotting=True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">signed_contrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span> <span class="o">==</span> <span class="n">block</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">block_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">prob_choose_right</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span> <span class="o">=</span> <span class="n">compute_performance</span><span class="p">(</span>
        <span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">prob_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plotting</span><span class="p">:</span>
        <span class="c1"># These starting parameters and constraints tend to produce a better fit, and are therefore</span>
        <span class="c1"># used for plotting.</span>
        <span class="n">psych</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">mle_fit_psycho</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span><span class="p">,</span> <span class="n">prob_choose_right</span><span class="p">]),</span>
            <span class="n">P_model</span><span class="o">=</span><span class="s1">&#39;erf_psycho_2gammas&#39;</span><span class="p">,</span>
            <span class="n">parstart</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]),</span>
            <span class="n">parmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span>
            <span class="n">parmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]),</span>
            <span class="n">nfits</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># These starting parameters and constraints are not ideal but are still used for computing</span>
        <span class="c1"># the training status for consistency.</span>
        <span class="n">psych</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">mle_fit_psycho</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span><span class="p">,</span> <span class="n">prob_choose_right</span><span class="p">]),</span>
            <span class="n">P_model</span><span class="o">=</span><span class="s1">&#39;erf_psycho_2gammas&#39;</span><span class="p">,</span>
            <span class="n">parstart</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">contrasts</span><span class="p">),</span> <span class="mf">20.</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]),</span>
            <span class="n">parmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">contrasts</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span>
            <span class="n">parmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">contrasts</span><span class="p">),</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">compute_ci</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.stats.proportion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smp</span> <span class="c1"># noqa</span>
        <span class="c1"># choice == -1 means contrast on right hand side</span>
        <span class="n">n_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">][(</span><span class="n">x</span> <span class="o">==</span> <span class="n">signed_contrast</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">block_idx</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))(</span><span class="n">contrasts</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">proportion_confint</span><span class="p">(</span><span class="n">n_right</span><span class="p">,</span> <span class="n">n_contrasts</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">prob_choose_right</span>

        <span class="k">return</span> <span class="n">psych</span><span class="p">,</span> <span class="n">ci</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">psych</span></div>



<div class="viewcode-block" id="compute_median_reaction_time">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_median_reaction_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_median_reaction_time</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">stim_on_type</span><span class="o">=</span><span class="s1">&#39;stimOn_times&#39;</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute median response time on zero contrast trials from trials object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : one.alf.io.AlfBunch</span>
<span class="sd">        An ALF trials object containing the keys {&#39;probabilityLeft&#39;, &#39;contrastLeft&#39;,</span>
<span class="sd">        &#39;contrastRight&#39;, &#39;feedbackType&#39;, &#39;choice&#39;, &#39;response_times&#39;, &#39;stimOn_times&#39;}.</span>
<span class="sd">    stim_on_type : str, default=&#39;stimOn_times&#39;</span>
<span class="sd">        The trials key to use when calculating the response times. The difference between this and</span>
<span class="sd">        &#39;feedback_times&#39; is used (see notes).</span>
<span class="sd">    contrast : float</span>
<span class="sd">        If None, the median response time is calculated for all trials, regardless of contrast,</span>
<span class="sd">        otherwise only trials where the matching signed percent contrast was presented are used.</span>
<span class="sd">    signed_contrast : numpy.array</span>
<span class="sd">        An array of signed contrasts in percent the length of trials, where left contrasts are -ve.</span>
<span class="sd">        If None, these are computed from the trials object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The median response time for trials with `contrast` (returns NaN if no trials matching</span>
<span class="sd">        `contrast` in trials object).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The `stim_on_type` is &#39;stimOn_times&#39; by default, however for IBL rig data, the photodiode is</span>
<span class="sd">      sometimes not calibrated properly which can lead to inaccurate (or absent, i.e. NaN) stim on</span>
<span class="sd">      times. Therefore, it is sometimes more accurate to use the &#39;stimOnTrigger_times&#39; (the time of</span>
<span class="sd">      the stimulus onset command), if available, or the &#39;goCue_times&#39; (the time of the soundcard</span>
<span class="sd">      output TTL when the audio go cue is played) or the &#39;goCueTrigger_times&#39; (the time of the</span>
<span class="sd">      audio go cue command).</span>
<span class="sd">    - The response/reaction time here is defined as the time between stim on and feedback, i.e. the</span>
<span class="sd">      entire open-loop trial duration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">signed_contrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">contrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">signed_contrast</span> <span class="o">==</span> <span class="n">contrast</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">contrast_idx</span><span class="p">):</span>
        <span class="n">reaction_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">((</span><span class="n">trials</span><span class="o">.</span><span class="n">response_times</span> <span class="o">-</span> <span class="n">trials</span><span class="p">[</span><span class="n">stim_on_type</span><span class="p">])</span>
                                     <span class="p">[</span><span class="n">contrast_idx</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reaction_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">reaction_time</span></div>



<div class="viewcode-block" id="compute_reaction_time">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.compute_reaction_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_reaction_time</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">stim_on_type</span><span class="o">=</span><span class="s1">&#39;stimOn_times&#39;</span><span class="p">,</span> <span class="n">stim_off_type</span><span class="o">=</span><span class="s1">&#39;response_times&#39;</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">compute_ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute median response time for all contrasts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : one.alf.io.AlfBunch</span>
<span class="sd">        An ALF trials object containing the keys {&#39;probabilityLeft&#39;, &#39;contrastLeft&#39;,</span>
<span class="sd">        &#39;contrastRight&#39;, &#39;feedbackType&#39;, &#39;choice&#39;, &#39;response_times&#39;, &#39;stimOn_times&#39;}.</span>
<span class="sd">    stim_on_type : str, default=&#39;stimOn_times&#39;</span>
<span class="sd">        The trials key to use when calculating the response times. The difference between this and</span>
<span class="sd">        `stim_off_type` is used (see notes).</span>
<span class="sd">    stim_off_type : str, default=&#39;response_times&#39;</span>
<span class="sd">        The trials key to use when calculating the response times. The difference between this and</span>
<span class="sd">        `stim_on_type` is used (see notes).</span>
<span class="sd">    signed_contrast : numpy.array</span>
<span class="sd">        An array of signed contrasts in percent the length of trials, where left contrasts are -ve.</span>
<span class="sd">        If None, these are computed from the trials object.</span>
<span class="sd">    block : float</span>
<span class="sd">        The block type to compute. If None, all trials are included, otherwise only trials where</span>
<span class="sd">        probabilityLeft matches this value are included.  For biasedChoiceWorld, the</span>
<span class="sd">        probabilityLeft set is {0.5, 0.2, 0.8}.</span>
<span class="sd">    compute_ci : bool</span>
<span class="sd">        If true, computes and returns the confidence intervals for response time at each contrast.</span>
<span class="sd">    alpha : float, default=0.32</span>
<span class="sd">        Significance level for confidence interval. Must be in (0, 1). If `compute_ci` is false,</span>
<span class="sd">        this value is ignored.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        The median response times for each unique signed contrast.</span>
<span class="sd">    numpy.array</span>
<span class="sd">        The set of unique signed contrasts.</span>
<span class="sd">    numpy.array</span>
<span class="sd">        The number of trials for each unique signed contrast.</span>
<span class="sd">    (numpy.array)</span>
<span class="sd">        If `compute_ci` is true, an array of confidence intervals is return in the shape (n_trials,</span>
<span class="sd">        2).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The response/reaction time by default is the time between stim on and response, i.e. the</span>
<span class="sd">      entire open-loop trial duration. One could use &#39;stimOn_times&#39; and &#39;firstMovement_times&#39; to</span>
<span class="sd">      get the true reaction time, or &#39;firstMovement_times&#39; and &#39;response_times&#39; to get the true</span>
<span class="sd">      response times, or calculate the last movement onset times and calculate the true movement</span>
<span class="sd">      times.  See module examples for how to calculate this.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    scipy.stats.bootstrap - the function used to compute the confidence interval.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">signed_contrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">probabilityLeft</span> <span class="o">==</span> <span class="n">block</span>

    <span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">signed_contrast</span><span class="p">[</span><span class="n">block_idx</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reaction_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">((</span><span class="n">trials</span><span class="p">[</span><span class="n">stim_off_type</span><span class="p">]</span> <span class="o">-</span> <span class="n">trials</span><span class="p">[</span><span class="n">stim_on_type</span><span class="p">])[(</span><span class="n">x</span> <span class="o">==</span> <span class="n">signed_contrast</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">block_idx</span><span class="p">]),</span>
        <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)(</span><span class="n">contrasts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">compute_ci</span><span class="p">:</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">contrasts</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">trials</span><span class="p">[</span><span class="n">stim_off_type</span><span class="p">]</span> <span class="o">-</span> <span class="n">trials</span><span class="p">[</span><span class="n">stim_on_type</span><span class="p">])[(</span><span class="n">x</span> <span class="o">==</span> <span class="n">signed_contrast</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">block_idx</span><span class="p">]</span>
            <span class="n">bt</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="p">((</span><span class="n">data</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">ci</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">confidence_interval</span><span class="o">.</span><span class="n">low</span>
            <span class="n">ci</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">confidence_interval</span><span class="o">.</span><span class="n">high</span>

        <span class="k">return</span> <span class="n">reaction_time</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span><span class="p">,</span> <span class="n">ci</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reaction_time</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">,</span> <span class="n">n_contrasts</span><span class="p">,</span></div>



<div class="viewcode-block" id="criterion_1a">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.criterion_1a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">criterion_1a</span><span class="p">(</span><span class="n">psych</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns bool indicating whether criteria for status &#39;trained_1a&#39; are met.</span>

<span class="sd">    Criteria</span>
<span class="sd">    --------</span>
<span class="sd">    - Bias is less than 16</span>
<span class="sd">    - Threshold is less than 19</span>
<span class="sd">    - Lapse rate on both sides is less than 0.2</span>
<span class="sd">    - The total number of trials is greater than 200 for each session</span>
<span class="sd">    - Performance on easy contrasts &gt; 80% for all sessions</span>
<span class="sd">    - Zero contrast trials must be present</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psych : numpy.array</span>
<span class="sd">        The fit psychometric parameters three consecutive sessions. Parameters are bias, threshold,</span>
<span class="sd">        lapse high, lapse low.</span>
<span class="sd">    n_trials : numpy.array of int</span>
<span class="sd">        The number for trials for each session.</span>
<span class="sd">    perf_easy : numpy.array of float</span>
<span class="sd">        The proportion of correct high contrast trials for each session.</span>
<span class="sd">    signed_contrast: numpy.array</span>
<span class="sd">        Unique list of contrasts displayed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the criteria are met for &#39;trained_1a&#39;.</span>
<span class="sd">    Bunch</span>
<span class="sd">        Bunch containing breakdown of the passing/ failing critieria</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The parameter thresholds chosen here were originally determined by averaging the parameter fits</span>
<span class="sd">    for a number of sessions determined to be of &#39;good&#39; performance by an experimenter.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Zero_contrast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">signed_contrast</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">signed_contrast</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseLow_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseHigh_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psych</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">19</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_trials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">n_trials</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">n_trials</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Perf_easy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">perf_easy</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">)}</span>

    <span class="n">passing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;trained_1a&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">passing</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">passing</span><span class="p">,</span> <span class="n">criteria</span></div>



<div class="viewcode-block" id="criterion_1b">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.criterion_1b">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">criterion_1b</span><span class="p">(</span><span class="n">psych</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns bool indicating whether criteria for trained_1b are met.</span>

<span class="sd">    Criteria</span>
<span class="sd">    --------</span>
<span class="sd">    - Bias is less than 10</span>
<span class="sd">    - Threshold is less than 20 (see notes)</span>
<span class="sd">    - Lapse rate on both sides is less than 0.1</span>
<span class="sd">    - The total number of trials is greater than 400 for each session</span>
<span class="sd">    - Performance on easy contrasts &gt; 90% for all sessions</span>
<span class="sd">    - The median response time across all zero contrast trials is less than 2 seconds</span>
<span class="sd">    - Zero contrast trials must be present</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psych : numpy.array</span>
<span class="sd">        The fit psychometric parameters three consecutive sessions. Parameters are bias, threshold,</span>
<span class="sd">        lapse high, lapse low.</span>
<span class="sd">    n_trials : numpy.array of int</span>
<span class="sd">        The number for trials for each session.</span>
<span class="sd">    perf_easy : numpy.array of float</span>
<span class="sd">        The proportion of correct high contrast trials for each session.</span>
<span class="sd">    rt : float</span>
<span class="sd">        The median response time for zero contrast trials.</span>
<span class="sd">    signed_contrast: numpy.array</span>
<span class="sd">        Unique list of contrasts displayed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the criteria are met for &#39;trained_1b&#39;.</span>
<span class="sd">    Bunch</span>
<span class="sd">        Bunch containing breakdown of the passing/ failing critieria</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The parameter thresholds chosen here were originally chosen to be slightly stricter than 1a,</span>
<span class="sd">    however it was decided to use round numbers so that readers would not assume a level of</span>
<span class="sd">    precision that isn&#39;t there (remember, these parameters were not chosen with any rigor). This</span>
<span class="sd">    regrettably means that the maximum threshold fit for 1b is greater than for 1a, meaning the</span>
<span class="sd">    slope of the psychometric curve may be slightly less steep than 1a.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Zero_contrast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">signed_contrast</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">signed_contrast</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseLow_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseHigh_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psych</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_trials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">n_trials</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">n_trials</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Perf_tasy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">perf_easy</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Reaction_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">rt</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">rt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">}</span>

    <span class="n">passing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;trained_1b&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">passing</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">passing</span><span class="p">,</span> <span class="n">criteria</span></div>



<div class="viewcode-block" id="criterion_ephys">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.criterion_ephys">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">criterion_ephys</span><span class="p">(</span><span class="n">psych_20</span><span class="p">,</span> <span class="n">psych_80</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns bool indicating whether criteria for ready4ephysrig are met.</span>

<span class="sd">    Criteria</span>
<span class="sd">    --------</span>
<span class="sd">    - Lapse on both sides &lt; 0.1 for both bias blocks</span>
<span class="sd">    - Bias shift between blocks &gt; 5</span>
<span class="sd">    - Total number of trials &gt; 400 for all sessions</span>
<span class="sd">    - Performance on easy contrasts &gt; 90% for all sessions</span>
<span class="sd">    - Median response time for zero contrast stimuli &lt; 2 seconds</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psych_20 : numpy.array</span>
<span class="sd">        The fit psychometric parameters for the blocks where probability of a left stimulus is 0.2.</span>
<span class="sd">        Parameters are bias, threshold, lapse high, lapse low.</span>
<span class="sd">    psych_80 : numpy.array</span>
<span class="sd">        The fit psychometric parameters for the blocks where probability of a left stimulus is 0.8.</span>
<span class="sd">        Parameters are bias, threshold, lapse high, lapse low.</span>
<span class="sd">    n_trials : numpy.array</span>
<span class="sd">        The number of trials for each session (typically three consecutive sessions).</span>
<span class="sd">    perf_easy : numpy.array</span>
<span class="sd">        The proportion of correct high contrast trials for each session (typically three</span>
<span class="sd">        consecutive sessions).</span>
<span class="sd">    rt : float</span>
<span class="sd">        The median response time for zero contrast trials.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if subject passes the ready4ephysrig criteria.</span>
<span class="sd">    Bunch</span>
<span class="sd">        Bunch containing breakdown of the passing/ failing critieria</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseLow_80&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych_80</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych_80</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseHigh_80&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych_80</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych_80</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseLow_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych_20</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych_20</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;LapseHigh_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych_20</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych_20</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Bias_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">psych_80</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">psych_20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">psych_80</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">psych_20</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_trials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">n_trials</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">n_trials</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Perf_easy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">perf_easy</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Reaction_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">rt</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">rt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">}</span>

    <span class="n">passing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;ready4ephysrig&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">passing</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">passing</span><span class="p">,</span> <span class="n">criteria</span></div>



<div class="viewcode-block" id="criterion_delay">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.criterion_delay">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">criterion_delay</span><span class="p">(</span><span class="n">n_ephys</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">perf_easy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns bool indicating whether criteria for &#39;ready4delay&#39; is met.</span>

<span class="sd">    Criteria</span>
<span class="sd">    --------</span>
<span class="sd">    - At least one session on an ephys rig</span>
<span class="sd">    - Total number of trials for any of the sessions is greater than 400</span>
<span class="sd">    - Performance on easy contrasts is greater than 90% for any of the sessions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_trials : numpy.array of int</span>
<span class="sd">        The number of trials for each session (typically three consecutive sessions).</span>
<span class="sd">    perf_easy : numpy.array</span>
<span class="sd">        The proportion of correct high contrast trials for each session (typically three</span>
<span class="sd">        consecutive sessions).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if subject passes the &#39;ready4delay&#39; criteria.</span>
<span class="sd">    Bunch</span>
<span class="sd">        Bunch containing breakdown of the passing/ failing critieria</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_ephys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">n_ephys</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">n_ephys</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_trials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">n_trials</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">n_trials</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Perf_easy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">perf_easy</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)}</span>

    <span class="n">passing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;ready4delay&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">passing</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">passing</span><span class="p">,</span> <span class="n">criteria</span></div>



<div class="viewcode-block" id="criteria_recording">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.criteria_recording">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">criteria_recording</span><span class="p">(</span><span class="n">n_ephys</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">psych_20</span><span class="p">,</span> <span class="n">psych_80</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns bool indicating whether criteria for ready4recording are met.</span>

<span class="sd">    Criteria</span>
<span class="sd">    --------</span>
<span class="sd">    - At least 3 ephys sessions</span>
<span class="sd">    - Delay on any session &gt; 0</span>
<span class="sd">    - Lapse on both sides &lt; 0.1 for both bias blocks</span>
<span class="sd">    - Bias shift between blocks &gt; 5</span>
<span class="sd">    - Total number of trials &gt; 400 for all sessions</span>
<span class="sd">    - Performance on easy contrasts &gt; 90% for all sessions</span>
<span class="sd">    - Median response time for zero contrast stimuli &lt; 2 seconds</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psych_20 : numpy.array</span>
<span class="sd">        The fit psychometric parameters for the blocks where probability of a left stimulus is 0.2.</span>
<span class="sd">        Parameters are bias, threshold, lapse high, lapse low.</span>
<span class="sd">    psych_80 : numpy.array</span>
<span class="sd">        The fit psychometric parameters for the blocks where probability of a left stimulus is 0.8.</span>
<span class="sd">        Parameters are bias, threshold, lapse high, lapse low.</span>
<span class="sd">    n_trials : numpy.array</span>
<span class="sd">        The number of trials for each session (typically three consecutive sessions).</span>
<span class="sd">    perf_easy : numpy.array</span>
<span class="sd">        The proportion of correct high contrast trials for each session (typically three</span>
<span class="sd">        consecutive sessions).</span>
<span class="sd">    rt : float</span>
<span class="sd">        The median response time for zero contrast trials.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if subject passes the ready4recording criteria.</span>
<span class="sd">    Bunch</span>
<span class="sd">        Bunch containing breakdown of the passing/ failing critieria</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterion_ephys</span><span class="p">(</span><span class="n">psych_20</span><span class="p">,</span> <span class="n">psych_80</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">perf_easy</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_ephys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">n_ephys</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">n_ephys</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;N_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">delay</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

    <span class="n">passing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;Criteria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="s1">&#39;ready4recording&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="n">passing</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">passing</span><span class="p">,</span> <span class="n">criteria</span></div>



<div class="viewcode-block" id="plot_psychometric">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.plot_psychometric">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_psychometric</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ci_alpha</span><span class="o">=</span><span class="mf">0.032</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot psychometric curve plots a la datajoint webpage.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : one.alf.io.AlfBunch</span>
<span class="sd">        An ALF trials object containing the keys {&#39;probabilityLeft&#39;, &#39;contrastLeft&#39;,</span>
<span class="sd">        &#39;contrastRight&#39;, &#39;feedbackType&#39;, &#39;choice&#39;, &#39;response_times&#39;, &#39;stimOn_times&#39;}.</span>
<span class="sd">    ax : matplotlib.pyplot.Axes</span>
<span class="sd">        An axis object to plot onto.</span>
<span class="sd">    title : str</span>
<span class="sd">        An optional plot title.</span>
<span class="sd">    plot_ci : bool</span>
<span class="sd">        If true, computes and plots the confidence intervals for response at each contrast.</span>
<span class="sd">    ci_alpha : float, default=0.032</span>
<span class="sd">        Significance level for confidence interval. Must be in (0, 1). If `plot_ci` is false,</span>
<span class="sd">        this value is ignored.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        If `ax` is None, these arguments are passed to matplotlib.pyplot.subplots.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.pyplot.Figure</span>
<span class="sd">        The figure handle containing the plot.</span>
<span class="sd">    matplotlib.pyplot.Axes</span>
<span class="sd">        The plotted axes.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    statsmodels.stats.proportion.proportion_confint - The function used to compute confidence</span>
<span class="sd">      interval.</span>
<span class="sd">    psychofit.mle_fit_psycho - The function used to fit the psychometric parameters.</span>
<span class="sd">    psychofit.erf_psycho_2gammas - The function used to transform contrast to response probability</span>
<span class="sd">      using the fit parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
    <span class="n">contrasts_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">prob_right_50</span><span class="p">,</span> <span class="n">contrasts_50</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_performance</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">prob_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">out_50</span> <span class="o">=</span> <span class="n">compute_psychometric</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">compute_ci</span><span class="o">=</span><span class="n">plot_ci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ci_alpha</span><span class="p">)</span>
    <span class="n">pars_50</span> <span class="o">=</span> <span class="n">out_50</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_ci</span> <span class="k">else</span> <span class="n">out_50</span>
    <span class="n">prob_right_fit_50</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">erf_psycho_2gammas</span><span class="p">(</span><span class="n">pars_50</span><span class="p">,</span> <span class="n">contrasts_fit</span><span class="p">)</span>

    <span class="n">prob_right_20</span><span class="p">,</span> <span class="n">contrasts_20</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_performance</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">prob_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">out_20</span> <span class="o">=</span> <span class="n">compute_psychometric</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">compute_ci</span><span class="o">=</span><span class="n">plot_ci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ci_alpha</span><span class="p">)</span>
    <span class="n">pars_20</span> <span class="o">=</span> <span class="n">out_20</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_ci</span> <span class="k">else</span> <span class="n">out_20</span>
    <span class="n">prob_right_fit_20</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">erf_psycho_2gammas</span><span class="p">(</span><span class="n">pars_20</span><span class="p">,</span> <span class="n">contrasts_fit</span><span class="p">)</span>

    <span class="n">prob_right_80</span><span class="p">,</span> <span class="n">contrasts_80</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_performance</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">prob_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">out_80</span> <span class="o">=</span> <span class="n">compute_psychometric</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">compute_ci</span><span class="o">=</span><span class="n">plot_ci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ci_alpha</span><span class="p">)</span>
    <span class="n">pars_80</span> <span class="o">=</span> <span class="n">out_80</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_ci</span> <span class="k">else</span> <span class="n">out_80</span>
    <span class="n">prob_right_fit_80</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">erf_psycho_2gammas</span><span class="p">(</span><span class="n">pars_80</span><span class="p">,</span> <span class="n">contrasts_fit</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">diverging_palette</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;dark&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

    <span class="n">fit_50</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">contrasts_fit</span><span class="p">,</span> <span class="n">prob_right_fit_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data_50</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">contrasts_50</span><span class="p">,</span> <span class="n">prob_right_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">fit_20</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">contrasts_fit</span><span class="p">,</span> <span class="n">prob_right_fit_20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_20</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">contrasts_20</span><span class="p">,</span> <span class="n">prob_right_20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fit_80</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">contrasts_fit</span><span class="p">,</span> <span class="n">prob_right_fit_80</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">data_80</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">contrasts_80</span><span class="p">,</span> <span class="n">prob_right_80</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">plot_ci</span><span class="p">:</span>
        <span class="n">errbar_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_50</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_50</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">errbar_20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_20</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_20</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">errbar_80</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_80</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_80</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">T</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">contrasts_50</span><span class="p">,</span> <span class="n">prob_right_50</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errbar_50</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">contrasts_20</span><span class="p">,</span> <span class="n">prob_right_20</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errbar_20</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">contrasts_80</span><span class="p">,</span> <span class="n">prob_right_80</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errbar_80</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">fit_50</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_50</span><span class="p">,</span> <span class="n">fit_20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_20</span><span class="p">,</span> <span class="n">fit_80</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_80</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;p_left=0.5 fit&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.5 data&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.2 fit&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.2 data&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.8 fit&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.8 data&#39;</span><span class="p">],</span>
              <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability choosing right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Contrasts&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="plot_reaction_time">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.plot_reaction_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_reaction_time</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ci_alpha</span><span class="o">=</span><span class="mf">0.32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot reaction time against contrast a la datajoint webpage.</span>

<span class="sd">    The reaction times are plotted individually for the following three blocks: {0.5, 0.2, 0.8}.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : one.alf.io.AlfBunch</span>
<span class="sd">        An ALF trials object containing the keys {&#39;probabilityLeft&#39;, &#39;contrastLeft&#39;,</span>
<span class="sd">        &#39;contrastRight&#39;, &#39;feedbackType&#39;, &#39;choice&#39;, &#39;response_times&#39;, &#39;stimOn_times&#39;}.</span>
<span class="sd">    ax : matplotlib.pyplot.Axes</span>
<span class="sd">        An axis object to plot onto.</span>
<span class="sd">    title : str</span>
<span class="sd">        An optional plot title.</span>
<span class="sd">    plot_ci : bool</span>
<span class="sd">        If true, computes and plots the confidence intervals for response at each contrast.</span>
<span class="sd">    ci_alpha : float, default=0.32</span>
<span class="sd">        Significance level for confidence interval. Must be in (0, 1). If `plot_ci` is false,</span>
<span class="sd">        this value is ignored.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        If `ax` is None, these arguments are passed to matplotlib.pyplot.subplots.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.pyplot.Figure</span>
<span class="sd">        The figure handle containing the plot.</span>
<span class="sd">    matplotlib.pyplot.Axes</span>
<span class="sd">        The plotted axes.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    scipy.stats.bootstrap - the function used to compute the confidence interval.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signed_contrast</span> <span class="o">=</span> <span class="n">get_signed_contrast</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
    <span class="n">out_50</span> <span class="o">=</span> <span class="n">compute_reaction_time</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">compute_ci</span><span class="o">=</span><span class="n">plot_ci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ci_alpha</span><span class="p">)</span>
    <span class="n">out_20</span> <span class="o">=</span> <span class="n">compute_reaction_time</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">compute_ci</span><span class="o">=</span><span class="n">plot_ci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ci_alpha</span><span class="p">)</span>
    <span class="n">out_80</span> <span class="o">=</span> <span class="n">compute_reaction_time</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">signed_contrast</span><span class="o">=</span><span class="n">signed_contrast</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">compute_ci</span><span class="o">=</span><span class="n">plot_ci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ci_alpha</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">diverging_palette</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;dark&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

    <span class="n">data_50</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out_50</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_50</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data_20</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out_20</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_80</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out_80</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_80</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">plot_ci</span><span class="p">:</span>
        <span class="n">errbar_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">out_50</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_50</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out_50</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_50</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">errbar_20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">out_20</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_20</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out_20</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_20</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">errbar_80</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">out_80</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_80</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">out_80</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_80</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">out_50</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_50</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errbar_50</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">out_20</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errbar_20</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">out_80</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_80</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errbar_80</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">data_50</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_20</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_80</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
              <span class="p">[</span><span class="s1">&#39;p_left=0.5 data&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.2 data&#39;</span><span class="p">,</span> <span class="s1">&#39;p_left=0.8 data&#39;</span><span class="p">],</span>
              <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Reaction time (s)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Contrasts&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="plot_reaction_time_over_trials">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.plot_reaction_time_over_trials">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_reaction_time_over_trials</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">stim_on_type</span><span class="o">=</span><span class="s1">&#39;stimOn_times&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot reaction time with trial number a la datajoint webpage.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials : one.alf.io.AlfBunch</span>
<span class="sd">        An ALF trials object containing the keys {&#39;probabilityLeft&#39;, &#39;contrastLeft&#39;,</span>
<span class="sd">        &#39;contrastRight&#39;, &#39;feedbackType&#39;, &#39;choice&#39;, &#39;response_times&#39;, &#39;stimOn_times&#39;}.</span>
<span class="sd">    stim_on_type : str, default=&#39;stimOn_times&#39;</span>
<span class="sd">        The trials key to use when calculating the response times. The difference between this and</span>
<span class="sd">        &#39;feedback_times&#39; is used (see notes for `compute_median_reaction_time`).</span>
<span class="sd">    ax : matplotlib.pyplot.Axes</span>
<span class="sd">        An axis object to plot onto.</span>
<span class="sd">    title : str</span>
<span class="sd">        An optional plot title.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        If `ax` is None, these arguments are passed to matplotlib.pyplot.subplots.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.pyplot.Figure</span>
<span class="sd">        The figure handle containing the plot.</span>
<span class="sd">    matplotlib.pyplot.Axes</span>
<span class="sd">        The plotted axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reaction_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">reaction_time</span><span class="p">[</span><span class="s1">&#39;reaction_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">response_times</span> <span class="o">-</span> <span class="n">trials</span><span class="p">[</span><span class="n">stim_on_type</span><span class="p">]</span>
    <span class="n">reaction_time</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">reaction_time</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">reaction_time_rolled</span> <span class="o">=</span> <span class="n">reaction_time</span><span class="p">[</span><span class="s1">&#39;reaction_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">reaction_time_rolled</span> <span class="o">=</span> <span class="n">reaction_time_rolled</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">reaction_time_rolled</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">reaction_time</span> <span class="o">=</span> <span class="n">reaction_time</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">reaction_time</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reaction_time</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">reaction_time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reaction_time_rolled</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">reaction_time_rolled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Reaction time (s)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trial number&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="query_criterion">
<a class="viewcode-back" href="../../../_autosummary/brainbox.behavior.training.html#brainbox.behavior.training.query_criterion">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">query_criterion</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">from_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the session for which a given training criterion was met.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject : str</span>
<span class="sd">        The subject name.</span>
<span class="sd">    status : str</span>
<span class="sd">        The training status to query for.</span>
<span class="sd">    from_status : str, optional</span>
<span class="sd">        Count number of sessions and days from reaching `from_status` to `status`.</span>
<span class="sd">    one : one.api.OneAlyx, optional</span>
<span class="sd">        An instance of ONE.</span>
<span class="sd">    validate : bool</span>
<span class="sd">        If true, check if status in TrainingStatus enumeration. Set to false for non-standard</span>
<span class="sd">        training pipelines.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The eID of the first session where this training status was reached.</span>
<span class="sd">    int</span>
<span class="sd">        The number of sessions it took to reach `status` (optionally from reaching `from_status`).</span>
<span class="sd">    int</span>
<span class="sd">        The number of days it tool to reach `status` (optionally from reaching `from_status`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">TrainingStatus</span><span class="p">[</span><span class="n">status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Unknown status &quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">&quot;. For non-standard training protocols set validate=False&#39;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">ONE</span><span class="p">()</span>
    <span class="n">subject_json</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">subject</span><span class="p">)[</span><span class="s1">&#39;json&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">criteria</span> <span class="o">:=</span> <span class="n">subject_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trained_criteria&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">to_date</span><span class="p">,</span> <span class="n">eid</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
    <span class="n">from_date</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_status</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">eids</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">date_range</span><span class="o">=</span><span class="p">[</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">],</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">delta_date</span> <span class="o">=</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">det</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">eid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">),</span> <span class="n">delta_date</span><span class="o">.</span><span class="n">days</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>