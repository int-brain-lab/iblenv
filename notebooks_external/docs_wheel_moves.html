<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working with wheel data &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../010_api_reference.html" />
    <link rel="prev" title="Plotting brain region values on the Swanson flat map" href="atlas_swanson_flatmap.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_repro_ephys.html">Data Release - Reproducible Ephys Paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html">Download the public datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with wheel data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Device">Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Loading-the-wheel-data">Loading the wheel data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Loading-movement-data">Loading movement data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#The-movements-algorithm">The movements algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculating-velocity">Calculating velocity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Last-move-onset">Last move onset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculating-reaction-times">Calculating reaction times</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Finding-reaction-time-and-‘determined’-movements">Finding reaction time and ‘determined’ movements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Direction-changes">Direction changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Splitting-wheel-trace-by-trial">Splitting wheel trace by trial</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Working with wheel data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks_external/docs_wheel_moves.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Working-with-wheel-data">
<h1>Working with wheel data<a class="headerlink" href="#Working-with-wheel-data" title="Permalink to this heading"></a></h1>
<p>This example will give you information about how the rotary encoder records wheel movements, how to find out the units and spatial resolution of the standard wheel data, and how to load the wheel data. There are also examples of how to load wheel movements and rection times from ALF datasets and DataJoint tables, as well as how to calculate these from scratch.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#%matplotlib notebook

import re

import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from one.api import ONE

from brainbox.io.one import load_wheel_reaction_times
import brainbox.behavior.wheel as wh
from ibllib.io.extractors.ephys_fpga import extract_wheel_moves
from ibllib.io.extractors.training_wheel import extract_first_movement_times
# from ibllib.misc.exp_ref import eid2ref

one = ONE(base_url=&#39;https://openalyx.internationalbrainlab.org&#39;, silent=True)
sns.set_style(&#39;whitegrid&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># NB: This function will soon be available from ibllib.misc.exp_ref
def eid2ref(eid):
    &quot;&quot;&quot;
    Get human-readable session ref from path
    :param eid: The experiment uuid to find reference for
    :return: dict containing &#39;subject&#39;, &#39;date&#39; and &#39;sequence&#39;
    &quot;&quot;&quot;
    path_str = str(one.eid2path(eid))
    pattern = r&#39;(?P&lt;subject&gt;[\w-]+)([\\/])(?P&lt;date&gt;\d{4}-\d{2}-\d{2})(\2)(?P&lt;sequence&gt;\d{3})&#39;
    match = re.search(pattern, path_str)
    return match.groupdict()
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>eid = &#39;c7bd79c9-c47e-4ea5-aea3-74dda991b48e&#39;
eid2ref(eid)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;subject&#39;: &#39;CSH_ZAD_029&#39;, &#39;date&#39;: &#39;2020-09-19&#39;, &#39;sequence&#39;: &#39;001&#39;}
</pre></div></div>
</div>
<section id="Device">
<h2>Device<a class="headerlink" href="#Device" title="Permalink to this heading"></a></h2>
<p>The standard resolution of the rotary encoder is 1024 ‘ticks’ per revolulation. With quadrature (X4) encoding we measure four fronts giving from the device: low -&gt; high and high -&gt; low, from channels A and B. Therefore the number of measured ‘ticks’ per revolution becomes 4096.</p>
<p>X4 encoding is used in ephys sessions, while in training sessions the encoding is X1, i.e. four times fewer ticks per revolution.</p>
<p><img alt="Quadrature encoding schematic" src="http://www.ni.com/cms/images/devzone/tut/ipuuzhqc3503.jpg" /></p>
<p>For more information on the rotary encoder see these links: <a class="reference external" href="http://www.ni.com/tutorial/7109/en/">National Instruments guide to rotary encoders</a> <a class="reference external" href="https://www.kuebler.com/pdf?2400-2420_en.pdf">Datasheet for the Kuebler</a></p>
</section>
<section id="Units">
<h2>Units<a class="headerlink" href="#Units" title="Permalink to this heading"></a></h2>
<p>The wheel module contains some default values that are useful for determining the units of the raw data, and for interconverting your ALF position units.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>device_info = (&#39;The wheel diameter is {} cm and the number of ticks is {} per revolution&#39;
               .format(wh.WHEEL_DIAMETER, wh.ENC_RES))
print(device_info)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The wheel diameter is 6.2 cm and the number of ticks is 4096 per revolution
</pre></div></div>
</div>
</section>
<section id="Loading-the-wheel-data">
<h2>Loading the wheel data<a class="headerlink" href="#Loading-the-wheel-data" title="Permalink to this heading"></a></h2>
<p>The wheel traces can be accessed via ONE. There are two ALF files: <code class="docutils literal notranslate"><span class="pre">wheel.position</span></code> and <code class="docutils literal notranslate"><span class="pre">wheel.timestamps</span></code>. The timestamps are, as usual, in seconds (same as the trials object) and the positions are in radians. The positions are not evenly sampled, meaning that when the wheel doesn’t move, no position is registered. For reference,</p>
<p>More information on the ALF dataset types can be found <a class="reference external" href="https://docs.google.com/document/d/1OqIqqakPakHXRAwceYLwFY9gOrm8_P62XIfCTnHwstg/edit#heading=h.hnjqyfnroyya">here</a>.</p>
<p><strong>NB</strong>: There are some old <code class="docutils literal notranslate"><span class="pre">wheel.velocity</span></code> ALF files that contain the volocity measured as the diff between neighbouring samples. Later on we describe a better way to calculate the velocity.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>wheel = one.load_object(eid, &#39;wheel&#39;, collection=&#39;alf&#39;)

print(&#39;wheel.position: \n&#39;, wheel.position)
print(&#39;wheel.timestamps: \n&#39;, wheel.timestamps)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_wheel.timestamps.npy: 100%|██████████| 12.3M/12.3M [00:00&lt;00:00, 32.2MB/s]
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_wheel.position.npy: 100%|██████████| 12.3M/12.3M [00:00&lt;00:00, 36.1MB/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
wheel.position:
 [ 1.53398079e-03 -0.00000000e+00 -1.53398079e-03 ...  7.01282327e+02
  7.01283861e+02  7.01285395e+02]
wheel.timestamps:
 [2.39976000e-03 5.46612000e-03 8.43249000e-03 ... 6.08392098e+03
 6.08408060e+03 6.08414086e+03]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
</section>
<section id="Loading-movement-data">
<h2>Loading movement data<a class="headerlink" href="#Loading-movement-data" title="Permalink to this heading"></a></h2>
<p>There is also an ALF dataset type called ‘wheelMoves’ with two attributes: 1. <code class="docutils literal notranslate"><span class="pre">wheelMoves.intervals</span></code> - An N-by-2 arrays where N is the number of movements detected. The first column contains the movement onset time in absolute seconds; the second contains the offset. 2. <code class="docutils literal notranslate"><span class="pre">wheelMoves.peakAmplitude</span></code> - The absolute maximum amplitude of each detected wheel movement, relative to onset position. This can be used to determine whether the movement was particularly large and therefore whether it was a
flinch vs a determined movement.</p>
<p>If the dataset doesn’t exist you can also extract the wheel moves with a single function. Below we attempt to load the wheelMoves ALF and upon failing, extract it ourselves.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>try:
    # Warning: Some older sessions may not have a wheelMoves dataset
    wheel_moves = one.load_object(eid, &#39;wheelMoves&#39;, collection=&#39;alf&#39;)
    assert wheel_moves, &#39;object not found&#39;
except AssertionError:
    wheel_moves = extract_wheel_moves(wheel.timestamps, wheel.position)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_wheelMoves.peakAmplitude.npy: 100%|██████████| 12.3k/12.3k [00:00&lt;00:00, 149kB/s]
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_wheelMoves.intervals.npy: 100%|██████████| 24.6k/24.6k [00:00&lt;00:00, 358kB/s]
</pre></div></div>
</div>
</section>
<section id="The-movements-algorithm">
<h2>The movements algorithm<a class="headerlink" href="#The-movements-algorithm" title="Permalink to this heading"></a></h2>
<p>The wheel movement onsets and offsets are calculated using the <code class="docutils literal notranslate"><span class="pre">wheel.movements</span></code> function. The output of this function is saved in the ‘wheelMoves’ ALF.</p>
<p>Refer to the <code class="docutils literal notranslate"><span class="pre">wheel.movements</span></code> function docstring for details of how the movements are detected. In addition to the data found in the wheelMoves object, the function outputs an array of peak velocity times. Also the function has a <code class="docutils literal notranslate"><span class="pre">make_plots</span></code> flag which will produce plots of the wheel position and velocity with the movement onsets and offsets highlighted (see below).</p>
<p>The movements algorithm requires the positions and timestamps to be evenly sampled so they should be interpolated first, which can be done with the <code class="docutils literal notranslate"><span class="pre">wheel.interpolate_position</span></code> function. The default sampling frequency is 1000Hz:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pos, t = wh.interpolate_position(wheel.timestamps, wheel.position)
sec = 5  # Number of seconds to plot
plt.figure()

# Plot the interpolated data points
mask = t &lt; (t[0] + sec)
plt.plot(t[mask], pos[mask], &#39;.&#39;, markeredgecolor=&#39;lightgrey&#39;, markersize=1)

# Plot the original data
mask = wheel.timestamps &lt; (wheel.timestamps[0] + sec)
plt.plot(wheel.timestamps[mask], wheel.position[mask], &#39;r+&#39;, markersize=6)

# Labels etc.
plt.xlabel(&#39;time / sec&#39;)
plt.ylabel(&#39;position / rad&#39;)
plt.box(on=None)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_12_0.png" src="../_images/notebooks_external_docs_wheel_moves_12_0.png" />
</div>
</div>
<p>Once interpolated, the movements can be extracted from the position trace. <strong>NB</strong>: The position thresholds are dependant on the wheel position units. The defaults values are for the raw input of a X4 1024 encoder, so we will convert them to radians:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Convert the pos threshold defaults from samples to correct unit
thresholds_cm = wh.samples_to_cm(np.array([8, 1.5]), resolution=wh.ENC_RES)
thresholds = wh.cm_to_rad(thresholds_cm)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Detect wheel movements for the first 5 seconds
mask = t &lt; (t[0] + sec)

onsets, offsets, peak_amp, peak_vel_times = wh.movements(
    t[mask], pos[mask], pos_thresh=thresholds[0], pos_thresh_onset=thresholds[0], make_plots=True)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_15_0.png" src="../_images/notebooks_external_docs_wheel_moves_15_0.png" />
</div>
</div>
<p>For scale, the stimulus must be moved 35 visual degrees to reach threshold. The wheel gain is 4 degrees/mm (<strong>NB</strong>: the gain is double for the first session or so, see <a class="reference external" href="https://docs.google.com/document/d/1RA6wgbWfxD2kGlpNxt0n3HVcW4TEIx8e-YO7k_W1pHs/edit">Appendix 2 of the behavior paper</a>)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>threshold_deg = 35 # visual degrees
gain = 4  # deg / mm
threshold_rad = wh.cm_to_rad(1e-1) * (threshold_deg / gain)  # rad

print(&#39;The wheel must be turned ~%.1f rad to move the stimulus to threshold&#39; % threshold_rad)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The wheel must be turned ~0.3 rad to move the stimulus to threshold
</pre></div></div>
</div>
</section>
<section id="Calculating-velocity">
<h2>Calculating velocity<a class="headerlink" href="#Calculating-velocity" title="Permalink to this heading"></a></h2>
<p>Wheel velocity can be calculated using the <code class="docutils literal notranslate"><span class="pre">velocity_smoothed</span></code> function, which returns the velocity and acceleration convolved with a Gaussian window. As with the <code class="docutils literal notranslate"><span class="pre">movements</span></code> function, the input is expected to be evenly sampled, therefore you should interpolate the wheel data before calling this function. The default window size of 3ms is reasonable, and interpolating at a frequency of 1000 (the default) is sufficiently high.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># pos was the output of interpolate_position using the default frequency of 1000Hz
Fs = 1000
pos, t = wh.interpolate_position(wheel.timestamps, wheel.position, freq=Fs)
vel, acc = wh.velocity_smoothed(pos, Fs)
</pre></div>
</div>
</div>
</section>
<section id="Last-move-onset">
<h2>Last move onset<a class="headerlink" href="#Last-move-onset" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">movements</span></code> algorithm is the recommended way of detecting movement onsets because it is quicker and more accurate, however there is another function that will return the last movement onset before a particular event. This is useful for quickly finding the movement that reached threshold for a given trial. This function finds the first sample after the velocity has been zero for at least 50ms. Because it uses velocity, the smoothed derivative of position, it is less accurate. <strong>NB</strong>: The
more accurate approach is to find all moves for which the onset occured before feedback time and the offset occured afterwards.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>trial_data = one.load_object(eid, &#39;trials&#39;, collection=&#39;alf&#39;)
idx = 23 # trial index
ts = wh.last_movement_onset(t, vel, trial_data[&#39;feedback_times&#39;][idx]);

mask = np.logical_and(trial_data[&#39;goCue_times&#39;][idx] &lt; t, t &lt; trial_data[&#39;feedback_times&#39;][idx])
plt.figure();
plt.plot(t[mask], pos[mask]);
plt.axvline(x=ts);
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_trials.stimOff_times.npy: 100%|██████████| 9.83k/9.83k [00:00&lt;00:00, 218kB/s]
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_trials.goCueTrigger_times.npy: 100%|██████████| 9.83k/9.83k [00:00&lt;00:00, 205kB/s]
/home/runner/Downloads/ONE/openalyx.internationalbrainlab.org/zadorlab/Subjects/CSH_ZAD_029/2020-09-19/001/alf/_ibl_trials.table.pqt: 100%|██████████| 89.6k/89.6k [00:00&lt;00:00, 388kB/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_21_1.png" src="../_images/notebooks_external_docs_wheel_moves_21_1.png" />
</div>
</div>
</section>
<section id="Calculating-reaction-times">
<h2>Calculating reaction times<a class="headerlink" href="#Calculating-reaction-times" title="Permalink to this heading"></a></h2>
<p>Reaction times based on wheel movements can be calculated with the <code class="docutils literal notranslate"><span class="pre">load_wheel_reaction_times</span></code> function which is located in the behavior module of brainbox.</p>
<p>Reaction times are defined as the time between the go cue (onset tone) and the onset of the first substantial wheel movement. A movement is considered sufficiently large if its peak amplitude is at least 1/3rd of the distance to threshold (~0.1 radians).</p>
<p>Negative times mean the onset of the movement occurred before the go cue. Nans may occur if there was no detected movement withing the period, or when the goCue_times or feedback_times are nan.</p>
<p>The function loads the trials object and if <code class="docutils literal notranslate"><span class="pre">firstMovement_times</span></code> is not present it loads the wheel moves and extracts these times.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load the reaction times
# brainbox.io.one.load_wheel_reaction_times
rt = load_wheel_reaction_times(eid)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>trial_data = one.load_object(eid, &#39;trials&#39;, collection=&#39;alf&#39;)

# # Replace nans with zeros
trial_data.contrastRight[np.isnan(trial_data.contrastRight)] = 0
trial_data.contrastLeft[np.isnan(trial_data.contrastLeft)] = 0

contrast = trial_data.contrastRight - trial_data.contrastLeft
mean_rt = [np.nanmean(rt[contrast == c]) for c in set(contrast)]

# RT may be nan if there were no detected movements, or if the goCue or stimOn times were nan
xdata = np.unique(contrast)
plt.figure(figsize=(4, 3))  # Some sort of strange behaviour in this cell&#39;s output
plt.plot(xdata, mean_rt);

plt.xlabel(&#39;contrast&#39;)
plt.ylabel(&#39;mean rt / s&#39;)
plt.ylim(bottom=0);
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_24_0.png" src="../_images/notebooks_external_docs_wheel_moves_24_0.png" />
</div>
</div>
</section>
<section id="Finding-reaction-time-and-‘determined’-movements">
<h2>Finding reaction time and ‘determined’ movements<a class="headerlink" href="#Finding-reaction-time-and-‘determined’-movements" title="Permalink to this heading"></a></h2>
<p>Below is an example of how you might filter trials by those responses that are unambiguous. The function <code class="docutils literal notranslate"><span class="pre">extract_first_movement_times</span></code> is used for calculating the trial reaction times but also returns whether the first significant movement was ‘final’, i.e. was the one that reached threshold. For details of how ‘first movement’ is defined, see the function docstring.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>firstMove_times, is_final_movement, ids = extract_first_movement_times(wheel_moves, trial_data)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-yellow-intense-fg ansi-bold">2022-12-07 12:04:18.63 WARNING  [training_wheel.py:368] no reliable goCue/Feedback times (both needed) for 114 trials</span>
</pre></div></div>
</div>
<section id="Direction-changes">
<h3>Direction changes<a class="headerlink" href="#Direction-changes" title="Permalink to this heading"></a></h3>
<p>Below is an example of how to plot the times that the wheel changed direction. Changing the smoothing window when calculating the velocity may improve the detected changes, depending on what your goal is.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n = 569
on, off = wheel_moves[&#39;intervals&#39;][n,]
mask = np.logical_and(t &gt; on, t &lt; off)
sng = np.sign(vel[mask])
idx, = np.where(np.diff(sng) != 0)

plt.figure()
plt.plot(t[mask], pos[mask], &#39;k&#39;)
for i in idx:
    plt.axvline(x=t[mask][i], color=&#39;k&#39;, linestyle=&#39;:&#39;)

plt.title(&#39;Movement #%s&#39; % n)
plt.xlabel(&#39;time / s&#39;)
plt.ylabel(&#39;position / rad&#39;);
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_28_0.png" src="../_images/notebooks_external_docs_wheel_moves_28_0.png" />
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">direction_changes</span></code> does the same as above, returning a list of times and indices of each movement’s direction changes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n = 403  # trial number
start, end = trial_data[&#39;intervals&#39;][n,]  # trial intervals
intervals = wheel_moves[&#39;intervals&#39;]  # movement onsets and offsets

# Find direction changes for a given trial
mask = np.logical_and(intervals[:,0] &gt; start, intervals[:,0] &lt; end)
change_times, idx, = wh.direction_changes(t, vel, intervals[mask])

plt.figure()
mask = np.logical_and(t &gt; start, t &lt; end)  # trial intervals mask
plt.plot(t[mask], pos[mask], &#39;k&#39;)  # plot wheel trace for trial
for i in np.concatenate(change_times):
    plt.axvline(x=i, color=&#39;k&#39;, linestyle=&#39;:&#39;)

plt.title(&#39;Trial #%s&#39; % n)
plt.xlabel(&#39;time / s&#39;)
plt.ylabel(&#39;position / rad&#39;);
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_30_0.png" src="../_images/notebooks_external_docs_wheel_moves_30_0.png" />
</div>
</div>
</section>
</section>
<section id="Splitting-wheel-trace-by-trial">
<h2>Splitting wheel trace by trial<a class="headerlink" href="#Splitting-wheel-trace-by-trial" title="Permalink to this heading"></a></h2>
<p>To plot a selection of ‘determined’ movements, we can split the traces using the <code class="docutils literal notranslate"><span class="pre">traces_by_trial</span></code> function.</p>
<p><em>NB</em>: This using the <code class="docutils literal notranslate"><span class="pre">within_ranges</span></code> function which is generic and can be used to detect which points are within a range. This is useful for returning masks for slicing (must be cast to bool), to label points within ranges or to dectect whether any points belong to more than one range.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>n_trials = 3  # Number of trials to plot
# Randomly select the trials to plot
trial_ids = np.random.randint(trial_data[&#39;choice&#39;].size, size=n_trials)
fig, axs = plt.subplots(1, n_trials, figsize=(8.5,2.5))
plt.tight_layout()

# Plot go cue and response times
goCues = trial_data[&#39;goCue_times&#39;][trial_ids]
responses = trial_data[&#39;response_times&#39;][trial_ids]

# Plot traces between trial intervals
starts = trial_data[&#39;intervals&#39;][trial_ids, 0]
ends = trial_data[&#39;intervals&#39;][trial_ids, 1]
# Cut up the wheel vectors
traces = wh.traces_by_trial(t, pos, start=starts, end=ends)
zipped = zip(traces, axs, goCues, responses, trial_ids)

for (trace, ax, go, resp, n) in zipped:
    ax.plot(trace[0], trace[1], &#39;k-&#39;)
    ax.axvline(x=go, color=&#39;g&#39;, label=&#39;go cue&#39;, linestyle=&#39;:&#39;)
    ax.axvline(x=resp, color=&#39;r&#39;, label=&#39;threshold&#39;, linestyle=&#39;:&#39;)
    ax.set_title(&#39;Trial #%s&#39; % n)

    # Turn off tick labels
    ax.set_yticklabels([])
    ax.set_xticklabels([])

# Add labels to first
axs[0].set_xlabel(&#39;time / sec&#39;)
axs[0].set_ylabel(&#39;position / rad&#39;)
plt.legend();
plt.tight_layout()
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_32_0.png" src="../_images/notebooks_external_docs_wheel_moves_32_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="atlas_swanson_flatmap.html" class="btn btn-neutral float-left" title="Plotting brain region values on the Swanson flat map" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../010_api_reference.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>