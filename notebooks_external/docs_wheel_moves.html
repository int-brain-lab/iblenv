<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working with wheel data &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/style.css?v=17142d56" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../010_api_reference.html" />
    <link rel="prev" title="Loading the gene expression atlas" href="atlas_genomics_load_agea.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_repro_ephys.html">Data Release - Reproducible Ephys Paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with wheel data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Device">Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Loading-the-wheel-data">Loading the wheel data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Loading-movement-data">Loading movement data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#The-movements-algorithm">The movements algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculating-velocity">Calculating velocity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Last-move-onset">Last move onset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculating-reaction-times">Calculating reaction times</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Finding-reaction-time-and-'determined'-movements">Finding reaction time and ‘determined’ movements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Direction-changes">Direction changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Splitting-wheel-trace-by-trial">Splitting wheel trace by trial</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Working with wheel data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks_external/docs_wheel_moves.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Working-with-wheel-data">
<h1>Working with wheel data<a class="headerlink" href="#Working-with-wheel-data" title="Link to this heading"></a></h1>
<p>This example will give you information about how the rotary encoder records wheel movements, how to find out the units and spatial resolution of the standard wheel data, and how to load the wheel data. There are also examples of how to load wheel movements and rection times from ALF datasets and DataJoint tables, as well as how to calculate these from scratch.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%matplotlib notebook</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">one.api</span> <span class="kn">import</span> <span class="n">ONE</span>

<span class="kn">from</span> <span class="nn">brainbox.io.one</span> <span class="kn">import</span> <span class="n">load_wheel_reaction_times</span>
<span class="kn">import</span> <span class="nn">brainbox.behavior.wheel</span> <span class="k">as</span> <span class="nn">wh</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.ephys_fpga</span> <span class="kn">import</span> <span class="n">extract_wheel_moves</span>
<span class="kn">from</span> <span class="nn">ibllib.io.extractors.training_wheel</span> <span class="kn">import</span> <span class="n">extract_first_movement_times</span>

<span class="n">one</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;4ecb5d24-f5cc-402c-be28-9d0f7cb14b3a&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">eid2ref</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2020-09-21_1_SWC_043
</pre></div></div>
</div>
<section id="Device">
<h2>Device<a class="headerlink" href="#Device" title="Link to this heading"></a></h2>
<p>The standard resolution of the rotary encoder is 1024 ‘ticks’ per revolulation. With quadrature (X4) encoding we measure four fronts giving from the device: low -&gt; high and high -&gt; low, from channels A and B. Therefore the number of measured ‘ticks’ per revolution becomes 4096.</p>
<p>X4 encoding is used in ephys sessions, while in training sessions the encoding is X1, i.e. four times fewer ticks per revolution.</p>
<p><img alt="Quadrature encoding schematic" src="http://www.ni.com/cms/images/devzone/tut/ipuuzhqc3503.jpg" /></p>
<p>For more information on the rotary encoder see these links:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.ni.com/tutorial/7109/en/">National Instruments guide to rotary encoders</a></p></li>
<li><p><a class="reference external" href="https://www.kuebler.com/pdf?2400-2420_en.pdf">Datasheet for the Kuebler</a></p></li>
</ul>
</section>
<section id="Units">
<h2>Units<a class="headerlink" href="#Units" title="Link to this heading"></a></h2>
<p>The wheel module contains some default values that are useful for determining the units of the raw data, and for interconverting your ALF position units.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The wheel diameter is </span><span class="si">{}</span><span class="s1"> cm and the number of ticks is </span><span class="si">{}</span><span class="s1"> per revolution&#39;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wh</span><span class="o">.</span><span class="n">WHEEL_DIAMETER</span><span class="p">,</span> <span class="n">wh</span><span class="o">.</span><span class="n">ENC_RES</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">device_info</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The wheel diameter is 6.2 cm and the number of ticks is 4096 per revolution
</pre></div></div>
</div>
</section>
<section id="Loading-the-wheel-data">
<h2>Loading the wheel data<a class="headerlink" href="#Loading-the-wheel-data" title="Link to this heading"></a></h2>
<p>The wheel traces can be accessed via ONE. There are two ALF files: <code class="docutils literal notranslate"><span class="pre">wheel.position</span></code> and <code class="docutils literal notranslate"><span class="pre">wheel.timestamps</span></code>. The timestamps are, as usual, in seconds (same as the trials object) and the positions are in radians. The positions are not evenly sampled, meaning that when the wheel doesn’t move, no position is registered. For reference,</p>
<p>More information on the ALF dataset types can be found <a class="reference external" href="https://docs.google.com/document/d/1OqIqqakPakHXRAwceYLwFY9gOrm8_P62XIfCTnHwstg/edit#heading=h.hnjqyfnroyya">here</a>.</p>
<p><strong>NB</strong>: There are some old <code class="docutils literal notranslate"><span class="pre">wheel.velocity</span></code> ALF files that contain the volocity measured as the diff between neighbouring samples. Later on we describe a better way to calculate the velocity.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wheel</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wheel.position: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wheel.timestamps: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
wheel.position:
 [ 1.53398079e-03 -0.00000000e+00 -1.53398079e-03 ... -4.52088682e+02
 -4.52090216e+02 -4.52091750e+02]
wheel.timestamps:
 [2.64973500e-02 3.13635300e-02 3.42632400e-02 ... 4.29549951e+03
 4.29570042e+03 4.29584134e+03]
</pre></div></div>
</div>
</section>
<section id="Loading-movement-data">
<h2>Loading movement data<a class="headerlink" href="#Loading-movement-data" title="Link to this heading"></a></h2>
<p>There is also an ALF dataset type called ‘wheelMoves’ with two attributes: 1. <code class="docutils literal notranslate"><span class="pre">wheelMoves.intervals</span></code> - An N-by-2 arrays where N is the number of movements detected. The first column contains the movement onset time in absolute seconds; the second contains the offset. 2. <code class="docutils literal notranslate"><span class="pre">wheelMoves.peakAmplitude</span></code> - The absolute maximum amplitude of each detected wheel movement, relative to onset position. This can be used to determine whether the movement was particularly large and therefore whether it was a
flinch vs a determined movement.</p>
<p>If the dataset doesn’t exist you can also extract the wheel moves with a single function. Below we attempt to load the wheelMoves ALF and upon failing, extract it ourselves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># Warning: Some older sessions may not have a wheelMoves dataset</span>
    <span class="n">wheel_moves</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheelMoves&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
    <span class="n">wheel_moves</span> <span class="o">=</span> <span class="n">extract_wheel_moves</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="The-movements-algorithm">
<h2>The movements algorithm<a class="headerlink" href="#The-movements-algorithm" title="Link to this heading"></a></h2>
<p>The wheel movement onsets and offsets are calculated using the <code class="docutils literal notranslate"><span class="pre">wheel.movements</span></code> function. The output of this function is saved in the ‘wheelMoves’ ALF.</p>
<p>Refer to the <code class="docutils literal notranslate"><span class="pre">wheel.movements</span></code> function docstring for details of how the movements are detected. In addition to the data found in the wheelMoves object, the function outputs an array of peak velocity times. Also the function has a <code class="docutils literal notranslate"><span class="pre">make_plots</span></code> flag which will produce plots of the wheel position and velocity with the movement onsets and offsets highlighted (see below).</p>
<p>The movements algorithm requires the positions and timestamps to be evenly sampled so they should be interpolated first, which can be done with the <code class="docutils literal notranslate"><span class="pre">wheel.interpolate_position</span></code> function. The default sampling frequency is 1000Hz:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pos</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">interpolate_position</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">sec</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Number of seconds to plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="c1"># Plot the interpolated data points</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot the original data</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="c1"># Labels etc.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time / sec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;position / rad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_11_0.png" src="../_images/notebooks_external_docs_wheel_moves_11_0.png" />
</div>
</div>
<p>Once interpolated, the movements can be extracted from the position trace. <strong>NB</strong>: The position thresholds are dependant on the wheel position units. The defaults values are for the raw input of a X4 1024 encoder, so we will convert them to radians:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert the pos threshold defaults from samples to correct unit</span>
<span class="n">thresholds_cm</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">samples_to_cm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]),</span> <span class="n">resolution</span><span class="o">=</span><span class="n">wh</span><span class="o">.</span><span class="n">ENC_RES</span><span class="p">)</span>
<span class="n">thresholds</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">cm_to_rad</span><span class="p">(</span><span class="n">thresholds_cm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Detect wheel movements for the first 5 seconds</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">onsets</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">peak_amp</span><span class="p">,</span> <span class="n">peak_vel_times</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">movements</span><span class="p">(</span>
    <span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos_thresh</span><span class="o">=</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_thresh_onset</span><span class="o">=</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_14_0.png" src="../_images/notebooks_external_docs_wheel_moves_14_0.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">onsets</span></code> and <code class="docutils literal notranslate"><span class="pre">offsets</span></code> are stored in the <code class="docutils literal notranslate"><span class="pre">wheelMoves.intervals</span></code> dataset.</p>
<p>For scale, the stimulus must be moved 35 visual degrees to reach threshold. The wheel gain is 4 degrees/mm (<strong>NB</strong>: the gain is double for the first session or so, see <a class="reference external" href="https://docs.google.com/document/d/1RA6wgbWfxD2kGlpNxt0n3HVcW4TEIx8e-YO7k_W1pHs/edit">Appendix 2 of the behavior paper</a>)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">threshold_deg</span> <span class="o">=</span> <span class="mi">35</span> <span class="c1"># visual degrees</span>
<span class="n">gain</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># deg / mm</span>
<span class="n">threshold_rad</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">cm_to_rad</span><span class="p">(</span><span class="mf">1e-1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">threshold_deg</span> <span class="o">/</span> <span class="n">gain</span><span class="p">)</span>  <span class="c1"># rad</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The wheel must be turned ~</span><span class="si">%.1f</span><span class="s1"> rad to move the stimulus to threshold&#39;</span> <span class="o">%</span> <span class="n">threshold_rad</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The wheel must be turned ~0.3 rad to move the stimulus to threshold
</pre></div></div>
</div>
</section>
<section id="Calculating-velocity">
<h2>Calculating velocity<a class="headerlink" href="#Calculating-velocity" title="Link to this heading"></a></h2>
<p>Wheel velocity can be calculated using the <code class="docutils literal notranslate"><span class="pre">velocity_filtered</span></code> function, which returns the velocity and acceleration passed through a (non-causal) 20 Hz low-pass Butterworth filter. As with the <code class="docutils literal notranslate"><span class="pre">movements</span></code> function, the input is expected to be evenly sampled, therefore you should interpolate the wheel data before calling this function.</p>
<div class="alert alert-block alert-info"><p>Info: Why filter? From the sampling distribution, there is no antialiasing needed, but the imprecision on the timestamps + positions gives a noisy estimate of the velocity.</p>
</div><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pos was the output of interpolate_position using the default frequency of 1000Hz</span>
<span class="n">Fs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">pos</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">interpolate_position</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">Fs</span><span class="p">)</span>
<span class="n">vel</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">velocity_filtered</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">Fs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Last-move-onset">
<h2>Last move onset<a class="headerlink" href="#Last-move-onset" title="Link to this heading"></a></h2>
<p>The _ibl_trials.firstMovement_times dataset contains the timestamps of the first recorded movement in a trial. The <code class="docutils literal notranslate"><span class="pre">get_movement_onset</span></code> function will find the times at which movement started, given an event timestamp that occurred during the movement. In the following example we find the onsets of the movements that led to a feedback response and calculate the movement response time for each trial.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trial_data</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;trials&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">get_movement_onset</span><span class="p">(</span><span class="n">wheel_moves</span><span class="o">.</span><span class="n">intervals</span><span class="p">,</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">response_times</span><span class="p">)</span>

<span class="c1"># The time from final movement onset to response threshold</span>
<span class="n">movement_response_times</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">response_times</span> <span class="o">-</span> <span class="n">ts</span>

<span class="n">idx</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># trial index</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;goCue_times&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;feedback_times&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ts</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;movement onset&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">response_times</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;response threshold&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_20_0.png" src="../_images/notebooks_external_docs_wheel_moves_20_0.png" />
</div>
</div>
</section>
<section id="Calculating-reaction-times">
<h2>Calculating reaction times<a class="headerlink" href="#Calculating-reaction-times" title="Link to this heading"></a></h2>
<p>Reaction times based on wheel movements can be calculated with the <code class="docutils literal notranslate"><span class="pre">load_wheel_reaction_times</span></code> function which is located in the behavior module of brainbox.</p>
<p>Reaction times are defined as the time between the go cue (onset tone) and the onset of the first substantial wheel movement. A movement is considered sufficiently large if its peak amplitude is at least 1/3rd of the distance to threshold (~0.1 radians).</p>
<p>Negative times mean the onset of the movement occurred before the go cue. Nans may occur if there was no detected movement withing the period, or when the goCue_times or feedback_times are nan.</p>
<p>The function loads the trials object and if <code class="docutils literal notranslate"><span class="pre">firstMovement_times</span></code> is not present it loads the wheel moves and extracts these times.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;c7bd79c9-c47e-4ea5-aea3-74dda991b48e&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Session &#39;</span> <span class="o">+</span> <span class="n">one</span><span class="o">.</span><span class="n">eid2ref</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">wheel</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>
<span class="n">pos</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">interpolate_position</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">wheel</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">vel</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">velocity_filtered</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">)</span>

<span class="c1"># Load the reaction times</span>
<span class="c1"># brainbox.io.one.load_wheel_reaction_times</span>
<span class="n">rt</span> <span class="o">=</span> <span class="n">load_wheel_reaction_times</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Session 2020-09-19_1_CSH_ZAD_029
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trial_data</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;trials&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>

<span class="c1"># # Replace nans with zeros</span>
<span class="n">trial_data</span><span class="o">.</span><span class="n">contrastRight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">trial_data</span><span class="o">.</span><span class="n">contrastRight</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">trial_data</span><span class="o">.</span><span class="n">contrastLeft</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">trial_data</span><span class="o">.</span><span class="n">contrastLeft</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">contrast</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">contrastRight</span> <span class="o">-</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">contrastLeft</span>
<span class="n">mean_rt</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">rt</span><span class="p">[</span><span class="n">contrast</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">contrast</span><span class="p">)]</span>

<span class="c1"># RT may be nan if there were no detected movements, or if the goCue or stimOn times were nan</span>
<span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Some sort of strange behaviour in this cell&#39;s output</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">mean_rt</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;contrast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mean rt / s&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_23_0.png" src="../_images/notebooks_external_docs_wheel_moves_23_0.png" />
</div>
</div>
</section>
<section id="Finding-reaction-time-and-'determined'-movements">
<h2>Finding reaction time and ‘determined’ movements<a class="headerlink" href="#Finding-reaction-time-and-'determined'-movements" title="Link to this heading"></a></h2>
<p>Below is an example of how you might filter trials by those responses that are unambiguous. The function <code class="docutils literal notranslate"><span class="pre">extract_first_movement_times</span></code> is used for calculating the trial reaction times but also returns whether the first significant movement was ‘final’, i.e. was the one that reached threshold. For details of how ‘first movement’ is defined, see the function docstring.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wheel_moves</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheelMoves&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span>
<span class="n">firstMove_times</span><span class="p">,</span> <span class="n">is_final_movement</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">extract_first_movement_times</span><span class="p">(</span><span class="n">wheel_moves</span><span class="p">,</span> <span class="n">trial_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-cyan-fg">2024-02-06 09:37:06 INFO     training_wheel.py:343  minimum quiescent period assumed to be 200ms</span>
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-yellow-intense-fg ansi-bold">2024-02-06 09:37:06 WARNING  training_wheel.py:367  no reliable goCue/Feedback times (both needed) for 114 trials</span>
</pre></div></div>
</div>
<section id="Direction-changes">
<h3>Direction changes<a class="headerlink" href="#Direction-changes" title="Link to this heading"></a></h3>
<p>Below is an example of how to plot the times that the wheel changed direction. Changing the smoothing window when calculating the velocity may improve the detected changes, depending on what your goal is.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">569</span>
<span class="n">on</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="n">wheel_moves</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">,]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">on</span><span class="p">,</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">off</span><span class="p">)</span>
<span class="n">sng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
<span class="n">idx</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sng</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Movement #</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time / s&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;position / rad&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_27_0.png" src="../_images/notebooks_external_docs_wheel_moves_27_0.png" />
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">direction_changes</span></code> does the same as above, returning a list of times and indices of each movement’s direction changes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">403</span>  <span class="c1"># trial number</span>
<span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">,]</span>  <span class="c1"># trial intervals</span>
<span class="n">intervals</span> <span class="o">=</span> <span class="n">wheel_moves</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">]</span>  <span class="c1"># movement onsets and offsets</span>

<span class="c1"># Find direction changes for a given trial</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">intervals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">,</span> <span class="n">intervals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
<span class="n">change_times</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">direction_changes</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">intervals</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">,</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>  <span class="c1"># trial intervals mask</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># plot wheel trace for trial</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">change_times</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Trial #</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time / s&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;position / rad&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_29_0.png" src="../_images/notebooks_external_docs_wheel_moves_29_0.png" />
</div>
</div>
</section>
</section>
<section id="Splitting-wheel-trace-by-trial">
<h2>Splitting wheel trace by trial<a class="headerlink" href="#Splitting-wheel-trace-by-trial" title="Link to this heading"></a></h2>
<p>To plot a selection of ‘determined’ movements, we can split the traces using the <code class="docutils literal notranslate"><span class="pre">traces_by_trial</span></code> function.</p>
<p><em>NB</em>: This using the <code class="docutils literal notranslate"><span class="pre">within_ranges</span></code> function which is generic and can be used to detect which points are within a range. This is useful for returning masks for slicing (must be cast to bool), to label points within ranges or to dectect whether any points belong to more than one range.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_trials</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of trials to plot</span>
<span class="c1"># Randomly select the trials to plot</span>
<span class="n">trial_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_trials</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Plot go cue and response times</span>
<span class="n">goCues</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;goCue_times&#39;</span><span class="p">][</span><span class="n">trial_ids</span><span class="p">]</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;response_times&#39;</span><span class="p">][</span><span class="n">trial_ids</span><span class="p">]</span>

<span class="c1"># Plot traces between trial intervals</span>
<span class="n">starts</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="n">trial_ids</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ends</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="n">trial_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="c1"># Cut up the wheel vectors</span>
<span class="n">traces</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">traces_by_trial</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">starts</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">ends</span><span class="p">)</span>
<span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">goCues</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">trial_ids</span><span class="p">)</span>

<span class="k">for</span> <span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">go</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">go</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;go cue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">resp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trial #</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Turn off tick labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

<span class="c1"># Add labels to first</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time / sec&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;position / rad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_docs_wheel_moves_31_0.png" src="../_images/notebooks_external_docs_wheel_moves_31_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="atlas_genomics_load_agea.html" class="btn btn-neutral float-left" title="Loading the gene expression atlas" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../010_api_reference.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>