

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working with IBL atlas object &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../_static/css/style.css?v=17142d56" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Atlas mapping" href="atlas_mapping.html" />
    <link rel="prev" title="Atlas Examples" href="../atlas_examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_repro_ephys.html">Data Release - Reproducible Ephys</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../loading_examples.html">Loading Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../atlas_examples.html">Atlas Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../atlas_examples.html#anatomical-atlases">Anatomical Atlases</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Working with IBL atlas object</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Getting-started">Getting started</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Exploring-the-volumes">Exploring the volumes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Exploring-brain-regions">Exploring brain regions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Navigate-the-brain-region-hierarchy">Navigate the brain region hierarchy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Coordinate-systems">Coordinate systems</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="atlas_mapping.html">Atlas mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="atlas_plotting_scalar_on_slice.html">Plotting brain region values on histology slices</a></li>
<li class="toctree-l3"><a class="reference internal" href="atlas_dorsal_cortex_flatmap.html">Plotting brain region values on cortical flatmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="atlas_circular_pyramidal_flatmap.html">Plotting brain region values on circular flatmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="atlas_plotting_points_on_slice.html">Plotting cluster locations on histology slices</a></li>
<li class="toctree-l3"><a class="reference internal" href="atlas_swanson_flatmap.html">Plotting brain region values on the Swanson flat map</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../atlas_examples.html#gene-expression">Gene expression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs_wheel_screen_stimulus.html">Computing the stimulus position using the wheel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../atlas_examples.html">Atlas Examples</a></li>
      <li class="breadcrumb-item active">Working with IBL atlas object</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks_external/atlas_working_with_ibllib_atlas.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Working-with-IBL-atlas-object">
<h1>Working with IBL atlas object<a class="headerlink" href="#Working-with-IBL-atlas-object" title="Link to this heading"></a></h1>
<section id="Getting-started">
<h2>Getting started<a class="headerlink" href="#Getting-started" title="Link to this heading"></a></h2>
<p>The Allen atlas image and annotation volumes can be accessed using the <code class="docutils literal notranslate"><span class="pre">iblatlas.atlas.AllenAtlas</span></code> class. Upon instantiating the class for the first time, the relevant files will be downloaded from the Allen database.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">iblatlas.atlas</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllenAtlas</span>

<span class="n">res</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># resolution of Atlas, available resolutions are 10, 25 (default) and 50</span>
<span class="n">brain_atlas</span> <span class="o">=</span> <span class="n">AllenAtlas</span><span class="p">(</span><span class="n">res_um</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Exploring-the-volumes">
<h2>Exploring the volumes<a class="headerlink" href="#Exploring-the-volumes" title="Link to this heading"></a></h2>
<p>The brain_atlas class contains two volumes, the diffusion weighted imaging <strong>(DWI) image</strong> volume and the <strong>annotation label</strong> volume. Each volume is saved into a matrix of the same shape (i.e. they contain the same number of voxels), as defined by the input resolution <code class="docutils literal notranslate"><span class="pre">res</span></code>.</p>
<section id="1.-Image-Volume">
<h3>1. Image Volume<a class="headerlink" href="#1.-Image-Volume" title="Link to this heading"></a></h3>
<p>The image volume contains the Allen atlas DWI average template. DWI images are typically represented in gray-scale colors.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access the image volume</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">image</span>

<span class="c1"># Explore the size of the image volume (ap, ml, dv)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shape of image volume: </span><span class="si">{</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Plot a coronal slice at ap = -1000um</span>
<span class="n">ap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c1"># input must be in metres</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">plot_cslice</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Shape of image volume: (528, 456, 320)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_atlas_working_with_ibllib_atlas_7_1.png" src="../_images/notebooks_external_atlas_working_with_ibllib_atlas_7_1.png" />
</div>
</div>
</section>
<section id="Label-Volume">
<h3>Label Volume<a class="headerlink" href="#Label-Volume" title="Link to this heading"></a></h3>
<p>The label volume contains information about which brain region each voxel in the volume belongs to.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access the label volume</span>
<span class="n">lab</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">label</span>

<span class="c1"># Explore the size of the label volume (ap, ml, dv)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shape of label volume: </span><span class="si">{</span><span class="n">lab</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Plot a coronal slice at ap = -1000um</span>
<span class="n">ap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c1"># input must be in metres</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">plot_cslice</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="s1">&#39;annotation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Shape of label volume: (528, 456, 320)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_atlas_working_with_ibllib_atlas_10_1.png" src="../_images/notebooks_external_atlas_working_with_ibllib_atlas_10_1.png" />
</div>
</div>
<p>The label volume used in the IBL AllenAtlas class differs from the Allen annotation volume in two ways.</p>
<ul class="simple">
<li><p>Each voxel has information about the index of the Allen region rather than the Allen atlas id</p></li>
<li><p>The volume has been lateralised to differentiate between the left and right hemisphere</p></li>
</ul>
<p>To understand this better let’s explore the BrainRegions class that contains information about the Allen structure tree.</p>
</section>
</section>
<section id="Exploring-brain-regions">
<h2>Exploring brain regions<a class="headerlink" href="#Exploring-brain-regions" title="Link to this heading"></a></h2>
<section id="Index-versus-Allen-ID">
<h3>Index versus Allen ID<a class="headerlink" href="#Index-versus-Allen-ID" title="Link to this heading"></a></h3>
<p>The Allen brain region structure tree can be accessed through the class <code class="docutils literal notranslate"><span class="pre">iblatlas.regions.BrainRegions</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">iblatlas.regions</span><span class="w"> </span><span class="kn">import</span> <span class="n">BrainRegions</span>

<span class="n">brain_regions</span> <span class="o">=</span> <span class="n">BrainRegions</span><span class="p">()</span>

<span class="c1"># Alternatively if you already have the AllenAtlas instantiated you can access it as an attribute</span>
<span class="n">brain_regions</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">regions</span>
</pre></div>
</div>
</div>
<p>The brain_regions class has the following data attributes</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brain_regions</span><span class="o">.</span><span class="vm">__annotations__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;id&#39;: numpy.ndarray,
 &#39;name&#39;: object,
 &#39;acronym&#39;: object,
 &#39;rgb&#39;: numpy.uint8,
 &#39;level&#39;: numpy.ndarray,
 &#39;parent&#39;: numpy.ndarray,
 &#39;order&#39;: numpy.uint16}
</pre></div></div>
</div>
<p>These attributes are the same as the Allen structure tree and for example <code class="docutils literal notranslate"><span class="pre">id</span></code> corresponds to the Allen atlas id while the <code class="docutils literal notranslate"><span class="pre">name</span></code> represents the full anatomical brain region name.</p>
<p>The index refers to the index in each of these attribute arrays. For example, index 1 corresponds to the <code class="docutils literal notranslate"><span class="pre">root</span></code> brain region with an atlas id of 977.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
997
root
</pre></div></div>
</div>
<p>Alternatively, index 1000 corresponds to <code class="docutils literal notranslate"><span class="pre">PPYd</span></code> with an atlas id of 185</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
185
PPYd
</pre></div></div>
</div>
<p>In the label volume we described above, it is these indices that we are referring to. Therefore, we know all voxels in the volume with a value of 0 will be voxels that lie in <code class="docutils literal notranslate"><span class="pre">root</span></code>, while the voxels that have a value of 1000 will be in <code class="docutils literal notranslate"><span class="pre">PPYd</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">root_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_atlas</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ppyd_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_atlas</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Voxels outside of the brain are labelled with <code class="docutils literal notranslate"><span class="pre">void</span></code>, which has the both the index and Allen ID being 0:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index_void</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index_void</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index_void</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0
void
</pre></div></div>
</div>
<p>As such, you can find all the voxels within the brain by filtering for non-zero indices:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vox_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">index_void</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can jump betwen acronym / id / index with these functions :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># From an acronym, get the index and id</span>
<span class="n">acronym</span> <span class="o">=</span> <span class="s1">&#39;MDm&#39;</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym2index</span><span class="p">(</span><span class="n">acronym</span><span class="p">)</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym2id</span><span class="p">(</span><span class="n">acronym</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The acronym </span><span class="si">{</span><span class="n">acronym</span><span class="si">}</span><span class="s1"> has the indices </span><span class="si">{</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> and Allen id </span><span class="si">{</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># From an id, get the index and acronym</span>
<span class="nb">id</span> <span class="o">=</span> <span class="mi">636</span>
<span class="n">acronym</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">id2acronym</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">id2index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The Allen id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1"> has the acronym </span><span class="si">{</span><span class="n">acronym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> and the indices </span><span class="si">{</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># From a single index, get the id and acronym</span>
<span class="c1"># (Note that this returns only 1 value)</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="n">acronym</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> has the acronym </span><span class="si">{</span><span class="n">acronym</span><span class="si">}</span><span class="s1"> and the Allen id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The acronym MDm has the indices [ 689 2016] and Allen id 636
The Allen id 636 has the acronym MDm and the indices [ 689 2016]
The index 2016 has the acronym MDm and the Allen id -636
</pre></div></div>
</div>
</section>
<section id="Lateralisation:-left/right-hemisphere-differentiation">
<h3>Lateralisation: left/right hemisphere differentiation<a class="headerlink" href="#Lateralisation:-left/right-hemisphere-differentiation" title="Link to this heading"></a></h3>
<p>An additional nuance is the lateralisation. If you compare the size of the brain_regions data class to the Allen structure tree, you will see that it has double the number of columms. This is because the IBL brain regions encodes both the left and right hemisphere using unique, positive integers (the index), whilst the Allen IDs are signed integers (the sign represents the left or right hemisphere).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print how many indexes there are</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2655
</pre></div></div>
</div>
<p>This is equivalent to 2x the number of unique Allen IDs (positive + negative), plus <code class="docutils literal notranslate"><span class="pre">void</span></code> (0) that is not lateralised:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">positive_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">negative_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">void_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_id</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_id</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">void_id</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2655
</pre></div></div>
</div>
<p>We can understand this better by exploring the <code class="docutils literal notranslate"><span class="pre">brain_regions.id</span></code> and <code class="docutils literal notranslate"><span class="pre">brain_regions.name</span></code> at the indices where it transitions between hemispheres.</p>
<p>The first value of <code class="docutils literal notranslate"><span class="pre">brain_region.id</span></code> is <code class="docutils literal notranslate"><span class="pre">void</span></code> (Allen id <code class="docutils literal notranslate"><span class="pre">0</span></code>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index_void</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0
</pre></div></div>
</div>
<p>The point of change between right and left hemisphere is at the index:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_id</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1327
</pre></div></div>
</div>
<p>Around this index, the <code class="docutils literal notranslate"><span class="pre">brain_region.id</span></code> go from positive Allen atlas ids (right hemisphere) to negative Allen atlas ids (left hemisphere).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1320</span><span class="p">:</span><span class="mi">1340</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[        25         34         43         49         57         65
        624  304325711       -997         -8       -567       -688
       -695       -315       -184        -68       -667 -526157192
 -526157196 -526322264]
</pre></div></div>
</div>
<p>Regions are organised following the same index ordering in left/right hemisphere. For example, you will find the same acronym <code class="docutils literal notranslate"><span class="pre">PPYd</span></code> at the index 1000, and once you’ve passed the positive integers:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_id</span><span class="p">)])</span>
<span class="c1"># Note: do not re-use this approach, this is for explanation only - you will see below a dedicated function</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PPYd
PPYd
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">brain_region.name</span></code> also go from right to left hemisphere:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1320</span><span class="p">:</span><span class="mi">1340</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;simple fissure&#39; &#39;intercrural fissure&#39; &#39;ansoparamedian fissure&#39;
 &#39;intraparafloccular fissure&#39; &#39;paramedian sulcus&#39; &#39;parafloccular sulcus&#39;
 &#39;Interpeduncular fossa&#39; &#39;retina&#39; &#39;root (left)&#39;
 &#39;Basic cell groups and regions (left)&#39; &#39;Cerebrum (left)&#39;
 &#39;Cerebral cortex (left)&#39; &#39;Cortical plate (left)&#39; &#39;Isocortex (left)&#39;
 &#39;Frontal pole cerebral cortex (left)&#39; &#39;Frontal pole layer 1 (left)&#39;
 &#39;Frontal pole layer 2/3 (left)&#39; &#39;Frontal pole layer 5 (left)&#39;
 &#39;Frontal pole layer 6a (left)&#39; &#39;Frontal pole layer 6b (left)&#39;]
</pre></div></div>
</div>
<p>In the label volume, we can therefore differentiate between left and right hemisphere voxels for the same brain region. First we will use a method in the brain_region class to find out the index of left and right <code class="docutils literal notranslate"><span class="pre">CA1</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym2index</span><span class="p">(</span><span class="s1">&#39;CA1&#39;</span><span class="p">)</span>
<span class="c1"># The first values are the acronyms, the second values are the indices</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([&#39;CA1&#39;], dtype=object), [array([ 458, 1785])])
</pre></div></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">acronym2index</span></code> returns a tuple, with the first value being a list of acronyms passed in and the second value giving the indices in the array that correspond to the left and right hemispheres for this region. We can now use these indices to search in the label volume</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CA1_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_atlas</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="mi">458</span><span class="p">)</span>
<span class="n">CA1_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_atlas</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1785</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Navigate-the-brain-region-hierarchy">
<h2>Navigate the brain region hierarchy<a class="headerlink" href="#Navigate-the-brain-region-hierarchy" title="Link to this heading"></a></h2>
<p>The 1328 regions in the Allen parcelation are organised in a hierarchical tree. For example, the region PPY encompasses both the regions PPYd and PPYs.</p>
<p>You can visually explore the hierarchy through this <a class="reference external" href="https://openalyx.internationalbrainlab.org/admin/experiments/brainregion/">webpage</a> (username: <code class="docutils literal notranslate"><span class="pre">intbrainlab</span></code>, password: <code class="docutils literal notranslate"><span class="pre">international</span></code>). (TODO THIS IS NOT A GREAT WAY, CHANGE TO OTHER REFERENCE)</p>
<section id="Ancestors">
<h3>Ancestors<a class="headerlink" href="#Ancestors" title="Link to this heading"></a></h3>
<p>To find ancestors of a region, i.e. regions that are higher in the hierarchy tree, use <code class="docutils literal notranslate"><span class="pre">brain_regions.ancestors</span></code>.</p>
<p>Let’s use the region PPYd as an example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Remember the Allen id at this index is 185</span>
<span class="n">brain_regions</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;id&#39;: array([ 997,    8,  343, 1065,  354,  370, 1069,  185]),
 &#39;name&#39;: array([&#39;root&#39;, &#39;Basic cell groups and regions&#39;, &#39;Brain stem&#39;, &#39;Hindbrain&#39;,
        &#39;Medulla&#39;, &#39;Medulla motor related&#39;, &#39;Parapyramidal nucleus&#39;,
        &#39;Parapyramidal nucleus deep part&#39;], dtype=object),
 &#39;acronym&#39;: array([&#39;root&#39;, &#39;grey&#39;, &#39;BS&#39;, &#39;HB&#39;, &#39;MY&#39;, &#39;MY-mot&#39;, &#39;PPY&#39;, &#39;PPYd&#39;],
       dtype=object),
 &#39;rgb&#39;: array([[255, 255, 255],
        [191, 218, 227],
        [255, 112, 128],
        [255, 155, 136],
        [255, 155, 205],
        [255, 179, 217],
        [255, 179, 217],
        [255, 179, 217]], dtype=uint8),
 &#39;level&#39;: array([0, 1, 2, 3, 4, 5, 6, 7], dtype=uint16),
 &#39;parent&#39;: array([  nan,  997.,    8.,  343., 1065.,  354.,  370., 1069.]),
 &#39;order&#39;: array([  0,   1, 639, 882, 935, 964, 998, 999], dtype=uint16)}
</pre></div></div>
</div>
<p>All parents along the hierarchy tree are returned. The parents are organised in increasing order of <code class="docutils literal notranslate"><span class="pre">level</span></code> (0-1-2…), i.e. the highest, all-encompassing level is first (<code class="docutils literal notranslate"><span class="pre">root</span></code> in the example above). Note:</p>
<ul class="simple">
<li><p>The fields contain all the parents regions, including the one passed in (which is last).</p></li>
<li><p>The field <code class="docutils literal notranslate"><span class="pre">parent</span></code> returns the parent region id of the regions in <code class="docutils literal notranslate"><span class="pre">id</span></code> (you can notice they are the same as in <code class="docutils literal notranslate"><span class="pre">id</span></code> but incremented by one level).</p></li>
<li><p>The field <code class="docutils literal notranslate"><span class="pre">order</span></code> returns values used for plotting (Note: this is <em>not</em> the parent’s index)</p></li>
</ul>
<p>For example, the last <code class="docutils literal notranslate"><span class="pre">parent</span></code> region is PPY (which is indeed the closest parent of PPYd):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">999</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1069
PPY
</pre></div></div>
</div>
</section>
<section id="Descendants">
<h3>Descendants<a class="headerlink" href="#Descendants" title="Link to this heading"></a></h3>
<p>To find the descendants of a region, use <code class="docutils literal notranslate"><span class="pre">brain_regions.descendants</span></code>.</p>
<p>Let’s use the region PPY as an example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">999</span>
<span class="n">brain_regions</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;id&#39;: array([1069,  185,  193]),
 &#39;name&#39;: array([&#39;Parapyramidal nucleus&#39;, &#39;Parapyramidal nucleus deep part&#39;,
        &#39;Parapyramidal nucleus superficial part&#39;], dtype=object),
 &#39;acronym&#39;: array([&#39;PPY&#39;, &#39;PPYd&#39;, &#39;PPYs&#39;], dtype=object),
 &#39;rgb&#39;: array([[255, 179, 217],
        [255, 179, 217],
        [255, 179, 217]], dtype=uint8),
 &#39;level&#39;: array([6, 7, 7], dtype=uint16),
 &#39;parent&#39;: array([ 370., 1069., 1069.]),
 &#39;order&#39;: array([ 998,  999, 1000], dtype=uint16)}
</pre></div></div>
</div>
<p>Note:</p>
<ul class="simple">
<li><p>The fields contain all the descendant regions, including the one passed in (which is first).</p></li>
<li><p>The field <code class="docutils literal notranslate"><span class="pre">parent</span></code> returns the parent region id of the regions in <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p></li>
<li><p>The field <code class="docutils literal notranslate"><span class="pre">order</span></code> returns values used for plotting (Note: this is <em>not</em> the parent’s index)</p></li>
</ul>
<p>Note also that the <code class="docutils literal notranslate"><span class="pre">descendants</span></code> methods will return all descendants from all the different branches down, for example for PTLp :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">atlas_id</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym2id</span><span class="p">(</span><span class="s1">&#39;PTLp&#39;</span><span class="p">)</span>
<span class="c1"># Print the acronyms of the descendants of this region</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">atlas_id</span><span class="p">)[</span><span class="s1">&#39;acronym&#39;</span><span class="p">])</span>
<span class="c1"># Print the levels of the descendants of this region</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">atlas_id</span><span class="p">)[</span><span class="s1">&#39;level&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;PTLp&#39; &#39;PTLp1&#39; &#39;PTLp2/3&#39; &#39;PTLp4&#39; &#39;PTLp5&#39; &#39;PTLp6a&#39; &#39;PTLp6b&#39; &#39;VISa&#39; &#39;VISa1&#39;
 &#39;VISa2/3&#39; &#39;VISa4&#39; &#39;VISa5&#39; &#39;VISa6a&#39; &#39;VISa6b&#39; &#39;VISrl&#39; &#39;VISrl1&#39; &#39;VISrl2/3&#39;
 &#39;VISrl4&#39; &#39;VISrl5&#39; &#39;VISrl6a&#39; &#39;VISrl6b&#39;]
[6 7 7 7 7 7 7 7 8 8 8 8 8 8 7 8 8 8 8 8 8]
</pre></div></div>
</div>
</section>
<section id="Find-region-at-a-particular-place-in-the-hierarchy">
<h3>Find region at a particular place in the hierarchy<a class="headerlink" href="#Find-region-at-a-particular-place-in-the-hierarchy" title="Link to this heading"></a></h3>
<section id="Leaf-node">
<h4>Leaf node<a class="headerlink" href="#Leaf-node" title="Link to this heading"></a></h4>
<p>If you need to check a region is a leaf node, i.e. that it has no descendant, you could use the <code class="docutils literal notranslate"><span class="pre">descendants</span></code> method and check that the returned length of the <code class="docutils literal notranslate"><span class="pre">id</span></code> is one (i.e. it only returns itself).</p>
<p>For example, PPYd is a leaf node:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">ppyd_desc</span> <span class="o">=</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<span class="nb">len</span><span class="p">(</span><span class="n">ppyd_desc</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>However, there is a faster method. To find all the regions that are leaf nodes, use <code class="docutils literal notranslate"><span class="pre">brain_regions.leaves</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brain_regions</span><span class="o">.</span><span class="n">leaves</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;id&#39;: array([-614454277, -607344862, -607344858, ...,  607344858,  607344862,
         614454277], shape=(2077,)),
 &#39;name&#39;: array([&#39;Supraoculomotor periaqueductal gray (left)&#39;,
        &#39;Interpeduncular nucleus rostrolateral (left)&#39;,
        &#39;Interpeduncular nucleus dorsolateral (left)&#39;, ...,
        &#39;Interpeduncular nucleus dorsolateral&#39;,
        &#39;Interpeduncular nucleus rostrolateral&#39;,
        &#39;Supraoculomotor periaqueductal gray&#39;], shape=(2077,), dtype=object),
 &#39;acronym&#39;: array([&#39;Su3&#39;, &#39;IPRL&#39;, &#39;IPDL&#39;, ..., &#39;IPDL&#39;, &#39;IPRL&#39;, &#39;Su3&#39;],
       shape=(2077,), dtype=object),
 &#39;rgb&#39;: array([[255, 144, 255],
        [255, 166, 255],
        [255, 166, 255],
        ...,
        [255, 166, 255],
        [255, 166, 255],
        [255, 144, 255]], shape=(2077, 3), dtype=uint8),
 &#39;level&#39;: array([6, 7, 7, ..., 7, 7, 6], shape=(2077,), dtype=uint16),
 &#39;parent&#39;: array([-795., -100., -100., ...,  100.,  100.,  795.], shape=(2077,)),
 &#39;order&#39;: array([842, 878, 877, ..., 877, 878, 842], shape=(2077,), dtype=uint16)}
</pre></div></div>
</div>
<p>It is recommended you use this function to check whether a region is a leaf node:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">brain_regions</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">brain_regions</span><span class="o">.</span><span class="n">leaves</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
</section>
<section id="Find-region-at-a-given-hierarchy-level">
<h4>Find region at a given hierarchy level<a class="headerlink" href="#Find-region-at-a-given-hierarchy-level" title="Link to this heading"></a></h4>
<p>To find all the regions that are on a given level of the hierarchy, use <code class="docutils literal notranslate"><span class="pre">brain_regions.level</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;brain_regions.level contains </span><span class="si">{</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1"> values, which are either </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">level</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
brain_regions.level contains 2655 values, which are either [ 0  1  2  3  4  5  6  7  8  9 10]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example: find the index and acronyms of brain regions at level 0 (i.e. highest parents):</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">brain_regions</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="n">brain_regions</span><span class="o">.</span><span class="n">acronym</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># Note that root appears twice because of the lateralisation</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[   0    1 1328]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;void&#39;, &#39;root&#39;, &#39;root&#39;], dtype=object)
</pre></div></div>
</div>
</section>
</section>
</section>
<section id="Coordinate-systems">
<h2>Coordinate systems<a class="headerlink" href="#Coordinate-systems" title="Link to this heading"></a></h2>
<p>The voxels can be translated to 3D space. In the IBL, all xyz coordinates are referenced from Bregma, which point is set as xyz coordinate [0,0,0].</p>
<img alt="IBL coordinate system" src="https://github.com/int-brain-lab/iblatlas/blob/main/examples/images/brain_xyz.png?raw=true" />
<p>In contrast, in the Allen coordinate framework, the [0,0,0] point corresponds to one of the cubic volume edge.</p>
<p>Below we show the value of Bregma in the Allen CCF space (in micrometer um):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">iblatlas.atlas</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALLEN_CCF_LANDMARKS_MLAPDV_UM</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ALLEN_CCF_LANDMARKS_MLAPDV_UM</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;bregma&#39;: array([5739, 5400,  332])}
</pre></div></div>
</div>
<p>To translate this into an index into the volume <code class="docutils literal notranslate"><span class="pre">brain_atlas</span></code>, you need to divide by the atlas resolution (also in micrometer):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find bregma position in indices</span>
<span class="n">bregma_index</span> <span class="o">=</span> <span class="n">ALLEN_CCF_LANDMARKS_MLAPDV_UM</span><span class="p">[</span><span class="s1">&#39;bregma&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">res_um</span>
</pre></div>
</div>
</div>
<p>This index can be passed into <code class="docutils literal notranslate"><span class="pre">brain_atlas.bc.i2xyz</span></code> that converts volume indices into IBL xyz coordinates (i.e. relative to Bregma):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find bregma position in xyz in m (expect this to be 0 0 0)</span>
<span class="n">bregma_xyz</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">i2xyz</span><span class="p">(</span><span class="n">bregma_index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bregma_xyz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0. 0. 0.]
</pre></div></div>
</div>
<p>Functions exist in both direction, i.e. from a volume index to IBL xyz, and from xyz to an index. Note that the functions return/input values are in <em>meters</em>, not micrometers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert from arbitrary index to xyz position (m) position relative to Bregma</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">102</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">178</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">i2xyz</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xyz values are in meters: </span><span class="si">{</span><span class="n">xyz</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Convert from xyz position (m) to index in atlas</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">325</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">250</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e6</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">xyz2i</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
xyz values are in meters: [-0.003189 -0.00045  -0.004118]
</pre></div></div>
</div>
<p>To know the sign and voxel resolution for each xyz axis, use:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the resolution (in meter) of each axis</span>
<span class="n">res_xyz</span> <span class="o">=</span> <span class="n">brain_atlas</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">dxyz</span>

<span class="c1"># Find the sign of each axis</span>
<span class="n">sign_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">res_xyz</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolution xyz: </span><span class="si">{</span><span class="n">res_xyz</span><span class="si">}</span><span class="s2"> in meter </span><span class="se">\n</span><span class="s2">Sign xyz:</span><span class="se">\t\t</span><span class="si">{</span><span class="n">sign_xyz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Resolution xyz: [ 2.5e-05 -2.5e-05 -2.5e-05] in meter
Sign xyz:               [ 1. -1. -1.]
</pre></div></div>
</div>
<p>To jump directly from an Allen xyz value to an IBL xyz value, use <code class="docutils literal notranslate"><span class="pre">brain_atlas.ccf2xyz</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example: Where is the Allen 0 relative to IBL Bregma?</span>
<span class="c1"># This will give the Bregma value shown above (in meters), but with opposite axis sign value</span>
<span class="n">brain_atlas</span><span class="o">.</span><span class="n">ccf2xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([-0.005739,  0.0054  ,  0.000332])
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../atlas_examples.html" class="btn btn-neutral float-left" title="Atlas Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="atlas_mapping.html" class="btn btn-neutral float-right" title="Atlas mapping" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>