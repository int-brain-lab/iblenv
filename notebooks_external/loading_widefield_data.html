<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loading Widefield Imaging Data &mdash; IBL Library  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../_static/css/style.css?v=17142d56" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Loading Multi-photon Calcium Imaging Data" href="loading_multi_photon_imaging_data.html" />
    <link rel="prev" title="Loading Raw Video Data" href="loading_raw_video_data.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            IBL Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Open Neurophysiology Environment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://int-brain-lab.github.io/ONE/">Full documentation Website for ONE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/public_introduction.html">Publicly available IBL data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_behavior.html">Data Release - Behavior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/data_release_pilot.html">Data Release - Pilot Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_repro_ephys.html">Data Release - Reproducible Ephys</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_brainwidemap.html">Data Release - Brain Wide Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_release_spikesorting_benchmarks.html">Data Release - Spike sorting benchmark datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public_docs/information_contact.html">Information and troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploring IBL Data</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_structure.html">Get to know the datasets and folder structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html#Explore-and-download-data-using-the-ONE-api">Explore and download data using the ONE-api</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../loading_examples.html">Loading Data</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="loading_trials_data.html">Loading Trials Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_wheel_data.html">Loading Wheel Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_spikesorting_data.html">Loading SpikeSorting Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_spike_waveforms.html">Loading Spike Waveforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_passive_data.html">Loading Passive Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_ephys_data.html">Loading Ephys Data (AP and LFP band)</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_raw_ephys_data.html">Loading Raw Ephys Data (AP and LFP band)</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_video_data.html">Loading Video Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_raw_video_data.html">Loading Raw Video Data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Loading Widefield Imaging Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Relevant-ALF-objects">Relevant ALF objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Widefield-pipeline">Widefield pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="#More-details">More details</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Relevant-packages">Relevant packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Finding-sessions-with-widefield-data">Finding sessions with widefield data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Loading-widefield-imaging-stack-data">Loading widefield imaging stack data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Aligning-data-to-the-Allen-reference-atlas">Aligning data to the Allen reference atlas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Loading-imaging-times">Loading imaging times</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="loading_multi_photon_imaging_data.html">Loading Multi-photon Calcium Imaging Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_raw_mesoscope_data.html">Loading Raw Mesoscope Imaging Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_raw_mesoscope_data.html#Downloading-the-raw-images">Downloading the raw images</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_photometry_data.html">Loading Fiber Photometry Data</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02_installation.html">Unified Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_contribution.html">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../atlas_examples.html">Atlas Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs_wheel_moves.html">Working with wheel data</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs_wheel_screen_stimulus.html">Computing the stimulus position using the wheel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../010_api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IBL Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../loading_examples.html">Loading Data</a></li>
      <li class="breadcrumb-item active">Loading Widefield Imaging Data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks_external/loading_widefield_data.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Loading-Widefield-Imaging-Data">
<h1>Loading Widefield Imaging Data<a class="headerlink" href="#Loading-Widefield-Imaging-Data" title="Link to this heading"></a></h1>
<p>Imaging data recorded using widefield</p>
<section id="Relevant-ALF-objects">
<h2>Relevant ALF objects<a class="headerlink" href="#Relevant-ALF-objects" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>imaging</p></li>
<li><p>imagingLightSource</p></li>
<li><p>widefieldU</p></li>
<li><p>widefieldSVT</p></li>
<li><p>widefieldChannels</p></li>
<li><p>widefieldLandmark</p></li>
</ul>
</section>
<section id="Widefield-pipeline">
<h2>Widefield pipeline<a class="headerlink" href="#Widefield-pipeline" title="Link to this heading"></a></h2>
<p>Widefield data collected in the IBL has been collected and processed following the pipeline described by <a class="reference external" href="10.1038/s41596-021-00527-z">Couto et al</a>. Briefly the raw data (imaging.frames.mov) has undergone motion and baseline correction followed by denoising and decomposition (SVD) resulting in a compressed image stack formed of the spatial components (widefieldU.images.npy) and the temporal components (widefeildlSVT.uncorrected.npy). Haemodynamic correction has also been applied yielding
corrected temporal components (widefieldSVT.haemoCorrected.npy).</p>
</section>
<section id="More-details">
<h2>More details<a class="headerlink" href="#More-details" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.google.com/document/d/1OqIqqakPakHXRAwceYLwFY9gOrm8_P62XIfCTnHwstg/edit#heading=h.7f0skb6ow9gw">Description of widefield datasets</a></p></li>
<li><p><a class="reference external" href="https://docs.google.com/document/d/1OqIqqakPakHXRAwceYLwFY9gOrm8_P62XIfCTnHwstg/edit#heading=h.5d32zs4grdoy">Description of imaging datasets</a></p></li>
</ul>
</section>
<section id="Relevant-packages">
<h2>Relevant packages<a class="headerlink" href="#Relevant-packages" title="Link to this heading"></a></h2>
<p>Please install the wfield package to work with widefield data</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jcouto</span><span class="o">/</span><span class="n">wfield</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>We encourage you to look at futher examples and tutorials that are available in the <a class="reference external" href="https://github.com/jcouto/wfield/tree/master">wfield github repo</a>.</p>
</section>
<section id="Finding-sessions-with-widefield-data">
<h2>Finding sessions with widefield data<a class="headerlink" href="#Finding-sessions-with-widefield-data" title="Link to this heading"></a></h2>
<p>Sessions that contain widefield data can be found by searching for sessions with a corresponding widefield dataset</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">one.api</span> <span class="kn">import</span> <span class="n">ONE</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">()</span>
<span class="n">sessions</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;widefieldU.images.npy&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span><span class="si">}</span><span class="s1"> sessions with widefield data found&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
50 sessions with widefield data found
</pre></div></div>
</div>
</section>
<section id="Loading-widefield-imaging-stack-data">
<h2>Loading widefield imaging stack data<a class="headerlink" href="#Loading-widefield-imaging-stack-data" title="Link to this heading"></a></h2>
<p>The imaging stack can be reconstructed from the decomponsed spatial and temporal components of the SVD. The imaging stack contains the imaging data for each frame in the session and has dimensions (nFrames, nx, ny) where <code class="docutils literal notranslate"><span class="pre">nx</span></code> is the width of the imaging window, and <code class="docutils literal notranslate"><span class="pre">ny</span></code> the height.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wfield</span>

<span class="c1"># Choose the first session</span>
<span class="n">eid</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Load the spatial components</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;widefieldU.images.npy&#39;</span><span class="p">)</span>
<span class="c1"># Load the haemocorrected temporal components</span>
<span class="n">SVT</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;widefieldSVT.haemoCorrected.npy&#39;</span><span class="p">)</span>
<span class="c1"># Use wfield package to build imaging stack</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">wfield</span><span class="o">.</span><span class="n">SVDStack</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">SVT</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of imaging stack: </span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dimensions of imaging stack: [85132, 540, 640]
</pre></div></div>
</div>
</section>
<section id="Aligning-data-to-the-Allen-reference-atlas">
<h2>Aligning data to the Allen reference atlas<a class="headerlink" href="#Aligning-data-to-the-Allen-reference-atlas" title="Link to this heading"></a></h2>
<p>We can register the imaging stack to the Allen reference atlas using the landmark file that contains the bregma and lambda position in the imaging window</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lmark_file</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;widefieldLandmarks.dorsalCortex.json&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">landmarks</span> <span class="o">=</span> <span class="n">wfield</span><span class="o">.</span><span class="n">load_allen_landmarks</span><span class="p">(</span><span class="n">lmark_file</span><span class="p">)</span>
<span class="c1"># Warp and register the image stack to the Allen dorsal cortex</span>
<span class="n">stack</span><span class="o">.</span><span class="n">set_warped</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">landmarks</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">])</span>

<span class="c1"># plot the data from the 100th frame</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>Out[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7fe68a6bd1c0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_external_loading_widefield_data_8_1.png" src="../_images/notebooks_external_loading_widefield_data_8_1.png" />
</div>
</div>
</section>
<section id="Loading-imaging-times">
<h2>Loading imaging times<a class="headerlink" href="#Loading-imaging-times" title="Link to this heading"></a></h2>
<p>Timestamps for each frame are in seconds from session start and are aligned to other times from the session, e.g behavioral or video events. The timestamps contain times for both the functional (haemodynamic corrected) and non-functional channel.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">times</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;imaging.times.npy&#39;</span><span class="p">)</span>
<span class="n">channels</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;imaging.imagingLightSource.npy&#39;</span><span class="p">)</span>
<span class="n">channel_info</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;imagingLightSource.properties.htsv&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">channel_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">channel_info</span><span class="p">)</span>

<span class="c1"># If haemocorrected need to take timestamps that correspond to functional channel</span>
<span class="n">functional_channel</span> <span class="o">=</span> <span class="mi">470</span>
<span class="n">functional_chn</span> <span class="o">=</span> <span class="n">channel_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">channel_info</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">functional_channel</span><span class="p">][</span><span class="s1">&#39;channel_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">channels</span> <span class="o">==</span> <span class="n">functional_chn</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="loading_raw_video_data.html" class="btn btn-neutral float-left" title="Loading Raw Video Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="loading_multi_photon_imaging_data.html" class="btn btn-neutral float-right" title="Loading Multi-photon Calcium Imaging Data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>